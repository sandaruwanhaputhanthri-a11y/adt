{
  "version": 3,
  "sources": ["../../../../assets/adt/modules/state.js", "../../../../assets/adt/modules/cookies.js", "../../../../assets/adt/modules/admin_popup.js", "../../../../assets/adt/modules/error_utils.js", "../../../../assets/adt/modules/video.js", "../../../../assets/adt/modules/translations.js", "../../../../assets/adt/modules/analytics.js", "../../../../assets/adt/modules/navigation.js", "../../../../assets/adt/modules/activities/send-email.js", "../../../../assets/adt/modules/activities/shortcut-utils.js", "../../../../assets/adt/modules/activities/multiple_choice.js", "../../../../assets/adt/modules/activities/quiz.js", "../../../../assets/adt/modules/activities/sorting.js", "../../../../assets/adt/modules/activities/matching.js", "../../../../assets/adt/modules/activities/true_false.js", "../../../../assets/adt/modules/activities/textvalidator.js", "../../../../assets/adt/modules/activities/open_ended.js", "../../../../assets/adt/modules/activities/fill_in_the_blank.js", "../../../../assets/adt/modules/activities/fill_in_a_table.js", "../../../../assets/adt/modules/activities/gibberish_detector.js", "../../../../assets/adt/modules/activities/profanity_detector.js", "../../../../assets/adt/modules/activities/validation.js", "../../../../assets/adt/activity.js", "../../../../assets/adt/modules/utils.js", "../../../../assets/adt/modules/browser_zoom_controller.js", "../../../../assets/adt/modules/interface.js", "../../../../assets/adt/modules/ui_utils.js", "../../../../assets/adt/modules/audio.js", "../../../../assets/adt/modules/tts_highlighter.js", "../../../../assets/adt/modules/notepad.js", "../../../../assets/adt/modules/character-generator.js", "../../../../assets/adt/modules/character-display.js", "../../../../assets/adt/modules/tutorial.js", "../../../../assets/adt/base.js"],
  "sourcesContent": ["/**\r\n * @module state\r\n * @description\r\n * Centralized state management for UI and activity modules. Provides helpers to get, set, update, and reset state, as well as initialize state from cookies.\r\n */\r\n\r\n/**\r\n * The main application state object. All UI and activity modules should use this for shared state.\r\n * @type {Object}\r\n */\r\nconst initialState = {\r\n    currentAudio: null,\r\n    isPlaying: false,\r\n    currentIndex: 0,\r\n    audioElements: [],\r\n    audioQueue: [],\r\n    eli5Active: false,\r\n    eli5Element: null,\r\n    eli5Audio: null,\r\n    eli5Mode: false,\r\n    readAloudMode: false,\r\n    signLanguageMode: false,\r\n    sideBarActive: false,\r\n    navOpen: false,\r\n    navScrollPosition: 0,\r\n    easyReadMode: false,\r\n    autoplayMode: false,\r\n    describeImagesMode: false,\r\n    syllablesMode: false,\r\n    glossaryMode: false,\r\n    audioSpeed: 1,\r\n    selectedOption: null,\r\n    selectedWord: null,\r\n    inCategoryNavigation: false,\r\n    currentWord: null,\r\n    translations: {},\r\n    audioFiles: {},\r\n    validateHandler: null,\r\n    retryHandler: null,\r\n    currentLanguage: document.documentElement.lang || 'en',\r\n    currentPage: \"\",\r\n    interfaceInitialized: false,\r\n    activeTabIndex: 0,\r\n    glossaryListOpen: false,\r\n    isReferencePage: false,\r\n    originatingPage: null,\r\n    stateMode: true,\r\n    videoFiles: {},\r\n    videoPlaying: false,\r\n    videoElement: null,\r\n    videoSource: \"\",\r\n    characterName: null,\r\n    characterGreeting: null,\r\n    notepadOpen: false,\r\n    navigationDirection: 'forward'\r\n};\r\n\r\n// State management\r\nexport const state = { ...initialState };\r\n\r\n/**\r\n * Gets the value of a state property by key.\r\n * @param {string} key - The state property to retrieve.\r\n * @returns {*} The value of the state property.\r\n */\r\nexport const getState = (key) => state[key];\r\n\r\n/**\r\n * Sets the value of a state property by key.\r\n * @param {string} key - The state property to set.\r\n * @param {*} value - The value to set.\r\n * @returns {*} The new value of the state property.\r\n */\r\nexport const setState = (key, value) => {\r\n    state[key] = value;\r\n    return state[key];\r\n};\r\n\r\n/**\r\n * Updates multiple state properties at once.\r\n * @param {Object} updates - An object with key-value pairs to update in state.\r\n */\r\nexport const updateState = (updates) => {\r\n    Object.entries(updates).forEach(([key, value]) => {\r\n        state[key] = value;\r\n    });\r\n};\r\n\r\n/**\r\n * Resets the state object to its initial values.\r\n */\r\nexport const resetState = () => {\r\n    Object.assign(state, initialState);\r\n};\r\n\r\n/**\r\n * Returns a shallow copy of the entire state object.\r\n * @returns {Object} The current state.\r\n */\r\nexport const getFullState = () => ({ ...state });\r\n\r\n/**\r\n * Initializes state properties from cookies, using defaults for toggles.\r\n * Should be called on app load to sync persisted state.\r\n */\r\nexport const initializeStateFromCookies = () => {\r\n    const cookieKeys = {\r\n        readAloudMode: false,\r\n        easyReadMode: false,\r\n        eli5Mode: false,\r\n        autoplayMode: false,\r\n        describeImagesMode: false,\r\n        syllablesMode: false,\r\n        audioSpeed: 1,\r\n        currentLanguage: document.documentElement.lang || 'en'\r\n    };\r\n\r\n    Object.entries(cookieKeys).forEach(([stateKey, defaultValue]) => {\r\n        const cookieValue = getCookie(stateKey);\r\n        if (cookieValue !== null) {\r\n            if (stateKey === 'audioSpeed') {\r\n                setState(stateKey, parseFloat(cookieValue) || 1);\r\n            } else if (typeof defaultValue === 'boolean') {\r\n                setState(stateKey, cookieValue === 'true');\r\n            } else {\r\n                setState(stateKey, cookieValue || defaultValue);\r\n            }\r\n        } else {\r\n            setState(stateKey, defaultValue);\r\n        }\r\n    });\r\n};", "/**\r\n * Sets a cookie with the given name, value, expiration (in days), and path.\r\n * @param {string} name - The name of the cookie.\r\n * @param {string} value - The value to store.\r\n * @param {number} [days=7] - Number of days until the cookie expires.\r\n * @param {string} [path=\"/\"] - The path where the cookie is valid.\r\n */\r\nexport const setCookie = (name, value, days = 7, path = \"/\") => {\r\n   let expires = \"\";\r\n   if (days) {\r\n      const date = new Date();\r\n      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);\r\n      expires = \"; expires=\" + date.toUTCString();\r\n   }\r\n   document.cookie = name + \"=\" + (value || \"\") + expires + \"; path=\" + path;\r\n};\r\n\r\n/**\r\n * Retrieves the value of a cookie by name.\r\n * @param {string} name - The name of the cookie to retrieve.\r\n * @returns {string|null} The cookie value, or null if not found.\r\n */\r\nexport const getCookie = (name) => {\r\n   const nameEQ = name + \"=\";\r\n   const ca = document.cookie.split(\";\");\r\n   for (let i = 0; i < ca.length; i++) {\r\n      let c = ca[i];\r\n      while (c.charAt(0) === \" \") c = c.substring(1, c.length);\r\n      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\r\n   }\r\n   return null;\r\n};\r\n\r\n/**\r\n * Erases a cookie by name and path.\r\n * @param {string} name - The name of the cookie to erase.\r\n * @param {string} [path=\"/\"] - The path where the cookie is valid.\r\n */\r\nexport const eraseCookie = (name, path = \"/\") => {\r\n   document.cookie = name + \"=; Max-Age=-99999999; path=\" + path;\r\n};", "import { state, setState, getFullState } from './state.js';\r\nimport { setCookie } from './cookies.js';\r\n\r\nlet adminPopupVisible = false;\r\n\r\nexport const initializeAdminPopup = () => {\r\n    createPopupElement();\r\n    setupKeyboardShortcut();\r\n};\r\n\r\nconst createPopupElement = () => {\r\n    if (!document.getElementById('admin-popup')) {\r\n        const popup = document.createElement('div');\r\n        popup.id = 'admin-popup';\r\n        // Fixed positioning and size\r\n        popup.style.cssText = `\r\n            position: fixed;\r\n            top: 50%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            width: 320px;\r\n            background: white;\r\n            border-radius: 8px;\r\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\r\n            z-index: 9999;\r\n            display: none;\r\n        `;\r\n\r\n        popup.innerHTML = `\r\n            <div style=\"padding: 12px 16px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: white; border-top-left-radius: 8px; border-top-right-radius: 8px;\">\r\n                <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n                    <h2 style=\"font-size: 16px; font-weight: 600; color: #1f2937;\">State Manager</h2>\r\n                    <span style=\"background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 12px;\">Ctrl + Shift + A</span>\r\n                </div>\r\n                <button id=\"close-admin-popup\" style=\"padding: 4px 8px; color: #6b7280; cursor: pointer; border-radius: 4px;\">\u00D7</button>\r\n            </div>\r\n            \r\n            <div id=\"admin-state-container\" style=\"max-height: 60vh; overflow-y: auto; padding: 8px 0;\">\r\n                <!-- State controls will be inserted here -->\r\n            </div>\r\n        `;\r\n\r\n        document.body.appendChild(popup);\r\n\r\n        const overlay = document.createElement('div');\r\n        overlay.id = 'admin-popup-overlay';\r\n        overlay.style.cssText = `\r\n            position: fixed;\r\n            inset: 0;\r\n            background: rgba(0, 0, 0, 0.5);\r\n            z-index: 9998;\r\n            display: none;\r\n        `;\r\n        document.body.appendChild(overlay);\r\n\r\n        document.getElementById('close-admin-popup').addEventListener('click', toggleAdminPopup);\r\n        overlay.addEventListener('click', toggleAdminPopup);\r\n\r\n        document.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Escape' && adminPopupVisible) {\r\n                toggleAdminPopup();\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\nconst setupKeyboardShortcut = () => {\r\n    document.addEventListener('keydown', (e) => {\r\n        if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a') {\r\n            e.preventDefault();\r\n            toggleAdminPopup();\r\n        }\r\n    });\r\n};\r\n\r\nexport const toggleAdminPopup = () => {\r\n    const popup = document.getElementById('admin-popup');\r\n    const overlay = document.getElementById('admin-popup-overlay');\r\n\r\n    if (!popup || !overlay) return;\r\n\r\n    adminPopupVisible = !adminPopupVisible;\r\n\r\n    if (adminPopupVisible) {\r\n        popup.style.display = 'block';\r\n        overlay.style.display = 'block';\r\n        updateStateDisplay();\r\n    } else {\r\n        popup.style.display = 'none';\r\n        overlay.style.display = 'none';\r\n    }\r\n};\r\n\r\nconst updateStateDisplay = () => {\r\n    const container = document.getElementById('admin-state-container');\r\n    if (!container) return;\r\n\r\n    const currentState = getFullState();\r\n    container.innerHTML = '';\r\n\r\n    // Filter and sort entries\r\n    const entries = Object.entries(currentState)\r\n        .filter(([_, value]) => typeof value === 'boolean' || typeof value === 'number')\r\n        .sort(([, a], [, b]) => {\r\n            if (typeof a === typeof b) return 0;\r\n            return typeof a === 'boolean' ? -1 : 1;\r\n        });\r\n\r\n    entries.forEach(([key, value]) => {\r\n        const type = typeof value;\r\n        const row = document.createElement('div');\r\n        row.style.cssText = `\r\n            padding: 12px 16px;\r\n            border-bottom: 1px solid #e5e7eb;\r\n            display: flex;\r\n            justify-content: space-between;\r\n            align-items: center;\r\n            background: white;\r\n        `;\r\n\r\n        const formattedKey = key\r\n            .replace(/([A-Z])/g, ' $1')\r\n            .replace(/^./, str => str.toUpperCase());\r\n\r\n        if (type === 'boolean') {\r\n            row.innerHTML = `\r\n                <span style=\"font-size: 14px; color: #374151;\">${formattedKey}</span>\r\n                <label class=\"switch\" style=\"position: relative; display: inline-block; width: 44px; height: 24px;\">\r\n                    <input type=\"checkbox\" \r\n                           data-key=\"${key}\"\r\n                           data-type=\"boolean\" \r\n                           ${value ? 'checked' : ''}\r\n                           style=\"opacity: 0; width: 0; height: 0;\">\r\n                    <span style=\"position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; \r\n                                background-color: ${value ? '#2563eb' : '#e5e7eb'}; transition: .4s; border-radius: 24px;\">\r\n                        <span style=\"position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px;\r\n                                   background-color: white; transition: .4s; border-radius: 50%;\r\n                                   transform: ${value ? 'translateX(20px)' : 'translateX(0)'};\">\r\n                        </span>\r\n                    </span>\r\n                </label>\r\n            `;\r\n        } else if (type === 'number') {\r\n            row.innerHTML = `\r\n                <span style=\"font-size: 14px; color: #374151;\">${formattedKey}</span>\r\n                <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n                    <button class=\"decrement\" style=\"width: 24px; height: 24px; border: 1px solid #e5e7eb; border-radius: 4px;\">\u2212</button>\r\n                    <input type=\"number\" \r\n                           data-key=\"${key}\"\r\n                           data-type=\"number\"\r\n                           value=\"${value}\"\r\n                           step=\"0.1\"\r\n                           style=\"width: 60px; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px; padding: 2px;\">\r\n                    <button class=\"increment\" style=\"width: 24px; height: 24px; border: 1px solid #e5e7eb; border-radius: 4px;\">+</button>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        container.appendChild(row);\r\n\r\n        // Add event listeners\r\n        if (type === 'boolean') {\r\n            const input = row.querySelector(`input[data-key=\"${key}\"]`);\r\n            input.addEventListener('change', handleStateChange);\r\n        } else if (type === 'number') {\r\n            const input = row.querySelector(`input[data-key=\"${key}\"]`);\r\n            const decrement = row.querySelector('.decrement');\r\n            const increment = row.querySelector('.increment');\r\n\r\n            input.addEventListener('change', handleStateChange);\r\n            decrement.addEventListener('click', () => adjustNumberValue(input, -0.1));\r\n            increment.addEventListener('click', () => adjustNumberValue(input, 0.1));\r\n        }\r\n    });\r\n};\r\n\r\nconst handleStateChange = (event) => {\r\n    const key = event.target.dataset.key;\r\n    const type = event.target.dataset.type;\r\n    let value;\r\n\r\n    if (type === 'boolean') {\r\n        value = event.target.checked;\r\n\r\n        // Update toggle appearance immediately\r\n        const toggleSpan = event.target.nextElementSibling;\r\n        toggleSpan.style.backgroundColor = value ? '#2563eb' : '#e5e7eb';\r\n        toggleSpan.querySelector('span').style.transform = value ? 'translateX(20px)' : 'translateX(0)';\r\n    } else if (type === 'number') {\r\n        value = parseFloat(event.target.value) || 0;\r\n    }\r\n\r\n    // Update state and cookie\r\n    setState(key, value);\r\n    setCookie(key, value.toString(), 7);\r\n\r\n    // Visual feedback\r\n    const row = event.target.closest('div');\r\n    const originalBackground = row.style.background;\r\n    row.style.background = '#eff6ff';\r\n    setTimeout(() => {\r\n        row.style.background = originalBackground;\r\n    }, 300);\r\n};\r\n\r\nconst adjustNumberValue = (input, delta) => {\r\n    const currentValue = parseFloat(input.value) || 0;\r\n    const newValue = Math.round((currentValue + delta) * 10) / 10;\r\n    input.value = newValue;\r\n    input.dispatchEvent(new Event('change'));\r\n};\r\n\r\n", "/**\r\n * @module error_utils\r\n * @description\r\n * Utilities for error handling, displaying error toasts, and safely showing main content.\r\n */\r\n\r\n/**\r\n * Handles initialization errors gracefully.\r\n * @param {Error} error - The error that occurred during initialization.\r\n */\r\nexport const handleInitializationError = (error) => {\r\n    console.error('Application initialization failed:', error?.message || 'Unknown error');\r\n\r\n    // Show main content even if initialization fails\r\n    showMainContent();\r\n\r\n    // Show specific error message based on error type\r\n    let errorMessage = 'Error initializing application. Some features may be unavailable.';\r\n\r\n    if (error instanceof ReferenceError) {\r\n        errorMessage = 'Application configuration error. Please refresh the page.';\r\n    } else if (error instanceof TypeError) {\r\n        errorMessage = 'Interface elements not found. Please check your connection.';\r\n    } else if (error.message?.includes('fetch')) {\r\n        errorMessage = 'Failed to load required components. Please check your connection.';\r\n    }\r\n\r\n    showErrorToast(errorMessage);\r\n};\r\n\r\n/**\r\n * Displays an error message in a toast notification.\r\n * @param {string} message - Error message to display.\r\n */\r\nexport const showErrorToast = (message) => {\r\n    try {\r\n        const toast = document.getElementById(\"toast\");\r\n        if (!toast) {\r\n            // Create toast element if it doesn't exist\r\n            createToastElement(message);\r\n            return;\r\n        }\r\n\r\n        updateToast(toast, message);\r\n    } catch (error) {\r\n        // Fallback error display\r\n        console.error('Failed to show error toast:', error);\r\n        alert(message);\r\n    }\r\n};\r\n\r\n/**\r\n * Creates a toast element if it doesn't exist and displays a message.\r\n * @private\r\n * @param {string} message - Message to display.\r\n */\r\nconst createToastElement = (message) => {\r\n    const toast = document.createElement('div');\r\n    toast.id = 'toast';\r\n    toast.className = 'fixed bottom-20 right-5 px-4 py-2 rounded-md shadow-lg z-50';\r\n    document.body.appendChild(toast);\r\n    updateToast(toast, message);\r\n};\r\n\r\n/**\r\n * Updates toast content and styling.\r\n * @private\r\n * @param {HTMLElement} toast - Toast element.\r\n * @param {string} message - Message to display.\r\n */\r\nconst updateToast = (toast, message) => {\r\n    toast.textContent = message;\r\n    toast.classList.remove(\"hidden\");\r\n    toast.classList.add(\"bg-red-200\", \"text-red-700\");\r\n\r\n    setTimeout(() => {\r\n        toast.classList.add(\"hidden\");\r\n    }, 5000);\r\n};\r\n\r\n/**\r\n * Shows the main content by removing hiding classes and making containers visible.\r\n */\r\nexport const showMainContent = () => {\r\n    try {\r\n        // Remove hidden class from body immediately\r\n        document.body.classList.remove('hidden');\r\n\r\n        // Show main content\r\n        const mainContent = document.querySelector('.container');\r\n        if (mainContent) {\r\n            mainContent.classList.remove('opacity-0', 'invisible', 'hidden');\r\n            mainContent.classList.add('opacity-100', 'visible');\r\n        }\r\n\r\n        // Also ensure any potential container is visible\r\n        const container = document.getElementById('content');\r\n        if (container) {\r\n            container.classList.remove('hidden', 'opacity-0', 'invisible');\r\n            container.classList.add('visible', 'opacity-100');\r\n        }\r\n\r\n        // Remove any other hiding classes that might be present\r\n        document.querySelectorAll('.initial-hidden').forEach(el => {\r\n            el.classList.remove('initial-hidden', 'hidden');\r\n        });\r\n\r\n    } catch (error) {\r\n        console.error('Error showing main content:', error);\r\n        // Fallback: Brute force show everything\r\n        document.body.style.display = 'block';\r\n        document.body.style.opacity = '1';\r\n        document.body.style.visibility = 'visible';\r\n    }\r\n};\r\n\r\n// Force show content after a timeout as a fallback\r\nconst SHOW_CONTENT_TIMEOUT = 2000; // 2 seconds\r\nsetTimeout(() => {\r\n    const content = document.getElementById('content');\r\n    if (document.body.classList.contains('hidden') || (content && content.classList.contains('opacity-0'))) {\r\n        console.warn('Forcing content display after timeout');\r\n        showMainContent();\r\n    }\r\n}, SHOW_CONTENT_TIMEOUT);\r\n\r\n/**\r\n * Safely finds an element by ID and executes a callback if it exists.\r\n * @param {string} elementId - ID of the element to find.\r\n * @param {Function} callback - Function to execute if element exists.\r\n * @returns {boolean} - Whether the operation was successful.\r\n */\r\nexport const safeElementCall = (elementId, callback) => {\r\n    try {\r\n        const element = document.getElementById(elementId);\r\n        if (!element) {\r\n            console.warn(`Element with id '${elementId}' not found`);\r\n            return false;\r\n        }\r\n        if (typeof callback !== 'function') {\r\n            console.warn('Invalid callback provided');\r\n            return false;\r\n        }\r\n\r\n        callback(element);\r\n        return true;\r\n    } catch (error) {\r\n        console.error(`Error in safeElementCall for '${elementId}':`, error);\r\n        return false;\r\n    }\r\n};", "/**\r\n * @module video\r\n * @description\r\n * Utilities for managing sign language video playback, including loading, starting, stopping, and UI container management.\r\n */\r\nimport { state, setState } from './state.js';\r\n\r\n/**\r\n * Stops the sign language video, hides the container, and updates state.\r\n */\r\nexport const stopSLVideo = () => {\r\n    const videoContainer = document.getElementById('sign-language-video');\r\n    const video = state.videoElement;\r\n    if (video) {\r\n        video.pause();\r\n        video.currentTime = 0;\r\n    }\r\n    videoContainer.classList.add('hidden');\r\n    setState('videoPlaying', false);\r\n};\r\n\r\n/**\r\n * Starts the sign language video for the current page.\r\n * Removes any existing video, loads the new video, and attempts playback.\r\n * Handles errors and updates state/UI accordingly.\r\n */\r\nexport const startSLVideo = () => {\r\n    const videoContainer = document.getElementById('sign-language-video');\r\n\r\n    // Remove the existing video element if it exists\r\n    const existingVideo = videoContainer.querySelector('video');\r\n    if (existingVideo) {\r\n        existingVideo.remove();\r\n    }\r\n\r\n    if (!state.videoSource) {\r\n        return;\r\n    }\r\n    const currentLanguage = state.currentLanguage || 'es';\r\n    const videoUrl = `content/i18n/${currentLanguage}/video/${state.videoSource}`;\r\n    // const videoUrl = state.videoSource;\r\n    // Use loadSLVideoWithPromise to load the video\r\n    loadSLVideoWithPromise(videoUrl)\r\n        .then((video) => {\r\n            // Append the new video element to the container\r\n            videoContainer.appendChild(video);\r\n\r\n            // Attempt to play the video\r\n            video.play()\r\n                .then(() => {\r\n                    // Video is playing successfully\r\n                    videoContainer.classList.remove('hidden');\r\n                    setState('videoPlaying', true);\r\n                })\r\n                .catch((error) => {\r\n                    // Handle play() error\r\n                    console.warn('Video playback failed:', error);\r\n                });\r\n        })\r\n        .catch((error) => {\r\n            console.error('Failed to start the video:', error);\r\n        });\r\n};\r\n\r\n/**\r\n * Loads a sign language video and returns a promise that resolves with the video element when loaded.\r\n * Falls back to a default video if the source fails to load.\r\n * @param {string} src - The source URL of the video.\r\n * @returns {Promise<HTMLVideoElement>} Resolves with the video element when loaded.\r\n */\r\nexport const loadSLVideoWithPromise = (src) => {\r\n    return new Promise((resolve, reject) => {\r\n        // Create a new video element\r\n        const video = document.createElement('video');\r\n        video.src = src;\r\n        video.controls = true;\r\n        video.autoplay = true;\r\n\r\n        // Add the specified classes\r\n        video.classList.add('w-full', 'h-full', 'object-cover');\r\n\r\n        // Update the state with the new video element\r\n        setState('videoElement', video);\r\n\r\n        // Handle video events\r\n        video.onloadeddata = () => {\r\n            resolve(video); // Resolve the promise with the video element when loaded\r\n        };\r\n\r\n        video.onerror = () => {\r\n            console.warn(`Error loading video: ${src}. Falling back to default video.`);\r\n            video.src = \"content/i18n/es/video/10_0.mp4\"; // Set the default video source\r\n            video.load(); // Reload the video with the new source\r\n\r\n            // Handle the fallback video loading\r\n            video.onloadeddata = () => {\r\n                resolve(video); // Resolve the promise with the fallback video\r\n            };\r\n\r\n            video.onerror = (error) => {\r\n                console.error('Error loading fallback video:', error);\r\n                reject(error); // Reject the promise if the fallback video also fails\r\n            };\r\n        };\r\n    });\r\n};\r\n\r\n/**\r\n * Loads the current sign language video source for the current page from state.\r\n * Updates state.videoSource based on the current page.\r\n */\r\nexport const loadCurrentSLVideo = () => {\r\n    const videoFiles = state.videoFiles;\r\n    const currentPage = state.currentPage.replace(/_/g, '-');\r\n    state.videoSource = videoFiles[\"video-\" + currentPage];\r\n}\r\n\r\n/**\r\n * Creates or removes the bottom container for sign language video.\r\n * Moves the video container into the bottom container when shown, and restores it when hidden.\r\n * Adjusts body padding to prevent content from being hidden.\r\n * @param {boolean} show - Whether to show (true) or hide (false) the bottom container.\r\n */\r\nexport const toggleBottomContainer = (show) => {\r\n    const existingContainer = document.getElementById('sign-language-bottom-container');\r\n    const videoContainer = document.getElementById('sign-language-video');\r\n\r\n    if (show) {\r\n        // Create the container if it doesn't exist\r\n        if (!existingContainer) {\r\n            const container = document.createElement('div');\r\n            container.id = 'sign-language-bottom-container';\r\n            // Use Tailwind classes for styling\r\n            container.className = [\r\n                'fixed',\r\n                'bottom-0',\r\n                'left-0',\r\n                'z-40',\r\n                'w-full',\r\n                'flex',\r\n                'justify-center',\r\n                'items-center',\r\n                'h-72', // or 'h-[300px]' if your Tailwind config allows arbitrary values\r\n            ].join(' ');\r\n\r\n            // Move the existing video container into this one if needed\r\n            if (videoContainer) {\r\n                container.appendChild(videoContainer);\r\n                // Ensure the video container is visible\r\n                videoContainer.classList.remove('hidden');\r\n            } else {\r\n                const newVideoContainer = document.createElement('div');\r\n                newVideoContainer.id = 'sign-language-video';\r\n                newVideoContainer.className = 'w-full h-full';\r\n                container.appendChild(newVideoContainer);\r\n            }\r\n\r\n            document.body.appendChild(container);\r\n\r\n            // Add Tailwind padding class to body\r\n            document.body.classList.add('pb-72');\r\n        } else if (videoContainer) {\r\n            // Ensure the video container is visible if already in the container\r\n            videoContainer.classList.remove('hidden');\r\n        }\r\n    } else {\r\n        // Remove the container if it exists\r\n        if (existingContainer) {\r\n            // Move the video container back to its original location if needed\r\n            if (videoContainer) {\r\n                document.body.appendChild(videoContainer);\r\n                // Hide the video container\r\n                videoContainer.classList.add('hidden');\r\n            }\r\n            existingContainer.remove();\r\n            document.body.classList.remove('pb-72');\r\n        }\r\n    }\r\n};", "/**\r\n * @module translations\r\n * @description\r\n * Handles loading, applying, and managing translations for the UI, including language switching, placeholders, ELI5, and glossary integration.\r\n */\r\nimport { state, setState } from './state.js';\r\nimport { unhighlightAllElements } from './ui_utils.js';\r\nimport { gatherAudioElements } from './audio.js';\r\nimport { showErrorToast } from './error_utils.js';\r\nimport { highlightGlossaryTerms, removeGlossaryHighlights, loadGlossaryTerms } from './interface.js';\r\nimport { loadCurrentSLVideo } from './video.js';\r\nimport { announceToScreenReader } from './ui_utils.js';\r\n\r\n/**\r\n * Set up translations and audio files for the application.\r\n * Ensures a language is set, fetches translations, and shows main content.\r\n * @returns {Promise<boolean>} Resolves true if successful, false otherwise.\r\n */\r\nexport const setupTranslations = async () => {\r\n    try {\r\n        if (!state.currentLanguage) {\r\n            console.warn('No language set, using default');\r\n            setState('currentLanguage', 'en');\r\n        }\r\n\r\n        await fetchTranslations();\r\n        //gatherAudioElements();\r\n        return true;\r\n    } catch (error) {\r\n        console.error('Error setting up translations:', error);\r\n        showErrorToast('Error loading translations. Using defaults.');\r\n        return false;\r\n    } finally {\r\n        // Always ensure content is shown\r\n        showMainContent();\r\n    }\r\n};\r\n\r\n/**\r\n * Safe JSON parsing with error handling.\r\n * @param {Response} response - The fetch response object.\r\n * @param {string} errorContext - Context for error reporting.\r\n * @returns {Promise<Object>} Parsed JSON object.\r\n * @throws {Error} If parsing fails.\r\n * @private\r\n */\r\nconst safeJsonParse = async (response, errorContext) => {\r\n    try {\r\n        const text = await response.text();\r\n        return JSON.parse(text);\r\n    } catch (error) {\r\n        console.error(`JSON parse error in ${errorContext}:`, error);\r\n        throw new Error(`Invalid JSON in ${errorContext}: ${error.message}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Fetch translations from server and apply them.\r\n * Loads interface and language-specific translations, merges them, and updates state.\r\n * Also applies translations to the DOM and updates audio/video files.\r\n * @returns {Promise<void>}\r\n */\r\nexport const fetchTranslations = async () => {\r\n    try {\r\n        const currentLang = state.currentLanguage || 'en';\r\n        // Fetch interface translations with proper error handling\r\n        const interfacePath = `./assets/interface_translations/${currentLang}/interface_translations.json`;\r\n        const interface_response = await fetch(interfacePath);\r\n        if (!interface_response.ok) {\r\n            console.warn('Interface translations not found, using defaults');\r\n            setState('translations', {});\r\n            return;\r\n        }\r\n        const interface_data = await safeJsonParse(interface_response, 'interface translations');\r\n\r\n        // Fetch content files (texts, audios, videos) from the language-specific path\r\n        await fetchContentFiles(`./content/i18n/${currentLang}`);\r\n\r\n        // Merge translations if interface data exists for current language\r\n        if (interface_data) {\r\n            setState('translations', {\r\n                ...state.translations,\r\n                ...interface_data,\r\n            });\r\n\r\n            updateLanguageDropdownFromAppConfig();\r\n        }\r\n\r\n        // Apply translations before showing content\r\n        await applyTranslations();\r\n\r\n    } catch (error) {\r\n        console.error('Error loading translations:', error);\r\n        // Set default translations if everything fails\r\n        setState('translations', {});\r\n        setState('audioFiles', {});\r\n        throw error;\r\n    } finally {\r\n        if (window.MathJax) {\r\n            window.MathJax.typeset();\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Apply translations to the DOM.\r\n * Handles easy-read mode, glossary highlights, and updates audio/video.\r\n * @returns {Promise<void>}\r\n */\r\nexport const applyTranslations = async () => {\r\n    unhighlightAllElements();\r\n\r\n    const translations = state.translations;\r\n    if (!translations) return;\r\n\r\n    for (const [key, value] of Object.entries(translations)) {\r\n        if (key.endsWith(\"_eli5\")) continue;\r\n\r\n        let translationKey = key;\r\n\r\n        if (state.easyReadMode) {\r\n            const elements = document.querySelectorAll(`[data-id=\"${key}\"]`);\r\n            const isHeader = Array.from(elements).some(element =>\r\n                element.tagName.toLowerCase().match(/^h[1-6]$/)\r\n            );\r\n\r\n            // Check if element is inside a word card, data-activity-item, nav list, or activity-text\r\n            const isExcluded = Array.from(elements).some(element => {\r\n                const wordCard = element.closest('.word-card');\r\n                const activityItem = element.closest('[data-activity-item]');\r\n                const activityText = element.closest('.activity-text');\r\n                return wordCard !== null || activityItem !== null || activityText !== null;\r\n            });\r\n\r\n            // Skip applying easy-read translation if it's a header or inside excluded areas\r\n            if (!isHeader && !isExcluded) {\r\n                const easyReadKey = `${key}_easy_read`;\r\n                if (translations.hasOwnProperty(easyReadKey)) {\r\n                    translationKey = easyReadKey;\r\n                }\r\n            }\r\n        }\r\n\r\n        applyTranslationToElements(key, translationKey);\r\n        applyTranslationToPlaceholders(key, translationKey);\r\n\r\n    }\r\n    // Adding to gather the correct audio elements\r\n    gatherAudioElements();\r\n    loadCurrentSLVideo();\r\n    handleEli5Translation();\r\n\r\n    // Re-apply glossary highlighting if it's active\r\n    // This ensures highlights are maintained when easy-read mode changes\r\n    if (state.glossaryMode && typeof highlightGlossaryTerms === 'function') {\r\n        // First remove existing highlights\r\n        if (typeof removeGlossaryHighlights === 'function') {\r\n            removeGlossaryHighlights();\r\n        }\r\n\r\n        // If we need to reload terms based on language, do that first\r\n        if (typeof loadGlossaryTerms === 'function') {\r\n            loadGlossaryTerms().then(() => {\r\n                highlightGlossaryTerms();\r\n            });\r\n        } else {\r\n            // Otherwise just reapply highlighting\r\n            highlightGlossaryTerms();\r\n        }\r\n    }\r\n\r\n    // Change the title of the page\r\n    const titleMeta = document.querySelector('meta[name=\"title-id\"]');\r\n    if (titleMeta) {\r\n        const titleId = titleMeta.getAttribute('content');\r\n        if (titleId && state.translations[titleId]) {\r\n            document.title = state.translations[titleId];\r\n        }\r\n    }\r\n\r\n    if (typeof document !== 'undefined' && typeof document.dispatchEvent === 'function') {\r\n        document.dispatchEvent(\r\n            new CustomEvent('adt-language-changed', {\r\n                detail: {\r\n                    language: state.currentLanguage\r\n                }\r\n            })\r\n        );\r\n    }\r\n};\r\n\r\n/**\r\n * Apply translation to elements with data-id attribute.\r\n * Handles text, images, and easy-read mode styling.\r\n * @param {string} key - The translation key.\r\n * @param {string} translationKey - The key to use for translation lookup.\r\n * @private\r\n */\r\nconst applyTranslationToElements = (key, translationKey) => {\r\n    const elements = document.querySelectorAll(`[data-id=\"${key}\"]`);\r\n    elements.forEach((element) => {\r\n        if (element) {\r\n            if (element.tagName === \"IMG\") {\r\n                element.setAttribute(\"alt\", state.translations[translationKey]);\r\n            } else {\r\n                // Convert newline characters to HTML line breaks\r\n                const translatedText = state.translations[translationKey].replace(/\\n/g, '<br>');\r\n\r\n                // Check if this is easy-read content\r\n                const isEasyRead = translationKey.endsWith('_easy_read');\r\n\r\n                // Don't apply easy read to nav items\r\n                if (isEasyRead && element.closest('nav')) {\r\n                    return;\r\n                }\r\n\r\n                // Set the content with proper line breaks\r\n                element.innerHTML = translatedText;\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Apply translation to placeholder attributes.\r\n * @param {string} key - The translation key.\r\n * @param {string} translationKey - The key to use for translation lookup.\r\n * @private\r\n */\r\nconst applyTranslationToPlaceholders = (key, translationKey) => {\r\n    const placeholderElements = document.querySelectorAll(\r\n        `[data-placeholder-id=\"${key}\"]`\r\n    );\r\n    placeholderElements.forEach((element) => {\r\n        if (element && (element.tagName === \"INPUT\" || element.tagName === \"TEXTAREA\")) {\r\n            element.setAttribute(\"placeholder\", state.translations[translationKey]);\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Handle ELI5 (Explain Like I'm 5) translations.\r\n * Updates the ELI5 content area if ELI5 mode is active.\r\n * @private\r\n */\r\nconst handleEli5Translation = () => {\r\n    if (state.eli5Mode) {\r\n        const mainSection = document.querySelector(\r\n            'section[data-id^=\"sectioneli5\"]'\r\n        );\r\n        if (mainSection) {\r\n            const eli5Id = mainSection.getAttribute(\"data-id\");\r\n            const eli5Text = state.translations[eli5Id];\r\n\r\n            if (eli5Text) {\r\n                const eli5Container = document.getElementById(\"eli5-content-text\");\r\n                if (eli5Container) {\r\n                    eli5Container.innerHTML = eli5Text;\r\n                }\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Update language dropdown with available languages.\r\n * Sets the visible language names in the dropdown.\r\n * @param {Object} interface_data - The interface translations object.\r\n * @private\r\n */\r\n/* const updateLanguageDropdown = (interface_data) => {\r\n    const dropdown = document.getElementById(\"language-dropdown\");\r\n    if (!dropdown) return;\r\n\r\n    const options = Array.from(dropdown.options);\r\n    options.forEach((option) => {\r\n        const languageData = interface_data[option.value];\r\n        if (languageData && languageData[\"language-name\"]) {\r\n            option.textContent = languageData[\"language-name\"];\r\n        }\r\n    });\r\n}; */\r\n\r\n/**\r\n * Update language dropdown using languages from window.appConfig.\r\n * Fetches each language's interface_translations.json to get the language name.\r\n * @returns {Promise<void>}\r\n */\r\nexport const updateLanguageDropdownFromAppConfig = async () => {\r\n    const dropdown = document.getElementById(\"language-dropdown\");\r\n    if (!dropdown || !window.appConfig || !window.appConfig.languages || !Array.isArray(window.appConfig.languages.available)) return;\r\n\r\n    // Clear existing options\r\n    dropdown.innerHTML = '';\r\n\r\n    for (const lang of window.appConfig.languages.available) {\r\n        try {\r\n            const response = await fetch(`./assets/interface_translations/${lang}/interface_translations.json`);\r\n            if (!response.ok) continue;\r\n            const interfaceData = await response.json();\r\n            // Try to get the language name from the loaded data\r\n            const languageName = interfaceData?.['language-name'] || lang;\r\n\r\n            const option = document.createElement('option');\r\n            option.value = lang;\r\n            option.textContent = languageName;\r\n            // Select the option if it matches the current language\r\n            if (lang === state.currentLanguage) {\r\n                option.selected = true;\r\n            }\r\n            dropdown.appendChild(option);\r\n        } catch (err) {\r\n            // If fetch fails, skip this language\r\n            console.warn(`Could not load interface translations for ${lang}`);\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Show main content of the application.\r\n * Removes hiding classes and applies transition for visibility.\r\n * @private\r\n */\r\nconst showMainContent = () => {\r\n    const mainContent = document.querySelector('body > .container');\r\n    if (mainContent) {\r\n        mainContent.classList.remove('opacity-0', 'invisible');\r\n        mainContent.classList.add('opacity-100', 'visible', 'transition-opacity', 'duration-300', 'ease-in-out');\r\n    }\r\n};\r\n\r\n/**\r\n * Translate a specific text key with optional variables.\r\n * @param {string} textToTranslate - The translation key.\r\n * @param {Object} [variables={}] - Variables to interpolate in the translation.\r\n * @returns {string} The translated string with variables replaced, or the key if not found.\r\n */\r\nexport const translateText = (textToTranslate, variables = {}) => {\r\n    if (!state.translations || !state.translations[textToTranslate]) {\r\n        return textToTranslate;\r\n    }\r\n\r\n    return state.translations[textToTranslate].replace(/\\${(.*?)}/g, (match, p1) =>\r\n        variables[p1] ?? \"\"\r\n    );\r\n};\r\n\r\nexport const cycleLanguage = () => {\r\n    // Get available languages from the dropdown\r\n    const languageDropdown = document.getElementById('language-dropdown');\r\n    if (!languageDropdown) {\r\n        console.error(\"Language dropdown not found\");\r\n        return;\r\n    }\r\n\r\n    // Get the current language and all available options\r\n    const currentLanguage = languageDropdown.value;\r\n    const options = Array.from(languageDropdown.options);\r\n    const currentIndex = options.findIndex(option => option.value === currentLanguage);\r\n\r\n    // Find the next language\r\n    const nextIndex = (currentIndex + 1) % options.length;\r\n    const nextLanguage = options[nextIndex].value;\r\n\r\n    // Update the dropdown value\r\n    languageDropdown.value = nextLanguage;\r\n\r\n    // Trigger the change event to activate language switch\r\n    const changeEvent = new Event('change');\r\n    languageDropdown.dispatchEvent(changeEvent);\r\n\r\n    // Announce language change to screen readers\r\n    // Get the language name for announcement\r\n    const langName = options[nextIndex].text;\r\n    announceToScreenReader(\r\n        translateText(\"language-changed-to\", { language: langName })\r\n    );\r\n};\r\n\r\n/**\r\n * Fetch and load texts, audios, and videos JSON files from a given path.\r\n * Updates the respective state properties: translations, audioFiles, and videoFiles.\r\n * @param {string} basePath - The base path where the JSON files are located\r\n * @returns {Promise<void>}\r\n */\r\nexport const fetchContentFiles = async (basePath) => {\r\n    try {\r\n        // Get cache-busting version from config\r\n        const version = window.appConfig?.bundleVersion || '';\r\n        const versionParam = version ? `?v=${version}` : '';\r\n        \r\n        // Fetch all three files in parallel\r\n        const [textsResponse, audiosResponse, videosResponse] = await Promise.allSettled([\r\n            fetch(`${basePath}/texts.json${versionParam}`),\r\n            fetch(`${basePath}/audios.json${versionParam}`),\r\n            fetch(`${basePath}/videos.json${versionParam}`)\r\n        ]);\r\n\r\n        // Process texts.json\r\n        if (textsResponse.status === 'fulfilled' && textsResponse.value.ok) {\r\n            const textsData = await safeJsonParse(textsResponse.value, 'texts.json');\r\n            setState('translations', { ...state.translations, ...textsData });\r\n        } else {\r\n            console.warn(`Could not load texts.json from ${basePath}`);\r\n        }\r\n\r\n        // Process audios.json\r\n        if (audiosResponse.status === 'fulfilled' && audiosResponse.value.ok) {\r\n            const audiosData = await safeJsonParse(audiosResponse.value, 'audios.json');\r\n            setState('audioFiles', { ...state.audioFiles, ...audiosData });\r\n        } else {\r\n            console.warn(`Could not load audios.json from ${basePath}`);\r\n        }\r\n\r\n        // Process videos.json\r\n        if (videosResponse.status === 'fulfilled' && videosResponse.value.ok) {\r\n            const videosData = await safeJsonParse(videosResponse.value, 'videos.json');\r\n            setState('videoFiles', { ...state.videoFiles, ...videosData });\r\n        } else {\r\n            console.warn(`Could not load videos.json from ${basePath}`);\r\n        }\r\n\r\n    } catch (error) {\r\n        console.error('Error fetching content files:', error);\r\n    }\r\n};", "/**\r\n * Matomo Analytics module for ADT educational platform\r\n * Handles initialization and tracking of user interactions\r\n */\r\n\r\n// Configuration object for Matomo\r\nconst matomoConfig = {\r\n  siteId: 1, // Replace with your actual site ID\r\n  trackerUrl: \"https://unisitetracker.unicef.io/matomo.php\", // Replace with your Matomo URL\r\n  srcUrl: \"https://unisitetracker.unicef.io/matomo.js\", // Replace with your Matomo JS URL\r\n};\r\n\r\n/**\r\n * Initialize Matomo Analytics\r\n * @param {Object} config - Optional configuration to override defaults\r\n */\r\nexport const initMatomo = (config = {}) => {\r\n  // Merge default config with provided options\r\n  const finalConfig = { ...matomoConfig, ...config };\r\n\r\n  // Add Matomo tracking code\r\n  window._paq = window._paq || [];\r\n\r\n  // Track this page view\r\n  window._paq.push(['trackPageView']);\r\n\r\n  // Enable link tracking\r\n  window._paq.push(['enableLinkTracking']);\r\n\r\n  // Set up the tracker\r\n  window._paq.push(['setTrackerUrl', finalConfig.trackerUrl]);\r\n  window._paq.push(['setSiteId', finalConfig.siteId]);\r\n\r\n  // Add the script to the page\r\n  const script = document.createElement('script');\r\n  script.type = 'text/javascript';\r\n  script.async = true;\r\n  script.defer = true;\r\n  script.src = finalConfig.srcUrl;\r\n\r\n  // Insert script at the end of the head element\r\n  document.head.appendChild(script);\r\n};\r\n\r\n/**\r\n * Track a custom event\r\n * @param {string} category - Event category\r\n * @param {string} action - Event action\r\n * @param {string} name - Event name (optional)\r\n * @param {number} value - Event value (optional)\r\n */\r\nexport const trackEvent = (category, action, name = null, value = null) => {\r\n  if (window._paq) {\r\n    window._paq.push(['trackEvent', category, action, name, value]);\r\n  } else {\r\n    console.warn('Matomo not initialized. Unable to track event.');\r\n  }\r\n};\r\n\r\n/**\r\n * Track activity completions\r\n * @param {string} activityId - ID of the completed activity\r\n * @param {string} activityType - Type of activity completed\r\n * @param {number} score - Score achieved (if applicable)\r\n */\r\nexport const trackActivityCompletion = (activityId, activityType, score = null) => {\r\n  trackEvent(\r\n    'Activity',\r\n    'Completion',\r\n    `${activityType}: ${activityId}`,\r\n    score\r\n  );\r\n};\r\n\r\n/**\r\n * Track navigation between pages\r\n * @param {string} fromPage - Origin page ID\r\n * @param {string} toPage - Destination page ID\r\n */\r\nexport const trackNavigation = (fromPage, toPage) => {\r\n  trackEvent(\r\n    'Navigation',\r\n    'PageChange',\r\n    `${fromPage} \u2192 ${toPage}`\r\n  );\r\n};\r\n\r\n/**\r\n * Track time spent on activities\r\n * @param {string} activityId - ID of the activity\r\n * @param {number} seconds - Seconds spent on activity\r\n */\r\nexport const trackTimeSpent = (activityId, seconds) => {\r\n  trackEvent(\r\n    'Activity',\r\n    'TimeSpent',\r\n    activityId,\r\n    Math.round(seconds)\r\n  );\r\n};\r\n\r\n/**\r\n * Track form submissions\r\n * @param {string} formId - ID of the form\r\n * @param {boolean} isComplete - Whether all fields were filled\r\n */\r\nexport const trackFormSubmission = (formId, isComplete) => {\r\n  trackEvent(\r\n    'Form',\r\n    'Submission',\r\n    formId,\r\n    isComplete ? 1 : 0\r\n  );\r\n};\r\n\r\n/**\r\n * Track toggle events\r\n * @param {string} toggleName - Name of the toggle (e.g., \"EasyReadMode\", \"ReadAloud\", etc.)\r\n * @param {boolean} isActive - Whether the toggle is activated (true) or deactivated (false)\r\n */\r\nexport const trackToggleEvent = (toggleName, isActive) => {\r\n  const action = isActive ? 'Activated' : 'Deactivated';\r\n  trackEvent('Toggle', action, toggleName);\r\n};", "/**\r\n * @module navigation\r\n * @description\r\n * Handles navigation events, state saving/restoring, keyboard shortcuts, and navigation UI logic.\r\n */\r\nimport { setCookie, getCookie } from \"./cookies.js\";\r\nimport { cacheInterfaceElements, toggleSidebar, setNavVisibility, formatNavigationItems } from \"./interface.js\";\r\nimport { trackNavigation } from \"./analytics.js\";\r\nimport { cycleLanguage } from \"./translations.js\";\r\n\r\nconst PAGE_LIST_SELECTOR = '.nav__list[data-nav-type=\"pages\"]';\r\nconst TOC_LIST_SELECTOR = '.nav__list[data-nav-type=\"toc\"]';\r\nconst NAV_TAB_COOKIE = \"navActiveTab\";\r\nconst NAV_TABS = [\"toc\", \"pages\"];\r\nconst DEFAULT_NAV_TAB = \"toc\";\r\n\r\nlet navigationData = { pages: [], toc: [] };\r\nconst getInitialNavTab = () => {\r\n  const savedTab = getCookie(NAV_TAB_COOKIE);\r\n  return NAV_TABS.includes(savedTab) ? savedTab : DEFAULT_NAV_TAB;\r\n};\r\n\r\nlet activeNavTab = getInitialNavTab();\r\n\r\nconst getPageListElement = () => document.querySelector(PAGE_LIST_SELECTOR);\r\n\r\nconst getNavLinks = () => document.querySelectorAll(`${PAGE_LIST_SELECTOR} .nav__list-link`);\r\n\r\nconst NAV_BUTTON_DISABLED_CLASSES = [\r\n  \"text-gray-300\",\r\n  \"opacity-40\",\r\n  \"cursor-not-allowed\",\r\n  \"pointer-events-none\",\r\n];\r\n\r\nconst applyNavButtonState = (button, isDisabled) => {\r\n  if (!button) return;\r\n\r\n  if (isDisabled) {\r\n    button.disabled = true;\r\n    button.setAttribute(\"aria-disabled\", \"true\");\r\n    button.tabIndex = -1;\r\n    NAV_BUTTON_DISABLED_CLASSES.forEach((cls) => button.classList.add(cls));\r\n  } else {\r\n    button.disabled = false;\r\n    button.removeAttribute(\"aria-disabled\");\r\n    button.tabIndex = 0;\r\n    NAV_BUTTON_DISABLED_CLASSES.forEach((cls) => button.classList.remove(cls));\r\n  }\r\n};\r\n\r\nexport const updateNavigationButtonStates = () => {\r\n  const navContainer = document.getElementById(\"back-forward-buttons\");\r\n  if (!navContainer || navContainer.classList.contains(\"hidden\")) {\r\n    return;\r\n  }\r\n\r\n  const backButton = document.getElementById(\"back-button\");\r\n  const forwardButton = document.getElementById(\"forward-button\");\r\n  if (!backButton && !forwardButton) {\r\n    return;\r\n  }\r\n\r\n  const navItems = Array.from(getNavLinks());\r\n  if (!navItems.length) {\r\n    applyNavButtonState(backButton, false);\r\n    applyNavButtonState(forwardButton, false);\r\n    return;\r\n  }\r\n\r\n  const currentHref = window.location.pathname.split(\"/\").pop() || \"index.html\";\r\n  const currentIndex = navItems.findIndex(\r\n    (item) => item.getAttribute(\"href\") === currentHref\r\n  );\r\n\r\n  if (currentIndex === -1) {\r\n    applyNavButtonState(backButton, false);\r\n    applyNavButtonState(forwardButton, false);\r\n    return;\r\n  }\r\n\r\n  applyNavButtonState(backButton, currentIndex === 0);\r\n  applyNavButtonState(forwardButton, currentIndex === navItems.length - 1);\r\n};\r\n\r\nconst enhancePageList = (pages) => {\r\n  if (!Array.isArray(pages)) {\r\n    return [];\r\n  }\r\n\r\n  return pages.map((page, index) => {\r\n    const pdfPageNumber = page?.page_number ?? null;\r\n    const sequentialIndex = index + 1;\r\n    const displayLabel = sequentialIndex === 1 ? `${sequentialIndex} (Cover)` : String(sequentialIndex);\r\n\r\n    return {\r\n      ...page,\r\n      page_label: String(sequentialIndex),\r\n      sequential_index: sequentialIndex,\r\n      pdf_page_number: pdfPageNumber,\r\n      display_label: displayLabel,\r\n    };\r\n  });\r\n};\r\n\r\nconst renderNavigationLists = () => {\r\n  buildTableOfContents();\r\n  buildPageList();\r\n  activateNavTab(activeNavTab);\r\n};\r\n\r\nconst buildTableOfContents = () => {\r\n  const tocList = document.querySelector(TOC_LIST_SELECTOR);\r\n  if (!tocList) return;\r\n\r\n  tocList.innerHTML = \"\";\r\n  navigationData.toc.forEach((chapter, index) => {\r\n    const item = document.createElement(\"li\");\r\n    item.classList.add(\"nav__list-item\", \"border-b\", \"border-gray-300\", \"flex\", \"items-center\");\r\n\r\n    const link = document.createElement(\"a\");\r\n    link.classList.add(\r\n      \"nav__toc-link\",\r\n      \"flex-grow\",\r\n      \"flex\",\r\n      \"items-center\",\r\n      \"w-full\",\r\n      \"h-full\",\r\n      \"p-2\",\r\n      \"py-3\",\r\n      \"hover:bg-blue-50\",\r\n      \"transition\",\r\n      \"text-gray-700\"\r\n    );\r\n\r\n    link.href = chapter.href;\r\n    if (chapter.chapter_id) {\r\n      link.setAttribute(\"data-text-id\", chapter.chapter_id);\r\n    }\r\n\r\n    const baseTitle = chapter.title || chapter.chapter_id || chapter.href;\r\n    const displayIndex = `${index + 1}.`;\r\n\r\n    const indexSpan = document.createElement(\"span\");\r\n    indexSpan.classList.add(\"text-gray-500\", \"font-semibold\", \"mr-3\", \"tabular-nums\");\r\n    indexSpan.textContent = displayIndex;\r\n\r\n    const titleSpan = document.createElement(\"span\");\r\n    if (chapter.chapter_id) {\r\n      titleSpan.setAttribute(\"data-id\", chapter.chapter_id);\r\n    }\r\n    titleSpan.classList.add(\"inline\", \"text-gray-800\");\r\n    titleSpan.textContent = baseTitle;\r\n    link.setAttribute(\"aria-label\", `${displayIndex} ${baseTitle}`);\r\n\r\n    link.appendChild(indexSpan);\r\n    link.appendChild(titleSpan);\r\n    item.appendChild(link);\r\n    tocList.appendChild(item);\r\n  });\r\n};\r\n\r\nconst buildPageList = () => {\r\n  const pageList = getPageListElement();\r\n  if (!pageList) return;\r\n\r\n  pageList.innerHTML = \"\";\r\n  if (!navigationData.pages?.length) {\r\n    return;\r\n  }\r\n\r\n  const chapterLookup = navigationData.toc.reduce((acc, chapter, index) => {\r\n    if (!chapter?.section_id) {\r\n      return acc;\r\n    }\r\n    acc[chapter.section_id] = {\r\n      ...chapter,\r\n      displayTitle: chapter.title || chapter.chapter_id || chapter.href,\r\n      index: index + 1,\r\n    };\r\n    return acc;\r\n  }, {});\r\n\r\n  const renderedChapters = new Set();\r\n\r\n  navigationData.pages.forEach((page) => {\r\n    const chapterInfo = chapterLookup[page.section_id];\r\n    if (chapterInfo && !renderedChapters.has(chapterInfo.section_id)) {\r\n      const headingItem = document.createElement(\"li\");\r\n      headingItem.classList.add(\r\n        \"nav__list-heading\",\r\n        \"px-2\",\r\n        \"pt-4\",\r\n        \"pb-2\",\r\n        \"text-xs\",\r\n        \"font-semibold\",\r\n        \"tracking-wide\",\r\n        \"text-gray-500\",\r\n        \"uppercase\"\r\n      );\r\n      headingItem.dataset.chapterId = chapterInfo.chapter_id || \"\";\r\n      const headingLabel = chapterInfo.index ? `${chapterInfo.index}. ${chapterInfo.displayTitle}` : chapterInfo.displayTitle;\r\n      headingItem.textContent = headingLabel;\r\n      pageList.appendChild(headingItem);\r\n      renderedChapters.add(chapterInfo.section_id);\r\n    }\r\n    const sequentialLabel = page.page_label || String(page.sequential_index || 1);\r\n    const displayLabel = page.display_label || sequentialLabel;\r\n    const pdfLabel =\r\n      page.pdf_page_number !== undefined && page.pdf_page_number !== null\r\n        ? String(page.pdf_page_number)\r\n        : \"\";\r\n\r\n    const item = document.createElement(\"li\");\r\n    item.classList.add(\"nav__list-item\");\r\n    item.dataset.sectionId = page.section_id;\r\n\r\n    const link = document.createElement(\"a\");\r\n    link.classList.add(\"nav__list-link\");\r\n    link.href = page.href;\r\n    link.dataset.pageNumber = sequentialLabel;\r\n    link.dataset.sectionIndex = (page.sequential_index || sequentialLabel).toString();\r\n    link.dataset.pageLabel = sequentialLabel;\r\n    link.dataset.pageDisplayLabel = displayLabel;\r\n    link.dataset.sectionId = page.section_id;\r\n    if (pdfLabel) {\r\n      link.dataset.pdfPage = pdfLabel;\r\n      link.setAttribute(\"aria-label\", `Page ${sequentialLabel}, Print page ${pdfLabel}`);\r\n    } else {\r\n      delete link.dataset.pdfPage;\r\n      link.setAttribute(\"aria-label\", `Page ${sequentialLabel}`);\r\n    }\r\n    link.textContent = displayLabel;\r\n\r\n    item.appendChild(link);\r\n    pageList.appendChild(item);\r\n  });\r\n\r\n  formatNavigationItems();\r\n};\r\n\r\nconst activateNavTab = (tab) => {\r\n  if (!tab) return;\r\n\r\n  const previousTab = activeNavTab;\r\n  if (previousTab) {\r\n    const previousPanel = document.querySelector(`[data-nav-panel=\"${previousTab}\"]`);\r\n    const previousList = previousPanel?.querySelector('.nav__list');\r\n    if (previousList) {\r\n      setCookie(`navScrollPosition-${previousTab}`, previousList.scrollTop, 7);\r\n    }\r\n  }\r\n\r\n  activeNavTab = tab;\r\n  setCookie(NAV_TAB_COOKIE, activeNavTab, 7);\r\n\r\n  const tabButtons = document.querySelectorAll('[data-nav-tab]');\r\n  const tabPanels = document.querySelectorAll('[data-nav-panel]');\r\n\r\n  tabButtons.forEach((button) => {\r\n    const isActive = button.dataset.navTab === tab;\r\n    button.setAttribute('aria-selected', isActive ? 'true' : 'false');\r\n    button.classList.toggle('bg-white', isActive);\r\n    button.classList.toggle('text-gray-900', isActive);\r\n    button.classList.toggle('shadow', isActive);\r\n    button.classList.toggle('text-gray-500', !isActive);\r\n  });\r\n\r\n  tabPanels.forEach((panel) => {\r\n    const isActive = panel.dataset.navPanel === tab;\r\n    panel.classList.toggle('hidden', !isActive);\r\n    panel.setAttribute('aria-hidden', (!isActive).toString());\r\n    if (isActive) {\r\n      const currentList = panel.querySelector('.nav__list');\r\n      if (currentList) {\r\n        const savedPosition = getCookie(`navScrollPosition-${tab}`);\r\n        if (savedPosition) {\r\n          currentList.scrollTop = parseInt(savedPosition, 10);\r\n        }\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nexport const initializeNavTabs = () => {\r\n  const tabButtons = document.querySelectorAll('[data-nav-tab]');\r\n  if (!tabButtons.length) return;\r\n\r\n  tabButtons.forEach((button) => {\r\n    button.addEventListener('click', () => activateNavTab(button.dataset.navTab));\r\n  });\r\n\r\n  activateNavTab(activeNavTab);\r\n};\r\n\r\nexport const setNavigationData = ({ pages = [], toc = [] }) => {\r\n  const normalizedPages = Array.isArray(pages) ? pages : [];\r\n  navigationData = {\r\n    pages: enhancePageList(normalizedPages),\r\n    toc: Array.isArray(toc) ? toc : [],\r\n  };\r\n  renderNavigationLists();\r\n  updateNavigationButtonStates();\r\n};\r\n\r\nexport const getNavigationData = () => navigationData;\r\n\r\n/**\r\n * Handles navigation link/button clicks, saves state, and transitions to the target page.\r\n * @param {Event} event - The navigation event.\r\n */\r\nexport const handleNavigation = (event) => {\r\n  const navLink = event.target.closest(\".nav__list-link, .nav__toc-link\");\r\n  const isNavButton =\r\n    navLink || event.target.id === \"back-button\" || event.target.id === \"forward-button\";\r\n\r\n  if (isNavButton) {\r\n    event.preventDefault();\r\n    const trigger = navLink || event.target;\r\n    const targetHref = trigger.href || trigger.getAttribute(\"data-href\");\r\n\r\n    if (!targetHref) {\r\n      console.error(\r\n        \"Navigation target URL is null or undefined for element:\",\r\n        trigger\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Cache current interface state\r\n    cacheInterfaceElements();\r\n\r\n    // Save current page state\r\n    savePageState();\r\n\r\n    const mainContent = document.querySelector('body > .container');\r\n    if (mainContent) {\r\n      mainContent.classList.add(\"opacity-0\");\r\n    }\r\n\r\n    setTimeout(() => {\r\n      window.location.href = targetHref;\r\n    }, 150);\r\n  }\r\n};\r\n\r\n/**\r\n * Saves the current page state (sidebar, scroll positions) to sessionStorage.\r\n */\r\nexport const savePageState = () => {\r\n  const state = {\r\n    sidebarState: getCookie(\"sidebarState\"),\r\n    scrollPosition: window.scrollY,\r\n    navScrollPosition: getPageListElement()?.scrollTop || 0,\r\n  };\r\n\r\n  sessionStorage.setItem(\"pageState\", JSON.stringify(state));\r\n};\r\n\r\n/**\r\n * Restores the page state (sidebar, scroll positions) from sessionStorage.\r\n */\r\nexport const restorePageState = () => {\r\n  try {\r\n    const savedState = sessionStorage.getItem(\"pageState\");\r\n    if (!savedState) return;\r\n\r\n    const state = JSON.parse(savedState);\r\n\r\n    // Restore scroll positions\r\n    setTimeout(() => {\r\n      window.scrollTo(0, state.scrollPosition);\r\n      const navList = getPageListElement();\r\n      if (navList) {\r\n        navList.scrollTop = state.navScrollPosition;\r\n      }\r\n    }, 100);\r\n  } catch (error) {\r\n    console.error(\"Error restoring page state:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Sets the navigation state (open/closed) and highlights the active link.\r\n * @param {boolean} state - Whether navigation should be open.\r\n */\r\nexport const setNavState = (state) => {\r\n  const navList = getPageListElement();\r\n  const navLinks = getNavLinks();\r\n\r\n  if (!navList || !navLinks) {\r\n    return;\r\n  }\r\n\r\n  // Use the shared visibility function to handle most operations\r\n  //setNavVisibility(state);\r\n\r\n  // Navigation-specific behaviors\r\n  const currentPath = window.location.pathname.split(\"/\").pop() || \"index.html\";\r\n  handleActiveLink(state, currentPath, navLinks, navList);\r\n};\r\n\r\n/**\r\n * Sets the navigation toggle button's aria-expanded attribute.\r\n * @param {boolean} navState - Navigation open state.\r\n * @param {HTMLElement} navToggle - The toggle button element.\r\n * @private\r\n */\r\nconst setNavToggle = (navState, navToggle) => {\r\n  if (!navToggle) return;\r\n  navToggle.setAttribute(\"aria-expanded\", navState ? \"true\" : \"false\");\r\n};\r\n\r\n/**\r\n * Sets the navigation popup's state and accessibility attributes.\r\n * @param {HTMLElement} navPopup - The navigation popup element.\r\n * @param {boolean} state - Whether navigation should be open.\r\n */\r\nexport const setNavPopupState = (navPopup, state) => {\r\n  if (!state) {\r\n    navPopup.classList.add(\"-translate-x-full\");\r\n    navPopup.setAttribute(\"aria-expanded\", \"false\");\r\n    navPopup.setAttribute(\"inert\", \"\");\r\n    navPopup.classList.remove(\"left-2\");\r\n  } else {\r\n    navPopup.classList.remove(\"-translate-x-full\");\r\n    navPopup.setAttribute(\"aria-expanded\", \"true\");\r\n    navPopup.removeAttribute(\"inert\");\r\n    navPopup.classList.add(\"left-2\");\r\n  }\r\n};\r\n\r\n/**\r\n * Toggles the navigation popup open/closed and updates toggle button.\r\n */\r\nexport const toggleNav = (newState = null) => {\r\n  const navPopup = document.getElementById(\"navPopup\");\r\n  const navList = getPageListElement();\r\n  const navLinks = getNavLinks();\r\n  const navToggle = document.querySelector(\".nav__toggle\");\r\n\r\n  if (!navList || !navToggle || !navLinks || !navPopup) {\r\n    return;\r\n  }\r\n\r\n  // Filter out non-boolean values (like PointerEvent objects)\r\n  const validState = typeof newState === 'boolean' ? newState : null;\r\n\r\n  // Determine current state\r\n  let isNavOpen;\r\n  if (validState !== null) {\r\n    isNavOpen = !validState;\r\n  } else {\r\n    isNavOpen = getCookie(\"navState\") === \"open\";\r\n  }\r\n  const currentPath = window.location.pathname.split(\"/\").pop() || \"index.html\";\r\n\r\n  // Toggle navigation visibility and toggle button\r\n  setNavVisibility(!isNavOpen);\r\n  setNavToggle(!isNavOpen, navToggle);\r\n\r\n  // Additional navigation-specific operations\r\n  handleActiveLink(!isNavOpen, currentPath, navLinks, navList);\r\n\r\n};\r\n\r\n/**\r\n * Highlights the active navigation link and scrolls it into view if needed.\r\n * @param {boolean} isNavOpen - Whether navigation is open.\r\n * @param {string} currentPath - The current page path.\r\n * @param {NodeList} navLinks - List of navigation link elements.\r\n * @param {HTMLElement} navList - The navigation list element.\r\n * @private\r\n */\r\nconst handleActiveLink = (isNavOpen, currentPath, navLinks, navList) => {\r\n  if (!isNavOpen || !navList) return;\r\n\r\n  const activeLink = Array.from(navLinks).find(\r\n    (link) => link.getAttribute(\"href\") === currentPath\r\n  );\r\n\r\n  if (activeLink) {\r\n    activeLink.setAttribute(\"tabindex\", \"0\");\r\n\r\n    setTimeout(() => {\r\n      const linkRect = activeLink.getBoundingClientRect();\r\n      const navRect = navList.getBoundingClientRect();\r\n      const isInView =\r\n        linkRect.top >= navRect.top && linkRect.bottom <= navRect.bottom;\r\n\r\n      if (!isInView) {\r\n        activeLink.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\r\n      }\r\n      activeLink.focus({ preventScroll: true });\r\n    }, 100);\r\n  }\r\n};\r\n\r\n/* export const updateNavPopupState = (navPopup) => {\r\n  const isHidden = navPopup.classList.toggle(\"-translate-x-full\");\r\n  navPopup.setAttribute(\"aria-expanded\", !isHidden ? \"true\" : \"false\");\r\n  if (isHidden) {\r\n    navPopup.setAttribute(\"inert\", \"\");\r\n  } else {\r\n    navPopup.removeAttribute(\"inert\");\r\n  }\r\n  navPopup.classList.toggle(\"left-2\");\r\n}; */\r\n\r\n/**\r\n * Navigates to the next page in the navigation list.\r\n */\r\nexport const nextPage = () => {\r\n  const currentHref = window.location.href.split(\"/\").pop() || \"index.html\";\r\n\r\n  // Get all nav links in order\r\n  const navItems = Array.from(document.querySelectorAll(\".nav__list-link\"));\r\n\r\n  // Find current page index\r\n  const currentIndex = navItems.findIndex(\r\n    (item) => item.getAttribute(\"href\") === currentHref\r\n  );\r\n\r\n  if (currentIndex >= 0 && currentIndex < navItems.length - 1) {\r\n    const navList = getPageListElement();\r\n    const scrollPosition = navList?.scrollTop || 0;\r\n    const basePath = window.location.pathname.substring(\r\n      0,\r\n      window.location.pathname.lastIndexOf(\"/\") + 1\r\n    );\r\n\r\n    // Save scroll position\r\n    setCookie(\"navScrollPosition\", scrollPosition, 7, basePath);\r\n\r\n    // Cache interface state\r\n    cacheInterfaceElements();\r\n\r\n    // Fade out content\r\n    const mainContent = document.querySelector('body > .container');\r\n    if (mainContent) {\r\n      mainContent.classList.add(\"opacity-0\");\r\n    }\r\n\r\n    // Navigate to next page\r\n    const nextPage = navItems[currentIndex + 1].getAttribute(\"href\");\r\n    const nextPageId = nextPage.split('/').pop();\r\n    trackNavigation(currentHref, nextPageId);\r\n\r\n    setTimeout(() => {\r\n      window.location.href = nextPage;\r\n    }, 150);\r\n  }\r\n};\r\n\r\n/**\r\n * Navigates to the previous page in the navigation list.\r\n */\r\nexport const previousPage = () => {\r\n  const currentHref = window.location.href.split(\"/\").pop() || \"index.html\";\r\n  const navItems = Array.from(document.querySelectorAll(\".nav__list-link\"));\r\n  const currentIndex = navItems.findIndex(\r\n    (item) => item.getAttribute(\"href\") === currentHref\r\n  );\r\n\r\n  if (currentIndex > 0) {\r\n    const navList = getPageListElement();\r\n    const scrollPosition = navList?.scrollTop || 0;\r\n    const basePath = window.location.pathname.substring(\r\n      0,\r\n      window.location.pathname.lastIndexOf(\"/\") + 1\r\n    );\r\n\r\n    setCookie(\"navScrollPosition\", scrollPosition, 7, basePath);\r\n    cacheInterfaceElements();\r\n\r\n    const mainContent = document.querySelector('body > .container');\r\n    if (mainContent) {\r\n      mainContent.classList.add(\"opacity-0\");\r\n    }\r\n\r\n    const prevPage = navItems[currentIndex - 1].getAttribute(\"href\");\r\n    const nextPageId = prevPage.split('/').pop().split('.')[0];\r\n    trackNavigation(currentHref, nextPageId);\r\n\r\n    setTimeout(() => {\r\n      window.location.href = prevPage;\r\n    }, 150);\r\n  }\r\n};\r\n\r\n/**\r\n * Handles keyboard shortcuts for navigation and sidebar toggling.\r\n * @param {KeyboardEvent} event - The keyboard event.\r\n */\r\nexport function handleKeyboardShortcuts(event) {\r\n\r\n  const activeElement = document.activeElement;\r\n\r\n  // More specific check for text input elements\r\n  const isInTextBox =\r\n    (activeElement.tagName === \"INPUT\" &&\r\n      activeElement.type !== \"checkbox\" &&\r\n      activeElement.type !== \"radio\") ||\r\n    activeElement.tagName === \"TEXTAREA\" ||\r\n    activeElement.isContentEditable;\r\n\r\n  // Check if any modifier keys are pressed (except Alt+Shift)\r\n  const hasModifiers =\r\n    event.ctrlKey || event.metaKey || (event.altKey && !event.shiftKey);\r\n\r\n  // Exit if in text input (but not checkbox/radio) or if unwanted modifier keys are pressed\r\n  if (\r\n    (isInTextBox && !activeElement.id.startsWith(\"toggle-\")) ||\r\n    hasModifiers\r\n  ) {\r\n    return;\r\n  }\r\n\r\n  // Get toggle states\r\n  const readAloudMode = getCookie(\"readAloudMode\") === \"true\";\r\n  const easyReadMode = getCookie(\"easyReadMode\") === \"true\";\r\n  const eli5Mode = getCookie(\"eli5Mode\") === \"true\";\r\n\r\n  // Handle navigation keys with null checks\r\n  if (event.key === \"ArrowRight\" || event.key === \"ArrowLeft\") {\r\n    event.preventDefault();\r\n\r\n    // Check if navigation is possible before proceeding\r\n    const navItems = document.querySelectorAll(\".nav__list-link\");\r\n    if (!navItems.length) return;\r\n\r\n    if (event.key === \"ArrowRight\") {\r\n      nextPage();\r\n    } else {\r\n      previousPage();\r\n    }\r\n    return;\r\n  }\r\n\r\n  switch (event.key) {\r\n    case \"x\":\r\n      event.preventDefault();\r\n      toggleNav();\r\n      break;\r\n    case \"a\":\r\n      event.preventDefault();\r\n      toggleSidebar();\r\n      break;\r\n    case \"z\":\r\n      event.preventDefault();\r\n      cycleLanguage();\r\n      break;\r\n    case \"Escape\":\r\n      event.preventDefault();\r\n      escapeKeyPressed();\r\n      break;\r\n  }\r\n\r\n  // Handle Alt+Shift shortcuts separately\r\n  if (event.altKey && event.shiftKey) {\r\n    //const key = event.key.toLowerCase();\r\n    switch (event.code) {\r\n      case \"KeyX\":\r\n        event.preventDefault();\r\n        toggleNav();\r\n        break;\r\n      case \"KeyA\":\r\n        event.preventDefault();\r\n        toggleSidebar();\r\n        break;\r\n      case \"KeyZ\":\r\n        event.preventDefault();\r\n        cycleLanguage();\r\n        break;\r\n    }\r\n    return;\r\n  }\r\n}\r\n\r\n/**\r\n * Handles Escape key to close nav/sidebar and focus main content.\r\n * @private\r\n */\r\nconst escapeKeyPressed = () => {\r\n  const navPopup = document.getElementById(\"navPopup\");\r\n  const navToggle = document.querySelector(\".nav__toggle\");\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  const content = document.querySelector(\"body .container\");\r\n\r\n  // Check if nav is open\r\n  if (navPopup && navPopup.getAttribute(\"aria-expanded\") === \"true\") {\r\n    // Close nav using the proper function\r\n    setNavVisibility(false);\r\n    setNavToggle(false, navToggle);\r\n  }\r\n  // Check if sidebar is open\r\n  else if (sidebar && sidebar.getAttribute('aria-expanded') === 'true') {\r\n    toggleSidebar();\r\n  }\r\n  // Move focus to main content\r\n  if (content) {\r\n    content.setAttribute(\"tabindex\", \"-1\");\r\n    content.focus();\r\n  }\r\n};\r\n\r\n/**\r\n * Sets up a click handler to close nav/sidebar when clicking outside.\r\n */\r\nexport const setupClickOutsideHandler = () => {\r\n  document.addEventListener('click', (event) => {\r\n    const navPopup = document.getElementById('navPopup');\r\n    const sidebar = document.getElementById('sidebar');\r\n    const navToggle = document.querySelector('.nav__toggle');\r\n    const sidebarToggle = document.getElementById('open-sidebar');\r\n    const content = document.querySelector('body > .container');\r\n\r\n    // Check if nav menu is open using aria-expanded attribute\r\n    const isNavOpen = navPopup && navPopup.getAttribute(\"aria-expanded\") === \"true\";\r\n\r\n    // Check if sidebar is open\r\n    const isSidebarOpen = sidebar && sidebar.getAttribute('aria-expanded') === 'true';\r\n\r\n    // If neither menu is open, no action needed\r\n    if (!isNavOpen && !isSidebarOpen) {\r\n      return;\r\n    }\r\n\r\n    // Check if click is outside the navigation menu\r\n    const clickedOutsideNav = isNavOpen &&\r\n      !navPopup.contains(event.target) &&\r\n      (!navToggle || !navToggle.contains(event.target));\r\n\r\n    // Check if click is outside the sidebar\r\n    const clickedOutsideSidebar = isSidebarOpen &&\r\n      !sidebar.contains(event.target) &&\r\n      (!sidebarToggle || !sidebarToggle.contains(event.target));\r\n\r\n    // Close navigation if clicked outside\r\n    if (clickedOutsideNav) {\r\n      toggleNav();\r\n    }\r\n\r\n    // Close sidebar if clicked outside\r\n    if (clickedOutsideSidebar) {\r\n      toggleSidebar();\r\n    }\r\n\r\n    // Focus main content if a menu was closed\r\n    if ((clickedOutsideNav || clickedOutsideSidebar) && content) {\r\n      content.setAttribute('tabindex', '-1');\r\n      content.focus();\r\n\r\n      // Announce to screen readers (if your announceToScreenReader function is available)\r\n      try {\r\n        const { announceToScreenReader } = require('./ui_utils.js');\r\n        announceToScreenReader('Men\u00FA cerrado');\r\n      } catch (e) {\r\n        // Function not available, continue silently\r\n      }\r\n    }\r\n  });\r\n};", "import { ActivityTypes } from '../utils.js';\r\n\r\nasync function executeMail(activityType) {\r\n  try {\r\n    const email = \"unicefadttest@gmail.com\"; //ADD EMAIL\r\n    const iconElements = document.querySelectorAll(\".fa-pen-to-square\");\r\n\r\n    const urlPage = window.location.href\r\n\r\n    iconElements.forEach((iconElement, index) => {\r\n      if (iconElement.classList.contains(\"fa-pen-to-square\") &&\r\n        iconElement.classList.contains(\"text-blue-700\") &&\r\n        iconElement.classList.contains(\"mr-2\")) {\r\n\r\n        const parentElement = iconElement.parentElement;\r\n\r\n        if (parentElement) {\r\n          const spanElement = parentElement.querySelector(\"span\");\r\n\r\n          if (spanElement) {\r\n            const answerText = spanElement.innerText.trim();\r\n\r\n            let answers = JSON.parse(localStorage.getItem(\"instructionPage\"));\r\n\r\n            if (!Array.isArray(answers)) {\r\n              answers = [];\r\n            }\r\n\r\n            const exists = answers.some(activity => activity.text === answerText);\r\n\r\n            if (!exists) {\r\n              answers.push({ number: answers.length + 1, text: answerText });\r\n              localStorage.setItem(\"instructionPage\", JSON.stringify(answers));\r\n            }\r\n          }\r\n        }\r\n      }\r\n    });\r\n    const activityId = location.pathname.split(\"/\").pop().split(\".\")[0];\r\n    const pageParts = activityId.replace(/_/g, \".\").split(\".\").slice(0, 2);\r\n    const firstNumber = parseInt(pageParts[0], 10);\r\n    const secondNumber = parseInt(pageParts[1], 10);\r\n    const adjustedFirstNumber = firstNumber === 0 ? 0 : firstNumber - 1;\r\n    const adjustedSecondNumber = secondNumber + 1;\r\n    const pageNumber = `${adjustedFirstNumber}.${adjustedSecondNumber}`;\r\n    const namePage = localStorage.getItem(\"namePage\");\r\n    const instructionPage = JSON.parse(localStorage.getItem(\"instructionPage\")) || [];\r\n    const intentCount = localStorage.getItem(activityId + \"-intentos\");\r\n\r\n\r\n    const filteredStorageData = {};\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key.startsWith(activityId) && !key.includes(\"-intentos\") && !key.includes(\"_succes\")) {\r\n        filteredStorageData[key] = localStorage.getItem(key);\r\n      }\r\n    }\r\n    const instructionPageHtml = instructionPage.length > 0\r\n      ? instructionPage.map(activity =>\r\n        `<h3><strong>Instrucci\u00F3n ${activity.number}</strong>: ${activity.text}</h3>`\r\n      ).join(\"\")\r\n      : \"<p>No hay instrucciones en esta pagina</p>\";\r\n\r\n    const completedActivities = JSON.parse(localStorage.getItem(\"completedActivities\") || \"[]\");\r\n    const activitiesWithDetails = completedActivities.map(activity => {\r\n\r\n      const parts = activity.replace(/_/g, \".\").split(\".\").slice(0, 2);\r\n      const first = parseInt(parts[0], 10);\r\n      const second = parseInt(parts[1], 10);\r\n      const adjustedFirst = first === 0 ? 0 : first - 1;\r\n      const adjustedSecond = second + 1;\r\n      const pageNum = `${adjustedFirst}.${adjustedSecond}`;\r\n      const sortValue = adjustedFirst * 100 + adjustedSecond;\r\n      const match = activity.match(/^[^\\-]+-([^-\\d]+)-(\\d+)-(.+)$/);\r\n\r\n      let nameActivity = '';\r\n      let intent = '';\r\n      let time = '';\r\n\r\n      if (match) {\r\n        nameActivity = match[1].trim();\r\n        intent = match[2];\r\n        time = match[3].trim();\r\n      }\r\n\r\n      return {\r\n        id: activity,\r\n        pageNumber: pageNum,\r\n        name: nameActivity,\r\n        sortValue: sortValue,\r\n        intent: intent,\r\n        time: time\r\n      };\r\n    });\r\n\r\n\r\n    // Sort activities by numeric value\r\n    activitiesWithDetails.sort((a, b) => a.sortValue - b.sortValue);\r\n\r\n    // Generate HTML for sorted activities\r\n    const completedActivitiesHtml = completedActivities.length > 0\r\n      ? `<ul>${activitiesWithDetails.map(activity =>\r\n        `\r\n          <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\"> <strong>P\u00E1gina ${activity.pageNumber}</strong>: ${activity.name} </th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Intentos: ${activity.intent}</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Time Completed: ${activity.time}</th>\r\n          </table>`\r\n\r\n      ).join(\"\")}</ul>`\r\n      : \"<p>No hay actividades completadas a\u00FAn.</p>\";\r\n\r\n    // Get the character information from localStorage\r\n    let idUser = localStorage.getItem(\"nameUser\");\r\n    let characterEmoji = \"\";\r\n    let studentID = localStorage.getItem(\"studentID\") || \"unknown-student\";\r\n\r\n    // Try to get the character emoji from localStorage\r\n    const characterInfo = localStorage.getItem(\"characterInfo\");\r\n    if (characterInfo) {\r\n      try {\r\n        const characterData = JSON.parse(characterInfo);\r\n        characterEmoji = characterData.emoji || \"\";\r\n      } catch (e) {\r\n        console.error(\"Error parsing character information:\", e);\r\n      }\r\n    }\r\n\r\n    // If nameUser is not set (unlikely as it's set on index page), use the backup generator\r\n    if (!idUser) {\r\n      const adjetivos = [\"R\u00E1pido\", \"Feroz\", \"Dulce\", \"Elegante\", \"Intr\u00E9pido\"];\r\n      const animales = [\"Tigre\", \"\u00C1guila\", \"Lobo\", \"Jaguar\", \"Puma\"];\r\n      function generarNombre() {\r\n        const adj = adjetivos[Math.floor(Math.random() * adjetivos.length)];\r\n        const ani = animales[Math.floor(Math.random() * animales.length)];\r\n        return `${ani} ${adj}`;\r\n      }\r\n\r\n      idUser = generarNombre();\r\n      localStorage.setItem(\"nameUser\", idUser);\r\n    }\r\n\r\n    let htmlContent = \"\";\r\n\r\n    switch (activityType) {\r\n      case ActivityTypes.MULTIPLE_CHOICE:\r\n      case ActivityTypes.QUIZ: {\r\n        const activityLabel = activityType === ActivityTypes.QUIZ ? 'Quiz interactivo' : 'Opci\u00F3n m\u00FAltiple';\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3 style=\"color: #333;\">P\u00E1gina: ${pageNumber} </h3>\r\n          <h4>Tipo: ${activityLabel}</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n\r\n         <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Estado</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Completado \u2705</th>\r\n          </table>\r\n\r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n      }\r\n\r\n      case ActivityTypes.FILL_IN_THE_BLANK:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3 style=\"color: #333;\">P\u00E1gina: ${pageNumber} </h3>\r\n          <h4>Tipo: Completar espacios en blanco</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n           <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Estado</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Completado \u2705</th>\r\n          </table>\r\n\r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      case ActivityTypes.OPEN_ENDED_ANSWER:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3 style=\"color: #333;\">P\u00E1gina: ${pageNumber} </h3>\r\n          <h4>Tipo: Respuesta abierta</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n          <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Pregunta</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Respuesta</th>\r\n              ${Object.entries(filteredStorageData)\r\n            .map(([key, value]) => [key.slice(-1), value])\r\n            .sort((a, b) => Number(a[0]) - Number(b[0]))\r\n            .map(([lastChar, value], index) => `<tr><td>${index}</td><td>${value}</td></tr>`)\r\n            .join(\"\")}\r\n            </table>\r\n         \r\n           <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      case ActivityTypes.SORTING:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3 style=\"color: #333;\">P\u00E1gina: ${pageNumber} </h3>\r\n          <h4 style=\"color: #555;\">Tipo: Ordenar elementos</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n          <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Estado</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Completado \u2705</th>\r\n          </table>\r\n\r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      case ActivityTypes.MATCHING:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3>P\u00E1gina: ${pageNumber}</h3>\r\n          <h4>Tipo: Relacionar columnas</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n\r\n         <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Estado</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Completado \u2705</th>\r\n          </table>\r\n\r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      case ActivityTypes.TRUE_FALSE:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3>P\u00E1gina: ${pageNumber}</h3>\r\n          <h4>Tipo: Verdadero o falso</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n\r\n           <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Estado</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Completado \u2705</th>\r\n          </table>\r\n\r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      case ActivityTypes.FILL_IN_A_TABLE:\r\n        htmlContent = `\r\n          <h2 style=\"color: #4CAF50; text-align: center;\">Respuesta del alumno ${characterEmoji} ${idUser}</h2>\r\n          <h3 style=\"text-align: center;\">Actividad: <a href=\"${urlPage}\">${namePage}</a></h3>\r\n          <h3 style=\"color: #333;\">${instructionPageHtml} </h3>\r\n          <h3>P\u00E1gina: ${pageNumber}</h3>\r\n          <h4>Tipo: Completar tabla</h4>\r\n          <h4 style=\"color: #555;\">Intentos: ${intentCount}</h4>\r\n\r\n\r\n          <table style=\"width: 100%; border-collapse: collapse; border: 1px solid #ddd;\">\r\n            <tr style=\"background-color: #4CAF50; color: white;\">\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Pregunta</th>\r\n              <th style=\"padding: 8px; border: 1px solid #ddd;\">Respuesta</th>\r\n              ${Object.entries(filteredStorageData)\r\n            .map(([key, value]) => [key.slice(-1), value])\r\n            .sort((a, b) => Number(a[0]) - Number(b[0]))\r\n            .map(([lastChar, value], index) => `<tr><td>${index}</td><td>${value}</td></tr>`)\r\n            .join(\"\")}\r\n            </table>\r\n         \r\n          <h3 style=\"color: #333; margin-top: 15px;\">\uD83D\uDCCC Actividades completadas:</h3>\r\n          <div style=\"background-color: #e9f7e5; padding: 10px; border-radius: 5px;\">\r\n            ${completedActivitiesHtml}\r\n          </div>\r\n        `;\r\n        break;\r\n\r\n      default:\r\n        alert(\"\u274C Tipo de actividad no reconocido.\");\r\n        return;\r\n    }\r\n\r\n    const API_KEY = \"\";\r\n\r\n    const payload = {\r\n      sender: { name: idUser, email: \"testmailadtunicef@gmail.com\" },\r\n      to: [{ email: email }],\r\n      subject: `Respuesta de estudiante [ID: ${studentID}]`,\r\n      htmlContent: htmlContent,\r\n    };\r\n\r\n    /*const response = await fetch(\"https://api.brevo.com/v3/smtp/email\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Accept\": \"application/json\",\r\n        \"Content-Type\": \"application/json\",\r\n        \"api-key\": API_KEY,\r\n      },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      throw new Error(`Error al enviar el correo: ${response.status} - ${errorText}`);\r\n    }*/\r\n\r\n  } catch (error) {\r\n    console.error(\"\u274C Error en el env\u00EDo del correo:\", error);\r\n  }\r\n  localStorage.removeItem(\"instructionPage\")\r\n}\r\n\r\nexport { executeMail };", "export const isTypingTarget = (target) => {\r\n    if (!target) {\r\n        return false;\r\n    }\r\n\r\n    const tagName = target.tagName?.toLowerCase();\r\n    const interactiveTags = ['input', 'textarea', 'select', 'button'];\r\n    if (interactiveTags.includes(tagName)) {\r\n        return true;\r\n    }\r\n\r\n    return Boolean(target.isContentEditable);\r\n};\r\n", "import { state, setState } from '../state.js';\r\nimport { playActivitySound } from '../audio.js';\r\nimport { updateSubmitButtonAndToast, ActivityTypes } from '../utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { executeMail } from './send-email.js';\r\nimport { updateResetButtonVisibility } from '../../activity.js';\r\nimport { isTypingTarget } from './shortcut-utils.js';\r\n\r\nlet multipleChoiceShortcutHandler = null;\r\n\r\nconst restoreSubmitButtonToValidate = () => {\r\n    const submitButton = document.getElementById(\"submit-button\");\r\n    if (!submitButton || submitButton.dataset.submitState !== 'retry') {\r\n        return;\r\n    }\r\n\r\n    submitButton.textContent = translateText(\"submit-text\");\r\n    submitButton.setAttribute(\"aria-label\", translateText(\"submit-text\"));\r\n    submitButton.dataset.submitState = 'submit';\r\n\r\n    if (state.retryHandler) {\r\n        submitButton.removeEventListener(\"click\", state.retryHandler);\r\n        state.retryHandler = null;\r\n    }\r\n\r\n    if (state.validateHandler) {\r\n        submitButton.removeEventListener(\"click\", state.validateHandler);\r\n        submitButton.addEventListener(\"click\", state.validateHandler);\r\n    }\r\n};\r\n\r\nexport const prepareMultipleChoice = (section) => {\r\n    restorePreviousSelection(section); // Restaurar selecci\u00F3n previa\r\n\r\n    const activityOptions = section.querySelectorAll(\".activity-option\");\r\n\r\n    // Remove any previous event listeners\r\n    activityOptions.forEach((option) => {\r\n        const newOption = option.cloneNode(true);\r\n        option.parentNode.replaceChild(newOption, option);\r\n    });\r\n\r\n    // Add new event listeners\r\n    section.querySelectorAll(\".activity-option\").forEach((option) => {\r\n        option.addEventListener(\"click\", () => selectOption(option));\r\n\r\n        // Keyboard event handling - Enter and Space trigger option selection\r\n        option.addEventListener(\"keydown\", (e) => {\r\n            if (e.key === \"Enter\" || e.key === \" \") {\r\n                e.preventDefault(); // Prevent scrolling on space\r\n                selectOption(option);\r\n            }\r\n        });\r\n\r\n        // Set proper ARIA attributes\r\n        const optionLetter = option.querySelector('.option-letter')?.textContent || '';\r\n        const imgAlt = option.querySelector('img')?.alt || '';\r\n        const shadowInput = option.querySelector('input[type=\"radio\"]');\r\n        if (shadowInput) {\r\n            shadowInput.setAttribute('tabindex', '-1');\r\n        }\r\n\r\n        // Create a more descriptive label that includes the image description\r\n        option.setAttribute('aria-label', `Option ${optionLetter}: ${imgAlt}`);\r\n        option.setAttribute('role', 'radio');\r\n        option.setAttribute('aria-checked', 'false');\r\n\r\n\r\n        // Add hover effect classes\r\n        option.classList.add(\r\n            'cursor-pointer',\r\n            'transition-all',\r\n            'duration-200',\r\n            'hover:shadow-md',\r\n            'focus:outline-none',\r\n            'focus:ring-2',\r\n            'focus:ring-blue-500',\r\n            'focus:ring-opacity-50'\r\n        );\r\n\r\n        // Style option label\r\n        const label = option.querySelector(\"span\");\r\n        if (label) {\r\n            label.classList.add(\r\n                'px-4',\r\n                'py-2',\r\n                'rounded-full',\r\n                'font-medium',\r\n                'transition-colors',\r\n                'duration-200'\r\n            );\r\n        }\r\n    });\r\n\r\n    // Set proper radiogroup role on the container\r\n    const radioGroup = section.querySelector('[role=\"group\"]');\r\n    if (radioGroup) {\r\n        radioGroup.setAttribute('role', 'radiogroup');\r\n        radioGroup.setAttribute('aria-labelledby', 'question-label');\r\n\r\n        let shortcutHint = radioGroup.querySelector('.quiz-shortcut-hint');\r\n        if (!shortcutHint) {\r\n            shortcutHint = document.createElement('p');\r\n            shortcutHint.className = 'quiz-shortcut-hint sr-only';\r\n            shortcutHint.setAttribute('aria-live', 'polite');\r\n            radioGroup.prepend(shortcutHint);\r\n        }\r\n\r\n        shortcutHint.textContent = translateText('quiz-shortcut-hint');\r\n    }\r\n\r\n    // Allow digit keys (1-9) to select options, Enter to submit\r\n    const options = [...section.querySelectorAll(\".activity-option\")];\r\n    const keyHandler = (e) => {\r\n        if (isTypingTarget(e.target)) {\r\n            return;\r\n        }\r\n\r\n        const digit = parseInt(e.key, 10);\r\n        if (digit >= 1 && digit <= options.length) {\r\n            e.preventDefault();\r\n            selectOption(options[digit - 1]);\r\n        } else if (e.key === \"Enter\") {\r\n            const submitButton = document.getElementById(\"submit-button\");\r\n            if (submitButton) {\r\n                e.preventDefault();\r\n                submitButton.click();\r\n            }\r\n        }\r\n    };\r\n    // Remove any previous handler before adding a new one\r\n    if (multipleChoiceShortcutHandler) {\r\n        document.removeEventListener(\"keydown\", multipleChoiceShortcutHandler);\r\n    }\r\n    multipleChoiceShortcutHandler = keyHandler;\r\n    document.addEventListener(\"keydown\", multipleChoiceShortcutHandler);\r\n};\r\nconst saveSelectionState = (option) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n\r\n    const areaId = option.closest(\"[data-area-id]\")?.getAttribute(\"data-area-id\") || \"default\";\r\n    const storageKey = `${activityId}_${areaId}_multipleChoice`;\r\n\r\n    const selectedData = {\r\n        question: option.getAttribute(\"data-activity-item\"),\r\n        value: option.querySelector('input[type=\"radio\"]').value,\r\n        areaId: areaId\r\n    };\r\n\r\n    localStorage.setItem(storageKey, JSON.stringify(selectedData));\r\n};\r\n\r\nconst restorePreviousSelection = (section) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n\r\n    const areaId = section.querySelector(\"[data-area-id]\")?.getAttribute(\"data-area-id\") || \"default\";\r\n    const storageKey = `${activityId}_${areaId}_multipleChoice`;\r\n\r\n    const savedSelection = localStorage.getItem(storageKey);\r\n    if (savedSelection) {\r\n        const { value } = JSON.parse(savedSelection);\r\n\r\n        const selectedOption = [...section.querySelectorAll(\".activity-option\")].find(option =>\r\n            option.querySelector('input[type=\"radio\"]').value === value\r\n        );\r\n\r\n        if (selectedOption) {\r\n            selectClickedOption(selectedOption);\r\n            setState('selectedOption', selectedOption);\r\n        }\r\n    }\r\n};\r\n\r\nconst isLetterHidden = (option) => {\r\n    const letterElement = option.querySelector('.option-letter');\r\n    const wrapper = letterElement?.parentElement;\r\n    return (\r\n        letterElement?.dataset.letterHidden === 'true' ||\r\n        wrapper?.dataset.letterHidden === 'true'\r\n    );\r\n};\r\n\r\nconst setLetterAppearance = (option, circleClasses, letterClasses) => {\r\n    const letterElement = option.querySelector('.option-letter');\r\n    const circle = letterElement?.parentElement;\r\n\r\n    if (!letterElement || !circle) {\r\n        return;\r\n    }\r\n\r\n    if (isLetterHidden(option)) {\r\n        circle.className = 'option-letter-wrapper sr-only';\r\n        letterElement.className = 'option-letter sr-only';\r\n        return;\r\n    }\r\n\r\n    if (circleClasses) {\r\n        circle.className = circleClasses;\r\n    }\r\n\r\n    if (letterClasses) {\r\n        letterElement.className = letterClasses;\r\n    }\r\n};\r\n\r\n\r\nconst selectOption = (option) => {\r\n    // Clear all validation styling before selecting a new option\r\n    clearAllValidationStyling();\r\n\r\n    const activityItem = getActivityItem(option);\r\n\r\n    const radioGroup = option.closest('[role=\"radiogroup\"]') || option.closest('[role=\"group\"]');\r\n    if (!radioGroup) {\r\n        return;\r\n    }\r\n\r\n    resetOptions(radioGroup);\r\n    selectClickedOption(option);\r\n    setState('selectedOption', option);\r\n\r\n    // Update ARIA attributes\r\n    radioGroup.querySelectorAll('.activity-option').forEach(opt => {\r\n        opt.setAttribute('aria-checked', 'false');\r\n    });\r\n    option.setAttribute('aria-checked', 'true');\r\n\r\n    // Announce selection to screen readers\r\n    const optionLetter = option.querySelector('.option-letter')?.textContent || '';\r\n    const liveRegion = document.getElementById('validation-results-announcement');\r\n    if (liveRegion) {\r\n        liveRegion.setAttribute('aria-live', 'polite');\r\n        liveRegion.textContent = `Option ${optionLetter} selected`;\r\n        setTimeout(() => {\r\n            liveRegion.textContent = '';\r\n        }, 1000);\r\n    }\r\n\r\n    // Guardar en localStorage\r\n    saveSelectionState(option);\r\n\r\n    restoreSubmitButtonToValidate();\r\n\r\n    const shortcutHint = radioGroup?.querySelector('.quiz-shortcut-hint');\r\n    if (shortcutHint) {\r\n        shortcutHint.textContent = translateText('quiz-shortcut-hint');\r\n    }\r\n};\r\n\r\n// New function to clear all validation styling\r\nconst clearAllValidationStyling = () => {\r\n    // Reset all validation marks\r\n    document.querySelectorAll(\".validation-mark\").forEach(mark => {\r\n        mark.classList.add('hidden');\r\n        mark.textContent = '';\r\n    });\r\n\r\n    // Reset all option containers\r\n    document.querySelectorAll(\".activity-option\").forEach(option => {\r\n        option.classList.remove('bg-green-50', 'bg-red-50');\r\n        option.removeAttribute('aria-invalid');\r\n\r\n        // Reset all feedback containers\r\n        const feedback = option.querySelector('.feedback-container');\r\n        if (feedback) {\r\n            feedback.classList.add('hidden');\r\n\r\n            // Clear feedback content\r\n            const feedbackIcon = feedback.querySelector('.feedback-icon');\r\n            const feedbackText = feedback.querySelector('.feedback-text');\r\n\r\n            if (feedbackIcon) {\r\n                feedbackIcon.className = 'feedback-icon';\r\n                feedbackIcon.textContent = '';\r\n            }\r\n\r\n            if (feedbackText) {\r\n                feedbackText.className = 'feedback-text';\r\n                feedbackText.textContent = '';\r\n            }\r\n        }\r\n        \r\n        // Reset the letter appearance\r\n        setLetterAppearance(\r\n            option,\r\n            'w-8 h-8 aspect-square rounded-full border-2 border-gray-300 flex items-center justify-center',\r\n            'option-letter text-gray-500'\r\n        );\r\n\r\n        option.classList.remove('selected-option');\r\n    });\r\n\r\n    // Announce change to screen readers\r\n    const validationResults = document.getElementById('validation-results-announcement');\r\n    if (validationResults) {\r\n        validationResults.textContent = translateText('selection-changed-resubmit');\r\n    }\r\n};\r\n\r\nconst resetOptions = (radioGroup) => {\r\n    radioGroup.querySelectorAll(\".activity-option\").forEach((opt) => {\r\n        // Reset aria attributes\r\n        opt.setAttribute('aria-checked', 'false');\r\n\r\n        setLetterAppearance(\r\n            opt,\r\n            'w-8 h-8 aspect-square rounded-full border-2 border-gray-300 flex items-center justify-center',\r\n            'option-letter text-gray-500'\r\n        );\r\n\r\n        // Reset option container\r\n        opt.classList.remove('bg-green-50', 'bg-red-50');\r\n    opt.classList.remove('selected-option');\r\n\r\n        // Hide feedback\r\n        const feedback = opt.querySelector('.feedback-container');\r\n        if (feedback) {\r\n            feedback.classList.add('hidden');\r\n        }\r\n    });\r\n};\r\n\r\nconst selectClickedOption = (option) => {\r\n    const input = option.querySelector('input[type=\"radio\"]');\r\n    if (input) {\r\n        input.checked = true;\r\n    }\r\n\r\n    // Update ARIA state\r\n    option.setAttribute('aria-checked', 'true');\r\n\r\n    setLetterAppearance(\r\n        option,\r\n        'w-8 h-8 aspect-square rounded-full border-2 border-blue-500 bg-blue-500 flex items-center justify-center',\r\n        'option-letter text-white'\r\n    );\r\n\r\n    option.classList.add('selected-option');\r\n};\r\n\r\nconst getActivityItem = (element) => {\r\n    let activityItem = element.getAttribute('data-activity-item');\r\n\r\n    if (!activityItem) {\r\n        const input = element.querySelector('input[type=\"radio\"]');\r\n        if (input) {\r\n            activityItem = input.getAttribute('data-activity-item');\r\n        }\r\n\r\n        if (element.tagName === 'INPUT') {\r\n            const label = element.closest('.activity-option');\r\n            if (label) {\r\n                activityItem = label.getAttribute('data-activity-item') || activityItem;\r\n            }\r\n        }\r\n    }\r\n\r\n    return activityItem;\r\n};\r\n\r\nexport const checkMultipleChoice = () => {\r\n    if (!state.selectedOption) {\r\n        // Add announcement for screen readers\r\n        const announcement = document.getElementById('validation-results-announcement');\r\n        if (announcement) {\r\n            announcement.setAttribute('aria-live', 'assertive');\r\n            announcement.textContent = translateText(\"select-option-first\");\r\n            setTimeout(() => {\r\n                announcement.textContent = '';\r\n            }, 3000);\r\n        }\r\n\r\n        return;\r\n    }\r\n\r\n    const input = state.selectedOption.querySelector('input[type=\"radio\"]');\r\n    const dataActivityItem = getActivityItem(state.selectedOption);\r\n    const isCorrect = correctAnswers[dataActivityItem];\r\n\r\n    styleSelectedOption(state.selectedOption, isCorrect);\r\n    showFeedback(state.selectedOption, isCorrect);\r\n    // Add this line to update reset button visibility\r\n    if (typeof updateResetButtonVisibility === 'function') {\r\n        updateResetButtonVisibility();\r\n    }\r\n    updateSubmitButtonAndToast(\r\n        isCorrect,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.MULTIPLE_CHOICE\r\n    );\r\n};\r\n\r\nconst styleSelectedOption = (option, isCorrect) => {\r\n    option.classList.remove('selected-option');\r\n\r\n    setLetterAppearance(\r\n        option,\r\n        `w-8 h-8 aspect-square rounded-full border-2 flex items-center justify-center ${isCorrect\r\n            ? 'border-green-500 bg-green-500 text-white'\r\n            : 'border-red-500 bg-red-500 text-white'\r\n            }`,\r\n        'option-letter text-white'\r\n    );\r\n\r\n    option.classList.add(isCorrect ? 'bg-green-50' : 'bg-red-50');\r\n\r\n    // Update ARIA for feedback status\r\n    option.setAttribute('aria-invalid', isCorrect ? 'false' : 'true');\r\n};\r\n\r\nconst showFeedback = (option, isCorrect) => {\r\n    const feedbackContainer = option.querySelector('.feedback-container');\r\n\r\n    if (!feedbackContainer) {\r\n        console.warn('Feedback container not found for option:', option);\r\n        return;\r\n    }\r\n\r\n    const feedbackIcon = feedbackContainer.querySelector('.feedback-icon');\r\n    const feedbackText = feedbackContainer.querySelector('.feedback-text');\r\n\r\n    if (!feedbackIcon || !feedbackText) {\r\n        console.warn('Feedback children missing for option:', option);\r\n        return;\r\n    }\r\n\r\n    feedbackContainer.classList.remove('hidden');\r\n\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    const dataExplanation = option.getAttribute('data-explanation');\r\n    const globalExplanation = window?.multipleChoiceExplanations?.[getActivityItem(option)];\r\n    const explanation = dataExplanation || globalExplanation;\r\n\r\n    if (isCorrect) {\r\n        feedbackIcon.className = 'feedback-icon hidden';\r\n        feedbackIcon.textContent = '';\r\n\r\n        feedbackText.className = 'feedback-text text-lg font-semibold text-green-800';\r\n        if (explanation) {\r\n            feedbackText.textContent = explanation;\r\n        } else {\r\n            feedbackText.textContent = translateText('multiple-choice-correct-answer');\r\n        }\r\n        \r\n        // Set ARIA attributes for feedback\r\n        feedbackContainer.setAttribute('role', 'status');\r\n        feedbackContainer.setAttribute('aria-live', 'polite');\r\n\r\n        playActivitySound('success');\r\n\r\n        // Recuperar el arreglo de actividades completadas del localStorage\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n        executeMail(ActivityTypes.MULTIPLE_CHOICE);\r\n    } else {\r\n        feedbackIcon.className = 'feedback-icon hidden';\r\n        feedbackIcon.textContent = '';\r\n        feedbackText.className = 'feedback-text text-lg font-semibold text-red-800';\r\n        if (explanation) {\r\n            feedbackText.textContent = explanation;\r\n        } else {\r\n            feedbackText.textContent = translateText('multiple-choice-try-again');\r\n        }\r\n        \r\n        // Set ARIA attributes for feedback\r\n        feedbackContainer.setAttribute('role', 'alert');\r\n\r\n        playActivitySound('error');\r\n    }\r\n};\r\n", "import { state, setState } from '../state.js';\r\nimport { playActivitySound, gatherAudioElements, stopAudio } from '../audio.js';\r\nimport { updateSubmitButtonAndToast, ActivityTypes } from '../utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { executeMail } from './send-email.js';\r\nimport { updateResetButtonVisibility } from '../../activity.js';\r\nimport { highlightElement, unhighlightElement, updatePlayPauseIcon } from '../ui_utils.js';\r\n\r\nconst QUIZ_SECTION_SELECTOR = 'section[role=\"activity\"][data-section-type=\"activity_quiz\"]';\r\nconst CORRECT_ANSWERS_SCRIPT_ID = 'quiz-correct-answers';\r\nconst EXPLANATIONS_SCRIPT_ID = 'quiz-explanations';\r\nconst QUIZ_SHORTCUT_KEYS = ['1', '2', '3'];\r\nlet quizShortcutHandlerRegistered = false;\r\n\r\nconst getSubmitButton = () => document.getElementById('submit-button');\r\n\r\nconst disableQuizSubmitButton = () => {\r\n  const submitButton = getSubmitButton();\r\n  if (!submitButton) {\r\n    return;\r\n  }\r\n\r\n  submitButton.setAttribute('disabled', 'true');\r\n  submitButton.setAttribute('aria-disabled', 'true');\r\n  submitButton.setAttribute('tabindex', '-1');\r\n  submitButton.classList.add('opacity-50', 'cursor-not-allowed');\r\n};\r\n\r\nconst enableQuizSubmitButton = () => {\r\n  const submitButton = getSubmitButton();\r\n  if (!submitButton) {\r\n    return;\r\n  }\r\n\r\n  submitButton.removeAttribute('disabled');\r\n  submitButton.removeAttribute('aria-disabled');\r\n  submitButton.removeAttribute('tabindex');\r\n  submitButton.classList.remove('opacity-50', 'cursor-not-allowed');\r\n};\r\nconst focusQuizSubmitButton = () => {\r\n  const submitButton = getSubmitButton();\r\n  if (!submitButton) {\r\n    return;\r\n  }\r\n\r\n  submitButton.classList.remove('hidden');\r\n  submitButton.removeAttribute('aria-hidden');\r\n  submitButton.removeAttribute('tabindex');\r\n\r\n  requestAnimationFrame(() => {\r\n    if (typeof submitButton.focus === 'function') {\r\n      try {\r\n        submitButton.focus({ preventScroll: true });\r\n      } catch (_error) {\r\n        submitButton.focus();\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nconst focusFirstQuizOption = () => {\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR);\r\n  if (!quizSection) {\r\n    return;\r\n  }\r\n\r\n  const firstOption = quizSection.querySelector('.activity-option');\r\n  if (!firstOption) {\r\n    return;\r\n  }\r\n\r\n  const radio = firstOption.querySelector('input[type=\"radio\"]');\r\n  const target = radio || firstOption;\r\n\r\n  requestAnimationFrame(() => {\r\n    if (typeof target.focus === 'function') {\r\n      try {\r\n        target.focus({ preventScroll: true });\r\n      } catch (_error) {\r\n        target.focus();\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nconst ensureValidationLiveRegion = () => {\r\n  if (document.getElementById('validation-results-announcement')) {\r\n    return;\r\n  }\r\n\r\n  const announcement = document.createElement('div');\r\n  announcement.id = 'validation-results-announcement';\r\n  announcement.className = 'sr-only';\r\n  announcement.setAttribute('role', 'status');\r\n  announcement.setAttribute('aria-live', 'polite');\r\n  document.body.appendChild(announcement);\r\n};\r\n\r\nconst applyQuizBackground = () => {\r\n  document.body.style.backgroundColor = '#FFFAF5';\r\n};\r\n\r\nconst parseJsonScriptContent = (elementId) => {\r\n  const scriptElement = document.getElementById(elementId);\r\n\r\n  if (!scriptElement || !scriptElement.textContent) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    return JSON.parse(scriptElement.textContent);\r\n  } catch (error) {\r\n    console.warn(`activity_quiz: unable to parse JSON for ${elementId}`, error);\r\n    return null;\r\n  }\r\n};\r\n\r\nconst mergeIntoWindow = (targetKey, data) => {\r\n  if (!data || typeof data !== 'object') {\r\n    return;\r\n  }\r\n\r\n  const existing = window[targetKey] || {};\r\n  window[targetKey] = { ...existing, ...data };\r\n};\r\n\r\nconst hydrateQuizData = () => {\r\n  const correctAnswers = parseJsonScriptContent(CORRECT_ANSWERS_SCRIPT_ID);\r\n  mergeIntoWindow('correctAnswers', correctAnswers);\r\n\r\n  const explanations = parseJsonScriptContent(EXPLANATIONS_SCRIPT_ID);\r\n  mergeIntoWindow('multipleChoiceExplanations', explanations);\r\n};\r\n\r\nconst getQuizActivityId = () =>\r\n  location.pathname.substring(location.pathname.lastIndexOf('/') + 1).split('.')[0];\r\n\r\nconst getAreaId = (element) =>\r\n  element.closest('[data-area-id]')?.getAttribute('data-area-id') || 'default';\r\n\r\nconst restoreQuizSubmitButtonToValidate = () => {\r\n  const submitButton = document.getElementById('submit-button');\r\n  if (!submitButton || submitButton.dataset.submitState !== 'retry') {\r\n    return;\r\n  }\r\n\r\n  submitButton.textContent = translateText('submit-text');\r\n  submitButton.setAttribute('aria-label', translateText('submit-text'));\r\n  submitButton.dataset.submitState = 'submit';\r\n\r\n  if (state.retryHandler) {\r\n    submitButton.removeEventListener('click', state.retryHandler);\r\n    state.retryHandler = null;\r\n  }\r\n\r\n  if (state.validateHandler) {\r\n    submitButton.removeEventListener('click', state.validateHandler);\r\n    submitButton.addEventListener('click', state.validateHandler);\r\n  }\r\n};\r\n\r\nconst saveQuizSelectionState = (option) => {\r\n  const activityId = getQuizActivityId();\r\n  const areaId = getAreaId(option);\r\n  const storageKey = `${activityId}_${areaId}_quiz`;\r\n\r\n  const selectedData = {\r\n    question: option.getAttribute('data-activity-item'),\r\n    value: option.querySelector('input[type=\"radio\"]').value,\r\n    areaId\r\n  };\r\n\r\n  localStorage.setItem(storageKey, JSON.stringify(selectedData));\r\n};\r\n\r\nconst restoreQuizSelection = (section) => {\r\n  const activityId = getQuizActivityId();\r\n  const areaId = section.querySelector('[data-area-id]')?.getAttribute('data-area-id') || 'default';\r\n  const storageKey = `${activityId}_${areaId}_quiz`;\r\n\r\n  const savedSelection = localStorage.getItem(storageKey);\r\n  if (savedSelection) {\r\n    const { value } = JSON.parse(savedSelection);\r\n    const selectedOption = [...section.querySelectorAll('.activity-option')].find((option) =>\r\n      option.querySelector('input[type=\"radio\"]').value === value\r\n    );\r\n\r\n    if (selectedOption) {\r\n      markQuizSelection(selectedOption);\r\n      setState('quizSelectedOption', selectedOption);\r\n      enableQuizSubmitButton();\r\n      return;\r\n    }\r\n  }\r\n\r\n  disableQuizSubmitButton();\r\n};\r\n\r\nconst isLetterHidden = (option) => {\r\n  const letterElement = option.querySelector('.option-letter');\r\n  const wrapper = letterElement?.parentElement;\r\n  return (\r\n    letterElement?.dataset.letterHidden === 'true' ||\r\n    wrapper?.dataset.letterHidden === 'true'\r\n  );\r\n};\r\n\r\nconst setLetterAppearance = (option, circleClasses, letterClasses) => {\r\n  const letterElement = option.querySelector('.option-letter');\r\n  const circle = letterElement?.parentElement;\r\n\r\n  if (!letterElement || !circle) {\r\n    return;\r\n  }\r\n\r\n  if (isLetterHidden(option)) {\r\n    circle.className = 'option-letter-wrapper sr-only';\r\n    letterElement.className = 'option-letter sr-only';\r\n    return;\r\n  }\r\n\r\n  if (circleClasses) {\r\n    circle.className = circleClasses;\r\n  }\r\n\r\n  if (letterClasses) {\r\n    letterElement.className = letterClasses;\r\n  }\r\n};\r\n\r\nconst clearQuizValidationStyling = () => {\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR) || document;\r\n  let audioBindingsCleared = false;\r\n\r\n  quizSection.querySelectorAll('.validation-mark').forEach((mark) => {\r\n    mark.classList.add('hidden');\r\n    mark.textContent = '';\r\n  });\r\n\r\n  quizSection.querySelectorAll('.activity-option').forEach((option) => {\r\n    option.classList.remove('bg-green-50', 'bg-red-50', 'selected-option');\r\n    option.removeAttribute('aria-invalid');\r\n\r\n    const feedback = option.querySelector('.feedback-container');\r\n    if (feedback) {\r\n      feedback.classList.add('hidden');\r\n      const feedbackIcon = feedback.querySelector('.feedback-icon');\r\n      const feedbackText = feedback.querySelector('.feedback-text');\r\n\r\n      if (feedbackIcon) {\r\n    const shadowInput = option.querySelector('input[type=\"radio\"]');\r\n    if (shadowInput) {\r\n      shadowInput.setAttribute('tabindex', '-1');\r\n    }\r\n        feedbackIcon.className = 'feedback-icon';\r\n        feedbackIcon.textContent = '';\r\n      }\r\n\r\n      if (feedbackText) {\r\n        feedbackText.className = 'feedback-text';\r\n        feedbackText.textContent = '';\r\n        if (feedbackText.hasAttribute('data-id')) {\r\n          feedbackText.removeAttribute('data-id');\r\n          audioBindingsCleared = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    setLetterAppearance(\r\n      option,\r\n      'w-8 h-8 aspect-square rounded-full border-2 border-gray-300 flex items-center justify-center',\r\n      'option-letter text-gray-500'\r\n    );\r\n  });\r\n\r\n  const validationResults = document.getElementById('validation-results-announcement');\r\n  if (validationResults) {\r\n    validationResults.textContent = translateText('selection-changed-resubmit');\r\n  }\r\n\r\n  if (audioBindingsCleared) {\r\n    gatherAudioElements();\r\n  }\r\n};\r\n\r\nconst resetQuizOptions = (radioGroup) => {\r\n  radioGroup.querySelectorAll('.activity-option').forEach((option) => {\r\n    option.setAttribute('aria-checked', 'false');\r\n\r\n    setLetterAppearance(\r\n      option,\r\n      'w-8 h-8 aspect-square rounded-full border-2 border-gray-300 flex items-center justify-center',\r\n      'option-letter text-gray-500'\r\n    );\r\n\r\n    option.classList.remove('bg-green-50', 'bg-red-50', 'selected-option');\r\n\r\n    const feedback = option.querySelector('.feedback-container');\r\n    if (feedback) {\r\n      feedback.classList.add('hidden');\r\n    }\r\n  });\r\n};\r\n\r\nconst markQuizSelection = (option) => {\r\n  const input = option.querySelector('input[type=\"radio\"]');\r\n  if (input) {\r\n    input.checked = true;\r\n  }\r\n\r\n  option.setAttribute('aria-checked', 'true');\r\n\r\n  setLetterAppearance(\r\n    option,\r\n    'w-8 h-8 aspect-square rounded-full border-2 border-blue-500 bg-blue-500 flex items-center justify-center',\r\n    'option-letter text-white'\r\n  );\r\n\r\n  option.classList.add('selected-option');\r\n};\r\n\r\nconst getQuizActivityItem = (element) => {\r\n  let activityItem = element.getAttribute('data-activity-item');\r\n\r\n  if (!activityItem) {\r\n    const input = element.querySelector('input[type=\"radio\"]');\r\n    if (input) {\r\n      activityItem = input.getAttribute('data-activity-item');\r\n    }\r\n\r\n    if (element.tagName === 'INPUT') {\r\n      const label = element.closest('.activity-option');\r\n      if (label) {\r\n        activityItem = label.getAttribute('data-activity-item') || activityItem;\r\n      }\r\n    }\r\n  }\r\n\r\n  return activityItem;\r\n};\r\n\r\nconst translateExplanationById = (explanationId) => {\r\n  if (!explanationId) {\r\n    return null;\r\n  }\r\n\r\n  const translated = translateText(explanationId);\r\n\r\n  if (!translated) {\r\n    return null;\r\n  }\r\n\r\n  if (state?.translations && Object.prototype.hasOwnProperty.call(state.translations, explanationId)) {\r\n    return translated;\r\n  }\r\n\r\n  return translated !== explanationId ? translated : null;\r\n};\r\n\r\nconst resolveQuizExplanation = (option) => {\r\n  if (!option) {\r\n    return { text: null, id: null };\r\n  }\r\n\r\n  const explanationId = option.getAttribute('data-explanation-id');\r\n  const translatedFromId = translateExplanationById(explanationId);\r\n  if (translatedFromId) {\r\n    console.debug('activity_quiz: resolved explanation via data attribute', {\r\n      explanationId,\r\n      source: 'data-explanation-id'\r\n    });\r\n    return { text: translatedFromId, id: explanationId };\r\n  }\r\n\r\n  const activityItem = getQuizActivityItem(option);\r\n  const globalExplanationKey = window?.multipleChoiceExplanations?.[activityItem];\r\n\r\n  const translatedFromGlobal = translateExplanationById(globalExplanationKey);\r\n  if (translatedFromGlobal) {\r\n    console.debug('activity_quiz: resolved explanation via global map', {\r\n      activityItem,\r\n      explanationId: globalExplanationKey\r\n    });\r\n    return { text: translatedFromGlobal, id: globalExplanationKey };\r\n  }\r\n\r\n  if (globalExplanationKey) {\r\n    console.debug('activity_quiz: using untranslated global explanation', {\r\n      activityItem,\r\n      explanationId: globalExplanationKey\r\n    });\r\n    return { text: globalExplanationKey, id: null };\r\n  }\r\n\r\n  const fallbackExplanation = option.getAttribute('data-explanation');\r\n  if (fallbackExplanation) {\r\n    console.debug('activity_quiz: using inline fallback explanation', {\r\n      activityItem,\r\n      fallbackExplanation\r\n    });\r\n  }\r\n  return { text: fallbackExplanation || null, id: null };\r\n};\r\n\r\nconst bindQuizFeedbackAudioId = (feedbackText, explanationId) => {\r\n  if (!feedbackText) {\r\n    return false;\r\n  }\r\n\r\n  const previousId = feedbackText.getAttribute('data-id');\r\n  const normalizedExplanationId = explanationId ?? null;\r\n\r\n  if (explanationId) {\r\n    feedbackText.setAttribute('data-id', explanationId);\r\n  } else {\r\n    feedbackText.removeAttribute('data-id');\r\n  }\r\n\r\n  const changed = previousId !== normalizedExplanationId;\r\n  if (changed) {\r\n    console.debug('activity_quiz: updated feedback audio binding', {\r\n      previousId,\r\n      explanationId: normalizedExplanationId\r\n    });\r\n  }\r\n  return changed;\r\n};\r\n\r\nconst resolveQuizExplanationAudioSrc = (explanationId) => {\r\n  if (!explanationId || !state?.audioFiles) {\r\n    return null;\r\n  }\r\n\r\n  const filename = state.audioFiles[explanationId];\r\n  if (!filename) {\r\n    return null;\r\n  }\r\n\r\n  const currentLanguage =\r\n    state.currentLanguage ||\r\n    (window.appConfig && window.appConfig.languages && window.appConfig.languages.default) ||\r\n    'es';\r\n\r\n  return `content/i18n/${currentLanguage}/audio/${filename}`;\r\n};\r\n\r\nconst playQuizExplanationAudio = (feedbackText, explanationId) => {\r\n  if (!feedbackText) {\r\n    return false;\r\n  }\r\n\r\n  const audioSrc = resolveQuizExplanationAudioSrc(explanationId);\r\n  if (!audioSrc) {\r\n    console.debug('activity_quiz: explanation audio unavailable', {\r\n      explanationId,\r\n      hasAudioFiles: Boolean(state?.audioFiles)\r\n    });\r\n    return false;\r\n  }\r\n\r\n  stopAudio();\r\n\r\n  const explanationAudio = new Audio(audioSrc);\r\n  explanationAudio.playbackRate = parseFloat(state.audioSpeed) || 1;\r\n  const shouldShowTtsUi = Boolean(state.readAloudMode);\r\n\r\n  if (!shouldShowTtsUi) {\r\n    console.debug('activity_quiz: playing explanation audio with read aloud disabled');\r\n  }\r\n\r\n  if (shouldShowTtsUi) {\r\n    highlightElement(feedbackText);\r\n  }\r\n  setState('currentAudio', explanationAudio);\r\n  setState('isPlaying', true);\r\n  if (shouldShowTtsUi) {\r\n    updatePlayPauseIcon(true);\r\n  }\r\n  console.debug('activity_quiz: playing explanation audio', {\r\n    explanationId,\r\n    audioSrc,\r\n    playbackRate: explanationAudio.playbackRate\r\n  });\r\n\r\n  const cleanup = () => {\r\n    if (shouldShowTtsUi) {\r\n      unhighlightElement(feedbackText);\r\n      updatePlayPauseIcon(false);\r\n    }\r\n    if (state.currentAudio === explanationAudio) {\r\n      setState('currentAudio', null);\r\n    }\r\n    setState('isPlaying', false);\r\n  };\r\n\r\n  explanationAudio.addEventListener('ended', cleanup, { once: true });\r\n  explanationAudio.addEventListener('error', cleanup, { once: true });\r\n\r\n  explanationAudio.play().catch((error) => {\r\n    console.warn('activity_quiz: explanation audio playback failed', error);\r\n    cleanup();\r\n  });\r\n\r\n  return true;\r\n};\r\n\r\nconst updateVisibleQuizFeedbackLanguage = () => {\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR);\r\n  if (!quizSection) {\r\n    return;\r\n  }\r\n\r\n  let bindingsChanged = false;\r\n\r\n  quizSection.querySelectorAll('.activity-option').forEach((option) => {\r\n    const feedbackContainer = option.querySelector('.feedback-container');\r\n    if (!feedbackContainer || feedbackContainer.classList.contains('hidden')) {\r\n      return;\r\n    }\r\n\r\n    const feedbackText = feedbackContainer.querySelector('.feedback-text');\r\n    if (!feedbackText) {\r\n      return;\r\n    }\r\n\r\n    const { text: explanation, id: explanationId } = resolveQuizExplanation(option);\r\n    const ariaInvalid = option.getAttribute('aria-invalid');\r\n    const isCorrect = ariaInvalid === 'false';\r\n    const fallbackCopy = translateText(\r\n      isCorrect ? 'multiple-choice-correct-answer' : 'multiple-choice-try-again'\r\n    );\r\n\r\n    feedbackText.textContent = explanation || fallbackCopy;\r\n    console.debug('activity_quiz: feedback text reapplied during language change', {\r\n      optionId: option.getAttribute('data-activity-item'),\r\n      explanationId,\r\n      text: feedbackText.textContent\r\n    });\r\n    const changed = bindQuizFeedbackAudioId(feedbackText, explanationId);\r\n    bindingsChanged = bindingsChanged || changed;\r\n  });\r\n\r\n  if (bindingsChanged) {\r\n    gatherAudioElements();\r\n  }\r\n};\r\n\r\nconst announceQuizSelection = (option) => {\r\n  const optionLetter = option.querySelector('.option-letter')?.textContent?.trim() || '';\r\n  const optionText = option.querySelector('.option-text')?.textContent?.trim() || '';\r\n  const liveRegion = document.getElementById('validation-results-announcement');\r\n  if (!liveRegion) {\r\n    return;\r\n  }\r\n\r\n  liveRegion.setAttribute('aria-live', 'polite');\r\n  if (optionLetter) {\r\n    liveRegion.textContent = `Option ${optionLetter} selected`;\r\n  } else if (optionText) {\r\n    liveRegion.textContent = `Selected ${optionText}`;\r\n  } else {\r\n    liveRegion.textContent = 'Option selected';\r\n  }\r\n  setTimeout(() => {\r\n    liveRegion.textContent = '';\r\n  }, 1000);\r\n};\r\n\r\nconst handleQuizOptionSelection = (option) => {\r\n  clearQuizValidationStyling();\r\n\r\n  const radioGroup = option.closest('[role=\"radiogroup\"]') || option.closest('[role=\"group\"]');\r\n  if (!radioGroup) {\r\n    return;\r\n  }\r\n\r\n  resetQuizOptions(radioGroup);\r\n  markQuizSelection(option);\r\n  setState('quizSelectedOption', option);\r\n  playActivitySound('drop');\r\n\r\n  radioGroup.querySelectorAll('.activity-option').forEach((opt) => opt.setAttribute('aria-checked', 'false'));\r\n  option.setAttribute('aria-checked', 'true');\r\n\r\n  announceQuizSelection(option);\r\n  saveQuizSelectionState(option);\r\n  enableQuizSubmitButton();\r\n  focusQuizSubmitButton();\r\n  restoreQuizSubmitButtonToValidate();\r\n};\r\n\r\nconst isTypingTarget = (target) => {\r\n  if (!target) {\r\n    return false;\r\n  }\r\n\r\n  const tagName = target.tagName?.toLowerCase();\r\n  const interactiveTags = ['input', 'textarea', 'select'];\r\n  if (interactiveTags.includes(tagName)) {\r\n    return true;\r\n  }\r\n\r\n  return Boolean(target.isContentEditable);\r\n};\r\n\r\nconst handleQuizShortcutKeydown = (event) => {\r\n  if (!QUIZ_SHORTCUT_KEYS.includes(event.key)) {\r\n    return;\r\n  }\r\n\r\n  if (isTypingTarget(event.target)) {\r\n    return;\r\n  }\r\n\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR);\r\n  if (!quizSection) {\r\n    return;\r\n  }\r\n\r\n  const options = quizSection.querySelectorAll('.activity-option');\r\n  const index = Number(event.key) - 1;\r\n  const option = options[index];\r\n  if (!option) {\r\n    return;\r\n  }\r\n\r\n  event.preventDefault();\r\n  event.stopPropagation();\r\n  handleQuizOptionSelection(option);\r\n};\r\n\r\nconst registerQuizShortcutHandler = () => {\r\n  if (quizShortcutHandlerRegistered) {\r\n    return;\r\n  }\r\n\r\n  document.addEventListener('keydown', handleQuizShortcutKeydown);\r\n  quizShortcutHandlerRegistered = true;\r\n};\r\n\r\nexport const resetQuizActivity = (activityId) => {\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR);\r\n  if (!quizSection) {\r\n    return;\r\n  }\r\n\r\n  quizSection.querySelectorAll('input[type=\"radio\"]').forEach((input) => {\r\n    input.checked = false;\r\n  });\r\n\r\n  quizSection.querySelectorAll('.activity-option').forEach((option) => {\r\n    option.setAttribute('aria-checked', 'false');\r\n  });\r\n\r\n  clearQuizValidationStyling();\r\n  setState('quizSelectedOption', null);\r\n  disableQuizSubmitButton();\r\n\r\n  Object.keys(localStorage)\r\n    .filter((key) => key.startsWith(`${activityId}_`) && key.endsWith('_quiz'))\r\n    .forEach((key) => localStorage.removeItem(key));\r\n};\r\n\r\nconst attachQuizRetryHandler = () => {\r\n  const submitButton = document.getElementById('submit-button');\r\n  if (!submitButton) {\r\n    return;\r\n  }\r\n\r\n  if (state.retryHandler) {\r\n    submitButton.removeEventListener('click', state.retryHandler);\r\n  }\r\n\r\n  const quizRetryHandler = () => {\r\n    playActivitySound('reset');\r\n    const activityId = getQuizActivityId();\r\n    resetQuizActivity(activityId);\r\n    restoreQuizSubmitButtonToValidate();\r\n    focusFirstQuizOption();\r\n  };\r\n\r\n  state.retryHandler = quizRetryHandler;\r\n  submitButton.addEventListener('click', quizRetryHandler, { once: false });\r\n};\r\n\r\nexport const prepareQuiz = (section) => {\r\n  setState('quizSelectedOption', null);\r\n  restoreQuizSelection(section);\r\n\r\n  const activityOptions = section.querySelectorAll('.activity-option');\r\n  activityOptions.forEach((option) => {\r\n    const newOption = option.cloneNode(true);\r\n    option.parentNode.replaceChild(newOption, option);\r\n  });\r\n\r\n  section.querySelectorAll('.activity-option').forEach((option) => {\r\n    option.addEventListener('click', () => handleQuizOptionSelection(option));\r\n    option.addEventListener('keydown', (event) => {\r\n      if (event.key === 'Enter' || event.key === ' ') {\r\n        event.preventDefault();\r\n        handleQuizOptionSelection(option);\r\n      }\r\n    });\r\n\r\n    const optionText = option.querySelector('.option-text')?.textContent?.trim() || '';\r\n    const imgAlt = option.querySelector('img')?.alt?.trim() || '';\r\n    const shadowInput = option.querySelector('input[type=\"radio\"]');\r\n    if (shadowInput) {\r\n      shadowInput.setAttribute('tabindex', '-1');\r\n    }\r\n\r\n    const labelParts = [];\r\n    if (optionText) {\r\n      labelParts.push(optionText);\r\n    }\r\n    if (imgAlt && imgAlt !== optionText) {\r\n      labelParts.push(imgAlt);\r\n    }\r\n\r\n    const ariaLabel = labelParts.join(' ').trim() || 'Option';\r\n    option.setAttribute('aria-label', ariaLabel);\r\n    option.setAttribute('role', 'radio');\r\n    option.setAttribute('aria-checked', 'false');\r\n\r\n    option.classList.add(\r\n      'cursor-pointer',\r\n      'transition-all',\r\n      'duration-200',\r\n      'hover:shadow-md',\r\n      'focus:outline-none',\r\n      'focus:ring-2',\r\n      'focus:ring-blue-500',\r\n      'focus:ring-opacity-50'\r\n    );\r\n\r\n    const label = option.querySelector('span');\r\n    if (label) {\r\n      label.classList.add('px-4', 'py-2', 'rounded-full', 'font-medium', 'transition-colors', 'duration-200');\r\n    }\r\n  });\r\n\r\n  const radioGroup = section.querySelector('[role=\"group\"]');\r\n  if (radioGroup) {\r\n    radioGroup.setAttribute('role', 'radiogroup');\r\n    radioGroup.setAttribute('aria-labelledby', 'question-label');\r\n\r\n    let shortcutHint = radioGroup.querySelector('.quiz-shortcut-hint');\r\n    if (!shortcutHint) {\r\n      shortcutHint = document.createElement('p');\r\n      shortcutHint.className = 'quiz-shortcut-hint sr-only';\r\n      shortcutHint.setAttribute('aria-live', 'polite');\r\n      radioGroup.prepend(shortcutHint);\r\n    }\r\n\r\n    shortcutHint.textContent = translateText('quiz-shortcut-hint');\r\n  }\r\n\r\n  registerQuizShortcutHandler();\r\n};\r\n\r\nexport const checkQuiz = () => {\r\n  if (!state.quizSelectedOption) {\r\n    const announcement = document.getElementById('validation-results-announcement');\r\n    if (announcement) {\r\n      announcement.setAttribute('aria-live', 'assertive');\r\n      announcement.textContent = translateText('select-option-first');\r\n      setTimeout(() => {\r\n        announcement.textContent = '';\r\n      }, 3000);\r\n    }\r\n    return;\r\n  }\r\n\r\n  const dataActivityItem = getQuizActivityItem(state.quizSelectedOption);\r\n  const isCorrect = correctAnswers[dataActivityItem];\r\n\r\n  styleQuizOption(state.quizSelectedOption, isCorrect);\r\n  showQuizFeedback(state.quizSelectedOption, isCorrect);\r\n\r\n  if (typeof updateResetButtonVisibility === 'function') {\r\n    updateResetButtonVisibility();\r\n  }\r\n\r\n  updateSubmitButtonAndToast(isCorrect, translateText('next-activity'), ActivityTypes.QUIZ);\r\n\r\n  if (!isCorrect) {\r\n    attachQuizRetryHandler();\r\n  }\r\n};\r\n\r\nconst styleQuizOption = (option, isCorrect) => {\r\n  option.classList.remove('selected-option');\r\n\r\n  setLetterAppearance(\r\n    option,\r\n    `w-8 h-8 aspect-square rounded-full border-2 flex items-center justify-center ${\r\n      isCorrect ? 'border-green-500 bg-green-500 text-white' : 'border-red-500 bg-red-500 text-white'\r\n    }`,\r\n    'option-letter text-white'\r\n  );\r\n\r\n  option.classList.add(isCorrect ? 'bg-green-50' : 'bg-red-50');\r\n  option.setAttribute('aria-invalid', isCorrect ? 'false' : 'true');\r\n};\r\n\r\nconst playQuizFeedbackAudioSequence = (isCorrect, feedbackText, explanationId) => {\r\n  const soundKey = isCorrect ? 'success' : 'error';\r\n  const soundEffect = playActivitySound(soundKey);\r\n\r\n  if (!state.readAloudMode) {\r\n    return;\r\n  }\r\n\r\n  const startExplanationPlayback = () => {\r\n    playQuizExplanationAudio(feedbackText, explanationId);\r\n  };\r\n\r\n  if (soundEffect && typeof soundEffect.addEventListener === 'function') {\r\n    soundEffect.addEventListener('ended', startExplanationPlayback, { once: true });\r\n  } else {\r\n    startExplanationPlayback();\r\n  }\r\n};\r\n\r\nconst showQuizFeedback = (option, isCorrect) => {\r\n  const feedbackContainer = option.querySelector('.feedback-container');\r\n  if (!feedbackContainer) {\r\n    return;\r\n  }\r\n\r\n  const feedbackIcon = feedbackContainer.querySelector('.feedback-icon');\r\n  const feedbackText = feedbackContainer.querySelector('.feedback-text');\r\n  if (!feedbackIcon || !feedbackText) {\r\n    return;\r\n  }\r\n\r\n  feedbackContainer.classList.remove('hidden');\r\n\r\n  const activityId = getQuizActivityId();\r\n  const attemptKey = `${activityId}-intentos`;\r\n  let attemptCount = parseInt(localStorage.getItem(attemptKey) || '0', 10);\r\n  attemptCount += 1;\r\n  localStorage.setItem(attemptKey, attemptCount.toString());\r\n\r\n  const { text: explanation, id: explanationId } = resolveQuizExplanation(option);\r\n  let bindingsChanged = false;\r\n\r\n  if (isCorrect) {\r\n    feedbackIcon.className = 'feedback-icon hidden';\r\n    feedbackIcon.textContent = '';\r\n    feedbackText.className = 'feedback-text text-lg font-semibold text-green-800';\r\n    feedbackText.textContent = explanation || translateText('multiple-choice-correct-answer');\r\n    bindingsChanged = bindQuizFeedbackAudioId(feedbackText, explanationId) || bindingsChanged;\r\n\r\n    feedbackContainer.setAttribute('role', 'status');\r\n    feedbackContainer.setAttribute('aria-live', 'polite');\r\n\r\n    const storedActivities = localStorage.getItem('completedActivities');\r\n    let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n    const namePage = localStorage.getItem('namePage');\r\n    const timeDone = new Date().toLocaleString('es-ES');\r\n    const newActivityId = `${activityId}-${namePage}-${attemptCount}-${timeDone}`;\r\n\r\n    completedActivities = completedActivities.filter((id) => !id.startsWith(`${activityId}-`));\r\n    completedActivities.push(newActivityId);\r\n    localStorage.setItem('completedActivities', JSON.stringify(completedActivities));\r\n\r\n    const heading = document.querySelector('h1');\r\n    if (heading) {\r\n      localStorage.setItem('namePage', heading.innerText);\r\n    }\r\n\r\n    executeMail(ActivityTypes.QUIZ);\r\n  } else {\r\n    feedbackIcon.className = 'feedback-icon hidden';\r\n    feedbackIcon.textContent = '';\r\n    feedbackText.className = 'feedback-text text-lg font-semibold text-red-800';\r\n    feedbackText.textContent = explanation || translateText('multiple-choice-try-again');\r\n    bindingsChanged = bindQuizFeedbackAudioId(feedbackText, explanationId) || bindingsChanged;\r\n\r\n    feedbackContainer.setAttribute('role', 'alert');\r\n  }\r\n\r\n  if (bindingsChanged) {\r\n    gatherAudioElements();\r\n  }\r\n\r\n  playQuizFeedbackAudioSequence(isCorrect, feedbackText, explanationId);\r\n};\r\n\r\nexport const initializeQuizActivity = () => {\r\n  const quizSection = document.querySelector(QUIZ_SECTION_SELECTOR);\r\n\r\n  if (!quizSection) {\r\n    return;\r\n  }\r\n\r\n  applyQuizBackground();\r\n  ensureValidationLiveRegion();\r\n  disableQuizSubmitButton();\r\n  hydrateQuizData();\r\n};\r\n\r\ndocument.addEventListener('adt-language-changed', updateVisibleQuizFeedbackLanguage);\r\n\r\nexport default {\r\n  initializeQuizActivity,\r\n  resetQuizActivity,\r\n  prepareQuiz,\r\n  checkQuiz\r\n};\r\n", "import { state, setState } from '../state.js';\r\nimport { playActivitySound } from '../audio.js';\r\nimport { ActivityTypes, updateSubmitButtonAndToast } from '../utils.js';\r\nimport { announceToScreenReader } from '../ui_utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { executeMail } from './send-email.js';\r\nimport { updateResetButtonVisibility } from '../../activity.js';\r\n\r\n/**\r\n * Helper function to strip emojis and clean up whitespace from text for accessibility\r\n * @param {string} text - The text to clean\r\n * @returns {string} - Clean text without emojis and normalized whitespace\r\n */\r\nconst stripEmojisAndCleanText = (text) => {\r\n  return text\r\n    .trim()\r\n    .replace(/[\\u{1F600}-\\u{1F64F}]|[\\u{1F300}-\\u{1F5FF}]|[\\u{1F680}-\\u{1F6FF}]|[\\u{1F1E0}-\\u{1F1FF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]|[\\u{1F900}-\\u{1F9FF}]|[\\u{1FA70}-\\u{1FAFF}]/gu, '')\r\n    .replace(/\\s+/g, ' ')\r\n    .trim();\r\n};\r\n\r\nexport const prepareSorting = (section) => {\r\n  setupWordCards(section);\r\n  setupCategories(section);\r\n  setupFeedbackReset(section);\r\n\r\n  // Load saved data only after setup is complete\r\n  setTimeout(() => {\r\n    loadFromLocalStorage();\r\n  }, 0);\r\n};\r\n\r\nconst setupWordCards = (section) => {\r\n  const wordCards = section.querySelectorAll(\".word-card\");\r\n  wordCards.forEach((wordCard) => {\r\n    addWordCardListeners(wordCard, section);\r\n    styleWordCard(wordCard);\r\n  });\r\n};\r\n\r\n// this is for take de id for localstorage\r\nconst activity = () => {\r\n  const activityElement = document.querySelector('[data-aria-id]');\r\n  if (!activityElement) {\r\n    return\r\n  }\r\n\r\n  const activity = activityElement.getAttribute('data-aria-id');\r\n\r\n  const activityId = location.pathname\r\n    .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n    .split(\".\")[0];\r\n\r\n  const localStorageKey = `${activityId}_${activity}`;\r\n  if (document.getElementsByTagName(\"h1\").length < 0) {\r\n    localStorage.setItem(\"namePage\", document.getElementsByTagName(\"h2\")[0].innerText);\r\n  } else if (document.getElementsByTagName(\"h1\").length > 0) {\r\n    localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n  }\r\n\r\n\r\n  return localStorageKey\r\n}\r\n\r\n// Helper function to get all focusable elements in the correct order\r\nconst getAllFocusableElements = (section) => {\r\n  const availableWordCards = Array.from(section.querySelectorAll('.word-card:not(.bg-gray-300):not(.placed-word)'))\r\n    .filter(card => !card.closest('.category')); // Exclude cards that are inside categories\r\n  const placedWordCards = Array.from(section.querySelectorAll('.placed-word'));\r\n  const categories = Array.from(section.querySelectorAll('section .category'));\r\n  const submitButton = document.getElementById('submit-button');\r\n  const resetButton = document.getElementById('reset-button');\r\n\r\n  // Build the complete list of focusable elements in logical tab order\r\n  let focusableElements = [];\r\n\r\n  // First add available word cards\r\n  focusableElements.push(...availableWordCards);\r\n\r\n  // Then add categories and placed word cards\r\n  focusableElements.push(...categories);\r\n  focusableElements.push(...placedWordCards);\r\n\r\n  // Add submit and reset buttons only if they exist\r\n  if (submitButton) {\r\n    focusableElements.push(submitButton);\r\n  }\r\n  if (resetButton) {\r\n    focusableElements.push(resetButton);\r\n  }\r\n\r\n  return focusableElements;\r\n};\r\n\r\nconst addWordCardListeners = (wordCard, section) => {\r\n  wordCard.addEventListener(\"click\", () => selectWordSort(wordCard));\r\n  wordCard.addEventListener('dragstart', handleDragStart);\r\n  wordCard.addEventListener(\"mousedown\", () => highlightBoxes(true));\r\n  wordCard.addEventListener(\"mouseup\", () => highlightBoxes(false));\r\n  wordCard.addEventListener(\"keydown\", (event) => handleWordCardKeydown(event, wordCard, section));\r\n\r\n  // Make images inside cards not draggable\r\n  const cardImage = wordCard.querySelector('img');\r\n  if (cardImage) {\r\n    cardImage.setAttribute('draggable', 'false');\r\n    cardImage.style.pointerEvents = 'none';\r\n  }\r\n}\r\n\r\nconst handleWordCardKeydown = (event, wordCard, section) => {\r\n  // Prevent arrow keys from triggering page navigation but allow natural tab order\r\n  if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' ||\r\n    event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n\r\n    // Handle arrow navigation within word cards only when focusing word cards\r\n    handleWordCardArrowNavigation(event.key, wordCard, section);\r\n    return;\r\n  }\r\n\r\n  // Allow natural tab navigation in most cases\r\n  if (event.key === 'Tab') {\r\n    // Only prevent default and control tab order when in category navigation mode\r\n    if (state.inCategoryNavigation) {\r\n      event.preventDefault();\r\n\r\n      // Exit category navigation mode if shift+tab is pressed\r\n      if (event.shiftKey) {\r\n        state.inCategoryNavigation = false;\r\n        resetSelectionState();\r\n        return; // Let browser handle the tab navigation naturally\r\n      }\r\n\r\n      // Otherwise, handle custom tab navigation within categories\r\n      const allFocusableElements = getAllFocusableElements(section);\r\n\r\n      if (allFocusableElements.length > 0) {\r\n        const currentIndex = allFocusableElements.indexOf(wordCard);\r\n        const nextIndex = (currentIndex + 1) % allFocusableElements.length;\r\n        allFocusableElements[nextIndex].focus();\r\n      }\r\n      return;\r\n    }\r\n    // Otherwise, let the browser handle natural tab order\r\n    return;\r\n  }\r\n\r\n  if (event.key === 'Enter' || event.key === ' ') {\r\n    event.preventDefault();\r\n    selectWordSort(wordCard);\r\n  }\r\n};\r\n\r\n// New function to handle arrow navigation through all elements\r\nconst handleAllElementsArrowNavigation = (key, currentElement, section) => {\r\n  const allFocusableElements = getAllFocusableElements(section);\r\n\r\n  if (allFocusableElements.length <= 1) return;\r\n\r\n  const currentIndex = allFocusableElements.indexOf(currentElement);\r\n  let nextIndex;\r\n\r\n  switch (key) {\r\n    case 'ArrowLeft':\r\n    case 'ArrowUp':\r\n      nextIndex = (currentIndex - 1 + allFocusableElements.length) % allFocusableElements.length;\r\n      break;\r\n    case 'ArrowRight':\r\n    case 'ArrowDown':\r\n      nextIndex = (currentIndex + 1) % allFocusableElements.length;\r\n      break;\r\n  }\r\n\r\n  if (allFocusableElements[nextIndex]) {\r\n    allFocusableElements[nextIndex].focus();\r\n  }\r\n};\r\n\r\nconst styleWordCard = (wordCard) => {\r\n  wordCard.classList.add(\r\n    \"cursor-pointer\",\r\n    \"transition\",\r\n    \"duration-300\",\r\n    \"hover:bg-yellow-300\",\r\n    \"transform\",\r\n    \"hover:scale-105\"\r\n  );\r\n};\r\n\r\nconst setupCategories = (section) => {\r\n  const categories = section.querySelectorAll('section .category');\r\n  categories.forEach((category) => {\r\n    category.setAttribute('tabindex', '0');\r\n    category.setAttribute('role', 'listbox');\r\n    category.addEventListener('dragover', allowDrop);\r\n    category.addEventListener('drop', (event) => dropSort(event, section));\r\n\r\n    // Find the preceding heading to label the category\r\n    const heading = category.previousElementSibling;\r\n    if (heading && heading.tagName.toLowerCase().startsWith('h')) {\r\n      // Ensure heading has an ID\r\n      if (!heading.id) {\r\n        heading.id = `category-label-${category.getAttribute('data-activity-category')}`;\r\n      }\r\n      category.setAttribute('aria-labelledby', heading.id);\r\n    }\r\n\r\n    // Add focus event to announce category contents for screen readers\r\n    category.addEventListener('focus', () => {\r\n      // Only announce contents if not in word placement mode\r\n      if (!state.currentWord) {\r\n        const categoryName = category.getAttribute('aria-label') || category.getAttribute('data-activity-category');\r\n        const placedCards = category.querySelectorAll('.placed-word');\r\n        const placedCount = placedCards.length;\r\n\r\n        let announcement = '';\r\n\r\n        if (placedCount === 0) {\r\n          announcement = `Categor\u00EDa: ${categoryName}. No hay palabras colocadas aqu\u00ED.`;\r\n        } else {\r\n          // Build a list of placed card names\r\n          const cardNames = Array.from(placedCards).map(card => card.textContent.trim());\r\n\r\n          announcement = `Categor\u00EDa: ${categoryName}. Contiene ${placedCount} palabra${placedCount !== 1 ? 's' : ''}: ${cardNames.join(', ')}.`;\r\n        }\r\n\r\n        announceToScreenReader(announcement);\r\n      }\r\n    });\r\n\r\n    category.addEventListener('click', (e) => {\r\n      // Add this logic to handle placing a selected word on category click\r\n      if (state.currentWord) {\r\n        // Prevent placing if the click target is already a placed word within the category\r\n        if (e.target.closest('.placed-word')) {\r\n          e.stopPropagation();\r\n          return; // Don't place a new word if clicking on an existing placed one\r\n        }\r\n        // If a word is selected, place it in this category\r\n        placeWord(category.getAttribute('data-activity-category'), section);\r\n      }\r\n    });\r\n\r\n    category.addEventListener('keydown', (e) => {\r\n      // Prevent arrow keys from triggering page navigation\r\n      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight' ||\r\n        e.key === 'ArrowUp' || e.key === 'ArrowDown') {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        // Handle arrow navigation within categories when in category mode\r\n        handleCategoryArrowNavigation(e.key, category, section);\r\n        return;\r\n      }\r\n\r\n      if (e.key === 'Tab') {\r\n        // Confine Tab navigation within categories only when a word is selected and in category navigation mode\r\n        if (state.currentWord && state.inCategoryNavigation) {\r\n          e.preventDefault();\r\n\r\n          // Exit category navigation mode if shift+tab is pressed\r\n          if (e.shiftKey) {\r\n            state.inCategoryNavigation = false;\r\n            resetSelectionState();\r\n            highlightBoxes(false);\r\n\r\n            // Find the last placed word card or first word card to focus\r\n            const wordCards = document.querySelectorAll('section .word-card:not(.bg-gray-300):not(.placed-word)');\r\n            if (wordCards.length > 0) {\r\n              wordCards[0].focus();\r\n            }\r\n            return;\r\n          }\r\n\r\n          // Otherwise continue with category tab navigation\r\n          const allCategories = Array.from(section.querySelectorAll('section .category'));\r\n          if (allCategories.length > 0) {\r\n            const currentIndex = allCategories.indexOf(category);\r\n            const nextIndex = (currentIndex + 1) % allCategories.length;\r\n            allCategories[nextIndex].focus();\r\n          }\r\n        } else {\r\n          // Allow natural tab navigation when not in category navigation mode\r\n          return;\r\n        }\r\n        return;\r\n      }\r\n\r\n      if (state.currentWord && (e.key === 'Enter' || e.key === ' ')) {\r\n        e.preventDefault();\r\n        const categoryName = category.getAttribute('data-activity-category');\r\n        placeWord(categoryName, section);\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n// Add a new function to handle arrow navigation\r\nconst handleArrowNavigation = (key, currentElement) => {\r\n  // Get all interactive elements in the activity\r\n  const allElements = [\r\n    ...document.querySelectorAll('.word-card:not(.bg-gray-300)'), // Available word cards\r\n    ...document.querySelectorAll('.category'),                    // Category dropzones\r\n    ...document.querySelectorAll('.placed-word')                  // Placed word cards\r\n  ];\r\n\r\n  // Get the current element's position\r\n  const rect = currentElement.getBoundingClientRect();\r\n  const currentCenter = {\r\n    x: rect.left + rect.width / 2,\r\n    y: rect.top + rect.height / 2\r\n  };\r\n\r\n  // Find the next element based on arrow direction\r\n  let closestElement = null;\r\n  let minDistance = Infinity;\r\n\r\n  allElements.forEach(element => {\r\n    if (element === currentElement) return; // Skip the current element\r\n\r\n    const elementRect = element.getBoundingClientRect();\r\n    const elementCenter = {\r\n      x: elementRect.left + elementRect.width / 2,\r\n      y: elementRect.top + elementRect.height / 2\r\n    };\r\n\r\n    // Calculate distance and direction\r\n    const deltaX = elementCenter.x - currentCenter.x;\r\n    const deltaY = elementCenter.y - currentCenter.y;\r\n    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);\r\n\r\n    // Check if the element is in the correct direction\r\n    let isInDirection = false;\r\n\r\n    switch (key) {\r\n      case 'ArrowLeft':\r\n        isInDirection = deltaX < -10; // Element is to the left\r\n        break;\r\n      case 'ArrowRight':\r\n        isInDirection = deltaX > 10;  // Element is to the right\r\n        break;\r\n      case 'ArrowUp':\r\n        isInDirection = deltaY < -10; // Element is above\r\n        break;\r\n      case 'ArrowDown':\r\n        isInDirection = deltaY > 10;  // Element is below\r\n        break;\r\n    }\r\n\r\n    // If in the right direction and closer than current closest\r\n    if (isInDirection && distance < minDistance) {\r\n      minDistance = distance;\r\n      closestElement = element;\r\n    }\r\n  });\r\n\r\n  // Focus the closest element if found\r\n  if (closestElement) {\r\n    closestElement.focus();\r\n  }\r\n};\r\n\r\nconst setupFeedbackReset = () => {\r\n  const feedback = document.querySelector(\"#feedback\");\r\n  if (feedback) {\r\n    feedback.addEventListener(\"click\", resetActivity);\r\n  }\r\n};\r\n\r\nexport const resetActivity = () => {\r\n  // Remove all placed word cards\r\n  const placedWordCards = document.querySelectorAll('section .placed-word');\r\n  placedWordCards.forEach((placedWordCard) => {\r\n    placedWordCard.remove();\r\n  });\r\n\r\n  // Restore original word cards\r\n  const originalWordCards = document.querySelectorAll('section .word-card');\r\n  originalWordCards.forEach((wordCard) => {\r\n    restoreOriginalCard(wordCard);\r\n  });\r\n\r\n  // Reset state variables\r\n  setState('currentWord', \"\");\r\n  if (state) state.inCategoryNavigation = false;\r\n\r\n  // Remove any visual feedback\r\n  const feedbackElement = document.getElementById(\"feedback\");\r\n  if (feedbackElement) {\r\n    feedbackElement.textContent = \"\";\r\n    feedbackElement.classList.remove(\"text-red-500\", \"text-green-500\");\r\n  }\r\n\r\n  const toast = document.getElementById(\"toast\");\r\n  if (toast) {\r\n    toast.textContent = \"\";\r\n    toast.classList.add(\"hidden\");\r\n    toast.classList.remove(\"bg-red-200\", \"text-red-700\", \"bg-green-200\", \"text-green-700\");\r\n  }\r\n\r\n  // Reset categories' visual state\r\n  highlightBoxes(false);\r\n\r\n  // Clear localStorage for this activity\r\n  clearSortingLocalStorage();\r\n\r\n  // Try to play reset sound if audio module is loaded\r\n  try {\r\n    if (typeof playActivitySound === 'function') {\r\n      playActivitySound('reset');\r\n    }\r\n  } catch (error) {\r\n    console.warn(\"Could not play reset sound:\", error);\r\n  }\r\n};\r\n\r\n// New function to clear localStorage data for sorting activities\r\nconst clearSortingLocalStorage = () => {\r\n  try {\r\n    const activityId = location.pathname\r\n      .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n      .split(\".\")[0];\r\n\r\n    // Get all localStorage keys for this activity\r\n    const localStorageKeys = Object.keys(localStorage).filter(key =>\r\n      key.startsWith(`${activityId}_`)\r\n    );\r\n\r\n    // Remove all matching localStorage items\r\n    localStorageKeys.forEach(key => {\r\n      localStorage.removeItem(key);\r\n    });\r\n\r\n    // Also try to remove the activity-specific item\r\n    const activityKey = activity();\r\n    if (activityKey) {\r\n      localStorage.removeItem(activityKey);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error clearing sorting localStorage:\", error);\r\n  }\r\n};\r\n\r\nexport const handleDragStart = (event) => {\r\n  const wordCard = event.target.closest('.word-card');\r\n  if (!wordCard) return;\r\n\r\n  if (wordCard.classList.contains('bg-gray-300')) {\r\n    event.preventDefault();\r\n    return;\r\n  }\r\n\r\n  event.dataTransfer.setData('text', wordCard.getAttribute('data-activity-item'));\r\n  wordCard.classList.add('selected');\r\n\r\n  if (event.dataTransfer.setDragImage) {\r\n    event.dataTransfer.setDragImage(wordCard, 0, 0);\r\n  }\r\n\r\n  highlightBoxes(true);\r\n};\r\n\r\nexport const highlightBoxes = (state) => {\r\n  const categories = document.querySelectorAll(\"section .category\");\r\n  categories.forEach((category) => {\r\n    if (state) {\r\n      category.classList.add(\"bg-blue-100\", \"border-blue-400\");\r\n    } else {\r\n      category.classList.remove(\"bg-blue-100\", \"border-blue-400\");\r\n    }\r\n  });\r\n};\r\n\r\nexport const selectWordSort = (wordCard) => {\r\n  // Check if this is a placed word card that should be removed\r\n  if (wordCard.classList.contains(\"placed-word\")) {\r\n    removeWord(wordCard);\r\n    return;\r\n  }\r\n\r\n  if (wordCard.classList.contains(\"bg-gray-300\")) {\r\n    // This is a disabled original card, find its placed counterpart and remove it\r\n    const placedWordCard = document.querySelector(`.placed-word[data-activity-item=\"${wordCard.getAttribute('data-activity-item')}\"]`);\r\n    if (placedWordCard) {\r\n      removeWord(placedWordCard);\r\n    }\r\n    return;\r\n  }\r\n\r\n  // Remove selection from all other word cards\r\n  document.querySelectorAll(\"section .word-card\")\r\n    .forEach((card) => card.classList.remove(\"border-blue-700\"));\r\n\r\n  wordCard.classList.remove(\"border-gray-300\");\r\n  wordCard.classList.add(\"border-blue-700\", \"border-2\", \"box-border\");\r\n\r\n  setState('currentWord', wordCard.getAttribute(\"data-activity-item\"));\r\n  // Enable category navigation mode and focus first category\r\n  state.inCategoryNavigation = true;\r\n  const firstCategory = document.querySelector('section .category');\r\n  if (firstCategory) {\r\n    firstCategory.focus();\r\n\r\n    // Get number of items in this category\r\n    const itemCount = firstCategory.querySelector('.word-list')?.children.length || 0;\r\n    const categoryName = firstCategory.getAttribute('aria-label') || firstCategory.getAttribute('data-activity-category');\r\n\r\n    // Enhanced announcement with more context\r\n    let announcement = `Seleccionado: ${wordCard.textContent.trim()}. `;\r\n    announcement += `Ahora enfocado en categor\u00EDa: ${categoryName}. `;\r\n\r\n    // Add information about what's already in the category\r\n    if (itemCount === 0) {\r\n      announcement += 'Esta categor\u00EDa est\u00E1 vac\u00EDa. ';\r\n    } else {\r\n      const placedCards = firstCategory.querySelectorAll('.placed-word');\r\n      const cardNames = Array.from(placedCards).map(card => card.textContent.trim());\r\n      announcement += `Ya contiene ${itemCount} palabra${itemCount !== 1 ? 's' : ''}: ${cardNames.join(', ')}. `;\r\n    }\r\n\r\n    announcement += 'Presione Enter para colocar aqu\u00ED, o use las flechas para moverse entre categor\u00EDas.';\r\n\r\n    announceToScreenReader(announcement);\r\n  }\r\n  highlightBoxes(true);\r\n};\r\n\r\nconst restoreOriginalCard = (wordCard) => {\r\n  wordCard.classList.remove(\r\n    \"bg-gray-300\",\r\n    \"cursor-not-allowed\",\r\n    \"text-gray-400\",\r\n    \"hover:bg-gray-300\",\r\n    \"hover:scale-100\"\r\n  );\r\n  wordCard.style.border = \"\";\r\n  wordCard.classList.add(\"cursor-pointer\", \"transition\", \"duration-300\", \"hover:bg-yellow-300\", \"transform\", \"hover:scale-105\");\r\n  wordCard.addEventListener(\"click\", () => selectWordSort(wordCard));\r\n};\r\n\r\nconst removeWord = (listItem) => {\r\n\r\n  const placedItemId = listItem.getAttribute('data-activity-item');\r\n\r\n  const parentCategory = listItem.closest('[data-activity-category]');\r\n  const categoryName = parentCategory.getAttribute('data-activity-category');\r\n\r\n  const savedData = JSON.parse(localStorage.getItem('wordPlacement')) || {};\r\n  if (savedData[categoryName]) {\r\n    savedData[categoryName] = savedData[categoryName].filter(word => word !== placedItemId);\r\n    if (savedData[categoryName].length === 0) {\r\n      delete savedData[categoryName];\r\n    }\r\n    localStorage.setItem('wordPlacement', JSON.stringify(savedData));\r\n  }\r\n\r\n  let wordCard = document.querySelector(`section .word-card[data-activity-item=\"${placedItemId}\"]`);\r\n\r\n  if (wordCard) {\r\n    const newWordCard = wordCard.cloneNode(true);\r\n    wordCard.parentNode.replaceChild(newWordCard, wordCard);\r\n\r\n    newWordCard.classList.remove(\r\n      \"bg-gray-300\",\r\n      \"cursor-not-allowed\",\r\n      \"text-gray-400\",\r\n      \"hover:bg-gray-300\",\r\n      \"hover:scale-100\"\r\n    );\r\n\r\n    newWordCard.classList.add(\r\n      \"cursor-pointer\",\r\n      \"transition\",\r\n      \"duration-300\",\r\n      \"hover:bg-yellow-300\",\r\n      \"transform\",\r\n      \"hover:scale-105\"\r\n    );\r\n\r\n    newWordCard.style.border = \"\";\r\n    newWordCard.setAttribute('draggable', 'true');\r\n\r\n    // Get the section for this activity\r\n    const section = document.querySelector('section[data-section-type=\"activity_sorting\"]');\r\n    addWordCardListeners(newWordCard, section);\r\n\r\n    // Focus on the restored word card after removal\r\n    setTimeout(() => {\r\n      newWordCard.focus();\r\n      announceToScreenReader(`${newWordCard.textContent.trim()} has been returned to available options.`);\r\n    }, 100);\r\n\r\n    saveToLocalStorage();\r\n    playActivitySound('reset');\r\n  } else {\r\n    console.error(`Could not find original card with id: ${placedItemId}`);\r\n  }\r\n  listItem.remove();\r\n};\r\n\r\nexport const placeWord = (category) => {\r\n  if (!state.currentWord) {\r\n    return;\r\n  }\r\n\r\n  playActivitySound('drop');\r\n\r\n  const categoryDiv = document.querySelector(\r\n    `div[data-activity-category=\"${category}\"]`\r\n  );\r\n  const listElement = categoryDiv?.querySelector(\"section .word-list\");\r\n\r\n  if (!listElement) {\r\n    console.error(`Category \"${category}\" not found or no word list available.`);\r\n    return;\r\n  }\r\n\r\n  const wordCard = document.querySelector(\r\n    `.word-card[data-activity-item=\"${state.currentWord}\"]`\r\n  );\r\n  if (!wordCard) {\r\n    console.error(`Word card for \"${state.currentWord}\" not found.`);\r\n    return;\r\n  }\r\n\r\n  // Place the word in the category\r\n  const placedWordCard = handleWordPlacement(wordCard, listElement);\r\n\r\n  // Important: Reset the selection state immediately to prevent duplication\r\n  const currentWordText = wordCard.textContent.trim();\r\n  const categoryName = categoryDiv.getAttribute('aria-label') || categoryDiv.getAttribute('data-activity-category');\r\n  resetSelectionState();\r\n\r\n  saveToLocalStorage();\r\n\r\n  // Enhanced focus management after placement\r\n  const section = document.querySelector('section[data-section-type=\"activity_sorting\"]');\r\n\r\n  // Give the DOM time to update and use a more specific selector for unplaced cards\r\n  setTimeout(() => {\r\n    // More specific query to find genuinely available word cards\r\n    const remainingWordCards = Array.from(document.querySelectorAll('section .word-card:not(.bg-gray-300):not(.placed-word)'))\r\n      .filter(card => !card.closest('.category')); // Exclude cards that are inside a category container\r\n\r\n    // Count how many words are now in the category\r\n    const categoryList = listElement || categoryDiv.querySelector(\".word-list\");\r\n    const wordsInCategory = categoryList ? categoryList.children.length : 0;\r\n\r\n    // Build the announcement message\r\n    let announcement = '';\r\n\r\n    // First announce the placement\r\n    announcement += `${currentWordText} colocado en ${categoryName}. `;\r\n\r\n    // Add category content information\r\n    if (wordsInCategory === 1) {\r\n      announcement += `Esta es la primera palabra en esta categor\u00EDa. `;\r\n    } else {\r\n      announcement += `Hay ${wordsInCategory} palabras en esta categor\u00EDa. `;\r\n    }\r\n\r\n    // Check if this was the last word being placed\r\n    if (remainingWordCards.length === 0) {\r\n      // All words placed - focus should go directly to submit button if available\r\n      const submitButton = document.getElementById('submit-button');\r\n      if (submitButton) {\r\n        submitButton.focus();\r\n        announcement += \"Todas las palabras han sido colocadas. Ahora est\u00E1 enfocado el bot\u00F3n de enviar. Presione Enter para enviar sus respuestas.\";\r\n        announceToScreenReader(announcement);\r\n      } else {\r\n        announcement += \"Todas las palabras han sido colocadas. Puede enviar sus respuestas ahora.\";\r\n        announceToScreenReader(announcement);\r\n      }\r\n    } else {\r\n      // Still have words to place - focus on next available word card\r\n      const nextWordCard = remainingWordCards[0];\r\n      nextWordCard.focus();\r\n\r\n      // Add information about what's next\r\n      announcement += `Ahora est\u00E1 enfocado en \"${nextWordCard.textContent.trim()}\", que es la siguiente palabra disponible.`;\r\n      announceToScreenReader(announcement);\r\n    }\r\n  }, 50); // Short delay to ensure DOM has updated\r\n};\r\n\r\n// Function to add a screen-reader-only \"next option\" button\r\nconst addNextOptionButton = (placedWordCard, nextWordCard) => {\r\n  // Get the category container\r\n  const categoryContainer = placedWordCard.closest('.category');\r\n  if (!categoryContainer) return;\r\n\r\n  // Check if we already have a \"next option\" button in this category\r\n  const existingButton = categoryContainer.querySelector('.next-option-button');\r\n  if (existingButton) {\r\n    existingButton.remove(); // Remove any existing button before adding a new one\r\n  }\r\n\r\n  // Remove any existing \"next option\" buttons from other categories\r\n  document.querySelectorAll('.next-option-button').forEach(button => {\r\n    button.remove();\r\n  });\r\n\r\n  const nextButton = document.createElement('button');\r\n  nextButton.className = 'sr-only focus:not-sr-only focus:absolute focus:z-50 bg-blue-600 text-white p-2 rounded next-option-button focus:ring-2 focus:ring-blue-300';\r\n  nextButton.textContent = \"Volver a la siguiente opci\u00F3n disponible\";\r\n  nextButton.setAttribute('aria-label', \"Volver a la siguiente opci\u00F3n disponible\");\r\n\r\n  nextButton.addEventListener('click', (e) => {\r\n    e.stopPropagation(); // Prevent triggering parent events\r\n    goToNextOption(nextWordCard);\r\n  });\r\n\r\n  nextButton.addEventListener('keydown', (e) => {\r\n    if (e.key === 'Enter' || e.key === ' ') {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      goToNextOption(nextWordCard);\r\n    }\r\n  });\r\n\r\n  // Add as the first element inside the category container\r\n  //placedWordCard.parentNode.insertBefore(nextButton, placedWordCard.nextSibling);\r\n\r\n  //Check if this message is in the code.\r\n};\r\n\r\nconst goToNextOption = (nextWordCard) => {\r\n  // First remove all next option buttons\r\n  document.querySelectorAll('.next-option-button').forEach(button => {\r\n    button.remove();\r\n  });\r\n\r\n  nextWordCard.focus();\r\n  setState('currentWord', nextWordCard.getAttribute('data-activity-item'));\r\n};\r\n\r\nconst handleWordPlacement = (wordCard, listElement) => {\r\n  const clonedWordCard = wordCard.cloneNode(true);\r\n\r\n  // First append to DOM so we can find the parent category\r\n  listElement.classList.add(\"flex\", \"flex-wrap\");\r\n  listElement.appendChild(clonedWordCard);\r\n\r\n  // Now setup the card with access to parent category\r\n  setupClonedCard(clonedWordCard);\r\n\r\n  disableOriginalCard(wordCard);\r\n\r\n  return clonedWordCard; // Return the placed card so we can add buttons to it\r\n};\r\n\r\nconst setupClonedCard = (clonedCard) => {\r\n  if (clonedCard.querySelector('img')) {\r\n    setupImageCard(clonedCard);\r\n  } else {\r\n    setupTextCard(clonedCard);\r\n  }\r\n\r\n  // Enhanced styling for placed cards\r\n  clonedCard.classList.add(\r\n    'placed-word',\r\n    'max-w-40',\r\n    'm-2',\r\n    'p-2',\r\n    'cursor-pointer',\r\n    'hover:bg-red-100',  // Hover suggests removal\r\n    'bg-blue-50',        // Light blue background to indicate placement\r\n    'border-2',          // More visible border\r\n    'border-blue-300',   // Blue border to indicate successful placement\r\n    'rounded-md',        // Rounded corners\r\n    'shadow-sm',         // Subtle shadow\r\n    'transition-all'     // Smooth transitions for hover effects\r\n  );\r\n\r\n  // Add role and aria attributes for screen readers\r\n  clonedCard.setAttribute('draggable', 'false');\r\n  clonedCard.setAttribute('tabindex', '0');\r\n  clonedCard.setAttribute('role', 'option');\r\n  clonedCard.setAttribute('aria-selected', 'false');\r\n\r\n  // Get category name for more descriptive aria-label\r\n  const parentCategory = clonedCard.closest('.category');\r\n  let categoryName = '';\r\n  if (parentCategory) {\r\n    categoryName = parentCategory.getAttribute('aria-label') || parentCategory.getAttribute('data-activity-category');\r\n  }\r\n\r\n  // Enhanced aria-label with category information - strip emojis for accessibility\r\n  const cleanWordText = stripEmojisAndCleanText(clonedCard.textContent);\r\n  clonedCard.setAttribute('aria-label', `${cleanWordText} - colocado en la categor\u00EDa: ${categoryName}. Presione Enter para quitar.`);\r\n\r\n  clonedCard.addEventListener(\"click\", function () {\r\n    removeWord(this);\r\n  });\r\n\r\n  clonedCard.addEventListener(\"keydown\", function (event) {\r\n    // Allow natural tab navigation for placed words\r\n    if (event.key === 'Tab') {\r\n      // Exit any current category navigation mode\r\n      if (state.inCategoryNavigation) {\r\n        state.inCategoryNavigation = false;\r\n        resetSelectionState();\r\n      }\r\n      // Let the browser handle natural tab navigation\r\n      return;\r\n    }\r\n\r\n    // Handle arrow navigation for placed words\r\n    if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' ||\r\n      event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n      const section = document.querySelector('section[data-section-type=\"activity_sorting\"]');\r\n      handleAllElementsArrowNavigation(event.key, this, section);\r\n      return;\r\n    }\r\n\r\n    if (event.key === 'Enter' || event.key === ' ') {\r\n      event.preventDefault();\r\n      event.stopPropagation(); // Stop the event from bubbling up to the category\r\n      removeWord(this);\r\n    }\r\n  });\r\n};\r\n\r\nconst setupTextCard = (card) => {\r\n  const textWrapper = document.createElement('div');\r\n  textWrapper.classList.add(\r\n    'text-wrapper',\r\n    'flex',\r\n    'items-center',\r\n    'justify-center',\r\n    'w-full'\r\n  );\r\n\r\n  while (card.firstChild) {\r\n    textWrapper.appendChild(card.firstChild);\r\n  }\r\n  card.appendChild(textWrapper);\r\n};\r\n\r\nconst disableOriginalCard = (wordCard) => {\r\n  if (!wordCard.classList.contains(\"placed-word\")) {\r\n    wordCard.classList.add(\r\n      \"bg-gray-300\",\r\n      \"cursor-not-allowed\",\r\n      \"text-gray-400\",\r\n      \"hover:bg-gray-300\",\r\n      \"hover:scale-100\"\r\n    );\r\n    wordCard.style.border = \"none\";\r\n    wordCard.classList.remove(\"selected\", \"shadow-lg\");\r\n    wordCard.removeEventListener(\"click\", () => selectWordSort(wordCard));\r\n  }\r\n};\r\n\r\nconst setupImageCard = (card) => {\r\n  const contentContainer = document.createElement('div');\r\n  contentContainer.classList.add(\r\n    'content-container',\r\n    'flex',\r\n    'flex-col',\r\n    'items-center',\r\n    'w-full',\r\n    'space-y-2'\r\n  );\r\n\r\n  const textWrapper = document.createElement('div');\r\n  textWrapper.classList.add(\r\n    'text-wrapper',\r\n    'flex',\r\n    'items-center',\r\n    'justify-center'\r\n  );\r\n\r\n  const image = card.querySelector('img');\r\n  const text = card.querySelector('.word-text, span:not(.validation-mark)');\r\n\r\n  if (image) {\r\n    image.setAttribute('draggable', 'false');\r\n    image.style.pointerEvents = 'none';\r\n    contentContainer.appendChild(image);\r\n  }\r\n  if (text) {\r\n    textWrapper.appendChild(text);\r\n  }\r\n  contentContainer.appendChild(textWrapper);\r\n\r\n  while (card.firstChild) {\r\n    card.removeChild(card.firstChild);\r\n  }\r\n  card.appendChild(contentContainer);\r\n};\r\n\r\n\r\nconst resetSelectionState = () => {\r\n  setState('currentWord', \"\");\r\n  highlightBoxes(false);\r\n};\r\n\r\n// Remaining sorting activity functions...\r\nexport const allowDrop = (event) => {\r\n  event.preventDefault();\r\n};\r\n\r\nexport const dropSort = (event) => {\r\n  event.preventDefault();\r\n  const data = event.dataTransfer.getData(\"text\");\r\n  setState('currentWord', data);\r\n  const category = event.target.closest(\".category\").dataset.activityCategory;\r\n\r\n  playActivitySound('drop');\r\n  placeWord(category);\r\n  highlightBoxes(false);\r\n};\r\n\r\n\r\nexport function checkSorting() {\r\n  const feedbackElement = document.getElementById(\"feedback\");\r\n  const toast = document.getElementById(\"toast\");\r\n  const activityId = location.pathname\r\n    .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n    .split(\".\")[0];\r\n\r\n  let correctCount = 0;\r\n  let incorrectCount = 0;\r\n  let key = activityId + \"-intentos\";\r\n  let intentCount = localStorage.getItem(key);\r\n  if (intentCount === null) {\r\n    localStorage.setItem(key, \"0\");\r\n    intentCount = 0;\r\n  } else {\r\n    intentCount = parseInt(intentCount, 10);\r\n  }\r\n\r\n  intentCount++;\r\n  localStorage.setItem(key, intentCount.toString());\r\n\r\n  const categories = document.querySelectorAll('section .category');\r\n\r\n  // Process all word placements first (unchanged code)\r\n  categories.forEach(category => {\r\n    const categoryType = category.getAttribute('data-activity-category');\r\n    const placedWords = category.querySelectorAll('.placed-word');\r\n\r\n    placedWords.forEach(placedWord => {\r\n      const wordKey = placedWord.getAttribute('data-activity-item');\r\n      const correctCategory = correctAnswers[wordKey];\r\n\r\n      // Remove any existing validation marks\r\n      const existingMark = placedWord.querySelector('.validation-mark');\r\n      if (existingMark) {\r\n        existingMark.remove();\r\n      }\r\n\r\n      // Create validation mark\r\n      const mark = document.createElement('span');\r\n      mark.classList.add(\r\n        'validation-mark',\r\n        'ml-2',  // margin left for spacing\r\n        'inline-flex',\r\n        'items-center',\r\n        'text-lg'\r\n      );\r\n\r\n      // Get the current category name for screen reader feedback\r\n      const categoryName = category.getAttribute('aria-label') || category.getAttribute('data-activity-category');\r\n      // Strip emojis and clean up whitespace from word text\r\n      const wordText = stripEmojisAndCleanText(placedWord.textContent);\r\n\r\n      if (categoryType === correctCategory) {\r\n        placedWord.classList.remove('bg-red-100', 'border-red-300');\r\n        placedWord.classList.add('bg-green-100', 'border-green-300', 'border');\r\n        mark.textContent = '\u2713';\r\n        mark.classList.add('text-green-700');\r\n        correctCount++;\r\n\r\n        // Enhanced aria-label for correct placement\r\n        placedWord.setAttribute('aria-label',\r\n          `${wordText} - colocado correctamente en la categor\u00EDa: ${categoryName}. Presione Enter para quitar.`\r\n        );\r\n      } else {\r\n        placedWord.classList.remove('bg-green-100', 'border-green-300');\r\n        placedWord.classList.add('bg-red-100', 'border-red-300', 'border');\r\n        mark.textContent = '\u2717';\r\n        mark.classList.add('text-red-700');\r\n        incorrectCount++;\r\n\r\n        // Enhanced aria-label for incorrect placement - include correct category\r\n        const correctCategoryElement = document.querySelector(`[data-activity-category=\"${correctCategory}\"]`);\r\n        const correctCategoryName = correctCategoryElement ?\r\n          (correctCategoryElement.getAttribute('aria-label') || correctCategoryElement.getAttribute('data-activity-category')) :\r\n          correctCategory;\r\n\r\n        placedWord.setAttribute('aria-label',\r\n          `${wordText} - colocado incorrectamente en la categor\u00EDa: ${categoryName}. Deber\u00EDa estar en: ${correctCategoryName}. Presione Enter para quitar.`\r\n        );\r\n      }\r\n\r\n      // Handle different card layouts based on content\r\n      if (placedWord.querySelector('img')) {\r\n        // Cards with images: Create structured layout\r\n        let contentContainer = placedWord.querySelector('.content-container');\r\n        if (!contentContainer) {\r\n          contentContainer = document.createElement('div');\r\n          contentContainer.classList.add(\r\n            'content-container',\r\n            'flex',\r\n            'flex-col',\r\n            'items-center',\r\n            'w-full',\r\n            'space-y-2'\r\n          );\r\n\r\n          // Move existing content into container\r\n          while (placedWord.firstChild) {\r\n            contentContainer.appendChild(placedWord.firstChild);\r\n          }\r\n          placedWord.appendChild(contentContainer);\r\n        }\r\n\r\n        // Create/update text wrapper\r\n        let textWrapper = placedWord.querySelector('.text-wrapper');\r\n        if (!textWrapper) {\r\n          textWrapper = document.createElement('div');\r\n          textWrapper.classList.add(\r\n            'text-wrapper',\r\n            'flex',\r\n            'items-center',\r\n            'justify-center'\r\n          );\r\n\r\n          // Move the text element into the wrapper\r\n          const textElement = contentContainer.querySelector('.word-text, span:not(.validation-mark)');\r\n          if (textElement) {\r\n            textWrapper.appendChild(textElement);\r\n          }\r\n          contentContainer.appendChild(textWrapper);\r\n        }\r\n\r\n        // Add the mark to the text wrapper\r\n        textWrapper.appendChild(mark);\r\n\r\n      } else {\r\n        // For text-only or text+icon cards: Simpler inline layout\r\n        let textWrapper = placedWord.querySelector('.text-wrapper');\r\n        if (!textWrapper) {\r\n          textWrapper = document.createElement('div');\r\n          textWrapper.classList.add(\r\n            'text-wrapper',\r\n            'flex',\r\n            'items-center',\r\n            'justify-center',\r\n            'w-full'\r\n          );\r\n\r\n          // Move all existing content to the wrapper\r\n          while (placedWord.firstChild) {\r\n            textWrapper.appendChild(placedWord.firstChild);\r\n          }\r\n          placedWord.appendChild(textWrapper);\r\n        }\r\n\r\n        // Add the mark after the content\r\n        textWrapper.appendChild(mark);\r\n      }\r\n\r\n      // Ensure proper spacing and layout\r\n      placedWord.classList.add('p-2', 'rounded');\r\n\r\n      // Add a slight delay and then announce the validation result to screen reader\r\n      setTimeout(() => {\r\n        if (categoryType === correctCategory) {\r\n          announceToScreenReader(`${wordText} est\u00E1 correctamente colocado en ${categoryName}.`);\r\n        } else {\r\n          const correctCategoryElement = document.querySelector(`[data-activity-category=\"${correctCategory}\"]`);\r\n          const correctCategoryName = correctCategoryElement ?\r\n            (correctCategoryElement.getAttribute('aria-label') || correctCategoryElement.getAttribute('data-activity-category')) :\r\n            correctCategory;\r\n          announceToScreenReader(`${wordText} est\u00E1 incorrectamente colocado. Deber\u00EDa estar en ${correctCategoryName}.`);\r\n        }\r\n      }, 100 * (correctCount + incorrectCount)); // Stagger announcements\r\n    });\r\n  });\r\n\r\n  const totalPlacedWords = document.querySelectorAll('section .placed-word').length;\r\n  const totalWords = Object.keys(correctAnswers).length;\r\n  const allWordsPlaced = totalPlacedWords === totalWords;\r\n  const allCorrect = correctCount === totalWords;\r\n\r\n  // Handle incomplete placement case with improved toast\r\n  if (!allWordsPlaced) {\r\n    const message = translateText(\"sorting-not-complete\", { cardsPlaced: totalPlacedWords, totalCards: totalWords });\r\n\r\n    // Update feedback element\r\n    feedbackElement.textContent = message;\r\n    feedbackElement.classList.remove(\"text-green-500\");\r\n    feedbackElement.classList.add(\"text-red-500\");\r\n\r\n    // Use updateSubmitButtonAndToast instead\r\n    updateSubmitButtonAndToast(\r\n      false,\r\n      translateText(\"retry\"),\r\n      ActivityTypes.SORTING,\r\n      totalWords - totalPlacedWords, // unfilledCount represents unplaced words here\r\n      {\r\n        message: message,\r\n        emoji: '\uD83E\uDD14',\r\n        toastType: 'warning',\r\n        timeout: 6000,\r\n        showCloseButton: true\r\n      }\r\n    );\r\n\r\n    playActivitySound('error');\r\n\r\n    // Add this line to update reset button visibility\r\n    if (typeof updateResetButtonVisibility === 'function') {\r\n      updateResetButtonVisibility();\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  // Handle completed activity feedback with improved toast\r\n  let feedbackMessage = translateText(\"sorting-results\", { correctCount: correctCount, incorrectCount: incorrectCount });\r\n  if (allCorrect) {\r\n    // Success handling code (unchanged)\r\n    playActivitySound('success');\r\n    const activityId = location.pathname\r\n      .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n      .split(\".\")[0];\r\n    // Activity tracking code (unchanged)\r\n    const storedActivities = localStorage.getItem(\"completedActivities\");\r\n    let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n    const namePage = localStorage.getItem(\"namePage\");\r\n    const timeDone = new Date().toLocaleString(\"es-ES\")\r\n    const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n    if (!completedActivities.includes(activityId)) {\r\n      completedActivities.push(newActivityId);\r\n      localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n    }\r\n    feedbackMessage = translateText(\"sorting-correct-answer\");\r\n    executeMail(ActivityTypes.SORTING);\r\n\r\n    // Announce overall success to screen reader\r\n    setTimeout(() => {\r\n      announceToScreenReader(`\u00A1Excelente! Todas las ${totalWords} palabras est\u00E1n correctamente colocadas.`);\r\n    }, 1000);\r\n  } else {\r\n    playActivitySound('error');\r\n    feedbackMessage = translateText(\"sorting-results\", { correctCount: correctCount, incorrectCount: incorrectCount });\r\n\r\n    // Announce overall results to screen reader\r\n    setTimeout(() => {\r\n      announceToScreenReader(`Resultados: ${correctCount} correctas, ${incorrectCount} incorrectas. Revisa las palabras marcadas con X.`);\r\n    }, 1000);\r\n  }\r\n\r\n\r\n\r\n  // Update feedback element\r\n  feedbackElement.textContent = feedbackMessage;\r\n  feedbackElement.classList.remove(\"text-red-500\", \"text-green-500\");\r\n  feedbackElement.classList.add(allCorrect ? \"text-green-500\" : \"text-red-500\");\r\n\r\n  // Keep this final call to updateSubmitButtonAndToast which now handles all toast functionality\r\n  updateSubmitButtonAndToast(\r\n    allCorrect,\r\n    allCorrect ? translateText(\"next-activity\") : translateText(\"retry\"),\r\n    ActivityTypes.SORTING,\r\n    0, // unfilledCount\r\n    {\r\n      message: feedbackMessage, // Custom message for this activity\r\n      emoji: allCorrect ? '\uD83C\uDF89' : '\uD83E\uDD14',\r\n      toastType: allCorrect ? 'success' : 'error', // Type of toast\r\n      timeout: 6000, // Custom timeout\r\n      showCloseButton: true // Show close button\r\n    }\r\n  );\r\n}\r\n\r\nconst saveToLocalStorage = () => {\r\n\r\n  const categories = document.querySelectorAll('[data-activity-category]');\r\n  const data = {};\r\n\r\n  categories.forEach(category => {\r\n    const categoryName = category.getAttribute('data-activity-category');\r\n    const words = [...category.querySelectorAll('.word-card')].map(word => word.dataset.activityItem);\r\n    data[categoryName] = words;\r\n  });\r\n\r\n  localStorage.setItem(activity(), JSON.stringify(data));\r\n\r\n};\r\n\r\n// Modify loadFromLocalStorage to handle errors gracefully\r\nconst loadFromLocalStorage = () => {\r\n  try {\r\n    const savedDataRaw = localStorage.getItem(activity());\r\n    if (!savedDataRaw) return;\r\n\r\n    let savedData = {};\r\n    try {\r\n      savedData = JSON.parse(savedDataRaw);\r\n    } catch (error) {\r\n      console.error(\"Error parsing saved sorting data:\", error);\r\n      return;\r\n    }\r\n\r\n    if (!savedData || Object.keys(savedData).length === 0) return;\r\n\r\n    Object.entries(savedData).forEach(([category, words]) => {\r\n      const categoryDiv = document.querySelector(`div[data-activity-category=\"${category}\"]`);\r\n      if (!categoryDiv) return;\r\n\r\n      if (Array.isArray(words)) {\r\n        words.forEach(word => {\r\n          const wordCard = document.querySelector(`.word-card[data-activity-item=\"${word}\"]`);\r\n          if (wordCard && state.currentWord !== word) {\r\n            // Set current word temporarily\r\n            const previousWord = state.currentWord;\r\n            setState('currentWord', word);\r\n\r\n            // Place the word silently (without sound)\r\n            placeWordSilently(category);\r\n\r\n            // Restore previous word\r\n            setState('currentWord', previousWord);\r\n          }\r\n        });\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error loading sorting data:\", error);\r\n  }\r\n};\r\n\r\n// Add a silent version of placeWord that doesn't play sounds\r\nconst placeWordSilently = (category) => {\r\n  if (!state.currentWord) return;\r\n\r\n  const categoryDiv = document.querySelector(\r\n    `div[data-activity-category=\"${category}\"]`\r\n  );\r\n  const listElement = categoryDiv?.querySelector(\".word-list\");\r\n\r\n  if (!listElement) return;\r\n\r\n  const wordCard = document.querySelector(\r\n    `.word-card[data-activity-item=\"${state.currentWord}\"]`\r\n  );\r\n  if (!wordCard) return;\r\n\r\n  // Place the word in the category\r\n  const placedWordCard = handleWordPlacement(wordCard, listElement);\r\n\r\n  // Reset selection state\r\n  resetSelectionState();\r\n\r\n  // Don't call saveToLocalStorage() here to prevent circular saves\r\n};\r\n\r\n// Add arrow navigation functions for word cards and categories\r\nconst handleWordCardArrowNavigation = (key, currentWordCard, section) => {\r\n  // Get only available (unplaced) word cards that are not inside categories\r\n  const availableWordCards = Array.from(section.querySelectorAll('.word-card:not(.bg-gray-300):not(.placed-word)'))\r\n    .filter(card => !card.closest('.category')); // Exclude cards that are inside categories\r\n\r\n  if (availableWordCards.length <= 1) return;\r\n\r\n  const currentIndex = availableWordCards.indexOf(currentWordCard);\r\n  let nextIndex;\r\n\r\n  switch (key) {\r\n    case 'ArrowLeft':\r\n    case 'ArrowUp':\r\n      nextIndex = (currentIndex - 1 + availableWordCards.length) % availableWordCards.length;\r\n      break;\r\n    case 'ArrowRight':\r\n    case 'ArrowDown':\r\n      nextIndex = (currentIndex + 1) % availableWordCards.length;\r\n      break;\r\n  }\r\n\r\n  if (availableWordCards[nextIndex]) {\r\n    availableWordCards[nextIndex].focus();\r\n  }\r\n};\r\n\r\nconst handleCategoryArrowNavigation = (key, currentCategory, section) => {\r\n  const allCategories = Array.from(section.querySelectorAll('section .category'));\r\n  if (allCategories.length <= 1) return;\r\n\r\n  const currentIndex = allCategories.indexOf(currentCategory);\r\n  let nextIndex;\r\n\r\n  switch (key) {\r\n    case 'ArrowLeft':\r\n    case 'ArrowUp':\r\n      nextIndex = (currentIndex - 1 + allCategories.length) % allCategories.length;\r\n      break;\r\n    case 'ArrowRight':\r\n    case 'ArrowDown':\r\n      nextIndex = (currentIndex + 1) % allCategories.length;\r\n      break;\r\n  }\r\n\r\n  if (allCategories[nextIndex]) {\r\n    const nextCategory = allCategories[nextIndex];\r\n    nextCategory.focus();\r\n\r\n    // If in word placement mode, provide more context about the category\r\n    if (state.currentWord) {\r\n      const categoryName = nextCategory.getAttribute('aria-label') || nextCategory.getAttribute('data-activity-category');\r\n      const placedCards = nextCategory.querySelectorAll('.placed-word');\r\n      const placedCount = placedCards.length;\r\n\r\n      let announcement = `Categor\u00EDa: ${categoryName}. `;\r\n\r\n      // Add information about the selected word\r\n      const selectedWordCard = document.querySelector(`.word-card[data-activity-item=\"${state.currentWord}\"]`);\r\n      const selectedWordText = selectedWordCard ? selectedWordCard.textContent.trim() : 'Palabra seleccionada';\r\n\r\n      announcement += `Palabra seleccionada: ${selectedWordText}. `;\r\n\r\n      // Add information about the category contents\r\n      if (placedCount === 0) {\r\n        announcement += `No hay palabras colocadas aqu\u00ED. `;\r\n      } else {\r\n        // Add information about what's already in the category\r\n        announcement += `Ya contiene ${placedCount} palabra${placedCount !== 1 ? 's' : ''}: `;\r\n        const cardNames = Array.from(placedCards).map(card => card.textContent.trim());\r\n        announcement += `${cardNames.join(', ')}. `;\r\n      }\r\n\r\n      announcement += 'Presione Enter para colocar la palabra aqu\u00ED.';\r\n\r\n      announceToScreenReader(announcement);\r\n    }\r\n  }\r\n};", "import { state, setState } from '../state.js';\r\nimport { playActivitySound } from '../audio.js';\r\nimport { updateSubmitButtonAndToast } from '../utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { ActivityTypes } from '../utils.js';\r\nimport { executeMail } from './send-email.js';\r\n\r\nconst applyCardStyling = (card, isInDropzone = false) => {\r\n    // Basic styling for all cards - now with scale effect for all cards\r\n    card.classList.add(\"hover:bg-yellow-300\", \"hover:scale-105\", \"transition-transform\", \"duration-200\");\r\n\r\n    // Additional styling only for cards in dropzones\r\n    if (isInDropzone) {\r\n        card.classList.add(\"placed-in-dropzone\");\r\n        card.classList.add(\"hover:shadow-md\");\r\n        card.setAttribute(\"title\", translateText(\"click-to-remove\"));\r\n    }\r\n};\r\n\r\nexport const prepareMatching = (section) => {\r\n    setupWordButtons(section);\r\n    setupDropzones(section);\r\n    setupDragListeners();\r\n};\r\n\r\nconst setupWordButtons = (section) => {\r\n    const wordButtons = section.querySelectorAll(\".activity-item\");\r\n    wordButtons.forEach((button) => {\r\n        button.addEventListener(\"click\", () => selectWord(button));\r\n        button.addEventListener(\"dragstart\", (event) => drag(event));\r\n        button.addEventListener(\"keydown\", (event) => handleWordButtonKeydown(event, button));\r\n        button.setAttribute(\"tabindex\", \"0\");\r\n        button.style.cursor = \"pointer\";\r\n\r\n        // Apply card styling (which now includes scale effect)\r\n        applyCardStyling(button);\r\n    });\r\n};\r\n\r\nconst setupDropzones = (section) => {\r\n    const dropzones = section.querySelectorAll(\".dropzone\");\r\n    dropzones.forEach((dropzone) => {\r\n        dropzone.addEventListener(\"click\", () => dropWord(dropzone.id));\r\n        dropzone.addEventListener(\"drop\", (event) => drop(event));\r\n        dropzone.addEventListener(\"dragover\", (event) => allowDrop(event));\r\n        dropzone.addEventListener(\"keydown\", (event) => handleDropzoneKeydown(event, dropzone));\r\n        dropzone.setAttribute(\"tabindex\", \"0\");\r\n        dropzone.style.cursor = \"pointer\";\r\n    });\r\n};\r\n\r\nconst setupDragListeners = () => {\r\n    const activityItems = document.querySelectorAll(\".activity-item\");\r\n    activityItems.forEach(item => {\r\n        item.addEventListener(\"click\", (event) => {\r\n            const dropzone = event.target.closest(\".dropzone\");\r\n            if (dropzone) {\r\n                // If card is already in a dropzone, remove it and return to original position\r\n                returnCardToOriginalPosition(event.target);\r\n\r\n                // Also clear the localStorage entry for this card\r\n                removeDropzoneStateForWord(event.target.getAttribute(\"data-activity-item\"));\r\n            } else {\r\n                // Regular selection behavior for cards not in dropzones\r\n                selectWord(event.target);\r\n            }\r\n        });\r\n\r\n        // Update keydown handler for accessibility as well\r\n        item.addEventListener(\"keydown\", (event) => {\r\n            if (event.key === \"Enter\" || event.key === \" \") {\r\n                event.preventDefault();\r\n                const dropzone = event.target.closest(\".dropzone\");\r\n                if (dropzone) {\r\n                    // Remove card on Enter/Space key if already in a dropzone\r\n                    returnCardToOriginalPosition(event.target);\r\n                    removeDropzoneStateForWord(event.target.getAttribute(\"data-activity-item\"));\r\n                } else {\r\n                    selectWord(event.target);\r\n                }\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\nconst handleWordButtonKeydown = (event, button) => {\r\n    if (event.key === \"Enter\" || event.key === \" \") {\r\n        event.preventDefault();\r\n        selectWord(button);\r\n    }\r\n};\r\n\r\nconst handleDropzoneKeydown = (event, dropzone) => {\r\n    if (event.key === \"Enter\" || event.key === \" \") {\r\n        event.preventDefault();\r\n        dropWord(dropzone.id);\r\n    }\r\n};\r\n\r\nexport const selectWord = (button) => {\r\n    // If a word is already selected, deselect it\r\n    if (state.selectedWord) {\r\n        state.selectedWord.classList.remove(\"border-4\", \"border-blue-500\");\r\n    }\r\n\r\n    // Mark the current word as selected\r\n    button.classList.add(\"border-4\", \"border-blue-500\");\r\n    setState('selectedWord', button);\r\n};\r\n\r\nexport const dropWord = (dropzoneId) => {\r\n    if (!state.selectedWord) return;\r\n\r\n    const target = document.getElementById(dropzoneId).querySelector(\"div[role='region']\");\r\n    const existingWord = target.querySelector(\".activity-item\");\r\n\r\n    if (existingWord) {\r\n        handleDropExchange(existingWord, state.selectedWord, target);\r\n        // Save to localStorage\r\n        saveDropzoneState(dropzoneId, state.selectedWord);\r\n        state.selectedWord.classList.remove(\"border-4\", \"border-blue-500\");\r\n        setState('selectedWord', null);\r\n        playActivitySound('drop');\r\n        return; // Exit early\r\n    }\r\n\r\n    // Check if selectedWord is already in a wrapper from another dropzone\r\n    const currentWrapper = state.selectedWord.parentElement;\r\n    if (currentWrapper && (currentWrapper.classList.contains('relative') || currentWrapper.classList.contains('inline-block'))) {\r\n        // Get reference to the card before removing the wrapper\r\n        const card = state.selectedWord;\r\n\r\n        // Remove the wrapper\r\n        currentWrapper.parentElement.removeChild(currentWrapper);\r\n\r\n        // Update the selectedWord reference to the card\r\n        state.selectedWord = card;\r\n    }\r\n\r\n    // No need for wrapper anymore, just add the card directly to target\r\n    target.appendChild(state.selectedWord);\r\n\r\n    // Apply card styling for dropzone\r\n    applyCardStyling(state.selectedWord, true);\r\n\r\n    // Save to localStorage\r\n    saveDropzoneState(dropzoneId, state.selectedWord);\r\n\r\n    state.selectedWord.classList.remove(\"border-4\", \"border-blue-500\");\r\n    setState('selectedWord', null);\r\n\r\n    // Play sound for successful placement\r\n    playActivitySound('drop');\r\n};\r\n\r\nexport const allowDrop = (event) => {\r\n    event.preventDefault();\r\n};\r\n\r\nexport const drag = (event) => {\r\n    event.dataTransfer.setData(\r\n        \"text\",\r\n        event.target.getAttribute(\"data-activity-item\")\r\n    );\r\n};\r\n\r\nexport const drop = (event) => {\r\n    event.preventDefault();\r\n    const data = event.dataTransfer.getData(\"text\");\r\n    const target = event.currentTarget.querySelector(\"div[role='region']\");\r\n    let wordElement = document.querySelector(`.activity-item[data-activity-item='${data}']`);\r\n    const existingWord = target.querySelector(\".activity-item\");\r\n\r\n    // Check if the dropped element is the same as the existing element in the target\r\n    if (existingWord && existingWord === wordElement) {\r\n        return;\r\n    }\r\n\r\n    if (existingWord) {\r\n        handleDropExchange(existingWord, wordElement, target);\r\n        // Save to localStorage\r\n        saveDropzoneState(event.currentTarget.id, wordElement);\r\n        return; // Exit early since handleDropExchange did all the work\r\n    }\r\n\r\n    // Check if wordElement is already in a wrapper from another dropzone\r\n    const currentWrapper = wordElement.parentElement;\r\n    if (currentWrapper && (currentWrapper.classList.contains('relative') || currentWrapper.classList.contains('inline-block'))) {\r\n        // Get reference to the card before removing the wrapper\r\n        const card = wordElement;\r\n\r\n        // Remove the wrapper\r\n        currentWrapper.parentElement.removeChild(currentWrapper);\r\n\r\n        // Update the wordElement reference to the card\r\n        wordElement = card;\r\n    }\r\n\r\n    // No need for wrapper, add card directly to target\r\n    target.appendChild(wordElement);\r\n\r\n    // Apply card styling for dropzone\r\n    applyCardStyling(wordElement, true);\r\n\r\n    // Save to localStorage\r\n    saveDropzoneState(event.currentTarget.id, wordElement);\r\n\r\n    // Play sound feedback\r\n    playActivitySound('drop');\r\n};\r\n\r\n// Funci\u00F3n para obtener la clave \u00FAnica de la actividad\r\nconst getActivityLocalStorageKey = () => {\r\n    const activityElement = document.querySelector('[data-aria-id]');\r\n    if (!activityElement) {\r\n        return null;\r\n    }\r\n\r\n    const activity = activityElement.getAttribute('data-aria-id');\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n\r\n    return `${activityId}_${activity}`;\r\n};\r\n\r\nconst saveDropzoneState = (dropzoneId, wordElement) => {\r\n    const localStorageKey = getActivityLocalStorageKey();\r\n\r\n    let storedData = JSON.parse(localStorage.getItem(localStorageKey)) || {};\r\n\r\n    const wordId = wordElement.getAttribute(\"data-activity-item\") || wordElement.getAttribute(\"data-id\");\r\n\r\n    const dropzone = document.getElementById(dropzoneId);\r\n\r\n\r\n    Object.keys(storedData).forEach(zoneId => {\r\n        storedData[zoneId] = storedData[zoneId].filter(item => item !== wordId);\r\n        if (storedData[zoneId].length === 0) delete storedData[zoneId];\r\n    });\r\n\r\n    storedData[dropzoneId] = [wordId];\r\n\r\n    localStorage.setItem(localStorageKey, JSON.stringify(storedData));\r\n};\r\n\r\n// Add this new function to remove a word from localStorage\r\nconst removeDropzoneStateForWord = (wordId) => {\r\n    const localStorageKey = getActivityLocalStorageKey();\r\n    let storedData = JSON.parse(localStorage.getItem(localStorageKey)) || {};\r\n\r\n    // Find and remove the word from any dropzone where it exists\r\n    Object.keys(storedData).forEach(dropzoneId => {\r\n        storedData[dropzoneId] = storedData[dropzoneId].filter(item => item !== wordId);\r\n        // Remove the dropzone entry if it's now empty\r\n        if (storedData[dropzoneId].length === 0) {\r\n            delete storedData[dropzoneId];\r\n        }\r\n    });\r\n\r\n    localStorage.setItem(localStorageKey, JSON.stringify(storedData));\r\n};\r\n\r\nexport const loadDropzoneState = () => {\r\n    const storedDataRaw = localStorage.getItem(getActivityLocalStorageKey());\r\n    let storedData = {};\r\n    if (storedDataRaw) {\r\n        try {\r\n            storedData = JSON.parse(storedDataRaw);\r\n        } catch (error) {\r\n            return;\r\n        }\r\n    }\r\n\r\n    Object.entries(storedData).forEach(([dropzoneId, words]) => {\r\n        let dropzone = document.querySelector(`#${dropzoneId}`);\r\n\r\n        if (!dropzone) {\r\n            return;\r\n        }\r\n\r\n        const target = dropzone.querySelector(\"div[role='region']\");\r\n\r\n        words.forEach(wordId => {\r\n            let wordElement = document.querySelector(`.activity-item[data-activity-item='${wordId}'], .activity-item[data-id='${wordId}']`);\r\n\r\n            if (!wordElement) {\r\n                return;\r\n            }\r\n\r\n            // Apply card styling for hover effect\r\n            applyCardStyling(wordElement);\r\n\r\n            // Check if wordElement is already in a wrapper from another dropzone\r\n            const currentWrapper = wordElement.parentElement;\r\n            if (currentWrapper && (currentWrapper.classList.contains('relative') || currentWrapper.classList.contains('inline-block'))) {\r\n                // Get reference to the card before removing the wrapper\r\n                const card = wordElement;\r\n\r\n                // Remove the wrapper\r\n                currentWrapper.parentElement.removeChild(currentWrapper);\r\n\r\n                // Update the wordElement reference to the card\r\n                wordElement = card;\r\n            }\r\n\r\n            if (!target.contains(wordElement)) {\r\n                // Add card directly to target without wrapper\r\n                target.appendChild(wordElement);\r\n\r\n                // Apply card styling for dropzone\r\n                applyCardStyling(wordElement, true);\r\n            }\r\n        });\r\n    });\r\n};\r\n\r\n//  load data the localstorage\r\nloadDropzoneState();\r\n\r\n\r\n\r\nconst handleDropExchange = (existingWord, newWordElement, target) => {\r\n    // First, check if newWordElement is in a dropzone\r\n    const newWordDropzone = newWordElement.closest(\".dropzone\");\r\n    const isNewWordInDropzone = newWordDropzone !== null && newWordDropzone !== target.closest(\".dropzone\");\r\n\r\n    if (isNewWordInDropzone) {\r\n        // Get the parent containers for both cards\r\n        const newWordRegion = newWordDropzone.querySelector(\"div[role='region']\");\r\n\r\n        // Perform the exchange directly\r\n\r\n        // 1. Remove both cards from their current positions\r\n        if (newWordElement.parentNode) {\r\n            newWordElement.parentNode.removeChild(newWordElement);\r\n        }\r\n\r\n        if (existingWord.parentNode) {\r\n            existingWord.parentNode.removeChild(existingWord);\r\n        }\r\n\r\n        // 2. Add them to their new positions\r\n        target.appendChild(newWordElement);\r\n        newWordRegion.appendChild(existingWord);\r\n\r\n        // 3. Apply styling to both cards\r\n        applyCardStyling(existingWord, true);\r\n        applyCardStyling(newWordElement, true);\r\n\r\n        // 4. Update localStorage for both dropzones\r\n        const targetDropzoneId = target.closest('.dropzone').id;\r\n        const sourceDropzoneId = newWordDropzone.id;\r\n\r\n        // Save the new positions in localStorage\r\n        saveDropzoneState(targetDropzoneId, newWordElement);\r\n        saveDropzoneState(sourceDropzoneId, existingWord);\r\n\r\n        // Play sound for successful swap\r\n        playActivitySound('drop');\r\n    } else {\r\n        // Original scenario - new word is coming from outside any dropzone\r\n        const originalContainer = document.querySelector(\".original-word-list\") ||\r\n            document.querySelector(\".grid:not(.dropzone)\");\r\n\r\n        // Move the existing card to the original container\r\n        originalContainer.appendChild(existingWord);\r\n\r\n        // Clean up classes from the card that's going back to original container\r\n        existingWord.classList.remove(\r\n            \"placed-in-dropzone\",\r\n            \"hover:scale-105\",\r\n            \"transition-transform\",\r\n            \"duration-200\",\r\n            \"hover:shadow-md\"\r\n        );\r\n\r\n        // Apply card styling for hover effect\r\n        applyCardStyling(existingWord);\r\n\r\n        // Add the new element to the target\r\n        target.appendChild(newWordElement);\r\n\r\n        // Apply card styling for dropzone\r\n        applyCardStyling(newWordElement, true);\r\n\r\n        // Save to localStorage \r\n        const targetDropzoneId = target.closest('.dropzone').id;\r\n        saveDropzoneState(targetDropzoneId, newWordElement);\r\n\r\n        // Remove the original card from any dropzone storage\r\n        removeDropzoneStateForWord(existingWord.getAttribute(\"data-activity-item\"));\r\n    }\r\n};\r\n\r\nconst returnCardToOriginalPosition = (card) => {\r\n    // First, find the original list container\r\n    const originalParent = document.querySelector(\".original-word-list\") ||\r\n        document.querySelector(\".grid:not(.dropzone)\");\r\n\r\n    if (originalParent && card) {\r\n        // Remove Tailwind styling classes - but preserve hover and scale effects\r\n        card.classList.remove(\r\n            \"border-4\",\r\n            \"border-blue-500\",\r\n            \"placed-in-dropzone\",\r\n            \"hover:shadow-md\"\r\n        );\r\n\r\n        // Make sure we don't remove these classes\r\n        // \"hover:bg-yellow-300\", \"hover:scale-105\", \"transition-transform\", \"duration-200\"\r\n\r\n        // Apply card styling for hover effect\r\n        applyCardStyling(card);\r\n\r\n        // If this card was the selected word, clear that state\r\n        if (state.selectedWord === card) {\r\n            setState('selectedWord', null);\r\n        }\r\n\r\n        // Move the card back to the original container\r\n        originalParent.appendChild(card);\r\n\r\n        // Play a sound effect for feedback\r\n        playActivitySound('click');\r\n    }\r\n};\r\n\r\nexport const checkMatching = () => {\r\n    let correctCount = 0;\r\n    resetDropzones();\r\n\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    Object.keys(correctAnswers).forEach((item) => {\r\n        const wordElement = document.querySelector(\r\n            `.activity-item[data-activity-item='${item}']`\r\n        );\r\n\r\n        if (wordElement) {\r\n            const parentDropzone = wordElement.closest(\".dropzone\");\r\n            handleDropzoneValidation(parentDropzone, item, correctAnswers[item], () => correctCount++);\r\n        }\r\n    });\r\n\r\n    updateFeedback(correctCount);\r\n};\r\n\r\nconst resetDropzones = () => {\r\n    // Remove background colors from dropzones if any\r\n    const dropzones = document.querySelectorAll(\".dropzone\");\r\n    dropzones.forEach((dropzone) => {\r\n        dropzone.classList.remove(\"bg-green-200\", \"bg-red-200\");\r\n    });\r\n\r\n    // Remove all validation marks\r\n    removeValidationIcons();\r\n\r\n    // Reset card styles but preserve original styling\r\n    const cards = document.querySelectorAll('.activity-item');\r\n    cards.forEach(card => {\r\n        // Only remove the validation-specific classes\r\n        card.classList.remove(\r\n            'border',\r\n            'border-green-300',\r\n            'border-red-300'\r\n        );\r\n    });\r\n};\r\n\r\nconst removeValidationIcons = () => {\r\n    const validationElements = document.querySelectorAll('.validation-icon, .validation-mark');\r\n    validationElements.forEach(el => el.remove());\r\n};\r\n\r\nconst handleDropzoneValidation = (parentDropzone, item, correctAnswer, onCorrect) => {\r\n    if (parentDropzone) {\r\n        const wordElement = parentDropzone.querySelector(`.activity-item[data-activity-item='${item}']`);\r\n        const isCorrect = parentDropzone.querySelector(\"div[role='region']\").id === correctAnswer;\r\n\r\n        if (wordElement) {\r\n            // Remove any existing validation icons\r\n            const existingIcon = wordElement.querySelector('.validation-icon, .validation-mark');\r\n            if (existingIcon) {\r\n                existingIcon.remove();\r\n            }\r\n\r\n            // Don't change the background color of the card\r\n            // Only add a subtle border to make the validation mark stand out\r\n            if (isCorrect) {\r\n                wordElement.classList.add('border', 'border-green-300');\r\n                onCorrect();\r\n            } else {\r\n                wordElement.classList.add('border', 'border-red-300');\r\n            }\r\n\r\n            // Create the mark as an inline element rather than absolutely positioned\r\n            const mark = document.createElement('span');\r\n            mark.classList.add(\r\n                'validation-mark',\r\n                'ml-2',  // margin-left to give some space between text and mark\r\n                'inline-flex',\r\n                'align-middle',\r\n                'font-bold'\r\n            );\r\n\r\n            // Style mark based on correctness\r\n            if (isCorrect) {\r\n                mark.textContent = '\u2713';\r\n                mark.classList.add('text-green-700');\r\n            } else {\r\n                mark.textContent = '\u2717';\r\n                mark.classList.add('text-red-700');\r\n            }\r\n\r\n            // Simply append the mark to the word element's content\r\n            wordElement.appendChild(mark);\r\n        }\r\n    }\r\n};\r\n\r\nconst updateFeedback = (correctCount) => {\r\n    const feedback = document.getElementById(\"feedback\");\r\n    const totalItems = Object.keys(correctAnswers).length;\r\n    const isAllCorrect = correctCount === totalItems;\r\n\r\n\r\n    playActivitySound(isAllCorrect ? 'success' : 'error');\r\n\r\n    if (isAllCorrect) {\r\n        // Obtener el ID de la actividad desde la URL\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let key = activityId + \"-intentos\";\r\n        let intentCount = localStorage.getItem(key);\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n\r\n        executeMail(ActivityTypes.MATCHING);\r\n    }\r\n\r\n    if (feedback) {\r\n        updateFeedbackText(feedback, isAllCorrect, correctCount);\r\n    }\r\n\r\n    updateSubmitButtonAndToast(\r\n        isAllCorrect,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.MATCHING\r\n    );\r\n};\r\n\r\nconst updateFeedbackText = (feedback, isAllCorrect, correctCount) => {\r\n    if (isAllCorrect) {\r\n        feedback.textContent = translateText(\"matching-correct-answers\");\r\n        feedback.classList.remove(\"text-red-500\");\r\n        feedback.classList.add(\"text-green-500\");\r\n    } else {\r\n        feedback.textContent = translateText(\"matching-correct-answers-count\", {\r\n            correctCount: correctCount,\r\n        });\r\n        feedback.classList.remove(\"text-green-500\");\r\n        feedback.classList.add(\"text-red-500\");\r\n    }\r\n};\r\n\r\nexport const resetActivity = () => {\r\n    // Get original container to return all cards to\r\n    const originalContainer = document.querySelector(\".original-word-list\") ||\r\n        document.querySelector(\".grid:not(.dropzone)\");\r\n\r\n    if (!originalContainer) return;\r\n\r\n    // Find all cards in dropzones\r\n    const cardsInDropzones = document.querySelectorAll(\".dropzone .activity-item\");\r\n\r\n    // Return each card to the original container\r\n    cardsInDropzones.forEach(card => {\r\n        // Remove dropzone-specific classes\r\n        card.classList.remove(\r\n            \"border-4\",\r\n            \"border-blue-500\",\r\n            \"placed-in-dropzone\",\r\n            \"hover:shadow-md\"\r\n        );\r\n\r\n        // Re-apply basic card styling\r\n        applyCardStyling(card);\r\n\r\n        // Move the card back to the original container\r\n        originalContainer.appendChild(card);\r\n    });\r\n\r\n    // Reset dropzone styling and remove validation icons\r\n    resetDropzones();\r\n\r\n    // Clear any selected state\r\n    if (state.selectedWord) {\r\n        state.selectedWord.classList.remove(\"border-4\", \"border-blue-500\");\r\n        setState('selectedWord', null);\r\n    }\r\n\r\n    // Clear local storage for this activity\r\n    const localStorageKey = getActivityLocalStorageKey();\r\n    localStorage.removeItem(localStorageKey);  // Replace setItem with removeItem\r\n\r\n    // Reset feedback message if present\r\n    const feedback = document.getElementById(\"feedback\");\r\n    if (feedback) {\r\n        feedback.textContent = \"\";\r\n        feedback.classList.remove(\"text-red-500\", \"text-green-500\");\r\n    }\r\n\r\n    // Play sound effect\r\n    playActivitySound('click');\r\n};", "import { state, setState } from '../state.js';\r\nimport { playActivitySound } from '../audio.js';\r\nimport { updateSubmitButtonAndToast } from '../utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { ActivityTypes } from '../utils.js';\r\nimport { executeMail } from './send-email.js';\r\n\r\n\r\nexport const prepareTrueFalse = (section) => {\r\n\r\n    initializeAudio();\r\n    enhanceKeyboardAccessibility(section);\r\n    setupRadioButtons(section);\r\n};\r\n\r\nconst initializeAudio = () => {\r\n    playActivitySound(''); // Initialize audio system\r\n};\r\n\r\nif (document.getElementsByTagName(\"h1\").length < 0) {\r\n    localStorage.setItem(\"namePage\", document.getElementsByTagName(\"h2\")[0].innerText);\r\n} else if (document.getElementsByTagName(\"h1\").length > 0) {\r\n    localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n}\r\n\r\n// Inside the enhanceKeyboardAccessibility function\r\nconst enhanceKeyboardAccessibility = (section) => {\r\n    // Ensure each fieldset has the proper keyboard navigation\r\n    const fieldsets = section.querySelectorAll('fieldset');\r\n\r\n    fieldsets.forEach(fieldset => {\r\n        const radios = Array.from(fieldset.querySelectorAll('input[type=\"radio\"]'));\r\n        const legendText = fieldset.querySelector('legend span')?.textContent || '';\r\n\r\n        if (radios.length > 0) {\r\n            // We'll enhance all radio buttons with proper key handling\r\n            radios.forEach(radio => {\r\n                // First remove any existing listeners to avoid duplicates\r\n                const newRadio = radio.cloneNode(true);\r\n                radio.parentNode.replaceChild(newRadio, radio);\r\n\r\n                // Now add our enhanced listeners\r\n                newRadio.addEventListener('keydown', (event) => {\r\n                    // Handle Enter key for selection\r\n                    if (event.key === 'Enter') {\r\n                        event.preventDefault();\r\n                        newRadio.checked = true;\r\n\r\n                        // Announce the selection with question context\r\n                        announceSelectionWithContext(newRadio, legendText);\r\n\r\n                        // Trigger change event\r\n                        const changeEvent = new Event('change', { bubbles: true });\r\n                        newRadio.dispatchEvent(changeEvent);\r\n                    }\r\n\r\n                    // Handle arrow keys\r\n                    if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' ||\r\n                        event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n\r\n                        event.preventDefault(); // Prevent default scroll behavior\r\n                        event.stopPropagation(); // Prevent bubbling to page navigation\r\n\r\n                        let nextIndex;\r\n                        const currentIndex = radios.indexOf(newRadio);\r\n\r\n                        // Determine which radio button to focus next\r\n                        if (event.key === 'ArrowLeft' || event.key === 'ArrowUp') {\r\n                            nextIndex = currentIndex === 0 ? radios.length - 1 : currentIndex - 1;\r\n                        } else {\r\n                            nextIndex = currentIndex === radios.length - 1 ? 0 : currentIndex + 1;\r\n                        }\r\n\r\n                        // Focus and select the next radio button\r\n                        radios[nextIndex].focus();\r\n                        radios[nextIndex].checked = true;\r\n\r\n                        // Announce the selection with question context\r\n                        announceSelectionWithContext(radios[nextIndex], legendText);\r\n\r\n                        // Trigger the change event to handle any logic tied to selection\r\n                        const changeEvent = new Event('change', { bubbles: true });\r\n                        radios[nextIndex].dispatchEvent(changeEvent);\r\n                    }\r\n                });\r\n\r\n                // Also enhance the onFocus event to announce the full context\r\n                newRadio.addEventListener('focus', () => {\r\n                    // When a radio button gets focus, announce the question and current state\r\n                    const optionText = newRadio.value === 'yes' ? 'S\u00ED' : 'No';\r\n                    const isChecked = newRadio.checked ? 'seleccionado' : 'no seleccionado';\r\n\r\n                    // Find or create an announcement element\r\n                    const focusAnnouncement = document.getElementById('focus-announcement') || createFocusAnnouncement();\r\n                    focusAnnouncement.textContent = `${legendText} - Opci\u00F3n: ${optionText}, ${isChecked}`;\r\n                });\r\n            });\r\n        }\r\n    });\r\n};\r\n\r\n// Helper function to announce selection with question context\r\nconst announceSelectionWithContext = (radio, questionText) => {\r\n    const optionText = radio.value === 'yes' ? 'S\u00ED' : 'No';\r\n\r\n    // Find or create the announcement element\r\n    const announcement = document.getElementById('keyboard-action-announcement') || createKeyboardActionAnnouncement();\r\n    announcement.textContent = `${questionText} - ${optionText} seleccionado`;\r\n};\r\n\r\n// Helper to create announcement element\r\nconst createKeyboardActionAnnouncement = () => {\r\n    const announcement = document.createElement('div');\r\n    announcement.id = 'keyboard-action-announcement';\r\n    announcement.className = 'sr-only';\r\n    announcement.setAttribute('role', 'status');\r\n    announcement.setAttribute('aria-live', 'assertive');\r\n    document.body.appendChild(announcement);\r\n    return announcement;\r\n};\r\n\r\n// Helper to create focus announcement element\r\nconst createFocusAnnouncement = () => {\r\n    const announcement = document.createElement('div');\r\n    announcement.id = 'focus-announcement';\r\n    announcement.className = 'sr-only';\r\n    announcement.setAttribute('role', 'status');\r\n    announcement.setAttribute('aria-live', 'polite');\r\n    document.body.appendChild(announcement);\r\n    return announcement;\r\n};\r\n\r\nconst setupRadioButtons = (section) => {\r\n    const buttons = section.querySelectorAll(\"input[type='radio']\");\r\n\r\n    buttons.forEach((button, index) => {\r\n        restorePreviousSelection(button);\r\n        addButtonListener(button);\r\n\r\n        // Ensure label and input are properly associated\r\n        const buttonId = button.id || `tf-radio-${button.name}-${button.value}-${index}`;\r\n        button.id = buttonId;\r\n\r\n        const label = button.closest('label');\r\n        if (label) {\r\n            label.setAttribute('for', buttonId);\r\n        }\r\n    });\r\n};\r\n\r\nconst restorePreviousSelection = (button) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n\r\n\r\n    const areaId = button.closest(\"[data-area-id]\")?.getAttribute(\"data-area-id\") || \"default\";\r\n    const storageKey = `${activityId}_${areaId}_${button.name}`;\r\n\r\n\r\n    const savedSelection = localStorage.getItem(storageKey);\r\n    if (savedSelection) {\r\n        const { value } = JSON.parse(savedSelection);\r\n        if (button.value === value) {\r\n            button.checked = true; // Restaurar la selecci\u00F3n guardada\r\n        }\r\n    }\r\n};\r\n\r\nconst addButtonListener = (button) => {\r\n    button.addEventListener(\"change\", () => {\r\n        playActivitySound('drop');\r\n\r\n        // Clear validation styling when changing selection\r\n        clearFeedbackForQuestion(button.name);\r\n\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n\r\n        const areaId = button.closest(\"[data-area-id]\")?.getAttribute(\"data-area-id\") || \"default\";\r\n        const storageKey = `${activityId}_${areaId}_${button.name}`;\r\n\r\n        const selectedData = {\r\n            question: button.name,\r\n            value: button.value,\r\n            dataActivityItem: button.getAttribute(\"data-activity-item\"),\r\n            areaId: areaId\r\n        };\r\n\r\n        // Guardar en localStorage con `activityId` y `data-area-id`\r\n        localStorage.setItem(storageKey, JSON.stringify(selectedData));\r\n\r\n        setState('selectedButton', button);\r\n    });\r\n};\r\n\r\n// Add a new function to clear feedback for a specific question\r\nconst clearFeedbackForQuestion = (questionName) => {\r\n    // Find all radio buttons for this question\r\n    const radioButtons = document.querySelectorAll(`section input[name=\"${questionName}\"]`);\r\n\r\n    radioButtons.forEach(radio => {\r\n        // Get the label containing this radio button\r\n        const parentLabel = radio.closest('label');\r\n        if (!parentLabel) {\r\n            console.warn(\"No parent label found for radio button\");\r\n            return;\r\n        }\r\n\r\n        // Reset validation mark - it's inside the div, not directly under the parentLabel\r\n        const buttonDiv = parentLabel.querySelector('div');\r\n        if (buttonDiv) {\r\n            const validationMark = buttonDiv.querySelector(\".validation-mark\");\r\n            if (validationMark) {\r\n                validationMark.classList.add('hidden');\r\n                validationMark.textContent = '';\r\n            } else {\r\n                console.warn(\"No validation mark found in button div\");\r\n            }\r\n\r\n            // Reset button styling - need to remove ALL color classes\r\n            buttonDiv.classList.remove(\r\n                'bg-green-500', 'bg-red-500',\r\n                'text-white', 'text-green-700', 'text-red-700'\r\n            );\r\n\r\n            // Restore original styling\r\n            buttonDiv.classList.add('bg-gray-200');\r\n\r\n            // If this button is checked, apply the blue style\r\n            if (radio.checked) {\r\n                buttonDiv.classList.add('bg-blue-500', 'text-white');\r\n            } else {\r\n                // Make sure peer-checked styles are applied correctly\r\n                buttonDiv.classList.add('peer-checked:bg-blue-500', 'peer-checked:text-white');\r\n            }\r\n        } else {\r\n            console.warn(\"No button div found for radio\");\r\n        }\r\n\r\n        // Remove any aria attributes and screen reader feedback\r\n        parentLabel.removeAttribute('aria-invalid');\r\n        const srFeedback = parentLabel.querySelector('.sr-validation-feedback');\r\n        if (srFeedback) {\r\n            srFeedback.remove();\r\n        }\r\n    });\r\n\r\n    // Announce the change to screen readers\r\n    const announcement = document.getElementById('validation-results-announcement');\r\n    if (announcement) {\r\n        announcement.textContent = translateText('selection-changed-resubmit');\r\n    }\r\n};\r\n\r\nexport const checkTrueFalse = () => {\r\n    clearPreviousFeedback();\r\n    const allQuestions = [1, 2, 3, 4, 5];\r\n    const validationResults = validateAllQuestions(allQuestions);\r\n\r\n    playAppropriateSound(validationResults.allCorrect);\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    // Announce results to screen readers\r\n    const resultsAnnouncement = document.getElementById('validation-results-announcement') ||\r\n        createResultsAnnouncementElement();\r\n\r\n    if (validationResults.allCorrect) {\r\n        resultsAnnouncement.textContent = translateText(\"Todas las respuestas son correctas\");\r\n        // Obtener el ID de la actividad desde la URL\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n        // Recuperar el arreglo de actividades completadas del localStorage\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n\r\n        executeMail(ActivityTypes.TRUE_FALSE);\r\n\r\n    } else {\r\n        // Count incorrect answers\r\n        const incorrectCount = validationResults.incorrectQuestions?.length || 0;\r\n\r\n        if (incorrectCount > 0) {\r\n            resultsAnnouncement.textContent = translateText(\"Hay \" + incorrectCount + \" respuestas incorrectas. Por favor, revisa tus respuestas e intenta de nuevo.\");\r\n        } else {\r\n            resultsAnnouncement.textContent = translateText(\"Hay algunas respuestas sin contestar. Por favor, completa todas las preguntas.\");\r\n        }\r\n    }\r\n    updateSubmitButtonAndToast(\r\n        validationResults.allCorrect,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.TRUE_FALSE\r\n    );\r\n\r\n\r\n};\r\n\r\n// Create an element to announce results to screen readers\r\nconst createResultsAnnouncementElement = () => {\r\n    const announcementElement = document.createElement('div');\r\n    announcementElement.id = 'validation-results-announcement';\r\n    announcementElement.className = 'sr-only';\r\n    announcementElement.setAttribute('role', 'status');\r\n    announcementElement.setAttribute('aria-live', 'assertive');\r\n    document.body.appendChild(announcementElement);\r\n    return announcementElement;\r\n};\r\n\r\nconst clearPreviousFeedback = () => {\r\n    document.querySelectorAll(\".feedback\").forEach(el => el.remove());\r\n    document.querySelectorAll(\".validation-mark\").forEach(mark => {\r\n        mark.classList.add('hidden');\r\n        mark.textContent = '';\r\n    });\r\n};\r\n\r\nconst validateAllQuestions = (allQuestions) => {\r\n    let allCorrect = true;\r\n    let allAnswered = true;\r\n    const incorrectQuestions = [];\r\n\r\n    allQuestions.forEach(questionNum => {\r\n        const selectedButton = document.querySelector(\r\n            `input[name=\"question${questionNum}\"]:checked`\r\n        );\r\n\r\n        if (!selectedButton) {\r\n            allCorrect = false;\r\n            allAnswered = false;\r\n            return;\r\n        }\r\n\r\n        const validationResult = validateQuestion(selectedButton);\r\n        if (!validationResult) {\r\n            allCorrect = false;\r\n            incorrectQuestions.push(questionNum);\r\n        }\r\n    });\r\n\r\n    return { allCorrect, allAnswered, incorrectQuestions };\r\n};\r\n\r\nconst validateQuestion = (selectedButton) => {\r\n    const dataActivityItem = selectedButton.getAttribute(\"data-activity-item\");\r\n    const selectedValue = selectedButton.value;\r\n    const expectedAnswer = correctAnswers[dataActivityItem];\r\n    const isCorrect = expectedAnswer === selectedValue;\r\n\r\n    updateValidationDisplay(selectedButton, isCorrect);\r\n\r\n    return isCorrect;\r\n};\r\n\r\nconst updateValidationDisplay = (selectedButton, isCorrect) => {\r\n    const validationMark = getValidationMark(selectedButton);\r\n    if (validationMark) {\r\n        updateValidationMark(validationMark, isCorrect);\r\n    }\r\n\r\n    updateButtonStyling(selectedButton, isCorrect);\r\n\r\n    // Add accessible text for screen readers\r\n    updateScreenReaderFeedback(selectedButton, isCorrect);\r\n};\r\n\r\nconst updateScreenReaderFeedback = (button, isCorrect) => {\r\n    // Find the parent label or closest container\r\n    const parentLabel = button.closest('label');\r\n\r\n    if (parentLabel) {\r\n        // Add screen reader feedback\r\n        let srFeedback = parentLabel.querySelector('.sr-validation-feedback');\r\n\r\n        if (!srFeedback) {\r\n            srFeedback = document.createElement('span');\r\n            srFeedback.className = 'sr-only sr-validation-feedback';\r\n            parentLabel.appendChild(srFeedback);\r\n        }\r\n\r\n        srFeedback.textContent = isCorrect ?\r\n            translateText(\"Esta respuesta es correcta\") :\r\n            translateText(\"Esta respuesta es incorrecta\");\r\n    }\r\n};\r\n\r\nconst getValidationMark = (button) => {\r\n    const validationMark = button.parentElement.querySelector(\".validation-mark\");\r\n    if (validationMark) {\r\n        validationMark.classList.remove('hidden');\r\n    }\r\n    return validationMark;\r\n};\r\n\r\nconst updateValidationMark = (mark, isCorrect) => {\r\n    const baseClasses = 'text-lg font-bold bg-white rounded-full w-6 h-6 flex items-center justify-center';\r\n\r\n    if (isCorrect) {\r\n        mark.textContent = '\u2713';\r\n        mark.className = `validation-mark ${baseClasses} text-green-600`;\r\n        // Add aria-label to mark for screen readers\r\n        mark.setAttribute('aria-label', translateText(\"Respuesta correcta\"));\r\n    } else {\r\n        mark.textContent = '\u2717';\r\n        mark.className = `validation-mark ${baseClasses} text-red-600`;\r\n        // Add aria-label to mark for screen readers\r\n        mark.setAttribute('aria-label', translateText(\"Respuesta incorrecta\"));\r\n    }\r\n};\r\n\r\nconst updateButtonStyling = (button, isCorrect) => {\r\n    const buttonDiv = button.parentElement.querySelector('div');\r\n    if (buttonDiv) {\r\n        buttonDiv.classList.remove('bg-gray-200', 'bg-green-500', 'bg-red-500', 'peer-checked:bg-blue-500');\r\n        buttonDiv.classList.add(isCorrect ? 'bg-green-500' : 'bg-red-500');\r\n\r\n        // Set the proper ARIA attributes\r\n        const parentLabel = button.closest('label');\r\n        if (parentLabel) {\r\n            parentLabel.setAttribute('aria-invalid', isCorrect ? 'false' : 'true');\r\n        }\r\n    }\r\n};\r\n\r\nconst playAppropriateSound = (allCorrect) => {\r\n    playActivitySound(allCorrect ? 'success' : 'error');\r\n};\r\n\r\nexport const retryTrueFalse = () => {\r\n    clearPreviousFeedback();\r\n    resetButtonStates();\r\n    setState('selectedButton', null);\r\n\r\n    // Clear screen reader announcements\r\n    const resultsAnnouncement = document.getElementById('validation-results-announcement');\r\n    if (resultsAnnouncement) {\r\n        resultsAnnouncement.textContent = '';\r\n    }\r\n\r\n    // Remove SR feedback elements\r\n    document.querySelectorAll('.sr-validation-feedback').forEach(el => el.remove());\r\n};\r\n\r\nconst resetButtonStates = () => {\r\n    document.querySelectorAll(\"section input[type='radio']\").forEach(button => {\r\n        button.checked = false;\r\n        const buttonDiv = button.parentElement.querySelector('div');\r\n        if (buttonDiv) {\r\n            buttonDiv.classList.remove('bg-green-500', 'bg-red-500');\r\n            buttonDiv.classList.add('bg-gray-200', 'peer-checked:bg-blue-500');\r\n        }\r\n\r\n        // Reset ARIA attributes\r\n        const parentLabel = button.closest('label');\r\n        if (parentLabel) {\r\n            parentLabel.removeAttribute('aria-invalid');\r\n        }\r\n    });\r\n};", "// Install required packages:\r\n// npm install nspell dictionary-en dictionary-es franc\r\n\r\n/**\r\n * Multilingual text validator\r\n * Uses nspell and dictionaries to validate text\r\n * Supports English and Spanish\r\n */\r\n\r\n// Import required libraries\r\n//import nspell from '../../libs/nspell/index.js';\r\n//import dictionaryEn from '../../libs/dictionary-en/index.js';\r\n//import dictionaryEs from '../../libs/dictionary-es-UY/index.js'; \r\n//import franc from '../../libs/franc/index.js';\r\n\r\n/**\r\n * Browser-compatible text validator using Spanish dictionary\r\n * Uses a simplified approach to validate text against a dictionary\r\n */\r\n\r\n// Class for text validation\r\nclass TextValidator {\r\n  constructor() {\r\n    // Initialize with document language\r\n    this.documentLanguage = document.documentElement.lang || 'es';\r\n    this.spanishWords = null;\r\n    this.initialized = false;\r\n    this.initializePromise = this.initialize();\r\n  }\r\n\r\n  /**\r\n   * Initialize dictionary by loading word list\r\n   */\r\n  async initialize() {\r\n    try {\r\n      // First, initialize with the fallback dictionary to ensure we have common words\r\n      this.initializeFallbackDictionary();\r\n\r\n      // Then try to load the full dictionary to supplement\r\n      try {\r\n        // Load the Spanish dictionary directly from the .dic file as text\r\n        const response = await fetch('./assets/modules/activities/index.dic');\r\n        const dicText = await response.text();\r\n\r\n        // Parse the dictionary file (skipping headers)\r\n        // Dictionary format has a count on the first line, then one word per line\r\n        const lines = dicText.split('\\n');\r\n        const wordCount = parseInt(lines[0], 10);\r\n\r\n        // Add words to our existing Set (which already has the fallback words)\r\n        // Start from line 1 (after the count)\r\n        for (let i = 1; i < lines.length; i++) {\r\n          // Dictionary format often has a word followed by flags separated by /\r\n          // We only want the word part\r\n          const line = lines[i].trim();\r\n          if (line) {\r\n            const word = line.split('/')[0].toLowerCase();\r\n            if (word) {\r\n              this.spanishWords.add(word);\r\n            }\r\n          }\r\n        }\r\n      } catch (dictError) {\r\n        console.warn('Could not load full dictionary, continuing with fallback only:', dictError);\r\n        // We already have the fallback dictionary loaded, so we can continue\r\n      }\r\n\r\n      this.initialized = true;\r\n    } catch (error) {\r\n      console.error('Error in dictionary initialization:', error);\r\n      // One last attempt to load just the fallback dictionary\r\n      this.initializeFallbackDictionary();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize a smaller fallback dictionary of common words\r\n   */\r\n  initializeFallbackDictionary() {\r\n    // Include a subset of very common Spanish words as fallback\r\n    const commonWords = [\r\n      'a', 'al', 'algo', 'algunos', 'ante', 'antes', 'como', 'con', 'contra', 'cual', 'cuando',\r\n      'de', 'del', 'desde', 'donde', 'durante', 'e', 'el', 'en', 'entre', 'era', 'eres', 'es',\r\n      'esa', 'ese', 'esta', 'est\u00E1', 'este', 'ha', 'hasta', 'hay', 'he', 'las', 'lo', 'los',\r\n      'me', 'mi', 'm\u00ED', 'mientras', 'muy', 'ni', 'no', 'nos', 'nosotros', 'nuestra', 'nuestro',\r\n      'o', 'otra', 'otro', 'para', 'pero', 'por', 'porque', 'que', 'qu\u00E9', 'quien', 'qui\u00E9n',\r\n      'se', 'sea', 'seg\u00FAn', 'si', 's\u00ED', 'siempre', 'sin', 'sobre', 'soy', 'su', 'sus', 'tal',\r\n      'tambi\u00E9n', 'tanto', 'te', 'tu', 't\u00FA', 'un', 'una', 'uno', 'unos', 'vosotros', 'y', 'ya', 'yo',\r\n\r\n      // Common words with accents that might be missed\r\n      'informaci\u00F3n', 'reformulaci\u00F3n', 'd\u00EDa', 'a\u00F1o', 'pa\u00EDs', 'despu\u00E9s', 'as\u00ED', 'trav\u00E9s',\r\n      'n\u00FAmero', 'l\u00EDnea', 'p\u00E1gina', 'p\u00E1rrafo', 't\u00EDtulo', 'cap\u00EDtulo', 'secci\u00F3n',\r\n      'm\u00E1s', 'aqu\u00ED', 'all\u00ED', 'ah\u00ED', 'quiz\u00E1s', 'oraci\u00F3n', 'an\u00E1lisis', 'acci\u00F3n',\r\n\r\n      // Common words describing feelings (not validating from the dictionary)\r\n      'sonr\u00EDe', 'r\u00EDe',\r\n\r\n      // Common textbook/educational terms\r\n      'ejemplo', 'ejercicio', 'actividad', 'lectura', 'texto', 'respuesta', 'pregunta',\r\n      'problema', 'soluci\u00F3n', 'explicaci\u00F3n', 'definici\u00F3n', 'concepto', 'tema', 'materia',\r\n      'vocabulario', 'gram\u00E1tica', 'verbos', 'sustantivos', 'adjetivos', 'adverbios',\r\n      'teor\u00EDa', 'pr\u00E1ctica', 'resultado', 'm\u00E9todo', 'sistema', 'funci\u00F3n', 'proceso',\r\n      'autor', 'libro', 'obra', 'personaje', 'historia', 'ciencia', 'matem\u00E1tica',\r\n      'biolog\u00EDa', 'f\u00EDsica', 'qu\u00EDmica', 'geograf\u00EDa', 'econom\u00EDa', 'tecnolog\u00EDa',\r\n\r\n      // Words missing from diccionary-es-UY\r\n      'subt\u00EDtulo', 'sumate', 's\u00FAmate', 'sumarse', 'c\u00F3mpralo', 'c\u00F3mprame', 'c\u00F3mprate', 'yacar\u00E9', 'yacare',\r\n\r\n      // Biology terms\r\n      'xer\u00F3fila', 'mes\u00F3fila', 'hidr\u00F3fila', 'fotos\u00EDntesis', 'clorofila', 'citoplasma',\r\n      'ADN', 'ARN', 'gen\u00E9tica', 'evoluci\u00F3n', 'c\u00E9lula', 'bacteria', 'virus', 'prote\u00EDna',\r\n      'amino\u00E1cido', 'enzima', 'mitocondria', 'cloroplasto', 'n\u00FAcleo', 'cromosoma',\r\n      'taxonom\u00EDa', 'especie', 'g\u00E9nero', 'familia', 'orden', 'clase', 'filo', 'reino',\r\n      'eucariota', 'procariota', 'aut\u00F3trofo', 'heter\u00F3trofo', 'mutaci\u00F3n', 'alelo',\r\n      'fenotipo', 'genotipo', 'meiosis', 'mitosis', 'gameto', 'zigoto', 'embri\u00F3n',\r\n      'organismo', 'ecosistema', 'bioma', 'h\u00E1bitat', 'nicho', 'bi\u00F3sfera', 'biodiversidad',\r\n      'end\u00E9mico', 'simbiosis', 'par\u00E1sito', 'hu\u00E9sped', 'cadena alimenticia', 'tr\u00F3fico',\r\n\r\n      // Physics terms\r\n      'f\u00EDsica', 'mec\u00E1nica', 'cinem\u00E1tica', 'din\u00E1mica', 'est\u00E1tica', 'termodin\u00E1mica',\r\n      'electromagn\u00E9tico', 'relatividad', 'cu\u00E1ntica', 'part\u00EDcula', '\u00E1tomo', 'electr\u00F3n',\r\n      'prot\u00F3n', 'neutr\u00F3n', 'fot\u00F3n', 'quark', 'bos\u00F3n', 'fermi\u00F3n', 'hadrones', 'leptones',\r\n      'fuerza', 'masa', 'energ\u00EDa', 'trabajo', 'potencia', 'aceleraci\u00F3n', 'velocidad',\r\n      'gravedad', 'densidad', 'presi\u00F3n', 'temperatura', 'calor', 'radiaci\u00F3n',\r\n      'conductividad', 'resistencia', 'voltaje', 'amperaje', 'frecuencia', 'longitud de onda',\r\n\r\n      // Chemistry terms\r\n      'qu\u00EDmica', 'elemento', 'compuesto', 'mol\u00E9cula', '\u00E1tomo', 'i\u00F3n', 'ani\u00F3n', 'cati\u00F3n',\r\n      'is\u00F3topo', 'valencia', 'enlace', 'covalente', 'i\u00F3nico', 'met\u00E1lico', 'soluci\u00F3n',\r\n      'soluto', 'solvente', 'concentraci\u00F3n', 'mol', 'molaridad', 'normalidad',\r\n      'pH', '\u00E1cido', 'base', 'sal', '\u00F3xido', 'hidr\u00F3xido', 'org\u00E1nico', 'inorg\u00E1nico',\r\n      'hidrocarburo', 'alcano', 'alqueno', 'alquino', 'alcohol', 'aldeh\u00EDdo', 'cetona',\r\n      '\u00E1cido carbox\u00EDlico', '\u00E9ster', '\u00E9ter', 'amina', 'amida', 'fenol', 'carbohidrato',\r\n      'l\u00EDpido', 'prote\u00EDna', 'pol\u00EDmero', 'mon\u00F3mero', 'catalizador', 'inhibidor',\r\n\r\n      // Mathematics terms\r\n      'matem\u00E1tica', '\u00E1lgebra', 'geometr\u00EDa', 'c\u00E1lculo', 'estad\u00EDstica', 'probabilidad',\r\n      'aritm\u00E9tica', 'trigonometr\u00EDa', 'ecuaci\u00F3n', 'funci\u00F3n', 'variable', 'constante',\r\n      'fracci\u00F3n', 'decimal', 'exponente', 'logaritmo', 'derivada', 'integral',\r\n      'matriz', 'vector', 'tensor', 'conjunto', 'permutaci\u00F3n', 'combinaci\u00F3n',\r\n      'teorema', 'axioma', 'postulado', 'corolario', 'lema', 'hip\u00F3tesis',\r\n      'demostraci\u00F3n', 'inducci\u00F3n', 'deducci\u00F3n', 'inferencia', 'algoritmo',\r\n\r\n      // Earth science terms\r\n      'geolog\u00EDa', 'meteorolog\u00EDa', 'hidrolog\u00EDa', 'oceanograf\u00EDa', 'mineralog\u00EDa',\r\n      'paleontolog\u00EDa', 'sismolog\u00EDa', 'vulcanolog\u00EDa', 'litosfera', 'atm\u00F3sfera',\r\n      'hidrosfera', 'biosfera', 'erosi\u00F3n', 'sedimentaci\u00F3n', 'tect\u00F3nica', 'placa',\r\n      'magma', 'lava', 'mineral', 'roca', 'f\u00F3sil', 'estrato', 'clima', 'tiempo',\r\n      'hurac\u00E1n', 'tornado', 'cicl\u00F3n', 'precipitaci\u00F3n', 'humedad', 'presi\u00F3n atmosf\u00E9rica',\r\n\r\n      // Astronomy terms\r\n      'astronom\u00EDa', 'astrof\u00EDsica', 'cosmolog\u00EDa', 'galaxia', 'estrella', 'planeta',\r\n      'sat\u00E9lite', 'cometa', 'asteroide', 'meteorito', 'nebulosa', 'constelaci\u00F3n',\r\n      'agujero negro', 'supernova', 'pulsar', 'qu\u00E1sar', 'c\u00FAmulo', 'universo',\r\n      'big bang', 'expansi\u00F3n', 'materia oscura', 'energ\u00EDa oscura', 'fusi\u00F3n nuclear',\r\n\r\n      // Technology terms\r\n      'tecnolog\u00EDa', 'computadora', 'algoritmo', 'programa', 'software', 'hardware',\r\n      'microprocesador', 'memoria', 'disco', 'pantalla', 'teclado', 'mouse',\r\n      'internet', 'wifi', 'bluetooth', 'router', 'servidor', 'firewall', 'ciberseguridad',\r\n      'programaci\u00F3n', 'base de datos', 'c\u00F3digo', 'binario', 'digital', 'an\u00E1logo',\r\n      'inteligencia artificial', 'aprendizaje autom\u00E1tico', 'rob\u00F3tica', 'nanotecnolog\u00EDa',\r\n      'biotecnolog\u00EDa', 'ingenier\u00EDa gen\u00E9tica', 'realidad virtual', 'realidad aumentada',\r\n\r\n      // Medical terms\r\n      'medicina', 'anatom\u00EDa', 'fisiolog\u00EDa', 'patolog\u00EDa', 'histolog\u00EDa', 'inmunolog\u00EDa',\r\n      'neurolog\u00EDa', 'cardiolog\u00EDa', 'dermatolog\u00EDa', 'pediatr\u00EDa', 'ortopedia',\r\n      'diagn\u00F3stico', 's\u00EDntoma', 's\u00EDndrome', 'tratamiento', 'terapia', 'medicamento',\r\n      'vacuna', 'anticuerpo', 'ant\u00EDgeno', 'sistema inmune', 'sistema nervioso',\r\n      'sistema circulatorio', 'sistema digestivo', 'sistema respiratorio'\r\n    ];\r\n\r\n    this.spanishWords = new Set(commonWords);\r\n    this.initialized = true;\r\n  }\r\n\r\n  /**\r\n   * Ensure dictionary is loaded before validation\r\n   */\r\n  async ensureInitialized() {\r\n    if (!this.initialized) {\r\n      await this.initializePromise;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if text is valid Spanish\r\n   * @param {string} text - Text to validate\r\n   * @returns {Promise<boolean>} - True if text appears valid\r\n   */\r\n  async isValidText(text) {\r\n    try {\r\n      await this.ensureInitialized();\r\n\r\n      // Clean the input\r\n      const cleanText = text.trim();\r\n\r\n      // Skip empty text\r\n      if (!cleanText) {\r\n        return false;\r\n      }\r\n\r\n      // First check for keyboard mashing and other obvious gibberish patterns\r\n      if (this.hasKeyboardMashing(cleanText)) {\r\n        console.warn('Text has keyboard mashing or gibberish patterns');\r\n        return false;\r\n      }\r\n\r\n      if (!this.hasReasonableVowelRatio(cleanText)) {\r\n        console.warn('Text has unreasonable vowel ratio');\r\n        return false;\r\n      }\r\n\r\n      if (!this.hasReasonableWordLengths(cleanText)) {\r\n        console.warn('Text has unreasonable word lengths');\r\n        return false;\r\n      }\r\n\r\n      // If we have a dictionary, use it\r\n      if (this.spanishWords && this.spanishWords.size > 0) {\r\n        // Tokenize the text into words\r\n        const words = cleanText.toLowerCase()\r\n          .split(/[^a-z\u00E1\u00E9\u00ED\u00F3\u00FA\u00FC\u00F1]+/)\r\n          .filter(word => word.length > 1); // Skip very short \"words\"\r\n\r\n        if (words.length === 0) {\r\n          return true; // No words to check\r\n        }\r\n\r\n        // Count how many words are in our dictionary\r\n        let validWordCount = 0;\r\n\r\n        for (const word of words) {\r\n          // Skip very short words\r\n          if (word.length <= 1) {\r\n            validWordCount++;\r\n            continue;\r\n          }\r\n\r\n          // 1. Check if the exact word is in our dictionary\r\n          if (this.spanishWords.has(word)) {\r\n            validWordCount++;\r\n            continue;\r\n          }\r\n\r\n          // 2. Try with non-accented version\r\n          const nonAccentedWord = this.removeAccents(word);\r\n          if (nonAccentedWord !== word && this.spanishWords.has(nonAccentedWord)) {\r\n            validWordCount++;\r\n            continue;\r\n          }\r\n\r\n          // 3. Try checking word stems (remove common endings)\r\n          const possibleStems = this.getPossibleStems(word);\r\n          const nonAccentedStems = possibleStems.map(stem => this.removeAccents(stem));\r\n\r\n          if (possibleStems.some(stem => this.spanishWords.has(stem)) ||\r\n            nonAccentedStems.some(stem => this.spanishWords.has(stem))) {\r\n            validWordCount++;\r\n            continue;\r\n          }\r\n\r\n        }\r\n\r\n        // Calculate the percentage of valid words\r\n        const validWordPercentage = (validWordCount / words.length) * 100;\r\n\r\n        // Text is considered valid if at least 30% of words are recognized\r\n        // This threshold is lower than with nspell because our dictionary might be incomplete\r\n        return validWordPercentage >= 25;\r\n      }\r\n\r\n      // If dictionary validation fails or isn't available, fall back to simpler checks\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error in TextValidator.isValidText:', error);\r\n      return true; // On error, be permissive\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get possible stem forms of a word by removing common endings\r\n   * @param {string} word - Word to get stems for\r\n   * @returns {string[]} - Array of possible stems\r\n   */\r\n\r\n  removeAccents(text) {\r\n    return text\r\n      .normalize(\"NFD\")\r\n      .replace(/[\\u0300-\\u036f]/g, \"\");\r\n  }\r\n  getPossibleStems(word) {\r\n    const stems = [word]; // Start with the original word\r\n\r\n    // First, check for verb conjugations - these are higher priority\r\n    // than gender variations because they're more common\r\n    if (word.length > 3) {\r\n      // Check for common verb endings for all Spanish conjugation patterns\r\n      const verbEndings = [\r\n        // Present indicative\r\n        { ending: 'o', replacement: 'ar' },     // traslado -> trasladar (1st person singular)\r\n        { ending: 'as', replacement: 'ar' },    // trasladas -> trasladar (2nd person singular)\r\n        { ending: 'a', replacement: 'ar' },     // traslada -> trasladar (3rd person singular)\r\n        { ending: 'amos', replacement: 'ar' },  // trasladamos -> trasladar (1st person plural)\r\n        { ending: '\u00E1is', replacement: 'ar' },   // traslad\u00E1is -> trasladar (2nd person plural)\r\n        { ending: 'an', replacement: 'ar' },    // trasladan -> trasladar (3rd person plural)\r\n\r\n        // Preterite\r\n        { ending: '\u00E9', replacement: 'ar' },     // traslad\u00E9 -> trasladar\r\n        { ending: 'aste', replacement: 'ar' },  // trasladaste -> trasladar\r\n        { ending: '\u00F3', replacement: 'ar' },     // traslad\u00F3 -> trasladar\r\n        { ending: 'amos', replacement: 'ar' },  // trasladamos -> trasladar\r\n        { ending: 'asteis', replacement: 'ar' }, // trasladasteis -> trasladar\r\n        { ending: 'aron', replacement: 'ar' },  // trasladaron -> trasladar\r\n\r\n        // Imperfect\r\n        { ending: 'aba', replacement: 'ar' },   // trasladaba -> trasladar\r\n        { ending: 'abas', replacement: 'ar' },  // trasladabas -> trasladar\r\n        { ending: '\u00E1bamos', replacement: 'ar' }, // traslad\u00E1bamos -> trasladar\r\n        { ending: 'abais', replacement: 'ar' }, // trasladabais -> trasladar\r\n        { ending: 'aban', replacement: 'ar' },  // trasladaban -> trasladar\r\n\r\n        // Future\r\n        { ending: 'ar\u00E9', replacement: 'ar' },   // trasladar\u00E9 -> trasladar\r\n        { ending: 'ar\u00E1s', replacement: 'ar' },  // trasladar\u00E1s -> trasladar\r\n        { ending: 'ar\u00E1', replacement: 'ar' },   // trasladar\u00E1 -> trasladar\r\n        { ending: 'aremos', replacement: 'ar' }, // trasladaremos -> trasladar\r\n        { ending: 'ar\u00E9is', replacement: 'ar' }, // trasladar\u00E9is -> trasladar\r\n        { ending: 'ar\u00E1n', replacement: 'ar' },  // trasladar\u00E1n -> trasladar\r\n\r\n        // Conditional\r\n        { ending: 'ar\u00EDa', replacement: 'ar' },   // trasladar\u00EDa -> trasladar\r\n        { ending: 'ar\u00EDas', replacement: 'ar' },  // trasladar\u00EDas -> trasladar\r\n        { ending: 'ar\u00EDamos', replacement: 'ar' }, // trasladar\u00EDamos -> trasladar\r\n        { ending: 'ar\u00EDais', replacement: 'ar' }, // trasladar\u00EDais -> trasladar\r\n        { ending: 'ar\u00EDan', replacement: 'ar' },  // trasladar\u00EDan -> trasladar\r\n\r\n        // Present subjunctive\r\n        { ending: 'e', replacement: 'ar' },     // traslade -> trasladar\r\n        { ending: 'es', replacement: 'ar' },    // traslades -> trasladar\r\n        { ending: 'emos', replacement: 'ar' },  // traslademos -> trasladar\r\n        { ending: '\u00E9is', replacement: 'ar' },   // traslad\u00E9is -> trasladar\r\n        { ending: 'en', replacement: 'ar' },    // trasladen -> trasladar\r\n\r\n        // Imperfect subjunctive\r\n        { ending: 'ara', replacement: 'ar' },   // trasladara -> trasladar\r\n        { ending: 'aras', replacement: 'ar' },  // trasladaras -> trasladar\r\n        { ending: '\u00E1ramos', replacement: 'ar' }, // traslad\u00E1ramos -> trasladar\r\n        { ending: 'arais', replacement: 'ar' }, // trasladarais -> trasladar\r\n        { ending: 'aran', replacement: 'ar' },  // trasladaran -> trasladar\r\n\r\n        { ending: 'ase', replacement: 'ar' },   // trasladase -> trasladar\r\n        { ending: 'ases', replacement: 'ar' },  // trasladases -> trasladar\r\n        { ending: '\u00E1semos', replacement: 'ar' }, // traslad\u00E1semos -> trasladar\r\n        { ending: 'aseis', replacement: 'ar' }, // trasladaseis -> trasladar\r\n        { ending: 'asen', replacement: 'ar' },  // trasladasen -> trasladar\r\n\r\n        // Future subjunctive (rare but included)\r\n        { ending: 'are', replacement: 'ar' },   // trasladare -> trasladar\r\n        { ending: 'ares', replacement: 'ar' },  // trasladares -> trasladar\r\n        { ending: '\u00E1remos', replacement: 'ar' }, // traslad\u00E1remos -> trasladar\r\n        { ending: 'areis', replacement: 'ar' }, // trasladareis -> trasladar\r\n        { ending: 'aren', replacement: 'ar' },  // trasladaren -> trasladar\r\n\r\n        // Imperative\r\n        { ending: 'a', replacement: 'ar' },     // traslada -> trasladar\r\n        { ending: 'ad', replacement: 'ar' },    // trasladad -> trasladar\r\n\r\n        // Gerund and participle\r\n        { ending: 'ando', replacement: 'ar' },  // trasladando -> trasladar\r\n        { ending: 'ado', replacement: 'ar' },   // trasladado -> trasladar\r\n        { ending: 'ada', replacement: 'ar' },   // trasladada -> trasladar\r\n        { ending: 'ados', replacement: 'ar' },  // trasladados -> trasladar\r\n        { ending: 'adas', replacement: 'ar' },  // trasladadas -> trasladar\r\n\r\n        // Now repeat for -er and -ir verbs\r\n        // -er verb endings (present indicative)\r\n        { ending: 'o', replacement: 'er' },     // como -> comer\r\n        { ending: 'es', replacement: 'er' },    // comes -> comer\r\n        { ending: 'e', replacement: 'er' },     // come -> comer\r\n        { ending: 'emos', replacement: 'er' },  // comemos -> comer\r\n        { ending: '\u00E9is', replacement: 'er' },   // com\u00E9is -> comer\r\n        { ending: 'en', replacement: 'er' },    // comen -> comer\r\n\r\n        // -ir verb endings (present indicative)\r\n        { ending: 'o', replacement: 'ir' },     // vivo -> vivir\r\n        { ending: 'es', replacement: 'ir' },    // vives -> vivir\r\n        { ending: 'e', replacement: 'ir' },     // vive -> vivir\r\n        { ending: 'imos', replacement: 'ir' },  // vivimos -> vivir\r\n        { ending: '\u00EDs', replacement: 'ir' },    // viv\u00EDs -> vivir\r\n        { ending: 'en', replacement: 'ir' },    // viven -> vivir\r\n\r\n        // Basic past tense and other common endings for -er/-ir\r\n        { ending: '\u00ED', replacement: 'ir' },     // viv\u00ED -> vivir\r\n        { ending: 'iste', replacement: 'ir' },  // viviste -> vivir\r\n        { ending: 'i\u00F3', replacement: 'ir' },    // vivi\u00F3 -> vivir\r\n        { ending: 'ieron', replacement: 'ir' }, // vivieron -> vivir\r\n\r\n        { ending: '\u00ED', replacement: 'er' },     // com\u00ED -> comer\r\n        { ending: 'iste', replacement: 'er' },  // comiste -> comer\r\n        { ending: 'i\u00F3', replacement: 'er' },    // comi\u00F3 -> comer\r\n        { ending: 'ieron', replacement: 'er' }, // comieron -> comer\r\n\r\n        // Imperfect for -er/-ir\r\n        { ending: '\u00EDa', replacement: 'er' },    // com\u00EDa -> comer\r\n        { ending: '\u00EDas', replacement: 'er' },   // com\u00EDas -> comer\r\n        { ending: '\u00EDamos', replacement: 'er' }, // com\u00EDamos -> comer\r\n        { ending: '\u00EDais', replacement: 'er' },  // com\u00EDais -> comer\r\n        { ending: '\u00EDan', replacement: 'er' },   // com\u00EDan -> comer\r\n\r\n        { ending: '\u00EDa', replacement: 'ir' },    // viv\u00EDa -> vivir\r\n        { ending: '\u00EDas', replacement: 'ir' },   // viv\u00EDas -> vivir\r\n        { ending: '\u00EDamos', replacement: 'ir' }, // viv\u00EDamos -> vivir\r\n        { ending: '\u00EDais', replacement: 'ir' },  // viv\u00EDais -> vivir\r\n        { ending: '\u00EDan', replacement: 'ir' },   // viv\u00EDan -> vivir\r\n      ];\r\n\r\n      for (const verbForm of verbEndings) {\r\n        if (word.length > verbForm.ending.length + 2 && word.endsWith(verbForm.ending)) {\r\n          const base = word.slice(0, -verbForm.ending.length);\r\n          const infinitive = base + verbForm.replacement;\r\n          stems.push(infinitive);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check gender variants first - before adding other stems\r\n    // This special handling for gender variations needs to come first\r\n    const genderVariations = [\r\n      { ending: 'ora', replacement: 'or' },     // computadora \u2192 computador\r\n      { ending: 'riz', replacement: 'r' },      // institutriz \u2192 institutor\r\n      { ending: 'esa', replacement: '' },       // princesa \u2192 prince\r\n      { ending: 'ina', replacement: 'o' },      // gallina \u2192 gallo\r\n      { ending: 'ica', replacement: 'o' },      // f\u00EDsica \u2192 f\u00EDsico\r\n      { ending: 'ada', replacement: 'ado' },    // cansada \u2192 cansado\r\n      { ending: 'a', replacement: 'o' },        // general feminine \u2192 masculine\r\n    ];\r\n\r\n    // Apply gender variation checks\r\n    for (const variation of genderVariations) {\r\n      if (word.length > variation.ending.length + 2 && word.endsWith(variation.ending)) {\r\n        const base = word.slice(0, -variation.ending.length);\r\n        const newStem = base + variation.replacement;\r\n        stems.push(newStem);\r\n      }\r\n    }\r\n\r\n    // Common word endings to remove\r\n    const endings = [\r\n      's', 'es', // Plurals\r\n      'mente', // Adverbs\r\n    ];\r\n\r\n    // Try removing each ending if the word is long enough\r\n    for (const ending of endings) {\r\n      if (word.length > ending.length + 2 && word.endsWith(ending)) {\r\n        stems.push(word.slice(0, -ending.length));\r\n      }\r\n    }\r\n\r\n    // // Handle common verb conjugations - try to derive possible infinitive forms\r\n    // if (word.length > 3) {\r\n    //   // Handle present tense conjugations\r\n    //   if (word.endsWith('e')) {\r\n    //     // 3rd person present of -er/-ir verbs (escribe -> escribir)\r\n    //     stems.push(word.slice(0, -1) + 'ir');\r\n    //     stems.push(word.slice(0, -1) + 'er');\r\n    //   }\r\n    //   if (word.endsWith('a')) {\r\n    //     // 3rd person present of -ar verbs (habla -> hablar)\r\n    //     stems.push(word.slice(0, -1) + 'ar');\r\n    //   }\r\n    //   if (word.endsWith('o')) {\r\n    //     // 1st person present forms (hablo -> hablar)\r\n    //     stems.push(word.slice(0, -1) + 'ar');\r\n    //     stems.push(word.slice(0, -1) + 'er');\r\n    //     stems.push(word.slice(0, -1) + 'ir');\r\n    //   }\r\n    // }\r\n\r\n    // Remove duplicates\r\n    const uniqueStems = [...new Set(stems)];\r\n\r\n    return uniqueStems;\r\n  }\r\n\r\n  /**\r\n   * Check if text has keyboard mashing patterns\r\n   * @param {string} text - Text to check\r\n   * @returns {boolean} - True if text has suspicious patterns\r\n   */\r\n  hasKeyboardMashing(text) {\r\n    // Check for repeated characters (more than 3 of the same character in a row)\r\n    if (/([a-zA-Z])\\1{3,}/.test(text)) {\r\n      return true;\r\n    }\r\n\r\n    // Check for sequences on keyboard like \"asdf\" or \"qwerty\"\r\n    const keyboardRows = [\r\n      'qwertyuiop',\r\n      'asdfghjkl',\r\n      'zxcvbnm'\r\n    ];\r\n\r\n    for (const row of keyboardRows) {\r\n      // Check for sequences of 4 or more adjacent keys\r\n      for (let i = 0; i <= row.length - 4; i++) {\r\n        const sequence = row.substr(i, 4);\r\n        if (text.toLowerCase().includes(sequence)) {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Check if text has a reasonable ratio of vowels to consonants\r\n   * @param {string} text - Text to check\r\n   * @returns {boolean} - True if vowel ratio is reasonable\r\n   */\r\n  hasReasonableVowelRatio(text) {\r\n    const letters = text.toLowerCase().replace(/[^a-z\u00F1\u00E1\u00E9\u00ED\u00F3\u00FA\u00FC]/g, '');\r\n    if (letters.length < 4) return true; // Too short to analyze\r\n\r\n    const vowels = letters.match(/[aeiou\u00E1\u00E9\u00ED\u00F3\u00FA\u00FC]/g) || [];\r\n    const vowelRatio = vowels.length / letters.length;\r\n\r\n    // Spanish has a higher vowel ratio than many languages\r\n    return vowelRatio >= 0.25 && vowelRatio <= 0.65;\r\n  }\r\n\r\n  /**\r\n   * Check if text has reasonable word lengths\r\n   * @param {string} text - Text to check\r\n   * @returns {boolean} - True if word lengths are reasonable\r\n   */\r\n  hasReasonableWordLengths(text) {\r\n    const words = text.split(/\\s+/).filter(w => w.length > 0);\r\n    if (words.length < 2) return true; // Too few words to analyze\r\n\r\n    // Check for extremely long words (likely gibberish)\r\n    const maxReasonableLength = 20;\r\n    const hasUnreasonablyLongWords = words.some(word =>\r\n      word.length > maxReasonableLength && !/[-_]/.test(word) // Allow exceptions for hyphenated words\r\n    );\r\n\r\n    return !hasUnreasonablyLongWords;\r\n  }\r\n\r\n  // Static version for convenience\r\n  static async isValidText(text) {\r\n    const instance = new TextValidator();\r\n    return instance.isValidText(text);\r\n  }\r\n}\r\n\r\nexport default TextValidator;", "import { playActivitySound } from '../audio.js';\r\nimport { updateSubmitButtonAndToast, provideFeedback, ActivityTypes } from '../utils.js';\r\nimport { clearInputValidationFeedback } from './fill_in_the_blank.js';\r\nimport TextValidator from './textvalidator.js';\r\n\r\nconst validator = new TextValidator();\r\n\r\nexport const prepareOpenEnded = (section) => {\r\n    const inputs = section.querySelectorAll('input[type=\"text\"], textarea');\r\n    setupInputListeners(inputs);\r\n    loadInputState(inputs);\r\n    initializeDictionary();\r\n    return inputs;\r\n};\r\n\r\nasync function initializeDictionary() {\r\n    // Initialize the TextValidator dictionary early\r\n    const textValidator = new TextValidator();\r\n    await textValidator.ensureInitialized();\r\n\r\n    // Store the validator in a global property so it can be accessed elsewhere\r\n    window.globalTextValidator = textValidator;\r\n}\r\n\r\nconst setupInputListeners = (inputs) => {\r\n    inputs.forEach(input => {\r\n        // Remove existing listeners to prevent duplicates\r\n        input.removeEventListener('input', handleInputChange);\r\n        input.removeEventListener('focus', handleInputFocus);\r\n        input.removeEventListener('blur', handleInputBlur);\r\n\r\n        // Add listeners\r\n        input.addEventListener('input', handleInputChange);\r\n        input.addEventListener('focus', handleInputFocus);\r\n        input.addEventListener('blur', handleInputBlur);\r\n    });\r\n};\r\n\r\nconst handleInputChange = (event) => {\r\n    const input = event.target;\r\n\r\n    // Clear validation feedback when input changes\r\n    clearInputValidationFeedback(input);\r\n\r\n    saveInputState(input);\r\n};\r\n\r\nconst handleInputFocus = (event) => {\r\n    event.target.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');\r\n};\r\n\r\nconst handleInputBlur = (event) => {\r\n    event.target.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');\r\n};\r\n\r\nconst saveInputState = (input) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    const inputId = input.getAttribute(\"data-aria-id\");\r\n    const localStorageKey = `${activityId}_${inputId}`;\r\n\r\n    localStorage.setItem(localStorageKey, input.value);\r\n};\r\n\r\nexport const loadInputState = (inputs) => {\r\n    inputs.forEach((input) => {\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n        const inputId = input.getAttribute(\"data-aria-id\");\r\n        const localStorageKey = `${activityId}_${inputId}`;\r\n\r\n        // Only replace content if there's a saved value in localStorage\r\n        const savedValue = localStorage.getItem(localStorageKey);\r\n        if (savedValue !== null) {\r\n            input.value = savedValue;\r\n        }\r\n        // Otherwise, keep the pre-filled content\r\n    });\r\n    localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\")\r\n};\r\n\r\nexport const countUnfilledInputs = (inputs) => {\r\n    let unfilledCount = 0;\r\n    let firstUnfilledInput = null;\r\n\r\n    // First, clear any existing feedback to avoid duplication or inconsistencies\r\n    inputs.forEach(input => {\r\n        clearInputValidationFeedback(input);\r\n    });\r\n\r\n    // Process each input in sequence\r\n    inputs.forEach((input, index) => {\r\n        const isFilled = input.value.trim() !== \"\";\r\n\r\n        // Apply feedback directly without setTimeout to avoid race conditions\r\n        provideFeedback(input, isFilled, \"\", ActivityTypes.OPEN_ENDED_ANSWER);\r\n\r\n        if (!isFilled) {\r\n            unfilledCount++;\r\n            if (!firstUnfilledInput) {\r\n                firstUnfilledInput = input;\r\n            }\r\n        }\r\n\r\n        // Only focus the first unfilled input after all feedback is applied\r\n        if (index === inputs.length - 1 && firstUnfilledInput) {\r\n            setTimeout(() => {\r\n                firstUnfilledInput.focus();\r\n            }, 50);\r\n        }\r\n    });\r\n\r\n    return unfilledCount;\r\n};", "import { playActivitySound } from '../audio.js';\r\nimport { updateSubmitButtonAndToast, provideFeedback, ActivityTypes } from '../utils.js';\r\nimport { loadInputState } from './open_ended.js';\r\nimport { translateText } from '../translations.js';\r\nimport { executeMail } from './send-email.js';\r\nimport { findAppropriateParentForFeedback } from './validation.js';\r\n//import { correctAnswers } from './correct_answers.js';\r\n\r\n\r\nexport const preparefillInBlank = (section) => {\r\n    const inputs = section.querySelectorAll('section input[type=\"text\"]:not(#filter-input), section textarea:not(#filter-input)');\r\n    setupInputListeners(inputs);\r\n    loadInputState(inputs);\r\n    return inputs;\r\n};\r\n\r\nconst setupInputListeners = (inputs) => {\r\n    inputs.forEach(input => {\r\n        input.addEventListener('input', handleInputChange);\r\n        input.addEventListener('focus', handleInputFocus);\r\n        input.addEventListener('blur', handleInputBlur);\r\n    });\r\n};\r\n\r\nexport const handleInputChange = (event) => {\r\n    const input = event.target;\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n\r\n    // Clear any existing validation feedback when the user makes changes\r\n    clearInputValidationFeedback(input);\r\n\r\n    // Validate the current input\r\n    validateInput(input);\r\n    saveInputState(input);\r\n\r\n    // Check if this input is part of an interchangeable pair\r\n    if (window.interchangeablePairs && window.interchangeablePairs[dataActivityItem]) {\r\n        // Revalidate all linked inputs in the interchangeable pair\r\n        const alternateItems = window.interchangeablePairs[dataActivityItem];\r\n        for (const alternateItem of alternateItems) {\r\n            const pairedInput = document.querySelector(`[data-activity-item=\"${alternateItem}\"]`);\r\n            if (pairedInput) {\r\n                // Also clear validation feedback for paired inputs\r\n                //clearInputValidationFeedback(pairedInput);\r\n                validateInput(pairedInput);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Show reset button when user starts typing (using the global function)\r\n    if (window.updateResetButtonVisibility) {\r\n        window.updateResetButtonVisibility(true);\r\n    }\r\n};\r\n\r\n// Add a new function to clear validation feedback\r\nexport const clearInputValidationFeedback = (input) => {\r\n    // Get the data-activity-item attribute to find related feedback elements\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n    const dataAriaId = input.getAttribute(\"data-aria-id\");\r\n    const inputId = input.id || '';\r\n\r\n    // Remove validation icons by various selectors to ensure all are caught\r\n    const selectors = [\r\n        `.feedback-icon-for-${dataActivityItem}`,\r\n        `.feedback-icon-for-${dataAriaId}`,\r\n        `.feedback-icon-for-${inputId}`,\r\n        `.feedback-icon-for-feedback`,\r\n        `.feedback-icon-for-profanity`,\r\n        `.feedback-icon-for-gibberish`\r\n    ];\r\n\r\n    // Use each selector to find and remove icons\r\n    selectors.forEach(selector => {\r\n        const icons = document.querySelectorAll(selector);\r\n        icons.forEach(icon => {\r\n            // Only remove if this icon is associated with this input\r\n            if (icon && icon.parentNode === input.parentNode) {\r\n                icon.remove();\r\n            }\r\n        });\r\n    });\r\n\r\n    // Also look for feedback containers that might be siblings of the flex container\r\n    const parent = input.parentNode;\r\n    if (parent) {\r\n        // Check if we're in a flex container\r\n        if (window.getComputedStyle(parent).display === 'flex') {\r\n            // Look for feedback containers that might be siblings of the flex container\r\n            const flexParent = parent.parentNode;\r\n            if (flexParent) {\r\n                const feedbackContainers = flexParent.querySelectorAll('.feedback-container');\r\n                feedbackContainers.forEach(container => {\r\n                    container.remove();\r\n                });\r\n            }\r\n        }\r\n\r\n        // Also remove any feedback elements inside the parent\r\n        const feedbackElements = parent.querySelectorAll('.feedback');\r\n        feedbackElements.forEach(el => {\r\n            el.remove();\r\n        });\r\n    }\r\n\r\n    // Reset input styling\r\n    input.classList.remove(\r\n        \"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\",\r\n        \"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\",\r\n        \"border-orange-500\", \"focus:border-orange-500\", \"focus:ring-orange-200\",\r\n        \"focus:ring\"\r\n    );\r\n\r\n    // Reset ARIA attributes and data attributes\r\n    input.removeAttribute(\"aria-invalid\");\r\n    input.removeAttribute(\"data-has-profanity-feedback\");\r\n    input.removeAttribute(\"data-has-gibberish-feedback\");\r\n\r\n    // Preserve enhanced accessibility aria-label with options list, but remove validation text\r\n    const originalLabel = input.getAttribute(\"aria-label\") || \"\";\r\n    if (originalLabel.includes(\" - \")) {\r\n        // If the aria-label has validation text (contains \" - \"), remove only the validation part\r\n        // but keep the options information\r\n        const parts = originalLabel.split(\" - \");\r\n        if (parts[0].includes(\"Las opciones disponibles son:\")) {\r\n            // This is one of our enhanced labels, preserve the options info\r\n            input.setAttribute(\"aria-label\", parts[0]);\r\n        } else {\r\n            // Regular validation feedback, remove it\r\n            input.setAttribute(\"aria-label\", parts[0]);\r\n        }\r\n    }\r\n\r\n    // Remove the right padding we added for the icon\r\n    input.style.paddingRight = '';\r\n}\r\n\r\nexport const handleInputFocus = (event) => {\r\n    event.target.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');\r\n};\r\n\r\nexport const handleInputBlur = (event) => {\r\n    event.target.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');\r\n};\r\n\r\nexport const checkFillInTheBlank = () => {\r\n    const inputs = document.querySelectorAll('section input[type=\"text\"]:not(#filter-input), section textarea:not(#filter-input)');\r\n    clearOldFeedback();\r\n\r\n    const validationResult = validateAllInputs(inputs);\r\n\r\n    handleValidationResult(validationResult);\r\n};\r\n\r\nconst clearOldFeedback = () => {\r\n    const oldFeedbacks = document.querySelectorAll(\".feedback\");\r\n    oldFeedbacks.forEach(feedback => feedback.remove());\r\n};\r\n\r\nconst validateAllInputs = (inputs) => {\r\n    let allCorrect = true;\r\n    let firstIncorrectInput = null;\r\n    let unfilledCount = 0;\r\n    inputs.forEach((input) => {\r\n        const validation = validateSingleInput(input);\r\n        if (!validation.isCorrect) {\r\n            allCorrect = false;\r\n\r\n            if (!firstIncorrectInput && !validation.isFilled) {\r\n                firstIncorrectInput = input;\r\n            }\r\n        }\r\n\r\n        if (!validation.isFilled) {\r\n            unfilledCount++;\r\n        }\r\n    });\r\n\r\n    return { allCorrect, firstIncorrectInput, unfilledCount };\r\n};\r\n\r\n// Fixed version of validateSingleInput function\r\nconst validateSingleInput = (input) => {\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n    const correctAnswer = correctAnswers[dataActivityItem];\r\n    const inputValue = input.value.trim().toLowerCase();\r\n    let isCorrect = false;\r\n    const isFilled = inputValue !== \"\";\r\n\r\n    if (correctAnswer && correctAnswer.includes('|')) {\r\n        // Multiple correct answers separated by |\r\n        const acceptableAnswers = correctAnswer.split('|');\r\n        isCorrect = isFilled && acceptableAnswers.some(answer =>\r\n            inputValue === answer.trim().toLowerCase());\r\n    } else if (window.interchangeablePairs && window.interchangeablePairs[dataActivityItem]) {\r\n        // This is part of an interchangeable pair\r\n        const alternateItems = window.interchangeablePairs[dataActivityItem];\r\n        const alternateAnswers = alternateItems.map(item => correctAnswers[item]);\r\n\r\n        // Check against correct answer or any alternate answers\r\n        isCorrect = (isFilled && correctAnswer && inputValue === correctAnswer.toLowerCase()) ||\r\n            alternateAnswers.some(alt => alt && inputValue === alt.toLowerCase());\r\n\r\n        // Check for duplicates if this field is valid\r\n        if (isCorrect && alternateItems.length > 0) {\r\n            // Get the paired fields\r\n            for (const alternateItem of alternateItems) {\r\n                const pairedInput = document.querySelector(`[data-activity-item=\"${alternateItem}\"]`);\r\n                if (pairedInput && pairedInput.value.trim().toLowerCase() === inputValue) {\r\n                    // Found duplicate answer - mark as incorrect\r\n                    isCorrect = false;\r\n                    // Add special feedback for duplicate answers\r\n                    provideFeedback(\r\n                        input,\r\n                        false,\r\n                        \"No puedes usar la misma palabra en ambos campos\",\r\n                        ActivityTypes.FILL_IN_THE_BLANK\r\n                    );\r\n                    return { isCorrect: false, isFilled };\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        // Regular validation with a single correct answer\r\n        isCorrect = isFilled &&\r\n            correctAnswer &&\r\n            correctAnswer.toLowerCase() === inputValue;\r\n    }\r\n\r\n    provideFeedback(\r\n        input,\r\n        isCorrect,\r\n        correctAnswer,\r\n        ActivityTypes.FILL_IN_THE_BLANK\r\n    );\r\n\r\n    if (!isCorrect) {\r\n        setAriaAttributes(input, dataActivityItem);\r\n    }\r\n\r\n    return { isCorrect, isFilled };\r\n};\r\n\r\nconst setAriaAttributes = (input, dataActivityItem) => {\r\n    const feedbackElement = input.parentNode.querySelector(\".feedback\");\r\n    if (feedbackElement) {\r\n        feedbackElement.setAttribute(\"aria-live\", \"assertive\");\r\n        feedbackElement.id = `feedback-${dataActivityItem}`;\r\n        input.setAttribute(\"aria-describedby\", feedbackElement.id);\r\n    }\r\n};\r\n\r\nconst handleValidationResult = (validationResult) => {\r\n    const { allCorrect, firstIncorrectInput, unfilledCount } = validationResult;\r\n\r\n    if (firstIncorrectInput) {\r\n        firstIncorrectInput.focus();\r\n    }\r\n\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    playActivitySound(allCorrect ? 'success' : 'error');\r\n\r\n    if (allCorrect) {\r\n\r\n        // Recuperar el arreglo de actividades completadas del localStorage\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\")\r\n        executeMail(ActivityTypes.FILL_IN_THE_BLANK);\r\n    }\r\n\r\n    updateSubmitButtonAndToast(\r\n        allCorrect,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.FILL_IN_THE_BLANK,\r\n        unfilledCount\r\n    );\r\n};\r\n\r\nexport const validateInput = (input) => {\r\n    const value = input.value.trim().toLowerCase();\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n    const correctAnswer = correctAnswers[dataActivityItem];\r\n\r\n    // Remove any existing duplicate feedback first\r\n    const existingFeedback = input.parentNode.querySelector(\".feedback\");\r\n    if (existingFeedback && existingFeedback.textContent === \"Palabra duplicada\") {\r\n        input.parentNode.removeChild(existingFeedback);\r\n    }\r\n\r\n    let isValid = false;\r\n    let hasDuplicate = false;\r\n\r\n    // Check if this is an interchangeable pair input\r\n    if (window.interchangeablePairs && window.interchangeablePairs[dataActivityItem]) {\r\n        // Get the alternate items and their correct answers\r\n        const alternateItems = window.interchangeablePairs[dataActivityItem];\r\n        const alternateAnswers = alternateItems.map(item => correctAnswers[item]);\r\n\r\n        // First check if the value matches any valid answer for this input\r\n        isValid = (value !== \"\" &&\r\n            (value === correctAnswer.toLowerCase() ||\r\n                alternateAnswers.some(alt => value === alt.toLowerCase())));\r\n\r\n        // Then check for duplicates (the same answer used in multiple fields)\r\n        if (isValid && value !== \"\") {\r\n            for (const alternateItem of alternateItems) {\r\n                const pairedInput = document.querySelector(`[data-activity-item=\"${alternateItem}\"]`);\r\n                if (pairedInput && pairedInput.value.trim().toLowerCase() === value) {\r\n                    // Found duplicate, mark as invalid\r\n                    isValid = false;\r\n                    hasDuplicate = true;\r\n\r\n                    // Show error message for duplicate\r\n                    const feedback = document.createElement(\"span\");\r\n                    feedback.classList.add(\"feedback\", \"ml-2\", \"px-2\", \"py-1\", \"rounded-full\",\r\n                        \"text-sm\", \"font-medium\", \"bg-red-100\", \"text-red-800\");\r\n                    feedback.textContent = \"Palabra duplicada\";\r\n                    input.parentNode.appendChild(feedback);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n    } else if (correctAnswer && correctAnswer.includes('|')) {\r\n        // Handle pipe-separated multiple correct answers\r\n        const acceptableAnswers = correctAnswer.split('|');\r\n        isValid = value !== \"\" && acceptableAnswers.some(answer =>\r\n            value === answer.trim().toLowerCase());\r\n    } else {\r\n        // Regular validation for non-interchangeable inputs\r\n        isValid = value !== \"\" &&\r\n            correctAnswer &&\r\n            correctAnswer.toLowerCase() === value;\r\n    }\r\n\r\n    // Only update style if we didn't find a duplicate (which would have already set the style)\r\n    updateInputValidationStyle(input, isValid);\r\n\r\n    return { isValid, hasDuplicate };\r\n};\r\n\r\nconst updateInputValidationStyle = (input, isValid) => {\r\n    input.classList.remove('border-red-500', 'border-green-500');\r\n\r\n    const trimmedValue = input.value.trim();\r\n    if (trimmedValue !== \"\") {\r\n        input.classList.add(isValid ? 'border-green-500' : 'border-red-500');\r\n\r\n        // Get previous validation state\r\n        const wasValid = input.dataset.wasValid === 'true';\r\n\r\n        // Only play sounds if:\r\n        // 1. The valid state changed to valid (for success sound)\r\n        // 2. The valid state changed to invalid or was already invalid (for error sound)\r\n        if (isValid && !wasValid && trimmedValue.length > 0) {\r\n            playActivitySound('validate_success');\r\n        } else if (!isValid) {\r\n            playActivitySound('validate_error');\r\n        }\r\n\r\n        // Store current validation state for next time\r\n        input.dataset.wasValid = isValid.toString();\r\n    }\r\n};\r\n\r\nexport const saveInputState = (input) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    const inputId = input.getAttribute(\"data-aria-id\");\r\n    const localStorageKey = `${activityId}_${inputId}`;\r\n\r\n    localStorage.setItem(localStorageKey, input.value);\r\n};\r\n\r\nexport const autofillCorrectAnswers = () => {\r\n    const inputs = document.querySelectorAll('section input[type=\"text\"]:not(#filter-input), section textarea:not(#filter-input)');\r\n    inputs.forEach((input) => {\r\n        const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n        const correctAnswer = correctAnswers[dataActivityItem];\r\n\r\n        if (correctAnswer) {\r\n            input.value = correctAnswer;\r\n            validateInput(input);\r\n            saveInputState(input);\r\n        }\r\n    });\r\n};\r\n\r\nexport const countUnfilledInputs = (inputs) => {\r\n    let unfilledCount = 0;\r\n    let firstUnfilledInput = null;\r\n\r\n    inputs.forEach((input) => {\r\n        const isFilled = input.value.trim() !== \"\";\r\n        provideFeedback(input, isFilled, \"\");\r\n\r\n        if (!isFilled) {\r\n            unfilledCount++;\r\n            if (!firstUnfilledInput) {\r\n                firstUnfilledInput = input;\r\n            }\r\n        }\r\n    });\r\n\r\n    if (firstUnfilledInput) {\r\n        firstUnfilledInput.focus();\r\n    }\r\n\r\n    return unfilledCount;\r\n};\r\n\r\n", "import { playActivitySound } from '../audio.js';\r\nimport { ActivityTypes, updateSubmitButtonAndToast, provideFeedback } from '../utils.js';\r\nimport { countUnfilledInputs } from './fill_in_the_blank.js';\r\nimport { translateText } from '../translations.js';\r\nimport { checkForGibberish } from './validation.js';\r\nimport { executeMail } from './send-email.js';\r\nimport TextValidator from './textvalidator.js';\r\n\r\nexport const prepareFillInTable = (section) => {\r\n    const inputs = section.querySelectorAll('input[type=\"text\"]:not(#filter-input), textarea:not(#filter-input)');\r\n    setupTableInputs(inputs);\r\n    loadInputState(inputs);\r\n    initializeDictionary();\r\n    return inputs;\r\n};\r\n\r\nasync function initializeDictionary() {\r\n    // Initialize the TextValidator dictionary early\r\n    const textValidator = new TextValidator();\r\n    await textValidator.ensureInitialized();\r\n\r\n    // Store the validator in a global property so it can be accessed elsewhere\r\n    window.globalTextValidator = textValidator;\r\n}\r\n\r\n\r\nconst setupTableInputs = (inputs) => {\r\n    inputs.forEach(input => {\r\n        input.addEventListener('input', handleTableInputChange);\r\n        input.addEventListener('focus', handleTableInputFocus);\r\n        input.addEventListener('blur', handleTableInputBlur);\r\n\r\n        // Add table-specific styling\r\n        input.classList.add(\r\n            'border',\r\n            'border-gray-300',\r\n            'rounded',\r\n            'p-2',\r\n            'w-full',\r\n            'transition-colors',\r\n            'duration-200'\r\n        );\r\n    });\r\n};\r\n\r\nconst handleTableInputChange = (event) => {\r\n    const input = event.target;\r\n    clearTableInputValidationFeedback(input);\r\n\r\n    saveTableInputState(input);\r\n\r\n    // Reset the cell and input styling completely\r\n    const cell = input.closest('td, th');\r\n    if (cell) {\r\n        cell.classList.remove('bg-red-50', 'bg-green-50', 'border-red-300', 'border-green-300');\r\n    }\r\n\r\n    // Remove all validation styling from the input itself\r\n    input.classList.remove(\r\n        'border-green-500', 'focus:border-green-500', 'focus:ring-green-200',\r\n        'border-red-500', 'focus:border-red-500', 'focus:ring-red-200',\r\n        'border-orange-500', 'focus:border-orange-500', 'focus:ring-orange-200',\r\n        'focus:ring'\r\n    );\r\n\r\n    //validateTableInput(input);\r\n\r\n};\r\n\r\nconst handleTableInputFocus = (event) => {\r\n    const input = event.target;\r\n    input.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');\r\n\r\n    // Highlight related cells if they exist\r\n    highlightRelatedCells(input);\r\n};\r\n\r\nconst handleTableInputBlur = (event) => {\r\n    const input = event.target;\r\n    input.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');\r\n\r\n    // Remove highlight from related cells\r\n    unhighlightRelatedCells(input);\r\n};\r\n\r\nexport const checkTableInputs = () => {\r\n\r\n    const inputs = document.querySelectorAll('section input[type=\"text\"]:not(#filter-input), section textarea:not(#filter-input)');\r\n    clearTableFeedback();\r\n\r\n    const validationResult = validateTableInputs(inputs);\r\n    const hasGibberish = checkForGibberish(inputs);\r\n\r\n    // Add gibberish check to validation result object\r\n    const enhancedValidationResult = {\r\n        ...validationResult,\r\n        hasGibberish,\r\n        // Calculate a final validity result that includes both checks\r\n        isValid: validationResult.allFilled && hasGibberish\r\n    };\r\n\r\n    handleTableValidationResult(enhancedValidationResult);\r\n};\r\n\r\nconst clearTableFeedback = () => {\r\n    document.querySelectorAll(\".feedback\").forEach(el => el.remove());\r\n    document.querySelectorAll(\".cell-highlight\").forEach(el => {\r\n        el.classList.remove('cell-highlight', 'bg-blue-50');\r\n    });\r\n};\r\n\r\nconst validateTableInputs = (inputs) => {\r\n    let allFilled = true;\r\n    let unfilledCount = 0;\r\n    let correctCount = 0;\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    // Check filled-not-required class is on the table.\r\n    const filledNotRequired = document.getElementsByClassName(\"filled-not-required\").length > 0;\r\n\r\n    inputs.forEach(input => {\r\n        const validation = validateSingleTableInput(input);\r\n        if (!validation.isFilled) {\r\n            allFilled = false;\r\n            unfilledCount++;\r\n        }\r\n        if (validation.isCorrect) {\r\n            correctCount++;\r\n        }\r\n    });\r\n\r\n    if (filledNotRequired) {\r\n        allFilled = true;\r\n        unfilledCount = 0;\r\n    }\r\n\r\n    return { allFilled, unfilledCount, correctCount };\r\n};\r\n\r\nconst validateSingleTableInput = (input) => {\r\n    const value = input.value.trim();\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n    const dataAriaId = input.getAttribute(\"data-aria-id\");\r\n\r\n    // Check if this table is \"filled-not-required\"\r\n    const filledNotRequired = document.getElementsByClassName(\"filled-not-required\").length > 0;\r\n\r\n    let correctAnswer;\r\n    try {\r\n        // First check if we have a global correctAnswers object\r\n        if (typeof correctAnswers !== 'undefined' && correctAnswers[dataActivityItem]) {\r\n            correctAnswer = correctAnswers[dataActivityItem];\r\n        } else if (typeof correctAnswers !== 'undefined' && correctAnswers[dataAriaId]) {\r\n            // Try using data-aria-id if data-activity-item didn't work\r\n            correctAnswer = correctAnswers[dataAriaId];\r\n            // } else if (input.getAttribute(\"data-correct-answer\")) {\r\n            //     // Otherwise check for inline data-correct-answer attribute\r\n            //     correctAnswer = input.getAttribute(\"data-correct-answer\");\r\n        } else {\r\n            // If no correct answer is defined, accept any non-empty input\r\n            correctAnswer = null;\r\n        }\r\n    } catch (error) {\r\n        console.warn(\"Could not retrieve correct answer:\", error);\r\n        correctAnswer = null;\r\n    }\r\n\r\n    // Determine if the input is valid\r\n    const isFilled = value !== \"\";\r\n\r\n    // For tables with filled-not-required, we should treat empty fields as valid\r\n    const isCorrect = filledNotRequired && !isFilled ?\r\n        true : // Empty is fine when not required\r\n        (correctAnswer ? correctAnswer.toLowerCase() === value.toLowerCase() : isFilled);\r\n\r\n    if (!(filledNotRequired && !isFilled)) {\r\n        // Only provide feedback for filled fields or when filling is required\r\n        provideFeedback(\r\n            input,\r\n            isCorrect,\r\n            correctAnswer,\r\n            ActivityTypes.FILL_IN_A_TABLE\r\n        );\r\n\r\n        // Update styling only for filled fields or when filling is required\r\n        updateTableCellStyle(input, isFilled, isCorrect);\r\n    } else {\r\n        // For empty fields in optional tables, clear any validation styling\r\n        clearTableInputValidationFeedback(input);\r\n    }\r\n\r\n    return { isFilled, isCorrect: filledNotRequired ? true : isCorrect };\r\n};\r\n\r\nconst updateTableCellStyle = (input, isFilled, isCorrect) => {\r\n    const cell = input.closest('td, th');\r\n    if (!cell) return;\r\n\r\n    // Remover clases previamente aplicadas\r\n    cell.classList.remove('bg-red-50', 'bg-green-50', 'border-red-300', 'border-green-300');\r\n\r\n    if (isFilled) {\r\n        if (isCorrect) {\r\n            cell.classList.add('bg-green-50', 'border-green-300');\r\n        } else {\r\n            cell.classList.add('bg-red-50', 'border-red-300');\r\n        }\r\n    }\r\n};\r\n\r\n// Add this function to clear validation feedback specifically for table inputs\r\n\r\nconst clearTableInputValidationFeedback = (input) => {\r\n    // Get identifiers\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n    const dataAriaId = input.getAttribute(\"data-aria-id\");\r\n    const inputId = input.id || '';\r\n\r\n    // Clear icon feedback\r\n    const selectors = [\r\n        `.feedback-icon-for-${dataActivityItem}`,\r\n        `.feedback-icon-for-${dataAriaId}`,\r\n        `.feedback-icon-for-${inputId}`\r\n    ];\r\n\r\n    selectors.forEach(selector => {\r\n        const icons = document.querySelectorAll(selector);\r\n        icons.forEach(icon => {\r\n            if (icon && (icon.parentNode === input.parentNode || icon.closest('td') === input.closest('td'))) {\r\n                icon.remove();\r\n            }\r\n        });\r\n    });\r\n\r\n    // Reset input styling\r\n    input.classList.remove(\r\n        \"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\",\r\n        \"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\",\r\n        \"focus:ring\"\r\n    );\r\n\r\n    // Reset cell styling\r\n    const cell = input.closest('td, th');\r\n    if (cell) {\r\n        cell.classList.remove('bg-red-50', 'bg-green-50', 'border-red-300', 'border-green-300');\r\n    }\r\n\r\n    // Reset ARIA attributes\r\n    input.removeAttribute(\"aria-invalid\");\r\n    const originalLabel = input.getAttribute(\"aria-label\") || \"\";\r\n    if (originalLabel.includes(\" - \")) {\r\n        input.setAttribute(\"aria-label\", originalLabel.split(\" - \")[0]);\r\n    }\r\n\r\n    // Remove padding if it was added\r\n    input.style.paddingRight = '';\r\n};\r\n\r\nconst handleTableValidationResult = (validationResult) => {\r\n    const { allFilled, unfilledCount, correctCount, hasGibberish, isValid } = validationResult;\r\n\r\n    if (allFilled && isValid) {\r\n        playActivitySound('success');\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\")\r\n\r\n        // Obtener el ID de la actividad desde la URL\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n\r\n        // Recuperar el arreglo de actividades completadas del localStorage\r\n        let key = activityId + \"-intentos\";\r\n        let intentCount = localStorage.getItem(key);\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n        executeMail(ActivityTypes.FILL_IN_A_TABLE);\r\n    } else {\r\n        playActivitySound('error');\r\n    }\r\n\r\n    updateSubmitButtonAndToast(\r\n        allFilled && isValid,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.FILL_IN_A_TABLE,\r\n        unfilledCount,\r\n    );\r\n};\r\n\r\nconst validateTableInput = (input) => {\r\n    const value = input.value.trim();\r\n    const dataActivityItem = input.getAttribute(\"data-activity-item\");\r\n\r\n    let correctAnswer;\r\n    try {\r\n        correctAnswer = correctAnswers?.[dataActivityItem] ?? null;\r\n    } catch (error) {\r\n        correctAnswer = null;\r\n    }\r\n\r\n    const isFilled = value !== \"\";\r\n    const isValid = correctAnswer ? correctAnswer.toLowerCase() === value.toLowerCase() : isFilled;\r\n\r\n    updateTableInputValidationStyle(input, isValid);\r\n};\r\n\r\nconst updateTableInputValidationStyle = (input, isValid) => {\r\n    const cell = input.closest('td, th');\r\n    if (!cell) return;\r\n\r\n    input.classList.remove('border-red-500', 'border-green-500');\r\n    cell.classList.remove('bg-red-50', 'bg-green-50');\r\n\r\n    if (input.value.trim() !== \"\") {\r\n        input.classList.add(isValid ? 'border-green-500' : 'border-red-500');\r\n        cell.classList.add(isValid ? 'bg-green-50' : 'bg-red-50');\r\n    }\r\n};\r\n\r\nconst saveTableInputState = (input) => {\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n\r\n    // Use data-aria-id as the primary identifier, fall back to id or data-activity-item\r\n    const inputId = input.getAttribute(\"data-aria-id\") || input.id || input.getAttribute(\"data-activity-item\");\r\n\r\n    if (!inputId) {\r\n        console.warn(\"Input element has no identifier for storage:\", input);\r\n        return;\r\n    }\r\n\r\n    const localStorageKey = `${activityId}_${inputId}`;\r\n    localStorage.setItem(localStorageKey, input.value);\r\n};\r\n\r\nconst loadInputState = (inputs) => {\r\n    inputs.forEach((input) => {\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n        // Use data-aria-id as the primary identifier, fall back to id or data-activity-item\r\n        const inputId = input.getAttribute(\"data-aria-id\") || input.id || input.getAttribute(\"data-activity-item\");\r\n\r\n        if (!inputId) {\r\n            console.warn(\"Input element has no identifier for loading:\", input);\r\n            return;\r\n        }\r\n\r\n        const localStorageKey = `${activityId}_${inputId}`;\r\n        const savedValue = localStorage.getItem(localStorageKey);\r\n\r\n        if (savedValue !== null) {\r\n            input.value = savedValue;\r\n\r\n            // Optionally validate the input after loading to show feedback\r\n            // This makes the saved state visually validated immediately on page load\r\n            validateTableInput(input);\r\n        }\r\n    });\r\n\r\n    // Store the page name for activity completion tracking\r\n    localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText || document.title);\r\n};\r\n\r\nconst highlightRelatedCells = (input) => {\r\n    const cell = input.closest('td, th');\r\n    if (!cell) return;\r\n\r\n    const rowIndex = cell.parentElement.rowIndex;\r\n    const cellIndex = cell.cellIndex;\r\n    const table = cell.closest('table');\r\n\r\n    if (!table) return;\r\n\r\n    // Highlight row\r\n    const row = table.rows[rowIndex];\r\n    Array.from(row.cells).forEach(cell => {\r\n        cell.classList.add('bg-blue-50', 'cell-highlight');\r\n    });\r\n\r\n    // Highlight column\r\n    Array.from(table.rows).forEach(row => {\r\n        const cell = row.cells[cellIndex];\r\n        if (cell) {\r\n            cell.classList.add('bg-blue-50', 'cell-highlight');\r\n        }\r\n    });\r\n};\r\n\r\nconst unhighlightRelatedCells = (input) => {\r\n    document.querySelectorAll('.cell-highlight').forEach(cell => {\r\n        cell.classList.remove('bg-blue-50', 'cell-highlight');\r\n    });\r\n};\r\n\r\n// Export utility functions that might be needed by other modules\r\nexport {\r\n    validateTableInput,\r\n    saveTableInputState,\r\n    countUnfilledInputs\r\n};", "/**\r\n * Enhanced Spanish language gibberish detector\r\n */\r\n\r\n// Common Spanish letter patterns and characteristics\r\nconst SPANISH_FEATURES = {\r\n  // Common Spanish bigrams (letter pairs) - expanded\r\n  commonBigrams: ['es', 'de', 'en', 'el', 'la', 'qu', 'ue', 'ar', 'os', 'as', 'er', 'ra', 'al', 'an', 'nt', 'or',\r\n    'co', 'ci', 'ca', 'ro', 'st', 'ie', 'ta', 'te', 'me', 'to', 'tr', 'pe', 'pa', 'ma', 'do', 'lo'],\r\n\r\n  // Common Spanish word endings - expanded\r\n  commonEndings: ['ar', 'er', 'ir', 'os', 'as', 'es', 'i\u00F3n', 'dad', 'ado', 'ido', 'mente', 'ista', 'amos',\r\n    'emos', 'imos', 'ando', 'endo', 'able', 'ante', 'encia', 'anza', 'tico', 'tivo', 'tulo'],\r\n\r\n  // Spanish special characters\r\n  specialChars: ['\u00E1', '\u00E9', '\u00ED', '\u00F3', '\u00FA', '\u00FC', '\u00F1', '\u00BF', '\u00A1'],\r\n\r\n  // Spanish vowels\r\n  vowels: ['a', 'e', 'i', 'o', 'u', '\u00E1', '\u00E9', '\u00ED', '\u00F3', '\u00FA', '\u00FC'],\r\n\r\n  // Invalid consonant clusters in Spanish\r\n  invalidClusters: ['bk', 'cg', 'dk', 'fh', 'gj', 'jf', 'kw', 'mz', 'pz', 'qk', 'xz', 'zx', 'zv'],\r\n\r\n  // Common small Spanish words (for quick validation)\r\n  commonWords: [\r\n    'el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'y', 'o', 'pero', 'sin', 'con', 'para', 'por',\r\n    'de', 'del', 'al', 'en', 'yo', 't\u00FA', '\u00E9l', 'ella', 'nosotros', 'vosotros', 'ellos', 'ellas', 'mi', 'su',\r\n    'ese', 'esta', 'esto', 'aqu\u00ED', 'all\u00ED', 'ahora', 'antes', 'despu\u00E9s', 's\u00ED', 'no', 'bien', 'mal',\r\n    'm\u00E1s', 'menos', 'muy', 'poco', 'mucho', 'todo', 'nada', 'algo', 'quien', 'que', 'como', 'cuando',\r\n    'donde', 'porque', 'ser', 'estar', 'ir', 'venir', 'hacer', 'tener', 'decir', 'dar', 'ver', 'poner',\r\n    'casa', 'tiempo', 'd\u00EDa', 'a\u00F1o', 'hombre', 'mujer', 'ni\u00F1o', 'ni\u00F1a', 'vida', 'ejemplo', 'palabra'\r\n  ]\r\n};\r\n\r\n/**\r\n * Calculates a \"Spanish likelihood score\" for a given text\r\n * Higher score = more likely to be Spanish\r\n * @param {string} text - Text to analyze\r\n * @returns {number} Score between 0-1\r\n */\r\nexport const calculateSpanishScore = (text) => {\r\n  if (!text || text.length < 3) return 0.5; // Too short to analyze meaningfully\r\n\r\n  const normalizedText = text.toLowerCase();\r\n\r\n  // Check for repeating characters (like \"aaa\")\r\n  if (hasExcessiveRepetition(normalizedText)) {\r\n    return 0.1; // Very likely gibberish\r\n  }\r\n\r\n  // Quick win: If text contains common Spanish words, boost the score\r\n  if (containsCommonSpanishWords(normalizedText)) {\r\n    return 0.8; // Very likely Spanish\r\n  }\r\n\r\n  // Check for invalid consonant clusters that don't exist in Spanish\r\n  if (hasInvalidConsonantClusters(normalizedText)) {\r\n    return 0.2; // Likely gibberish\r\n  }\r\n\r\n  // Normal scoring approach\r\n  const bigramScore = checkBigrams(normalizedText);\r\n  const vowelScore = checkVowelRatio(normalizedText);\r\n  const endingScore = checkWordEndings(normalizedText);\r\n  const specialCharScore = checkSpecialChars(normalizedText);\r\n\r\n  // Calculate weighted final score - adjusted weights\r\n  const score = (bigramScore * 0.5) + (vowelScore * 0.3) + (endingScore * 0.15) + (specialCharScore * 0.05);\r\n\r\n  return Math.min(1, Math.max(0, score));\r\n};\r\n\r\n/**\r\n * Checks if text is likely Spanish or gibberish\r\n * @param {string} text - Text to check\r\n * @returns {boolean} True if the text appears to be Spanish\r\n */\r\nexport const isLikelySpanish = (text) => {\r\n  // Special case for \"subt\u00EDtulo\" and other known false positives\r\n  const knownSpanishWords = [\"subt\u00EDtulo\", \"t\u00EDtulo\", \"cap\u00EDtulo\", \"fauna\", \"flora\", \"c\u00E1psula\", \"c\u00E1psulas\", \"c\u00E1psula\", \"rubio\", \"rubia\", \"t\u00EDtulos\", \"subt\u00EDtulos\", \"gris\"];\r\n  for (const word of knownSpanishWords) {\r\n    if (text.toLowerCase().includes(word)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  const score = calculateSpanishScore(text);\r\n  return score > 0.25; // Adjusted threshold\r\n};\r\n\r\n// Enhanced helper functions\r\nfunction checkBigrams(text) {\r\n  let matches = 0;\r\n  let totalBigrams = 0;\r\n\r\n  for (let i = 0; i < text.length - 1; i++) {\r\n    const bigram = text.substring(i, i + 2);\r\n    // Skip bigrams with spaces\r\n    if (bigram.includes(' ')) continue;\r\n\r\n    totalBigrams++;\r\n    if (SPANISH_FEATURES.commonBigrams.includes(bigram)) {\r\n      matches++;\r\n    }\r\n  }\r\n\r\n  return totalBigrams > 0 ? Math.min(1, matches / totalBigrams) : 0;\r\n}\r\n\r\nfunction checkVowelRatio(text) {\r\n  // Remove spaces for more accurate calculation\r\n  const textNoSpaces = text.replace(/\\s+/g, '');\r\n  if (textNoSpaces.length === 0) return 0;\r\n\r\n  let vowelCount = 0;\r\n\r\n  for (let i = 0; i < textNoSpaces.length; i++) {\r\n    if (SPANISH_FEATURES.vowels.includes(textNoSpaces[i])) {\r\n      vowelCount++;\r\n    }\r\n  }\r\n\r\n  // Spanish typically has around 45-50% vowels\r\n  const vowelRatio = vowelCount / textNoSpaces.length;\r\n\r\n  // Calculate score based on proximity to ideal Spanish vowel ratio\r\n  return 1 - Math.min(1, Math.abs(0.47 - vowelRatio) * 2.5);\r\n}\r\n\r\nfunction checkWordEndings(text) {\r\n  const words = text.split(/\\s+/).filter(word => word.length > 2);\r\n  if (words.length === 0) return 0;\r\n\r\n  let endingMatches = 0;\r\n\r\n  words.forEach(word => {\r\n    for (const ending of SPANISH_FEATURES.commonEndings) {\r\n      if (word.endsWith(ending)) {\r\n        endingMatches++;\r\n        break;\r\n      }\r\n    }\r\n  });\r\n\r\n  return Math.min(1, endingMatches / words.length);\r\n}\r\n\r\nfunction checkSpecialChars(text) {\r\n  let specialCharCount = 0;\r\n\r\n  for (const char of SPANISH_FEATURES.specialChars) {\r\n    if (text.includes(char)) {\r\n      specialCharCount++;\r\n    }\r\n  }\r\n\r\n  return Math.min(1, specialCharCount / 3);\r\n}\r\n\r\n// New helper functions\r\nfunction hasExcessiveRepetition(text) {\r\n  // Check for triple or more repeated characters\r\n  if (/(.)\\1{2,}/.test(text)) {\r\n    return true;\r\n  }\r\n\r\n  // Check for repeating patterns (like \"ababab\")\r\n  const repeatingPatternRegex = /(.{2,})\\1{2,}/;\r\n  return repeatingPatternRegex.test(text);\r\n}\r\n\r\nfunction containsCommonSpanishWords(text) {\r\n  const words = text.split(/\\s+/);\r\n\r\n  for (const word of words) {\r\n    if (word.length > 1 && SPANISH_FEATURES.commonWords.includes(word)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction hasInvalidConsonantClusters(text) {\r\n  for (const cluster of SPANISH_FEATURES.invalidClusters) {\r\n    if (text.includes(cluster)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}", "/**\r\n * Basic profanity filter for educational applications\r\n * Self-contained implementation without external dependencies\r\n */\r\n\r\n// Basic list of inappropriate words in English and Spanish\r\nconst inappropriateWords = [\r\n  // English words\r\n  'fuck', 'shit', 'ass', 'damn', 'bitch', 'bastard', 'cunt', 'dick', 'penis', 'vagina',\r\n  // Spanish words  \r\n  'mierda', 'puta', 'pene', 'pija', 'boludez', 'puto', 'boludo', 'boluda', 'joder', 'carajo', 'co\u00F1o', 'pendejo', 'culero', 'verga', 'polla',\r\n  'chinga', 'follar', 'marica', 'maricon', 'pinche', 'cabron', 'cabr\u00F3n', 'culo', 'gilipollas', 'qu\u00E9 cabr\u00F3n', 'la concha de tu madre', 'co\u00F1o', 'carajo', 'puta madre', 'pelotudo'\r\n];\r\n\r\n/**\r\n * Checks if text contains inappropriate language\r\n * @param {string} text - Text to check\r\n * @returns {boolean} - True if inappropriate language is detected\r\n */\r\nexport const containsProfanity = (text) => {\r\n  if (!text || typeof text !== 'string') return false;\r\n\r\n  // Convert to lowercase for case-insensitive matching\r\n  const lowerText = text.toLowerCase();\r\n\r\n  // Check if any of the inappropriate words appear in the text\r\n  return inappropriateWords.some(word => {\r\n    // Check for whole words by looking for word boundaries\r\n    const regex = new RegExp(`\\\\b${word}\\\\b`, 'i');\r\n    return regex.test(lowerText);\r\n  });\r\n};\r\n\r\n/**\r\n * Gets a clean version of the text with profanity replaced by asterisks\r\n * @param {string} text - Text to clean\r\n * @returns {string} - Cleaned text\r\n */\r\nexport const cleanText = (text) => {\r\n  if (!text || typeof text !== 'string') return text;\r\n\r\n  let cleanedText = text;\r\n\r\n  inappropriateWords.forEach(word => {\r\n    const regex = new RegExp(`\\\\b${word}\\\\b`, 'gi');\r\n    cleanedText = cleanedText.replace(regex, '*'.repeat(word.length));\r\n  });\r\n\r\n  return cleanedText;\r\n};", "import { ActivityTypes, updateSubmitButtonAndToast } from '../utils.js';\r\nimport { translateText } from '../translations.js';\r\nimport { playActivitySound } from '../audio.js';\r\nimport { checkMultipleChoice } from './multiple_choice.js';\r\nimport { checkQuiz } from './quiz.js';\r\nimport { checkFillInTheBlank, clearInputValidationFeedback } from './fill_in_the_blank.js';\r\nimport { checkMatching } from './matching.js';\r\nimport { checkSorting } from './sorting.js';\r\nimport { checkTrueFalse } from './true_false.js';\r\nimport { checkTableInputs } from './fill_in_a_table.js';\r\nimport { isLikelySpanish } from './gibberish_detector.js';\r\nimport { executeMail } from './send-email.js';\r\nimport { containsProfanity } from './profanity_detector.js';\r\nimport TextValidator from './textvalidator.js';\r\n\r\n/**\r\n * Central validation handler for all activity types\r\n * @param {string} activityType - Type of activity to validate\r\n * @returns {void}\r\n */\r\nexport const validateInputs = (activityType) => {\r\n    try {\r\n        switch (activityType) {\r\n            case ActivityTypes.MULTIPLE_CHOICE:\r\n                checkMultipleChoice();\r\n                break;\r\n\r\n            case ActivityTypes.QUIZ:\r\n                checkQuiz();\r\n                break;\r\n\r\n            case ActivityTypes.FILL_IN_THE_BLANK:\r\n                checkFillInTheBlank();\r\n                break;\r\n\r\n            case ActivityTypes.OPEN_ENDED_ANSWER:\r\n                validateOpenEndedAnswer();\r\n                break;\r\n\r\n            case ActivityTypes.SORTING:\r\n                checkSorting();\r\n                break;\r\n\r\n            case ActivityTypes.MATCHING:\r\n                checkMatching();\r\n                break;\r\n\r\n            case ActivityTypes.TRUE_FALSE:\r\n                checkTrueFalse();\r\n                break;\r\n\r\n            case ActivityTypes.FILL_IN_A_TABLE:\r\n                checkTableInputs();\r\n                break;\r\n\r\n            default:\r\n                console.error(\"Unknown validation type:\", activityType);\r\n                throw new Error(`Unsupported activity type: ${activityType}`);\r\n        }\r\n    } catch (error) {\r\n        console.error(`Validation error for ${activityType}:`, error);\r\n        handleValidationError(error);\r\n    }\r\n};\r\n\r\n// Also ensure the open-ended text inputs clear validation on input\r\nconst setupOpenEndedInputListeners = () => {\r\n    const inputs = document.querySelectorAll('section input[type=\"text\"], section textarea');\r\n    inputs.forEach(input => {\r\n        // Remove existing listener to avoid duplicates\r\n        input.removeEventListener('input', handleOpenEndedInputChange);\r\n        // Add the listener\r\n        input.addEventListener('input', handleOpenEndedInputChange);\r\n    });\r\n};\r\n\r\nconst handleOpenEndedInputChange = (event) => {\r\n    const input = event.target;\r\n    clearInputValidationFeedback(input);\r\n};\r\n\r\n/**\r\n * Validates text inputs for open-ended answers\r\n */\r\nconst validateOpenEndedAnswer = async () => {\r\n    // First, set up the input listeners to clear validation on change\r\n    setupOpenEndedInputListeners();\r\n\r\n    // Only select inputs within the activity section, not from the entire page\r\n    const activitySection = document.querySelector('[data-section-type=\"activity_open_ended_answer\"]');\r\n    if (!activitySection) {\r\n        console.error(\"No open-ended activity section found\");\r\n        return;\r\n    }\r\n\r\n    const textInputs = activitySection.querySelectorAll('input[type=\"text\"]:not(#filter-input), textarea:not(#filter-input)');\r\n\r\n    // First, clear any existing feedback to avoid duplication\r\n    textInputs.forEach(input => {\r\n        clearInputValidationFeedback(input);\r\n    });\r\n\r\n    const unfilledCount = countUnfilledTextInputs(textInputs);\r\n\r\n    // Check for gibberish in filled inputs - now async\r\n    const hasInvalidContent = await checkForGibberish(textInputs);\r\n\r\n    const allValid = unfilledCount === 0 && !hasInvalidContent;\r\n\r\n    playActivityFeedback(allValid);\r\n    const activityId = location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n    let key = activityId + \"-intentos\";\r\n    let intentCount = localStorage.getItem(key);\r\n    if (intentCount === null) {\r\n        localStorage.setItem(key, \"0\");\r\n        intentCount = 0;\r\n    } else {\r\n        intentCount = parseInt(intentCount, 10);\r\n    }\r\n\r\n    intentCount++;\r\n    localStorage.setItem(key, intentCount.toString());\r\n\r\n    if (allValid) {\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n        // Recuperar el arreglo de actividades completadas del localStorage\r\n        const storedActivities = localStorage.getItem(\"completedActivities\");\r\n        let completedActivities = storedActivities ? JSON.parse(storedActivities) : [];\r\n\r\n        const namePage = localStorage.getItem(\"namePage\");\r\n        const timeDone = new Date().toLocaleString(\"es-ES\");\r\n        const newActivityId = `${activityId}-${namePage}-${intentCount}-${timeDone}`;\r\n\r\n        // Remover cualquier entrada anterior con el mismo activityId\r\n        completedActivities = completedActivities.filter(id => !id.startsWith(`${activityId}-`));\r\n\r\n        // Agregar la nueva entrada actualizada\r\n        completedActivities.push(newActivityId);\r\n\r\n        // Guardar en localStorage\r\n        localStorage.setItem(\"completedActivities\", JSON.stringify(completedActivities));\r\n\r\n\r\n        localStorage.setItem(\"namePage\", document.querySelector(\"h1\")?.innerText ?? \"unknown_page\");\r\n\r\n        executeMail(ActivityTypes.OPEN_ENDED_ANSWER);\r\n    }\r\n\r\n    updateActivityFeedback(allValid, unfilledCount, hasInvalidContent);\r\n};\r\n\r\n/**\r\n * Counts unfilled text inputs\r\n * @param {NodeList} inputs - Collection of input elements\r\n * @returns {number} Number of unfilled inputs\r\n */\r\n\r\nconst countUnfilledTextInputs = (inputs) => {\r\n    let unfilledCount = 0;\r\n    let firstUnfilledInput = null;\r\n\r\n    // Process each input directly\r\n    Array.from(inputs).forEach((input) => {\r\n        const isFilled = input.value.trim() !== \"\";\r\n\r\n        // Apply regular validation feedback to all inputs\r\n        provideFeedback(input, isFilled);\r\n\r\n        if (!isFilled) {\r\n            unfilledCount++;\r\n            if (!firstUnfilledInput) {\r\n                firstUnfilledInput = input;\r\n            }\r\n        }\r\n    });\r\n\r\n    // Focus first unfilled input \r\n    if (firstUnfilledInput) {\r\n        setTimeout(() => {\r\n            firstUnfilledInput.focus();\r\n        }, 50);\r\n    }\r\n\r\n    return unfilledCount;\r\n};\r\n\r\n// /**\r\n//  * Checks if any filled text inputs contain gibberish instead of Spanish\r\n//  * @param {NodeList} inputs - Collection of input elements\r\n//  * @returns {boolean} True if gibberish detected\r\n//  */\r\n\r\n// // Update the checkForGibberish function to also check for profanity\r\n// export const checkForGibberish = (inputs) => {\r\n//     let hasGibberish = false;\r\n//     let hasProfanity = false;\r\n//     let firstGibberishInput = null;\r\n//     let firstProfanityInput = null;\r\n\r\n//     inputs.forEach((input) => {\r\n//         const text = input.value.trim();\r\n//         if (text.length > 0) {\r\n//             // Check for gibberish first\r\n//             const isSpanish = isLikelySpanish(text);\r\n\r\n//             if (!isSpanish) {\r\n//                 hasGibberish = true;\r\n//                 provideFeedbackForGibberish(input);\r\n\r\n//                 if (!firstGibberishInput) {\r\n//                     firstGibberishInput = input;\r\n//                 }\r\n//             } else {\r\n//                 // Only check for profanity if the text passed the Spanish test\r\n//                 const containsExplicitContent = containsProfanity(text);\r\n\r\n//                 if (containsExplicitContent) {\r\n//                     hasProfanity = true;\r\n//                     provideFeedbackForProfanity(input);\r\n\r\n//                     if (!firstProfanityInput) {\r\n//                         firstProfanityInput = input;\r\n//                     }\r\n//                 }\r\n//             }\r\n//         }\r\n//     });\r\n\r\n//     // Prioritize focusing profanity issues over gibberish\r\n//     if (firstProfanityInput) {\r\n//         firstProfanityInput.focus();\r\n//     } else if (firstGibberishInput) {\r\n//         firstGibberishInput.focus();\r\n//     }\r\n\r\n//     return hasGibberish || hasProfanity;\r\n// };\r\n\r\n/**\r\n * Checks if any filled text inputs contain gibberish instead of Spanish/English\r\n * Updated to use the multilingual TextValidator\r\n * @param {NodeList} inputs - Collection of input elements\r\n * @returns {boolean} True if gibberish or profanity detected\r\n */\r\nexport const checkForGibberish = async (inputs) => {\r\n    let hasGibberish = false;\r\n    let hasProfanity = false;\r\n    let firstGibberishInput = null;\r\n    let firstProfanityInput = null;\r\n\r\n    // Use the globally pre-initialized validator if available\r\n    const textValidator = window.globalTextValidator || new TextValidator();\r\n\r\n    if (!window.globalTextValidator) {\r\n        await textValidator.ensureInitialized();\r\n    }\r\n\r\n    // Convert NodeList to Array to use async/await properly\r\n    const inputsArray = Array.from(inputs);\r\n\r\n    // Process each input\r\n    for (const input of inputsArray) {\r\n        const text = input.value.trim();\r\n        if (text.length > 0) {\r\n            try {\r\n                const containsExplicitContent = containsProfanity(text);\r\n\r\n                if (containsExplicitContent) {\r\n                    hasProfanity = true;\r\n                    provideFeedbackForProfanity(input);\r\n\r\n                    if (!firstProfanityInput) {\r\n                        firstProfanityInput = input;\r\n                    }\r\n                } else {\r\n\r\n                    // Skip gibberish validation for inputs with do-not-validate class\r\n                    const skipGibberishValidation = input.classList.contains(\"do-not-validate\");\r\n                    if (skipGibberishValidation) {\r\n                        continue;\r\n                    }\r\n                    // Use our pre-initialized validator instance\r\n                    const isValidText = await textValidator.isValidText(text);\r\n\r\n                    if (!isValidText) {\r\n                        hasGibberish = true;\r\n                        provideFeedbackForGibberish(input);\r\n\r\n                        if (!firstGibberishInput) {\r\n                            firstGibberishInput = input;\r\n                        }\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                console.error(\"Error validating text:\", error);\r\n                // On error, fall back to the original isLikelySpanish as a backup\r\n                const isSpanish = isLikelySpanish(text);\r\n\r\n                if (!isSpanish) {\r\n                    hasGibberish = true;\r\n                    provideFeedbackForGibberish(input);\r\n\r\n                    if (!firstGibberishInput) {\r\n                        firstGibberishInput = input;\r\n                    }\r\n                } else {\r\n                    // Check for profanity\r\n                    const containsExplicitContent = containsProfanity(text);\r\n\r\n                    if (containsExplicitContent) {\r\n                        hasProfanity = true;\r\n                        provideFeedbackForProfanity(input);\r\n\r\n                        if (!firstProfanityInput) {\r\n                            firstProfanityInput = input;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // Prioritize focusing profanity issues over gibberish\r\n    if (firstProfanityInput) {\r\n        firstProfanityInput.focus();\r\n    } else if (firstGibberishInput) {\r\n        firstGibberishInput.focus();\r\n    }\r\n\r\n    return hasGibberish || hasProfanity;\r\n};\r\n\r\n// Add new function for profanity feedback\r\nconst provideFeedbackForProfanity = (input) => {\r\n\r\n    // First, clear any existing validation icons\r\n    clearInputValidationFeedback(input);\r\n\r\n    // Create feedback element\r\n    const feedback = createFeedbackElement();\r\n    feedback.classList.add(\"text-red-600\");\r\n    feedback.textContent = translateText(\"validation-inappropriate-language\") || \"Inappropriate language\";\r\n    feedback.style.display = \"block\";\r\n    feedback.style.width = \"100%\";\r\n    feedback.style.textAlign = \"left\";\r\n\r\n    //  // Add proper spacing and visual cues\r\n    //  feedback.classList.add(\"mt-2\", \"pl-2\", \"border-l-4\", \"border-red-500\", \"bg-red-50\", \"p-2\", \"rounded\");\r\n\r\n    // Clear any existing styles and add red border to match the profanity feedback\r\n    input.classList.remove(\r\n        \"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\",\r\n        \"border-orange-500\", \"focus:border-orange-500\", \"focus:ring-orange-200\"\r\n    );\r\n    input.classList.add(\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\", \"focus:ring\");\r\n\r\n    // Add ARIA attributes for accessibility\r\n    input.setAttribute(\"aria-invalid\", \"true\");\r\n    input.setAttribute(\"aria-label\", `${input.value} - ${translateText(\"validation-inappropriate-language\") || \"Inappropriate language\"}`);\r\n    input.setAttribute(\"data-has-profanity-feedback\", \"true\");\r\n\r\n    // Ensure input has proper padding if we're going to add an icon\r\n    input.style.paddingRight = '30px';\r\n\r\n    // // Remove any existing feedback icons for this input\r\n    // const existingIcons = document.querySelectorAll(`.feedback-icon-for-${input.id || 'profanity'}`);\r\n    // existingIcons.forEach(icon => icon.remove());\r\n\r\n    // Create an icon element for visual feedback\r\n    const iconElement = document.createElement(\"div\");\r\n    // Use both ID and data-activity-item for more reliable cleanup\r\n    const dataAriaId = input.getAttribute('data-aria-id') || '';\r\n    const dataActivityItem = input.getAttribute('data-activity-item') || '';\r\n    iconElement.className = `feedback-icon-for-${dataAriaId || input.id || dataActivityItem || 'profanity'}`;\r\n\r\n    iconElement.style.position = \"absolute\";\r\n    iconElement.style.pointerEvents = \"none\";\r\n    iconElement.style.zIndex = \"10\";\r\n\r\n    // Add the warning icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = \"fas fa-exclamation-circle text-red-600 feedback-icon\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n    iconElement.appendChild(icon);\r\n\r\n    // Position the icon element\r\n    const rect = input.getBoundingClientRect();\r\n    const parentRect = input.parentNode.getBoundingClientRect();\r\n\r\n    // Calculate position relative to the parent\r\n    const top = rect.top - parentRect.top + (rect.height - 24) / 2;\r\n    const right = parentRect.right - rect.right + 10;\r\n\r\n    // Set the position\r\n    iconElement.style.top = `${top}px`;\r\n    iconElement.style.right = `${right}px`;\r\n\r\n    // Make sure parent has position relative or absolute\r\n    const parentPosition = window.getComputedStyle(input.parentNode).position;\r\n    if (parentPosition === 'static') {\r\n        input.parentNode.style.position = 'relative';\r\n    }\r\n\r\n    // Add the icon after the input\r\n    input.parentNode.insertBefore(iconElement, input.nextSibling);\r\n\r\n    // Add text feedback after the parent div containing the input\r\n    const textParent = findAppropriateParentForFeedback(input);\r\n    textParent.appendChild(feedback);\r\n\r\n    //appendFeedback(input, feedback);\r\n    setupAriaAttributes(input, feedback);\r\n};\r\n\r\n// Add a helper function to find the appropriate parent element for the feedback text\r\nexport const findAppropriateParentForFeedback = (input) => {\r\n    // Start with the direct parent\r\n    let parent = input.parentNode;\r\n\r\n    // In 17_0_adt.html, the structure is typically:\r\n    // <div class=\"bg-blue-50 p-4 rounded-lg flex items-center\">\r\n    //   <img ...>\r\n    //   <textarea ...></textarea>\r\n    // </div>\r\n\r\n    // Check if we're in a flex container\r\n    const isFlexContainer = window.getComputedStyle(parent).display === 'flex';\r\n\r\n    // Special case for grid layouts like in 16_2_adt.html\r\n    const isGridContainer = window.getComputedStyle(parent).display === 'grid';\r\n\r\n    if (isFlexContainer || isGridContainer) {\r\n        // Instead of creating a wrapper inside the flex container,\r\n        // look for the parent of the flex container to place feedback after it\r\n        const containerParent = parent.parentNode;\r\n\r\n        // Create a feedback container that will be placed AFTER the flex container\r\n        const feedbackContainer = document.createElement('div');\r\n        feedbackContainer.className = 'feedback-container w-full mt-2';\r\n        feedbackContainer.style.marginTop = '0.5rem';\r\n\r\n        // Insert the feedback container after the container\r\n        if (containerParent.lastChild === parent) {\r\n            containerParent.appendChild(feedbackContainer);\r\n        } else {\r\n            containerParent.insertBefore(feedbackContainer, parent.nextSibling);\r\n        }\r\n\r\n        return feedbackContainer;\r\n    }\r\n\r\n    // Special case for textareas in 16_2_adt.html that aren't in flex containers\r\n    // but still need feedback positioned afterward\r\n    if (input.tagName.toLowerCase() === 'textarea') {\r\n        // Create a wrapper div if one doesn't exist\r\n        const wrapper = document.createElement('div');\r\n        wrapper.className = 'feedback-container w-full';\r\n\r\n        // Insert the wrapper after the textarea\r\n        parent.insertBefore(wrapper, input.nextSibling);\r\n        return wrapper;\r\n    }\r\n\r\n    // If not in a special container, just return the parent\r\n    return parent;\r\n};\r\n\r\n/**\r\n * Provides feedback for gibberish detection\r\n * @param {HTMLElement} input - Input element with gibberish\r\n */\r\nconst provideFeedbackForGibberish = (input) => {\r\n    // First, clear any existing validation icons\r\n    clearInputValidationFeedback(input);\r\n\r\n    const feedback = createFeedbackElement();\r\n    feedback.classList.add(\"text-orange-500\");\r\n    feedback.textContent = translateText(\"validation-check-spelling\") || \"Check your spelling\";\r\n    feedback.style.display = \"block\";\r\n    feedback.style.width = \"100%\";\r\n    feedback.style.textAlign = \"left\";\r\n\r\n    // Clear any existing styles and add orange border to match the gibberish feedback\r\n    input.classList.remove(\r\n        \"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\",\r\n        \"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\"\r\n    );\r\n    input.classList.add(\"border-orange-500\", \"focus:border-orange-500\", \"focus:ring-orange-200\", \"focus:ring\");\r\n\r\n    // Add ARIA attributes for accessibility\r\n    input.setAttribute(\"aria-invalid\", \"true\");\r\n    input.setAttribute(\"aria-label\", `${input.value} - ${translateText(\"validation-check-spelling\") || \"Check your spelling\"}`);\r\n    input.setAttribute(\"data-has-gibberish-feedback\", \"true\"); // Mark this input as having gibberish feedback\r\n\r\n    // Ensure input has proper padding if we're going to add an icon\r\n    input.style.paddingRight = '30px';\r\n\r\n    // // Remove any existing feedback icons for this input\r\n    // const existingIcons = document.querySelectorAll(`.feedback-icon-for-${input.id || 'gibberish'}`);\r\n    // existingIcons.forEach(icon => icon.remove());\r\n\r\n    // Create an icon element for visual feedback\r\n    const iconElement = document.createElement(\"div\");\r\n    // Use data-aria-id as primary identifier\r\n    const dataAriaId = input.getAttribute('data-aria-id') || '';\r\n    iconElement.className = `feedback-icon-for-${dataAriaId || input.id || 'gibberish'}`;\r\n\r\n    iconElement.style.position = \"absolute\";\r\n    iconElement.style.pointerEvents = \"none\";\r\n    iconElement.style.zIndex = \"10\";\r\n\r\n    // Add the warning icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = \"fas fa-question-circle text-orange-500 feedback-icon\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n    iconElement.appendChild(icon);\r\n\r\n    // Position the icon element\r\n    const rect = input.getBoundingClientRect();\r\n    const parentRect = input.parentNode.getBoundingClientRect();\r\n\r\n    // Calculate position relative to the parent\r\n    const top = rect.top - parentRect.top + (rect.height - 24) / 2;\r\n    const right = parentRect.right - rect.right + 10;\r\n\r\n    // Set the position\r\n    iconElement.style.top = `${top}px`;\r\n    iconElement.style.right = `${right}px`;\r\n\r\n    // Make sure parent has position relative or absolute\r\n    const parentPosition = window.getComputedStyle(input.parentNode).position;\r\n    if (parentPosition === 'static') {\r\n        input.parentNode.style.position = 'relative';\r\n    }\r\n\r\n    // Add the icon after the input\r\n    input.parentNode.insertBefore(iconElement, input.nextSibling);\r\n\r\n    // Find appropriate container and add the text feedback\r\n    // This will place it outside the flex container\r\n    const textParent = findAppropriateParentForFeedback(input);\r\n    textParent.appendChild(feedback);\r\n\r\n    //appendFeedback(input, feedback);\r\n    setupAriaAttributes(input, feedback);\r\n};\r\n\r\n/**\r\n * Provides feedback for input validation\r\n * @param {HTMLElement} input - Input element to validate\r\n * @param {boolean} isValid - Validation state\r\n */\r\nconst provideFeedback = (input, isValid) => {\r\n    // We'll directly apply the provideFeedback from utils.js\r\n    const utils = window.utils || {};\r\n    if (utils.provideFeedback) {\r\n        utils.provideFeedback(input, isValid, \"\", ActivityTypes.OPEN_ENDED_ANSWER);\r\n    } else {\r\n        // Direct application if utils not available\r\n        applyFeedbackToInput(input, isValid);\r\n    }\r\n\r\n    //const feedback = createFeedbackElement();\r\n\r\n    // if (isValid) {\r\n    //     applyValidFeedbackStyles(feedback);\r\n    // } else {\r\n    //     applyInvalidFeedbackStyles(feedback);\r\n    // }\r\n\r\n    // appendFeedback(input, feedback);\r\n    // setupAriaAttributes(input, feedback);\r\n\r\n    // We're actually going to use the utils.provideFeedback which will call handleTextInputFeedback\r\n    // This ensures consistent styling across all activity types\r\n    // import('../utils.js').then(utils => {\r\n    //     utils.provideFeedback(input, isValid, \"\", ActivityTypes.OPEN_ENDED_ANSWER);\r\n    // });\r\n};\r\n\r\n// Add a direct feedback application function\r\nconst applyFeedbackToInput = (input, isValid) => {\r\n    // Ensure element has padding to accommodate the icon\r\n    input.style.paddingRight = '30px';\r\n\r\n    // Remove any existing feedback icons first\r\n    const existingIconClass = `.feedback-icon-for-${input.id || 'feedback'}`;\r\n    const existingIcon = document.querySelector(existingIconClass);\r\n    if (existingIcon) existingIcon.remove();\r\n\r\n    // Create an icon element\r\n    const iconElement = document.createElement(\"div\");\r\n    // Use data-aria-id as primary identifier\r\n    const dataAriaId = input.getAttribute('data-aria-id') || '';\r\n    iconElement.className = `feedback-icon-for-${dataAriaId || input.id || 'feedback'}`;\r\n\r\n    // Position the icon absolutely within the input's coordinate space\r\n    iconElement.style.position = \"absolute\";\r\n    iconElement.style.pointerEvents = \"none\";\r\n    iconElement.style.zIndex = \"10\";\r\n\r\n    // Add the Font Awesome icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = isValid ?\r\n        \"fas fa-check-circle text-green-600 feedback-icon\" :\r\n        \"fas fa-times-circle text-red-600 feedback-icon\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n    iconElement.appendChild(icon);\r\n\r\n    // Add appropriate ARIA attributes for accessibility\r\n    if (isValid) {\r\n        input.setAttribute(\"aria-invalid\", \"false\");\r\n        input.setAttribute(\"aria-label\", `${input.value} - ${translateText(\"fill-in-the-blank-correct-answer\")}`);\r\n\r\n        // Add matching green border and focus styles to input\r\n        input.classList.remove(\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\");\r\n        input.classList.add(\"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\", \"focus:ring\");\r\n    } else {\r\n        input.setAttribute(\"aria-invalid\", \"true\");\r\n        input.setAttribute(\"aria-label\", `${input.value} - ${translateText(\"fill-in-the-blank-try-again\")}`);\r\n\r\n        // Add matching red border and focus styles to input\r\n        input.classList.remove(\"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\");\r\n        input.classList.add(\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\", \"focus:ring\");\r\n    }\r\n\r\n    // Position the icon element absolutely related to the input\r\n    const rect = input.getBoundingClientRect();\r\n    const parentRect = input.parentNode.getBoundingClientRect();\r\n\r\n    // Calculate position relative to the parent\r\n    const top = rect.top - parentRect.top + (rect.height - 24) / 2; // Center icon vertically (24px is approx icon height)\r\n    const right = parentRect.right - rect.right + 10;\r\n\r\n    // Set the position\r\n    iconElement.style.top = `${top}px`;\r\n    iconElement.style.right = `${right}px`;\r\n\r\n    // Make sure parent has position relative or absolute\r\n    const parentPosition = window.getComputedStyle(input.parentNode).position;\r\n    if (parentPosition === 'static') {\r\n        input.parentNode.style.position = 'relative';\r\n    }\r\n\r\n    // Add the icon after the input (as a sibling)\r\n    input.parentNode.insertBefore(iconElement, input.nextSibling);\r\n}\r\n\r\n/**\r\n * Creates a feedback element with base styles\r\n * @returns {HTMLElement} Styled feedback element\r\n */\r\nconst createFeedbackElement = () => {\r\n    const feedback = document.createElement(\"span\");\r\n    feedback.classList.add(\r\n        \"feedback\",\r\n        // \"ml-2\",\r\n        // \"px-2\",\r\n        // \"py-1\",\r\n        // \"rounded-full\",\r\n        \"text-base\",\r\n        \"text-nowrap\",\r\n        \"font-medium\",\r\n        \"transition-colors\",\r\n        \"duration-200\"\r\n    );\r\n    feedback.setAttribute(\"role\", \"alert\");\r\n    return feedback;\r\n};\r\n\r\n/**\r\n * Applies styles for valid feedback\r\n * @param {HTMLElement} feedback - Feedback element\r\n */\r\nconst applyValidFeedbackStyles = (feedback) => {\r\n    feedback.classList.add(\"bg-green-100\", \"text-green-800\");\r\n    feedback.textContent = \"\u2713\";\r\n};\r\n\r\n/**\r\n * Applies styles for invalid feedback\r\n * @param {HTMLElement} feedback - Feedback element\r\n */\r\nconst applyInvalidFeedbackStyles = (feedback) => {\r\n    feedback.classList.add(\"bg-red-100\", \"text-red-800\");\r\n    feedback.textContent = \"\u00D7\";\r\n};\r\n\r\n/**\r\n * Appends feedback element to input container\r\n * @param {HTMLElement} input - Input element\r\n * @param {HTMLElement} feedback - Feedback element\r\n */\r\nconst appendFeedback = (input, feedback) => {\r\n    const container = input.parentElement;\r\n    const existingFeedback = container.querySelector(\".feedback\");\r\n\r\n    if (existingFeedback && container) {\r\n        try {\r\n            container.removeChild(existingFeedback);\r\n        } catch (e) {\r\n            console.warn(\"Could not remove feedback node:\", e);\r\n        }\r\n    }\r\n\r\n    container.appendChild(feedback);\r\n};\r\n\r\n/**\r\n * Sets up ARIA attributes for accessibility\r\n * @param {HTMLElement} input - Input element\r\n * @param {HTMLElement} feedback - Feedback element\r\n */\r\nconst setupAriaAttributes = (input, feedback) => {\r\n    const feedbackId = `feedback-${Math.random().toString(36).substr(2, 9)}`;\r\n    feedback.id = feedbackId;\r\n    input.setAttribute(\"aria-describedby\", feedbackId);\r\n};\r\n\r\n/**\r\n * Plays appropriate feedback sound\r\n * @param {boolean} isSuccess - Whether to play success or error sound\r\n */\r\nconst playActivityFeedback = (isSuccess) => {\r\n    playActivitySound(isSuccess ? 'success' : 'error');\r\n};\r\n\r\n/**\r\n * Updates activity feedback and UI state\r\n * @param {boolean} isValid - Overall validation state\r\n * @param {number} unfilledCount - Number of unfilled inputs\r\n * @param {boolean} hasGibberish - Whether gibberish was detected\r\n */\r\n// Update updateActivityFeedback to handle profanity cases\r\nconst updateActivityFeedback = (isValid, unfilledCount, hasInappropriateContent) => {\r\n    updateSubmitButtonAndToast(\r\n        isValid,\r\n        translateText(\"next-activity\"),\r\n        ActivityTypes.OPEN_ENDED_ANSWER,\r\n        unfilledCount\r\n    );\r\n\r\n    // Add specific feedback for inappropriate content\r\n    if (hasInappropriateContent) {\r\n        const toast = document.getElementById(\"toast\");\r\n        if (toast) {\r\n            toast.classList.remove(\"hidden\");\r\n            toast.classList.add(\"text-orange-700\");\r\n\r\n            // Since both gibberish and profanity are merged into one flag now\r\n            toast.textContent = translateText(\"validation-write-appropriate\") ||\r\n                \"Please use appropriate language\";\r\n\r\n            setTimeout(() => {\r\n                toast.classList.add(\"hidden\");\r\n            }, 3000);\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Handles validation errors\r\n * @param {Error} error - Error object\r\n */\r\nconst handleValidationError = (error) => {\r\n    const toast = document.getElementById(\"toast\");\r\n    if (toast) {\r\n        toast.textContent = translateText(\"validation-error\");\r\n        toast.classList.remove(\"hidden\");\r\n        toast.classList.add(\"bg-red-200\", \"text-red-700\");\r\n\r\n        setTimeout(() => {\r\n            toast.classList.add(\"hidden\");\r\n        }, 3000);\r\n    }\r\n};", "import { state, setState } from './modules/state.js';\r\nimport { ActivityTypes } from './modules/utils.js'; // Import ActivityTypes first\r\nimport { initializeActivityAudioElements, playActivitySound } from './modules/audio.js';\r\nimport { prepareMultipleChoice } from './modules/activities/multiple_choice.js';\r\nimport { prepareQuiz, resetQuizActivity } from './modules/activities/quiz.js';\r\nimport { prepareSorting } from './modules/activities/sorting.js';\r\nimport { prepareMatching } from './modules/activities/matching.js';\r\nimport { prepareTrueFalse } from './modules/activities/true_false.js';\r\nimport { validateInputs } from './modules/activities/validation.js';\r\nimport { preparefillInBlank } from './modules/activities/fill_in_the_blank.js';\r\nimport { prepareFillInTable } from './modules/activities/fill_in_a_table.js';\r\nimport { prepareOpenEnded } from './modules/activities/open_ended.js';\r\nimport { translateText } from './modules/translations.js';\r\nimport { nextPage } from './modules/navigation.js';\r\n\r\n// Constants for class names and selectors\r\nconst CLASS_NAMES = {\r\n    VALIDATION: {\r\n        SUCCESS: [\"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\"],\r\n        ERROR: [\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\"],\r\n        WARNING: [\"border-orange-500\", \"focus:border-orange-500\", \"focus:ring-orange-200\"]\r\n    },\r\n    FEEDBACK: {\r\n        SUCCESS: [\"bg-green-100\", \"border-green-300\"],\r\n        ERROR: [\"bg-red-100\", \"border-red-300\"]\r\n    }\r\n};\r\n\r\nconst SELECTORS = {\r\n    FILL_IN_THE_BLANK: 'section[data-section-type=\"activity_fill_in_the_blank\"]',\r\n    FILL_IN_A_TABLE: 'section[data-section-type=\"activity_fill_in_a_table\"]',\r\n    MULTIPLE_CHOICE: 'section[data-section-type=\"activity_multiple_choice\"]',\r\n    QUIZ: 'section[data-section-type=\"activity_quiz\"]',\r\n    TRUE_FALSE: 'section[data-section-type=\"activity_true_false\"]',\r\n    OPEN_ENDED: 'section[data-section-type=\"activity_open_ended_answer\"]'\r\n};\r\n\r\n// Helper function to get activity ID from path\r\nconst getActivityIdFromPath = () => {\r\n    return location.pathname\r\n        .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n        .split(\".\")[0];\r\n};\r\n\r\n// Check if any inputs matching the selector have non-empty values\r\nconst hasNonEmptyInputs = (selector) => {\r\n    const inputs = document.querySelectorAll(selector);\r\n    return Array.from(inputs).some(input => input.value.trim() !== '');\r\n};\r\n\r\n// Checks if an activity has user data based on activity type\r\nconst activityHasUserData = (activityType) => {\r\n    const activityId = getActivityIdFromPath();\r\n\r\n    // Common checks for localStorage data\r\n    const hasLocalStorageData = Object.keys(localStorage).some(key =>\r\n        key.startsWith(`${activityId}_`) &&\r\n        key !== `${activityId}_success`\r\n    );\r\n\r\n    if (!hasLocalStorageData) {\r\n        // Use a function lookup pattern instead of switch\r\n        if (activityType === 'activity_open_ended_answer') {\r\n            return hasNonEmptyInputs('section textarea, section input[type=\"text\"]');\r\n        }\r\n        else if (activityType === 'activity_fill_in_the_blank') {\r\n            return hasNonEmptyInputs('section .blank-input, section input[type=\"text\"]:not(#filter-input)');\r\n        }\r\n        else if (activityType === 'activity_fill_in_a_table') {\r\n            return hasNonEmptyInputs('section td input[type=\"text\"], section td textarea');\r\n        }\r\n        else if (activityType === 'activity_multiple_choice') {\r\n            return document.querySelectorAll('section input[type=\"radio\"]:checked').length > 0;\r\n        }\r\n        else if (activityType === 'activity_quiz') {\r\n            return document.querySelectorAll('section input[type=\"radio\"]:checked').length > 0;\r\n        }\r\n        else if (activityType === 'activity_true_false') {\r\n            return document.querySelectorAll('section input[type=\"radio\"]:checked').length > 0;\r\n        }\r\n        else if (activityType === 'activity_sorting') {\r\n            const placedItems = document.querySelectorAll('section .placed-word');\r\n            return placedItems.length > 0 || hasLocalStorageData;\r\n        }\r\n        else if (activityType === 'activity_matching') {\r\n            const matchedItems = document.querySelectorAll('section .matching-item.matched');\r\n            return matchedItems.length > 0 || hasLocalStorageData;\r\n        }\r\n    } else {\r\n        // If localStorage has data, we assume user data exists\r\n        return true;\r\n    }\r\n};\r\n\r\n// Simplified function to check for user data\r\nexport const checkForUserData = () => {\r\n    const activitySection = document.querySelector('section[role=\"activity\"]');\r\n    if (!activitySection) return false;\r\n\r\n    const activityType = activitySection.dataset.sectionType;\r\n    return activityHasUserData(activityType);\r\n};\r\n\r\n// Update the reset button visibility based on whether there's user data\r\nexport const updateResetButtonVisibility = () => {\r\n    const resetButton = document.getElementById(\"reset-button\");\r\n    if (!resetButton) return;\r\n    \r\n    const activitySection = document.querySelector('section[role=\"activity\"]');\r\n    const activityType = activitySection?.dataset.sectionType;\r\n    const resetSupportedTypes = new Set([\r\n        ActivityTypes.OPEN_ENDED_ANSWER,\r\n        ActivityTypes.FILL_IN_THE_BLANK,\r\n        ActivityTypes.SORTING,\r\n        ActivityTypes.FILL_IN_A_TABLE,\r\n        ActivityTypes.MATCHING\r\n    ]);\r\n\r\n    if (!resetSupportedTypes.has(activityType)) {\r\n        resetButton.classList.add(\"hidden\");\r\n        return;\r\n    }\r\n\r\n    // Check if there's any user data for this activity\r\n    const hasUserData = checkForUserData();\r\n\r\n    // Toggle visibility\r\n    resetButton.classList.toggle(\"hidden\", !hasUserData);\r\n};\r\n\r\n// Helper function to reset inputs\r\nconst resetInputs = (inputs, activityId) => {\r\n    inputs.forEach(input => {\r\n        input.value = '';\r\n        input.classList.remove(\r\n            ...CLASS_NAMES.VALIDATION.SUCCESS,\r\n            ...CLASS_NAMES.VALIDATION.ERROR,\r\n            ...CLASS_NAMES.VALIDATION.WARNING\r\n        );\r\n\r\n        const inputId = input.getAttribute(\"data-aria-id\") || input.getAttribute(\"data-activity-item\");\r\n        if (inputId) {\r\n            const localStorageKey = `${activityId}_${inputId}`;\r\n            localStorage.removeItem(localStorageKey);\r\n        }\r\n    });\r\n};\r\n\r\n// Helper function to clear feedback elements\r\nconst clearFeedbackElements = () => {\r\n    document.querySelectorAll(\"[class^='feedback-icon-for-']\").forEach(icon => {\r\n        icon.remove();\r\n    });\r\n    document.querySelectorAll(\".feedback-container\").forEach(container => {\r\n        container.innerHTML = '';\r\n    });\r\n};\r\n\r\n// Helper function for resetting selection-based activities\r\nconst resetSelectionInputs = (radioButtons) => {\r\n    radioButtons.forEach(radio => {\r\n        radio.checked = false;\r\n    });\r\n};\r\n\r\nconst submitActivityClasses = [\r\n    'min-w-[180px]',\r\n    'px-8',\r\n    'py-3',\r\n    'rounded-2xl',\r\n    'text-lg',\r\n    'font-semibold',\r\n    'shadow-lg'\r\n];\r\n\r\nconst resetActivityClasses = [\r\n    'px-6',\r\n    'py-3',\r\n    'rounded-2xl',\r\n    'text-lg',\r\n    'font-medium'\r\n];\r\n\r\nconst relocateActionButtons = (section) => {\r\n    const target = section?.querySelector('[data-submit-target]');\r\n    const submitButton = document.getElementById('submit-button');\r\n    const resetButton = document.getElementById('reset-button');\r\n    const originalContainer = document.getElementById('submit-reset-container');\r\n\r\n    if (!submitButton || !originalContainer) {\r\n        return;\r\n    }\r\n\r\n    const applyActivityStyles = () => {\r\n        submitActivityClasses.forEach(cls => submitButton.classList.add(cls));\r\n        resetButton && resetActivityClasses.forEach(cls => resetButton.classList.add(cls));\r\n        submitButton.dataset.submitLocation = 'activity';\r\n    };\r\n\r\n    const removeActivityStyles = () => {\r\n        submitActivityClasses.forEach(cls => submitButton.classList.remove(cls));\r\n        resetButton && resetActivityClasses.forEach(cls => resetButton.classList.remove(cls));\r\n        submitButton.dataset.submitLocation = 'interface';\r\n    };\r\n\r\n    if (target) {\r\n        if (!target.contains(submitButton)) {\r\n            target.appendChild(submitButton);\r\n            if (resetButton) {\r\n                target.appendChild(resetButton);\r\n            }\r\n            applyActivityStyles();\r\n        }\r\n        originalContainer.classList.add('hidden');\r\n    } else {\r\n        if (!originalContainer.contains(submitButton)) {\r\n            originalContainer.appendChild(submitButton);\r\n            if (resetButton) {\r\n                originalContainer.appendChild(resetButton);\r\n            }\r\n        }\r\n        removeActivityStyles();\r\n        originalContainer.classList.remove('hidden');\r\n    }\r\n};\r\n\r\n// Clear localStorage for an activity\r\nconst clearActivityLocalStorage = (activityId) => {\r\n    Object.keys(localStorage)\r\n        .filter(key => key.startsWith(`${activityId}_`))\r\n        .forEach(key => localStorage.removeItem(key));\r\n};\r\n\r\n// Helper function to reset the submit button\r\nconst resetSubmitButton = () => {\r\n    const submitButton = document.getElementById(\"submit-button\");\r\n    if (submitButton) {\r\n        submitButton.textContent = translateText(\"submit-text\");\r\n        submitButton.setAttribute(\"aria-label\", translateText(\"submit-text\"));\r\n        submitButton.removeEventListener(\"click\", nextPage);\r\n        submitButton.dataset.submitState = 'submit';\r\n\r\n        if (state.validateHandler) {\r\n            submitButton.addEventListener(\"click\", state.validateHandler);\r\n        }\r\n    }\r\n};\r\n\r\n// Clear all feedback elements and styling\r\nconst clearAllFeedback = () => {\r\n    // Elements to remove completely\r\n    const elementsToRemove = [\r\n        \".feedback-icon\",\r\n        \"[class^='feedback-icon-for-']\",\r\n        \".mark\",\r\n        \".validation-mark\",\r\n        \".sr-only\"\r\n    ].join(\", \");\r\n\r\n    document.querySelectorAll(elementsToRemove).forEach(el => el.remove());\r\n\r\n    // Elements to clear content\r\n    document.querySelectorAll(\".feedback-container\").forEach(container => {\r\n        container.innerHTML = '';\r\n    });\r\n\r\n    // Clear validation styling on inputs\r\n    document.querySelectorAll(\"input, textarea\").forEach(input => {\r\n        input.classList.remove(\r\n            ...CLASS_NAMES.VALIDATION.SUCCESS,\r\n            ...CLASS_NAMES.VALIDATION.ERROR,\r\n            ...CLASS_NAMES.VALIDATION.WARNING\r\n        );\r\n\r\n        [\"aria-invalid\", \"aria-describedby\", \"data-has-gibberish-feedback\", \"data-has-profanity-feedback\"]\r\n            .forEach(attr => input.removeAttribute(attr));\r\n    });\r\n\r\n    // Clear styling on activity options\r\n    document.querySelectorAll(\".activity-option span, .statement-option, .placed-word\").forEach(el => {\r\n        el.classList.remove(\r\n            ...CLASS_NAMES.FEEDBACK.SUCCESS,\r\n            ...CLASS_NAMES.FEEDBACK.ERROR,\r\n            \"border-green-600\", \"border-red-600\",\r\n            \"border-2\"\r\n        );\r\n    });\r\n\r\n    // Reset toast\r\n    const toast = document.getElementById(\"toast\");\r\n    if (toast) {\r\n        toast.textContent = \"\";\r\n        toast.classList.add(\"hidden\");\r\n        toast.classList.remove(\r\n            \"bg-red-200\", \"text-red-700\",\r\n            \"bg-green-200\", \"text-green-700\",\r\n            \"bg-orange-200\", \"text-orange-700\"\r\n        );\r\n    }\r\n\r\n    // Reset feedback element\r\n    const feedbackElement = document.getElementById(\"feedback\");\r\n    if (feedbackElement) {\r\n        feedbackElement.textContent = \"\";\r\n        feedbackElement.classList.remove(\"text-red-500\", \"text-green-500\");\r\n    }\r\n};\r\n\r\n// Base reset function for activity types\r\nconst resetActivityBase = (activityId, { sectionSelector, inputSelector, additionalReset }) => {\r\n    const activitySection = document.querySelector(sectionSelector);\r\n    const inputs = activitySection ?\r\n        activitySection.querySelectorAll(inputSelector) :\r\n        document.querySelectorAll(inputSelector);\r\n\r\n    resetInputs(inputs, activityId);\r\n\r\n    if (additionalReset && typeof additionalReset === 'function') {\r\n        additionalReset(activityId);\r\n    }\r\n\r\n    clearFeedbackElements();\r\n};\r\n\r\n// Initialize handlers using a function that will be called after module load\r\nfunction initializeActivityHandlers() {\r\n    // Define activity reset handlers\r\n    const activityResetHandlers = {};\r\n\r\n    // Add handlers to the object using ActivityTypes (now safe to use)\r\n    activityResetHandlers[ActivityTypes.FILL_IN_THE_BLANK] = (activityId) => {\r\n        resetActivityBase(activityId, {\r\n            sectionSelector: SELECTORS.FILL_IN_THE_BLANK,\r\n            inputSelector: 'input[type=\"text\"]:not(#filter-input)'\r\n        });\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.FILL_IN_A_TABLE] = (activityId) => {\r\n        resetActivityBase(activityId, {\r\n            sectionSelector: SELECTORS.FILL_IN_A_TABLE,\r\n            inputSelector: 'input[type=\"text\"]:not(#filter-input), textarea:not(#filter-input)'\r\n        });\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.MULTIPLE_CHOICE] = (activityId) => {\r\n        const activitySection = document.querySelector(SELECTORS.MULTIPLE_CHOICE);\r\n        const radioButtons = activitySection ?\r\n            activitySection.querySelectorAll('input[type=\"radio\"]') :\r\n            document.querySelectorAll('input[type=\"radio\"]');\r\n\r\n        resetSelectionInputs(radioButtons);\r\n\r\n        document.querySelectorAll(\".activity-option span\").forEach(option => {\r\n            option.classList.remove(\r\n                ...CLASS_NAMES.FEEDBACK.SUCCESS,\r\n                ...CLASS_NAMES.FEEDBACK.ERROR,\r\n                \"border-green-600\", \"border-red-600\", \"border-2\"\r\n            );\r\n\r\n            const mark = option.querySelector(\".mark\");\r\n            if (mark) mark.remove();\r\n\r\n            const srText = option.querySelector(\".sr-only\");\r\n            if (srText) srText.remove();\r\n        });\r\n\r\n        localStorage.removeItem(`${activityId}_selectedOption`);\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.QUIZ] = (activityId) => {\r\n        resetQuizActivity(activityId);\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.TRUE_FALSE] = (activityId) => {\r\n        const activitySection = document.querySelector(SELECTORS.TRUE_FALSE);\r\n        const radioButtons = activitySection ?\r\n            activitySection.querySelectorAll('input[type=\"radio\"]') :\r\n            document.querySelectorAll('input[type=\"radio\"]');\r\n\r\n        resetSelectionInputs(radioButtons);\r\n\r\n        document.querySelectorAll(\".statement-option\").forEach(option => {\r\n            option.classList.remove(\r\n                ...CLASS_NAMES.FEEDBACK.SUCCESS,\r\n                ...CLASS_NAMES.FEEDBACK.ERROR\r\n            );\r\n\r\n            const icon = option.querySelector(\".feedback-icon\");\r\n            if (icon) icon.remove();\r\n        });\r\n\r\n        Object.keys(localStorage)\r\n            .filter(key => key.startsWith(`${activityId}_tf_`))\r\n            .forEach(key => localStorage.removeItem(key));\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.OPEN_ENDED_ANSWER] = (activityId) => {\r\n        resetActivityBase(activityId, {\r\n            sectionSelector: SELECTORS.OPEN_ENDED,\r\n            inputSelector: 'textarea, input[type=\"text\"]'\r\n        });\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.SORTING] = (activityId) => {\r\n        import('./modules/activities/sorting.js').then(module => {\r\n            if (module.resetActivity) {\r\n                module.resetActivity(activityId);\r\n            }\r\n        });\r\n    };\r\n\r\n    activityResetHandlers[ActivityTypes.MATCHING] = (activityId) => {\r\n        import('./modules/activities/matching.js').then(module => {\r\n            if (module.resetActivity) {\r\n                module.resetActivity(activityId);\r\n            }\r\n        });\r\n    };\r\n\r\n    // Define activity setup handlers\r\n    const activityHandlers = {};\r\n\r\n    activityHandlers[ActivityTypes.MULTIPLE_CHOICE] = {\r\n        setup: prepareMultipleChoice,\r\n        validate: () => validateInputs(ActivityTypes.MULTIPLE_CHOICE)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.QUIZ] = {\r\n        setup: prepareQuiz,\r\n        validate: () => validateInputs(ActivityTypes.QUIZ)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.FILL_IN_THE_BLANK] = {\r\n        setup: preparefillInBlank,\r\n        validate: () => validateInputs(ActivityTypes.FILL_IN_THE_BLANK)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.OPEN_ENDED_ANSWER] = {\r\n        setup: prepareOpenEnded,\r\n        validate: () => validateInputs(ActivityTypes.OPEN_ENDED_ANSWER)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.SORTING] = {\r\n        setup: prepareSorting,\r\n        validate: () => validateInputs(ActivityTypes.SORTING)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.MATCHING] = {\r\n        setup: prepareMatching,\r\n        validate: () => validateInputs(ActivityTypes.MATCHING)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.TRUE_FALSE] = {\r\n        setup: prepareTrueFalse,\r\n        validate: () => validateInputs(ActivityTypes.TRUE_FALSE)\r\n    };\r\n\r\n    activityHandlers[ActivityTypes.FILL_IN_A_TABLE] = {\r\n        setup: prepareFillInTable,\r\n        validate: () => validateInputs(ActivityTypes.FILL_IN_A_TABLE)\r\n    };\r\n\r\n    return { activityResetHandlers, activityHandlers };\r\n}\r\n\r\n// Store the handlers in state when prepareActivity is called\r\nlet activityResetHandlers;\r\nlet activityHandlers;\r\n\r\n// Function to handle activity reset\r\nconst handleResetActivity = () => {\r\n    // Make sure handlers are initialized\r\n    if (!activityResetHandlers) {\r\n        const handlers = initializeActivityHandlers();\r\n        activityResetHandlers = handlers.activityResetHandlers;\r\n        activityHandlers = handlers.activityHandlers;\r\n    }\r\n\r\n    const activityId = getActivityIdFromPath();\r\n    clearActivityLocalStorage(activityId);\r\n\r\n    const activitySection = document.querySelector('section[role=\"activity\"]');\r\n    if (activitySection) {\r\n        const activityType = activitySection.dataset.sectionType;\r\n        const resetHandler = activityResetHandlers[activityType];\r\n\r\n        if (resetHandler) {\r\n            resetHandler(activityId);\r\n        } else {\r\n            console.warn(`No reset handler found for activity type: ${activityType}`);\r\n        }\r\n    }\r\n\r\n    playActivitySound('reset');\r\n    resetSubmitButton();\r\n    clearAllFeedback();\r\n    updateResetButtonVisibility();\r\n};\r\n\r\n// Setup an activity section with the appropriate handlers\r\nconst setupActivitySection = (section, activityType, submitButton) => {\r\n    // Make sure handlers are initialized\r\n    if (!activityHandlers) {\r\n        const handlers = initializeActivityHandlers();\r\n        activityResetHandlers = handlers.activityResetHandlers;\r\n        activityHandlers = handlers.activityHandlers;\r\n    }\r\n\r\n    const handler = activityHandlers[activityType];\r\n\r\n    if (handler) {\r\n        handler.setup(section);\r\n        setState('validateHandler', handler.validate);\r\n    } else {\r\n        console.error(\"Unknown activity type:\", activityType);\r\n    }\r\n\r\n    if (state.validateHandler) {\r\n        submitButton.removeEventListener(\"click\", state.validateHandler);\r\n        submitButton.addEventListener(\"click\", state.validateHandler);\r\n    }\r\n\r\n    relocateActionButtons(section);\r\n};\r\n\r\n// Main activity preparation function - make sure this is at the end of the file\r\nexport const prepareActivity = () => {\r\n    // Initialize the handlers\r\n    const handlers = initializeActivityHandlers();\r\n    activityResetHandlers = handlers.activityResetHandlers;\r\n    activityHandlers = handlers.activityHandlers;\r\n\r\n    initializeActivityAudioElements();\r\n    const activitySections = document.querySelectorAll('section[role=\"activity\"]');\r\n    const submitButton = document.getElementById(\"submit-button\");\r\n    const resetButton = document.getElementById(\"reset-button\");\r\n\r\n    if (activitySections.length === 0) {\r\n        if (submitButton) submitButton.classList.add(\"hidden\");\r\n        if (resetButton) resetButton.classList.add(\"hidden\");\r\n        return;\r\n    } else {\r\n        if (submitButton) submitButton.classList.remove(\"hidden\");\r\n        if (resetButton) resetButton.classList.remove(\"hidden\");\r\n    }\r\n\r\n    if (!submitButton) {\r\n        console.warn(\"Submit button not found\");\r\n        return;\r\n    }\r\n\r\n    activitySections.forEach((section) => {\r\n        const activityType = section.dataset.sectionType;\r\n        setupActivitySection(section, activityType, submitButton);\r\n    });\r\n\r\n    if (resetButton) {\r\n        resetButton.addEventListener(\"click\", handleResetActivity);\r\n    }\r\n\r\n    updateResetButtonVisibility();\r\n};", "/**\r\n * @module utils\r\n * @description\r\n * Utility functions for activity feedback, button toggles, toast notifications, and activity state management.\r\n */\r\n\r\nimport { state } from './state.js';\r\nimport { setCookie } from './cookies.js';\r\nimport { translateText } from './translations.js';\r\nimport { nextPage } from './navigation.js';\r\nimport { playActivitySound } from './audio.js';\r\nimport { trackActivityCompletion } from './analytics.js';\r\nimport { updateResetButtonVisibility } from '../activity.js';\r\n\r\n/**\r\n * Enum for supported activity types.\r\n * @readonly\r\n * @enum {string}\r\n */\r\nexport const ActivityTypes = Object.freeze({\r\n    MULTIPLE_CHOICE: \"activity_multiple_choice\",\r\n    QUIZ: \"activity_quiz\",\r\n    FILL_IN_THE_BLANK: \"activity_fill_in_the_blank\",\r\n    SORTING: \"activity_sorting\",\r\n    OPEN_ENDED_ANSWER: \"activity_open_ended_answer\",\r\n    MATCHING: \"activity_matching\",\r\n    TRUE_FALSE: \"activity_true_false\",\r\n    FILL_IN_A_TABLE: \"activity_fill_in_a_table\",\r\n});\r\n\r\nwindow.utils = {\r\n    provideFeedback: null\r\n}\r\n\r\n/**\r\n * Toggles the state of a custom toggle button and updates its visual state.\r\n * @param {string} buttonId - The ID of the toggle button element.\r\n * @param {boolean|null} [toState=null] - The state to set, or toggles if null.\r\n */\r\nexport const toggleButtonState = (buttonId, toState = null) => {\r\n    const button = document.getElementById(buttonId);\r\n    if (button) {\r\n        const isChecked = button.getAttribute('aria-checked') === 'true';\r\n        const newState = toState !== null ? toState : !isChecked;\r\n\r\n        button.setAttribute('aria-checked', newState);\r\n        button.querySelector('#toggle-dot').classList.toggle('translate-x-5', newState);\r\n        button.querySelector('#toggle-background').classList.toggle('bg-gray-400', !newState);\r\n        button.querySelector('#toggle-background').classList.toggle('bg-blue-700', newState);\r\n    } else {\r\n        console.error(`No element found with ID: ${buttonId}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Toggles the color scheme of a button and its icon based on state.\r\n * @param {string} buttonId - The ID of the button element.\r\n * @param {boolean} newState - The state to apply.\r\n */\r\nexport const toggleButtonColor = (buttonId, newState) => {\r\n    const button = document.getElementById(buttonId);\r\n    if (button) {\r\n        const icon = button.querySelector('svg');\r\n\r\n        // Toggle button classes\r\n        button.classList.toggle('bg-gray-200', !newState);\r\n        button.classList.toggle('hover:bg-gray-300', !newState);\r\n        button.classList.toggle('bg-blue-50', newState);\r\n        button.classList.toggle('hover:bg-gray-100', newState);\r\n        button.classList.toggle('focus:ring-blue-500', newState);\r\n\r\n        // Toggle icon classes\r\n        if (icon) {\r\n            icon.classList.toggle('text-gray-600', !newState);\r\n            icon.classList.toggle('text-blue-600', newState);\r\n        }\r\n    } else {\r\n        console.error(`No button found with ID: ${buttonId}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the submit button and toast notification based on activity result.\r\n * Handles correct/incorrect feedback, button text, and toast styling.\r\n * @param {boolean} isCorrect - Whether the answer is correct.\r\n * @param {string} [buttonText] - The text for the submit button.\r\n * @param {string} activityType - The type of activity.\r\n * @param {number} [unfilledCount=0] - Number of unfilled fields (for fill-in-the-blank).\r\n * @param {Object} [options={}] - Additional options for toast and feedback.\r\n */\r\nexport const updateSubmitButtonAndToast = (\r\n    isCorrect,\r\n    buttonText = translateText(\"next-activity\"),\r\n    activityType,\r\n    unfilledCount = 0,\r\n    options = {}\r\n) => {\r\n    const submitButton = document.getElementById(\"submit-button\");\r\n    const resetButton = document.getElementById(\"reset-button\");\r\n    const toast = document.getElementById(\"toast\");\r\n    const isMultipleChoiceLike =\r\n        activityType === ActivityTypes.MULTIPLE_CHOICE || activityType === ActivityTypes.QUIZ;\r\n    const shouldShowToast = !isMultipleChoiceLike;\r\n    \r\n    // Default options\r\n    const defaultOptions = {\r\n        message: '', // Custom message to override default\r\n        emoji: '', // Custom emoji to override default\r\n        toastType: '', // Can be 'success', 'error', 'warning', 'info'\r\n        timeout: 6000, // Time in milliseconds before hiding toast\r\n        showCloseButton: true // Whether to show the close button\r\n    };\r\n\r\n    // Merge defaults with provided options\r\n    const mergedOptions = { ...defaultOptions, ...options };\r\n\r\n    // Remove previous event listeners\r\n    checkCurrentActivityCompletion(isCorrect);\r\n    submitButton.removeEventListener(\"click\", state.validateHandler);\r\n    submitButton.removeEventListener(\"click\", state.retryHandler);\r\n    submitButton.removeEventListener(\"click\", nextPage);\r\n\r\n    updateResetButtonVisibility();\r\n\r\n    // Control reset button visibility based on activity type\r\n    if (resetButton) {\r\n        // Only show reset button for activities where it makes sense\r\n        if (activityType === ActivityTypes.OPEN_ENDED_ANSWER ||\r\n            activityType === ActivityTypes.FILL_IN_THE_BLANK ||\r\n            activityType === ActivityTypes.SORTING ||\r\n            activityType === ActivityTypes.FILL_IN_A_TABLE ||\r\n            activityType === ActivityTypes.MATCHING) {\r\n            resetButton.classList.remove(\"hidden\");\r\n        } else {\r\n            resetButton.classList.add(\"hidden\");\r\n        }\r\n    }\r\n\r\n    if (isCorrect) {\r\n        // Track successful activity completion\r\n        const activityId = location.pathname\r\n            .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n            .split(\".\")[0];\r\n\r\n        trackActivityCompletion(activityId, activityType);\r\n        \r\n    submitButton.textContent = buttonText;\r\n    submitButton.dataset.submitState = (buttonText === translateText(\"next-activity\")) ? 'next' : 'submit';\r\n        \r\n                if (shouldShowToast && toast) {\r\n            // Determine message and emoji based on options or defaults\r\n            const message = mergedOptions.message ||\r\n                ((activityType === ActivityTypes.OPEN_ENDED_ANSWER ||\r\n                    activityType === ActivityTypes.FILL_IN_A_TABLE)\r\n                    ? translateText(\"answers-submitted\")\r\n                    : translateText(\"correct-answer\"));\r\n\r\n            const emoji = mergedOptions.emoji || '\uD83C\uDF89';\r\n            const toastType = mergedOptions.toastType || 'success';\r\n\r\n            // Display toast with success styling\r\n            setupToast(\r\n                toast,\r\n                toastType,\r\n                emoji,\r\n                message,\r\n                mergedOptions.showCloseButton\r\n            );\r\n        }\r\n\r\n        if (buttonText === translateText(\"next-activity\")) {\r\n            submitButton.addEventListener(\"click\", nextPage);\r\n            submitButton.setAttribute(\"aria-label\", translateText(\"next-activity\"));\r\n\r\n            const activityId = location.pathname\r\n                .substring(location.pathname.lastIndexOf(\"/\") + 1)\r\n                .split(\".\")[0];\r\n            localStorage.setItem(`${activityId}_success`, \"true\");\r\n        }\r\n\r\n        // Set timeout to hide toast\r\n        if (shouldShowToast) {\r\n            setTimeout(() => {\r\n                toast?.classList.add(\"hidden\");\r\n            }, mergedOptions.timeout || 6000);\r\n        } else {\r\n            toast?.classList.add(\"hidden\");\r\n        }\r\n    } else {\r\n        if (shouldShowToast) {\r\n            // Handle incorrect submission with enhanced options\r\n            handleIncorrectSubmission(\r\n                submitButton, \r\n                toast, \r\n                activityType, \r\n                unfilledCount, \r\n                mergedOptions\r\n            );\r\n        } else {\r\n            handleIncorrectSubmission(\r\n                submitButton,\r\n                toast,\r\n                activityType,\r\n                unfilledCount,\r\n                mergedOptions\r\n            );\r\n            toast?.classList.add(\"hidden\");\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Checks and updates the completion icon for the current activity.\r\n * @param {boolean} isCorrect - Whether the activity was completed correctly.\r\n */\r\nexport const checkCurrentActivityCompletion = (isCorrect) => {\r\n    const activityId = location.pathname.substring(location.pathname.lastIndexOf(\"/\") + 1).split(\".\")[0];\r\n    const currentActivityIcon = document.querySelector(`[class*=\"${activityId}\"]`);\r\n\r\n    // Add null check before accessing classList\r\n    if (!currentActivityIcon) {\r\n        console.warn(`Activity icon not found for ID: ${activityId}`);\r\n        return;\r\n    }\r\n\r\n    if (isCorrect) {\r\n        currentActivityIcon.classList.replace(\"fa-pen-to-square\", \"fa-square-check\");\r\n        currentActivityIcon.classList.replace(\"text-blue-700\", \"text-green-500\");\r\n    } else {\r\n        currentActivityIcon.classList.replace(\"fa-square-check\", \"fa-pen-to-square\");\r\n        currentActivityIcon.classList.replace(\"text-green-500\", \"text-blue-700\");\r\n    }\r\n}\r\n\r\n/**\r\n * Handles incorrect submission feedback, updates button text, and sets up retry/validate handlers.\r\n * @param {HTMLElement} submitButton - The submit button element.\r\n * @param {HTMLElement} toast - The toast notification element.\r\n * @param {string} activityType - The type of activity.\r\n * @param {number} unfilledCount - Number of unfilled fields.\r\n * @param {Object} [options={}] - Additional options for toast and feedback.\r\n * @private\r\n */\r\nconst handleIncorrectSubmission = (submitButton, toast, activityType, unfilledCount, options = {}) => {\r\n    const isMultipleChoiceLike = activityType === ActivityTypes.MULTIPLE_CHOICE || activityType === ActivityTypes.QUIZ;\r\n    \r\n    if (isMultipleChoiceLike) {\r\n        submitButton.textContent = translateText(\"retry\");\r\n        submitButton.setAttribute(\"aria-label\", translateText(\"retry\"));\r\n        submitButton.dataset.submitState = 'retry';\r\n        state.retryHandler = retryActivity;\r\n        submitButton.addEventListener(\"click\", state.retryHandler);\r\n    } else {\r\n        submitButton.textContent = translateText(\"submit-text\");\r\n        submitButton.setAttribute(\"aria-label\", translateText(\"submit-text\"));\r\n        submitButton.dataset.submitState = 'submit';\r\n        // Make sure we're adding the current validateHandler\r\n        if (state.validateHandler) {\r\n            submitButton.addEventListener(\"click\", state.validateHandler);\r\n        }\r\n    }\r\n\r\n    if (isMultipleChoiceLike) {\r\n        toast?.classList.add(\"hidden\");\r\n        return;\r\n    }\r\n\r\n    updateToastForIncorrectSubmission(toast, activityType, unfilledCount, options);\r\n};\r\n\r\n/**\r\n * Updates the toast notification for incorrect submissions.\r\n * @param {HTMLElement} toast - The toast notification element.\r\n * @param {string} activityType - The type of activity.\r\n * @param {number} unfilledCount - Number of unfilled fields.\r\n * @param {Object} [options={}] - Additional options for toast and feedback.\r\n * @private\r\n */\r\nconst updateToastForIncorrectSubmission = (toast, activityType, unfilledCount, options = {}) => {\r\n    if (!toast) return;\r\n\r\n    // Use provided options or determine defaults based on activity\r\n    let message = options.message;\r\n    let emoji = options.emoji;\r\n    let toastType = options.toastType;\r\n\r\n    // If no specific options provided, determine based on activity and completion\r\n    if (!message || !emoji || !toastType) {\r\n        if (activityType === ActivityTypes.OPEN_ENDED_ANSWER ||\r\n            activityType === ActivityTypes.FILL_IN_THE_BLANK ||\r\n            activityType === ActivityTypes.FILL_IN_A_TABLE) {\r\n\r\n            if (unfilledCount > 0) {\r\n                // Warning for incomplete fields\r\n                message = message || translateText(\"fill-in-the-blank-not-complete\", {\r\n                    unfilledCount: unfilledCount,\r\n                });\r\n                emoji = emoji || '\u26A0\uFE0F';\r\n                toastType = toastType || 'warning';\r\n            } else {\r\n                // Error for incorrect answers\r\n                let defaultMessage;\r\n                switch (activityType) {\r\n                    case ActivityTypes.FILL_IN_A_TABLE:\r\n                    case ActivityTypes.FILL_IN_THE_BLANK:\r\n                    default:\r\n                        defaultMessage = translateText(\"fill-in-the-blank-try-again\");\r\n                }\r\n                message = message || defaultMessage;\r\n                emoji = emoji || '\uD83E\uDD14';\r\n                toastType = toastType || 'error';\r\n            }\r\n        } else {\r\n            // Default for other activity types\r\n            message = message || translateText(\"fill-in-the-blank-try-again\");\r\n            emoji = emoji || '\uD83E\uDD14';\r\n            toastType = toastType || 'error';\r\n        }\r\n    }\r\n\r\n    // Display the toast with determined values\r\n    setupToast(\r\n        toast,\r\n        toastType,\r\n        emoji,\r\n        message,\r\n        options.showCloseButton !== false\r\n    );\r\n\r\n    // Set timeout for hiding toast\r\n    setTimeout(() => {\r\n        toast?.classList.add(\"hidden\");\r\n    }, options.timeout || 6000);\r\n};\r\n\r\n/**\r\n * Provides feedback for an activity input element, including ARIA attributes and icons.\r\n * @param {HTMLElement} element - The input or option element.\r\n * @param {boolean} isCorrect - Whether the answer is correct.\r\n * @param {string} correctAnswer - The correct answer (if applicable).\r\n * @param {string} activityType - The type of activity.\r\n */\r\nexport const provideFeedback = (element, isCorrect, correctAnswer, activityType) => {\r\n    let feedback = document.createElement(\"span\");\r\n    feedback.classList.add(\r\n        \"feedback\",\r\n        \"ml-2\",\r\n        \"px-2\",\r\n        \"py-1\",\r\n        \"rounded-full\",\r\n        \"text-lg\",\r\n        \"w-32\",\r\n        \"text-center\"\r\n    );\r\n    feedback.setAttribute(\"role\", \"alert\");\r\n\r\n    const dataActivityItem = element.getAttribute(\"data-activity-item\");\r\n    if (dataActivityItem) {\r\n        feedback.setAttribute(\"aria-labelledby\", dataActivityItem);\r\n    }\r\n\r\n    window.utils.provideFeedback = provideFeedback;\r\n\r\n    handleFeedbackPlacement(element, feedback, activityType);\r\n    updateFeedbackContent(feedback, isCorrect, activityType, element);\r\n\r\n    // Set ARIA attributes\r\n    feedback.id = `feedback-${dataActivityItem}`;\r\n    element.setAttribute(\"aria-describedby\", feedback.id);\r\n};\r\n\r\nconst handleFeedbackPlacement = (element, feedback, activityType) => {\r\n    /*if (activityType === ActivityTypes.FILL_IN_THE_BLANK) {\r\n        element.parentNode.appendChild(feedback);\r\n    } else if (activityType === ActivityTypes.MULTIPLE_CHOICE) {\r\n        const feedbackContainer = document.querySelector(\".questions\");\r\n        feedbackContainer?.appendChild(feedback);\r\n    }*/\r\n};\r\n\r\n/**\r\n * Updates the feedback content for an element based on activity type and correctness.\r\n * @param {HTMLElement} feedback - The feedback element.\r\n * @param {boolean} isCorrect - Whether the answer is correct.\r\n * @param {string} activityType - The type of activity.\r\n * @param {HTMLElement} element - The input or option element.\r\n * @private\r\n */\r\nconst updateFeedbackContent = (feedback, isCorrect, activityType, element) => {\r\n    feedback.innerText = \"\";\r\n    feedback.classList.remove(\r\n        \"bg-green-200\",\r\n        \"text-green-700\",\r\n        \"bg-red-200\",\r\n        \"text-red-700\"\r\n    );\r\n\r\n    if (activityType === ActivityTypes.FILL_IN_THE_BLANK ||\r\n        activityType === ActivityTypes.OPEN_ENDED_ANSWER ||\r\n        activityType === ActivityTypes.FILL_IN_A_TABLE) {\r\n\r\n        handleTextInputFeedback(feedback, isCorrect, element);\r\n    } else if (activityType === ActivityTypes.MULTIPLE_CHOICE) {\r\n        handleMultipleChoiceFeedback(feedback, isCorrect, element);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles feedback for text input activities (fill-in-the-blank, open-ended, table).\r\n * @param {HTMLElement} feedback - The feedback element.\r\n * @param {boolean} isCorrect - Whether the answer is correct.\r\n * @param {HTMLElement} element - The input element.\r\n * @private\r\n */\r\nconst handleTextInputFeedback = (feedback, isCorrect, element) => {\r\n    // Remove the feedback span as we'll place the icon directly in the element\r\n    feedback.remove();\r\n\r\n    // Get a reliable identifier for this element (prefer data-aria-id over id)\r\n    const elementId = element.getAttribute('data-activity-item') || element.getAttribute('data-aria-id') || element.id || `input-${Math.random().toString(36).substr(2, 9)}`;\r\n\r\n    // Remove any existing feedback icons related to this element\r\n    const existingIcons = document.querySelectorAll(`.feedback-icon-for-${element.getAttribute('data-activity-item')}`);\r\n    existingIcons.forEach(icon => icon.remove());\r\n\r\n    // Ensure element has padding to accommodate the icon\r\n    element.style.paddingRight = '30px';\r\n\r\n    // Create an icon element\r\n    const iconElement = document.createElement(\"div\");\r\n    iconElement.className = `feedback-icon-for-${elementId}`;\r\n\r\n    // Position the icon absolutely within the input's coordinate space\r\n    iconElement.style.position = \"absolute\";\r\n    iconElement.style.pointerEvents = \"none\";\r\n    iconElement.style.zIndex = \"10\";\r\n\r\n    // Add the Font Awesome icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = isCorrect ?\r\n        \"fas fa-check-circle text-green-600 feedback-icon\" :\r\n        \"fas fa-times-circle text-red-600 feedback-icon\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n    iconElement.appendChild(icon);\r\n\r\n    // Add appropriate ARIA attributes for accessibility\r\n    if (isCorrect) {\r\n        element.setAttribute(\"aria-invalid\", \"false\");\r\n        element.setAttribute(\"aria-label\", `${element.value} - ${translateText(\"fill-in-the-blank-correct-answer\")}`);\r\n\r\n        // Add matching green border and focus styles to input\r\n        element.classList.remove(\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\");\r\n        element.classList.add(\"border-green-500\", \"bg-green-100\", \"focus:border-green-500\", \"focus:ring-green-200\", \"focus:ring\");\r\n    } else {\r\n        element.setAttribute(\"aria-invalid\", \"true\");\r\n        element.setAttribute(\"aria-label\", `${element.value} - ${translateText(\"fill-in-the-blank-try-again\")}`);\r\n\r\n        // Add matching red border and focus styles to input\r\n        element.classList.remove(\"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\");\r\n        element.classList.add(\"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\", \"focus:ring\");\r\n    }\r\n\r\n    // Position the icon element absolutely related to the input\r\n    const rect = element.getBoundingClientRect();\r\n    const parentRect = element.parentNode.getBoundingClientRect();\r\n\r\n    // Calculate position relative to the parent\r\n    const top = rect.top - parentRect.top + (rect.height - 24) / 2; // Center icon vertically (24px is approx icon height)\r\n    const right = parentRect.right - rect.right + 10;\r\n\r\n    // Set the position\r\n    iconElement.style.top = `${top}px`;\r\n    iconElement.style.right = `${right}px`;\r\n\r\n    // Make sure parent has position relative or absolute\r\n    const parentPosition = window.getComputedStyle(element.parentNode).position;\r\n    if (parentPosition === 'static') {\r\n        element.parentNode.style.position = 'relative';\r\n    }\r\n\r\n    // Add the icon after the input (as a sibling)\r\n    element.parentNode.insertBefore(iconElement, element.nextSibling);\r\n};\r\n\r\n/**\r\n * Handles feedback for multiple choice activities.\r\n * @param {HTMLElement} feedback - The feedback element.\r\n * @param {boolean} isCorrect - Whether the answer is correct.\r\n * @param {HTMLElement} element - The option element.\r\n * @private\r\n */\r\nconst handleMultipleChoiceFeedback = (feedback, isCorrect, element) => {\r\n    const label = element.closest(\".activity-option\");\r\n    if (!label) return;\r\n\r\n    const associatedLabel = label.querySelector(\"span\");\r\n    if (!associatedLabel) return;\r\n\r\n    const existingMark = associatedLabel.querySelector(\".mark\");\r\n    existingMark?.remove();\r\n\r\n    if (isCorrect) {\r\n        updateForCorrectChoice(feedback, null, associatedLabel);\r\n    } else {\r\n        updateForIncorrectChoice(feedback, null, associatedLabel);\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the UI for a correct multiple choice selection.\r\n * @param {HTMLElement} feedback - The feedback element.\r\n * @param {HTMLElement|null} mark - The mark element (unused).\r\n * @param {HTMLElement} associatedLabel - The label element.\r\n * @private\r\n */\r\nconst updateForCorrectChoice = (feedback, mark, associatedLabel) => {\r\n    // Remove the feedback span\r\n    feedback.remove();\r\n\r\n    // Clear existing marks\r\n    const existingMark = associatedLabel.querySelector(\".mark\");\r\n    if (existingMark) existingMark.remove();\r\n\r\n    // Create a Font Awesome check icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = \"fas fa-check-circle text-green-600 mark tick ml-2\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n    // Add the icon to the label\r\n    associatedLabel.appendChild(icon);\r\n\r\n    // Add a screen reader text for accessibility\r\n    const srText = document.createElement(\"span\");\r\n    srText.className = \"sr-only\";\r\n    srText.textContent = translateText(\"multiple-choice-correct-answer\");\r\n    associatedLabel.appendChild(srText);\r\n\r\n    // Add success background\r\n    associatedLabel.classList.add(\"bg-green-100\", \"border-green-600\", \"border-2\");\r\n};\r\n\r\n/**\r\n * Updates the UI for an incorrect multiple choice selection.\r\n * @param {HTMLElement} feedback - The feedback element.\r\n * @param {HTMLElement|null} mark - The mark element (unused).\r\n * @param {HTMLElement} associatedLabel - The label element.\r\n * @private\r\n */\r\nconst updateForIncorrectChoice = (feedback, mark, associatedLabel) => {\r\n    // Remove the feedback span\r\n    feedback.remove();\r\n\r\n    // Clear existing marks\r\n    const existingMark = associatedLabel.querySelector(\".mark\");\r\n    if (existingMark) existingMark.remove();\r\n\r\n    // Create a Font Awesome x icon\r\n    const icon = document.createElement(\"i\");\r\n    icon.className = \"fas fa-times-circle text-red-600 mark cross ml-2\";\r\n    icon.setAttribute(\"aria-hidden\", \"true\");\r\n\r\n    // Add the icon to the label\r\n    associatedLabel.appendChild(icon);\r\n\r\n    // Add a screen reader text for accessibility\r\n    const srText = document.createElement(\"span\");\r\n    srText.className = \"sr-only\";\r\n    srText.textContent = translateText(\"multiple-choice-try-again\");\r\n    associatedLabel.appendChild(srText);\r\n\r\n    // Add error background\r\n    associatedLabel.classList.add(\"bg-red-100\", \"border-red-600\", \"border-2\");\r\n};\r\n\r\nexport const retryActivity = () => {\r\n    playActivitySound('reset');\r\n\r\n    clearFeedback();\r\n    resetButtons();\r\n    resetButtonState();\r\n};\r\n\r\nconst clearFeedback = () => {\r\n    // Remove feedback spans\r\n    document.querySelectorAll(\".feedback\").forEach(feedback => {\r\n        feedback.remove();\r\n    });\r\n\r\n    // Remove feedback icons from text inputs\r\n    // document.querySelectorAll(\"[class^='feedback-icon-for-']\").forEach(icon => {\r\n    //     icon.remove();\r\n    // });\r\n\r\n    // Remove feedback icons from text inputs\r\n    document.querySelectorAll(\".fas.fa-check-circle, .fas.fa-times-circle\").forEach(icon => {\r\n        if (!icon.classList.contains(\"mark\")) { // Don't remove icons that are part of multiple choice marks\r\n            icon.remove();\r\n        }\r\n    });\r\n\r\n    // Reset input fields styling\r\n    document.querySelectorAll(\"input[type='text'], textarea\").forEach(input => {\r\n        input.removeAttribute(\"aria-invalid\");\r\n        input.removeAttribute(\"aria-label\");\r\n\r\n        // Remove the colored borders and focus rings\r\n        input.classList.remove(\r\n            \"border-green-500\", \"focus:border-green-500\", \"focus:ring-green-200\",\r\n            \"border-red-500\", \"focus:border-red-500\", \"focus:ring-red-200\",\r\n            \"focus:ring\"\r\n        );\r\n    });\r\n\r\n    // Reset multiple choice options styling\r\n    document.querySelectorAll(\".activity-option span\").forEach(label => {\r\n        label.classList.remove(\"bg-green-100\", \"bg-red-100\", \"border-green-600\", \"border-red-600\", \"border-2\");\r\n        const mark = label.querySelector(\".mark\");\r\n        if (mark) mark.remove();\r\n        const srText = label.querySelector(\".sr-only\");\r\n        if (srText) srText.remove();\r\n    });\r\n\r\n    const toast = document.getElementById(\"toast\");\r\n    if (toast) {\r\n        toast.remove();\r\n    }\r\n};\r\n\r\n/**\r\n * Resets all radio button styling for activities.\r\n * @private\r\n */\r\nconst resetButtons = () => {\r\n    const allRadioButtons = document.querySelectorAll(\"input[type='radio']\");\r\n    allRadioButtons.forEach(button => {\r\n        button.classList.remove(\"bg-green-200\", \"bg-red-200\", \"text-black\");\r\n    });\r\n};\r\n\r\n/**\r\n * Resets the submit button and related state for a new attempt.\r\n * @private\r\n */\r\nconst resetButtonState = () => {\r\n    state.selectedButton = null;\r\n\r\n    const submitButton = document.getElementById(\"submit-button\");\r\n    if (submitButton) {\r\n        submitButton.textContent = translateText(\"submit-text\");\r\n        submitButton.setAttribute(\"aria-label\", translateText(\"submit-text\"));\r\n\r\n        submitButton.removeEventListener(\"click\", state.retryHandler);\r\n        submitButton.removeEventListener(\"click\", state.validateHandler);\r\n        submitButton.addEventListener(\"click\", state.validateHandler);\r\n        submitButton.dataset.submitState = 'submit';\r\n    }\r\n};\r\n\r\n/**\r\n * Sets the style of the toast notification based on type.\r\n * @param {HTMLElement} toast - The toast notification element.\r\n * @param {string} [type='success'] - The type of toast ('success', 'warning', 'error', etc.).\r\n * @private\r\n */\r\nconst setToastStyle = (toast, type = 'success') => {\r\n    // First remove all styling classes\r\n    toast.classList.remove(\r\n        \"bg-red-100\", \"bg-white\", \"bg-yellow-100\", \"bg-green-100\", \"bg-blue-100\", \"text-red-700\",\r\n        \"border-red-400\", \"border-yellow-400\", \"border-green-400\",\r\n        \"border-l-4\"\r\n    );\r\n\r\n    // Then apply the correct styling based on type\r\n    switch (type) {\r\n        case 'success':\r\n            toast.classList.add(\"border-green-600\", \"bg-green-100\");\r\n            break;\r\n        case 'warning':\r\n            toast.classList.add(\"border-yellow-600\", \"bg-yellow-100\");\r\n            break;\r\n        case 'error':\r\n            toast.classList.add(\"border-red-600\", \"bg-red-100\");\r\n            break;\r\n        default:\r\n            toast.classList.add(\"border-blue-600\", \"bg-blue-100\");\r\n    }\r\n};\r\n\r\n/**\r\n * Adds a close button to the toast notification.\r\n * @param {HTMLElement} toast - The toast notification element.\r\n * @private\r\n */\r\nconst addCloseButtonToToast = (toast) => {\r\n    // Create close button\r\n    const closeButton = document.createElement('button');\r\n    closeButton.className = 'absolute -top-2 -right-2 bg-white border-1 border-gray-500 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center transition-colors shadow-[1px_1px_2px_rgba(0,0,0,0.2)]';\r\n    closeButton.setAttribute('aria-label', translateText(\"close\"));\r\n    closeButton.setAttribute('type', 'button');\r\n\r\n    // Create X icon\r\n    const closeIcon = document.createElement('i');\r\n    closeIcon.className = 'fas fa-times text-gray-600 text-xs';\r\n\r\n    // Add close functionality\r\n    closeButton.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n        toast.classList.add('hidden');\r\n    });\r\n\r\n    closeButton.appendChild(closeIcon);\r\n    toast.appendChild(closeButton);\r\n};\r\n\r\n/**\r\n * Sets up the toast notification with emoji, message, and optional close button.\r\n * @param {HTMLElement} toast - The toast notification element.\r\n * @param {string} type - The type of toast ('success', 'warning', 'error', etc.).\r\n * @param {string} emoji - The emoji to display.\r\n * @param {string} message - The message to display.\r\n * @param {boolean} [showCloseButton=true] - Whether to show the close button.\r\n * @private\r\n */\r\nconst setupToast = (toast, type = 'success', emoji, message, showCloseButton = true) => {\r\n    // Clear existing content\r\n    toast.innerHTML = '';\r\n\r\n    // Make sure positioning is preserved - add these if they don't exist\r\n    toast.classList.add('fixed', 'top-10', 'left-1/2', 'transform', '-translate-x-1/2');\r\n\r\n    toast.classList.remove('hidden');\r\n\r\n    // Create emoji span element\r\n    const emojiSpan = document.createElement('span');\r\n    emojiSpan.className = 'text-2xl mr-2';\r\n    emojiSpan.textContent = emoji;\r\n\r\n    // Create text paragraph\r\n    const textP = document.createElement('p');\r\n    textP.className = 'text-gray-800 font-medium';\r\n    textP.innerHTML = message;\r\n\r\n    // Apply styling\r\n    setToastStyle(toast, type);\r\n\r\n    // Add elements to toast\r\n    toast.appendChild(emojiSpan);\r\n    toast.appendChild(textP);\r\n\r\n    // Add the close button if requested\r\n    if (showCloseButton) {\r\n        addCloseButtonToToast(toast);\r\n    }\r\n};\r\n\r\n/**\r\n * Sets up click-outside functionality for toast dismissal.\r\n * @private\r\n */\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    const toast = document.getElementById('toast');\r\n    if (!toast) return;\r\n\r\n    // Add click listener to document\r\n    document.addEventListener('click', (e) => {\r\n        // If toast is visible and click is outside toast\r\n        if (!toast.classList.contains('hidden') && !toast.contains(e.target)) {\r\n            toast.classList.add('hidden');\r\n        }\r\n    });\r\n\r\n    // Prevent clicks inside the toast from closing it\r\n    toast.addEventListener('click', (e) => {\r\n        e.stopPropagation();\r\n    });\r\n});\r\n\r\n", "/**\r\n * Browser Zoom Controller\r\n * \r\n * This module provides a cross-browser solution for zooming web content\r\n * that properly maintains layout relationships and positioning.\r\n * \r\n * Features:\r\n * - Detects browser environment and uses optimal zooming method\r\n * - Maintains proper layout for fixed elements at different zoom levels\r\n * - Preserves bottom interface elements' positioning\r\n * - Handles sidebar positioning during zoom\r\n * - Persists zoom settings across page navigation\r\n */\r\n\r\n// Track current zoom state\r\nlet currentZoom = 1;\r\n\r\n/**\r\n * Check if running on Windows with high DPI scaling\r\n * @returns {boolean} True if high DPI Windows environment detected\r\n */\r\nexport function isHighDpiWindows() {\r\n  const isWindows = navigator.userAgent.indexOf('Win') !== -1;\r\n  const hasHighDpi = window.devicePixelRatio > 1.3;\r\n  return isWindows && hasHighDpi;\r\n}\r\n\r\n/**\r\n * Determine if running in Chrome, Edge, or Safari\r\n * @returns {boolean} True for browsers that support the zoom property\r\n */\r\nfunction isChromiumOrSafari() {\r\n  const isChrome = !!window.chrome;\r\n  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\r\n\r\n  return isChrome || isSafari;\r\n}\r\n\r\n/**\r\n * Set zoom level using the most appropriate method for the current browser\r\n * @param {number} zoomLevel - Zoom factor (0.5 = 50%, 1 = 100%, 2 = 200%)\r\n */\r\nexport function setNativeZoom(zoomLevel) {\r\n  // Validate zoom level\r\n  //   if (typeof zoomLevel !== 'number' || zoomLevel <= 0) {\r\n  //     console.error('Invalid zoom level. Must be a positive number.');\r\n  //     return;\r\n  //   }\r\n\r\n  // Force zoom via direct style application (most reliable approach)\r\n  document.body.style.zoom = zoomLevel;\r\n\r\n  // Store current zoom for reference\r\n  currentZoom = zoomLevel;\r\n\r\n  // Save zoom level for persistence\r\n  localStorage.setItem('pageZoomLevel', zoomLevel.toString());\r\n\r\n  // For Chrome/Safari/Edge, use the native zoom property\r\n  if (isChromiumOrSafari()) {\r\n    document.body.style.zoom = zoomLevel;\r\n    adjustInterfaceForNativeZoom(zoomLevel);\r\n    return;\r\n  }\r\n\r\n  // For Firefox and others, use CSS transform with additional adjustments\r\n  applyTransformZoom(zoomLevel);\r\n}\r\n\r\n/**\r\n * Apply transform-based zoom for Firefox and other browsers\r\n * @param {number} zoomLevel - Zoom factor\r\n */\r\nfunction applyTransformZoom(zoomLevel) {\r\n  const html = document.documentElement;\r\n  const body = document.body;\r\n  const contentContainer = document.querySelector('.container.content');\r\n  const interfaceContainer = document.getElementById('interface-container');\r\n  const navContainer = document.getElementById('nav-container');\r\n  const sidebar = document.getElementById('sidebar');\r\n\r\n  // Calculate inverse zoom for compensating dimensions\r\n  const inverseZoom = 1 / zoomLevel;\r\n\r\n  // Apply zoom to body\r\n  if (body) {\r\n    body.style.transform = `scale(${zoomLevel})`;\r\n    body.style.transformOrigin = 'top center';\r\n    body.style.width = `${inverseZoom * 100}%`;\r\n    body.style.minHeight = `${inverseZoom * 100}vh`;\r\n    body.style.overflow = 'hidden';\r\n  }\r\n\r\n  // Adjust main content container\r\n  if (contentContainer) {\r\n    // Reset any previous transform that might be set directly on the container\r\n    contentContainer.style.transform = 'none';\r\n\r\n    // Adjust dimensions to fill the viewport at scaled size\r\n    contentContainer.style.minHeight = `calc(${inverseZoom * 100}vh - ${inverseZoom * 100}px)`;\r\n    contentContainer.style.width = '100%';\r\n    contentContainer.style.maxWidth = 'none';\r\n  }\r\n\r\n  // Ensure interface elements stay correctly positioned\r\n  if (interfaceContainer) {\r\n    interfaceContainer.style.position = 'fixed';\r\n    interfaceContainer.style.bottom = '0';\r\n    interfaceContainer.style.left = '0';\r\n    interfaceContainer.style.width = `${inverseZoom * 100}%`;\r\n    interfaceContainer.style.transform = `scale(${zoomLevel})`;\r\n    interfaceContainer.style.transformOrigin = 'bottom left';\r\n    interfaceContainer.style.zIndex = '9999';\r\n  }\r\n\r\n  // Adjust navigation container\r\n  if (navContainer) {\r\n    navContainer.style.position = 'fixed';\r\n    navContainer.style.transform = `scale(${zoomLevel})`;\r\n    navContainer.style.transformOrigin = 'top left';\r\n    navContainer.style.zIndex = '9999';\r\n  }\r\n\r\n  // Adjust sidebar positioning if it's open\r\n  if (sidebar && sidebar.getAttribute('aria-expanded') === 'true') {\r\n    sidebar.style.transform = `scale(${zoomLevel})`;\r\n    sidebar.style.transformOrigin = 'top right';\r\n    sidebar.style.right = '0';\r\n  }\r\n\r\n  // Dispatch custom event for other components that might need to adjust\r\n  window.dispatchEvent(new CustomEvent('zoomchange', { detail: { zoomLevel } }));\r\n}\r\n\r\n/**\r\n * Make adjustments for bottom interface when using native zoom\r\n * @param {number} zoomLevel - Zoom factor\r\n */\r\nfunction adjustInterfaceForNativeZoom(zoomLevel) {\r\n  const bottomInterface = document.querySelector('.fixed.bottom-0');\r\n  const sidebar = document.getElementById('sidebar');\r\n\r\n  if (bottomInterface) {\r\n    // Ensure bottom interface stays at the bottom with native zoom\r\n    bottomInterface.style.bottom = '0';\r\n  }\r\n\r\n  if (sidebar && sidebar.getAttribute('aria-expanded') === 'true') {\r\n    // Ensure sidebar stays properly positioned\r\n    sidebar.style.right = '0';\r\n  }\r\n\r\n  // Dispatch custom event for other components that might need to adjust\r\n  window.dispatchEvent(new CustomEvent('zoomchange', { detail: { zoomLevel } }));\r\n}\r\n\r\n/**\r\n * Reset zoom to 100%\r\n */\r\nexport function resetZoom() {\r\n  setNativeZoom(1);\r\n\r\n  // Clean up any additional styles that were set\r\n  const contentContainer = document.querySelector('.container.content');\r\n  const interfaceContainer = document.getElementById('interface-container');\r\n  const navContainer = document.getElementById('nav-container');\r\n  const sidebar = document.getElementById('sidebar');\r\n\r\n  // Reset body styles\r\n  document.body.style.transform = '';\r\n  document.body.style.width = '';\r\n  document.body.style.minHeight = '';\r\n  document.body.style.overflow = '';\r\n\r\n  // Reset content container\r\n  if (contentContainer) {\r\n    contentContainer.style.minHeight = '';\r\n    contentContainer.style.width = '';\r\n    contentContainer.style.maxWidth = '';\r\n  }\r\n\r\n  // Reset interface container\r\n  if (interfaceContainer) {\r\n    interfaceContainer.style.position = '';\r\n    interfaceContainer.style.transform = '';\r\n    interfaceContainer.style.width = '';\r\n  }\r\n\r\n  // Reset navigation container\r\n  if (navContainer) {\r\n    navContainer.style.position = '';\r\n    navContainer.style.transform = '';\r\n  }\r\n\r\n  // Reset sidebar\r\n  if (sidebar) {\r\n    sidebar.style.transform = '';\r\n    sidebar.style.right = '';\r\n  }\r\n\r\n  // Remove zoom level from storage\r\n  localStorage.removeItem('pageZoomLevel');\r\n}\r\n\r\n/**\r\n * Get the current zoom level\r\n * @returns {number} Current zoom level\r\n */\r\nexport function getCurrentZoom() {\r\n  return currentZoom;\r\n}\r\n\r\n/**\r\n * Apply any previously stored zoom level\r\n */\r\nexport function applyStoredZoom() {\r\n  const storedZoom = localStorage.getItem('pageZoomLevel');\r\n  if (storedZoom && !isNaN(parseFloat(storedZoom))) {\r\n    setNativeZoom(parseFloat(storedZoom));\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Initialize zoom controller - call this on page load\r\n */\r\nexport function initializeZoomController() {\r\n  // Apply any stored zoom level\r\n  const zoomApplied = applyStoredZoom();\r\n\r\n  // Listen for resize events to maintain zoom layout\r\n  window.addEventListener('resize', () => {\r\n    if (currentZoom !== 1) {\r\n      // Reapply current zoom after resize to maintain proper layout\r\n      setNativeZoom(currentZoom);\r\n    }\r\n  });\r\n\r\n  // Add event listener for \"z\" key to toggle zoom for testing\r\n  document.addEventListener('keydown', (e) => {\r\n    // Alt+Z for zoom to 75%\r\n    if (e.altKey && e.key === 'z') {\r\n      setNativeZoom(currentZoom === 0.75 ? 1 : 0.75);\r\n    }\r\n  });\r\n\r\n  return zoomApplied;\r\n}\r\n\r\n// Add a direct test function that can be called from console\r\nexport function testZoomNow() {\r\n  try {\r\n    document.body.style.zoom = 0.75;\r\n    return true;\r\n  } catch (err) {\r\n    console.error('Error applying zoom:', err);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Create floating zoom controls UI\r\n */\r\nexport function createZoomControls() {\r\n  // Remove existing controls if any\r\n  const existingControls = document.getElementById('zoom-controls');\r\n  if (existingControls) {\r\n    existingControls.remove();\r\n  }\r\n\r\n  // Create controls container\r\n  const controls = document.createElement('div');\r\n  controls.id = 'zoom-controls';\r\n  controls.className = 'fixed bottom-20 left-4 bg-white rounded-lg shadow-lg p-2 z-50 flex items-center space-x-2 border border-gray-200';\r\n\r\n  // Add zoom out button\r\n  const zoomOutBtn = document.createElement('button');\r\n  zoomOutBtn.className = 'p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500';\r\n  zoomOutBtn.innerHTML = '<i class=\"fas fa-search-minus\"></i>';\r\n  zoomOutBtn.setAttribute('aria-label', 'Zoom out');\r\n  zoomOutBtn.addEventListener('click', () => {\r\n    setNativeZoom(0.75);\r\n  });\r\n\r\n  // Add reset button\r\n  const resetBtn = document.createElement('button');\r\n  resetBtn.className = 'p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500';\r\n  resetBtn.innerHTML = '<i class=\"fas fa-undo\"></i>';\r\n  resetBtn.setAttribute('aria-label', 'Reset zoom');\r\n  resetBtn.addEventListener('click', resetZoom);\r\n\r\n  // Add zoom in button\r\n  const zoomInBtn = document.createElement('button');\r\n  zoomInBtn.className = 'p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500';\r\n  zoomInBtn.innerHTML = '<i class=\"fas fa-search-plus\"></i>';\r\n  zoomInBtn.setAttribute('aria-label', 'Zoom in');\r\n  zoomInBtn.addEventListener('click', () => {\r\n    setNativeZoom(1.25);\r\n  });\r\n\r\n  // Add zoom level display\r\n  const zoomLevel = document.createElement('span');\r\n  zoomLevel.id = 'zoom-level-display';\r\n  zoomLevel.className = 'text-sm font-medium text-gray-700 px-2';\r\n  zoomLevel.textContent = '100%';\r\n\r\n  // Update zoom level display when zoom changes\r\n  window.addEventListener('zoomchange', (e) => {\r\n    const level = e.detail.zoomLevel;\r\n    zoomLevel.textContent = `${Math.round(level * 100)}%`;\r\n  });\r\n\r\n  // Assemble controls\r\n  controls.appendChild(zoomOutBtn);\r\n  controls.appendChild(resetBtn);\r\n  controls.appendChild(zoomInBtn);\r\n  controls.appendChild(zoomLevel);\r\n\r\n  // Add to document\r\n  document.body.appendChild(controls);\r\n\r\n  return controls;\r\n}", "/**\r\n * @module interface\r\n * @description\r\n * UI logic for navigation, sidebar, glossary, language switching, accessibility, and layout adjustments.\r\n */\r\nimport { stopAudio, toggleReadAloud } from './audio.js';\r\nimport { getCookie, setCookie } from \"./cookies.js\";\r\nimport { showErrorToast } from \"./error_utils.js\";\r\nimport { setState, state } from \"./state.js\";\r\nimport { fetchTranslations, translateText } from \"./translations.js\";\r\nimport { toggleButtonState, toggleButtonColor } from \"./utils.js\";\r\nimport { populateGlossaryTerms } from './ui_utils.js';\r\nimport { stopSLVideo, startSLVideo, toggleBottomContainer } from './video.js';\r\n// Replace previous zoom imports with the new controller functions\r\nimport {\r\n  setNativeZoom,\r\n  resetZoom,\r\n  getCurrentZoom,\r\n  applyStoredZoom,\r\n  isHighDpiWindows,\r\n  initializeZoomController,\r\n  createZoomControls\r\n} from './browser_zoom_controller.js';\r\nimport { trackToggleEvent } from './analytics.js';\r\nimport { toggleNav, getNavigationData } from './navigation.js';\r\n\r\n\r\nlet glossaryTerms = {};\r\nlet interfaceCache = {\r\n  interface: null,\r\n  navigation: null,\r\n  sidebarState: null,\r\n};\r\nlet lastSidebarTrigger = null;\r\n\r\n// Constants for sidebar focus management\r\nconst SIDEBAR_TRANSITION_MS = 300;\r\nconst SIDEBAR_FOCUS_DELAY_MS = SIDEBAR_TRANSITION_MS + 50;\r\nconst SIDEBAR_FOCUSABLE_SELECTOR = 'button:not([disabled]):not([tabindex=\"-1\"]):not([aria-hidden=\"true\"]), a[href]:not([tabindex=\"-1\"]):not([aria-hidden=\"true\"]), input:not([disabled]):not([tabindex=\"-1\"]):not([aria-hidden=\"true\"]), select:not([disabled]):not([tabindex=\"-1\"]):not([aria-hidden=\"true\"]), textarea:not([disabled]):not([tabindex=\"-1\"]):not([aria-hidden=\"true\"]), [tabindex]:not([tabindex=\"-1\"]):not([aria-hidden=\"true\"])';\r\n\r\nconst focusFirstSidebarElement = () => {\r\n  const sidebar = document.getElementById('sidebar');\r\n  if (!sidebar) return;\r\n\r\n  // Query only visible, non-hidden focusable elements within the currently visible tab\r\n  const focusableElements = sidebar.querySelectorAll(SIDEBAR_FOCUSABLE_SELECTOR);\r\n\r\n  // Find first truly visible element (not in a hidden tab)\r\n  const firstInteractive = Array.from(focusableElements).find(el => {\r\n    const tabContent = el.closest('.tab-content');\r\n    return !tabContent || !tabContent.classList.contains('hidden');\r\n  });\r\n\r\n  if (firstInteractive) {\r\n    firstInteractive.focus({ preventScroll: true });\r\n  }\r\n};\r\n\r\nconst restoreSidebarTriggerFocus = () => {\r\n  if (lastSidebarTrigger && document.contains(lastSidebarTrigger)) {\r\n    lastSidebarTrigger.focus({ preventScroll: true });\r\n  } else {\r\n    const fallbackTrigger = document.getElementById('open-sidebar');\r\n    fallbackTrigger?.focus({ preventScroll: true });\r\n  }\r\n  lastSidebarTrigger = null;\r\n};\r\n\r\n/**\r\n * Returns the cached sidebar HTML.\r\n * @returns {string|null} The cached sidebar HTML or null if not cached.\r\n */\r\nexport const getCachedInterface = () => interfaceCache.interface;\r\n\r\n/**\r\n * Returns the cached navigation HTML.\r\n * @returns {string|null} The cached navigation HTML or null if not cached.\r\n */\r\nexport const getCachedNavigation = () => interfaceCache.navigation;\r\n\r\n/**\r\n * Initializes the sidebar, applies saved state, and attaches listeners.\r\n * Adds styling and restores open/closed state from cookies.\r\n */\r\nexport const initializeSidebar = () => {\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  if (!sidebar) return;\r\n\r\n  // Load saved sidebar state\r\n  const savedState = getCookie(\"sidebarState\");\r\n  const stateMode = getCookie(\"stateMode\") === \"true\";\r\n  const isOpen = savedState === \"open\";\r\n\r\n  // Apply initial state\r\n  if (!stateMode) {\r\n    setSidebarVisibility(isOpen, { manageFocus: false });\r\n  }\r\n\r\n  // Ensure proper styling\r\n  sidebar.classList.add(\r\n    \"fixed\",\r\n    \"top-2\",\r\n    \"w-80\",\r\n    \"bg-white\",\r\n    \"shadow-lg\",\r\n    \"z-70\",\r\n    \"overflow-y-auto\"\r\n  );\r\n  attachSidebarListeners();\r\n};\r\n\r\n/**\r\n * Initializes the navigation popup and applies saved state.\r\n * Restores open/closed state from cookies.\r\n */\r\nexport const initializeNavigation = () => {\r\n  const navPopup = document.getElementById(\"navPopup\");\r\n  if (!navPopup) return;\r\n\r\n  // Load saved navigation state\r\n  const savedState = getCookie(\"navState\");\r\n  const stateMode = getCookie(\"stateMode\") === \"true\";\r\n  const isOpen = savedState === \"open\";\r\n\r\n  // Apply initial state\r\n  if (!stateMode) {\r\n    if (isOpen) {\r\n      toggleNav(isOpen);\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Attaches listeners to the sidebar for state persistence.\r\n * @private\r\n */\r\nconst attachSidebarListeners = () => {\r\n  // Save sidebar state before page unload\r\n  window.addEventListener(\"beforeunload\", () => {\r\n    const sidebarState = interfaceCache.sidebarState ? \"open\" : \"closed\";\r\n    setCookie(\"sidebarState\", sidebarState, 7);\r\n  });\r\n};\r\n\r\n/**\r\n * Initializes the language dropdown, populates options, and sets current language.\r\n * Retries initialization if the dropdown is not found immediately.\r\n * @returns {Promise<boolean>} Resolves true if successful, false otherwise.\r\n */\r\nexport const initializeLanguageDropdown = async () => {\r\n  try {\r\n    // Maximum retry attempts\r\n    const MAX_RETRIES = 3;\r\n    let retryCount = 0;\r\n\r\n    const tryInitialize = async () => {\r\n      const dropdown = document.getElementById(\"language-dropdown\");\r\n      if (!dropdown) {\r\n        if (retryCount >= MAX_RETRIES) {\r\n          throw new Error(\"Language dropdown not found after maximum retries\");\r\n        }\r\n        retryCount++;\r\n        await new Promise(resolve => setTimeout(resolve, 200));\r\n        return tryInitialize();\r\n      }\r\n\r\n      // Once found, clear existing options\r\n      dropdown.innerHTML = '';\r\n\r\n      // Get languages from meta tag\r\n      const metaTag = document.querySelector('meta[name=\"available-languages\"]');\r\n      const languages = metaTag ? metaTag.getAttribute(\"content\")?.split(\",\") : [\"es\", \"en\"];\r\n\r\n      // Set current language before adding options\r\n      const currentLang = state.currentLanguage ||\r\n        getCookie(\"currentLanguage\") ||\r\n        document.documentElement.lang ||\r\n        \"es\";\r\n\r\n      // Add options for each language, marking currentLang as selected\r\n      languages.forEach(lang => {\r\n        const option = document.createElement(\"option\");\r\n        option.value = lang;\r\n        option.textContent = lang.toUpperCase();\r\n        if (lang === currentLang) {\r\n          option.selected = true;\r\n        }\r\n        dropdown.appendChild(option);\r\n      });\r\n\r\n      dropdown.value = currentLang;\r\n      setState(\"currentLanguage\", currentLang);\r\n\r\n      // Ensure visibility of dropdown and container\r\n      dropdown.classList.remove('hidden');\r\n      const container = dropdown.closest('.flex.items-center');\r\n      if (container) {\r\n        container.classList.remove('hidden');\r\n        container.style.display = 'flex';\r\n        // Add necessary Tailwind classes\r\n        container.classList.add(\r\n          'flex',\r\n          'items-center',\r\n          'space-x-4',\r\n          'ml-auto',\r\n          'mr-4'\r\n        );\r\n      }\r\n\r\n      // Style the dropdown\r\n      dropdown.classList.add(\r\n        'ml-4',\r\n        'p-2',\r\n        'border',\r\n        'border-gray-300',\r\n        'rounded-md',\r\n        'bg-white',\r\n        'text-gray-700'\r\n      );\r\n      // Update the HTML lang attribute to match the selected language\r\n      document.documentElement.lang = currentLang;\r\n      return true;\r\n    };\r\n\r\n    return await tryInitialize();\r\n\r\n  } catch (error) {\r\n    console.error(\"Error initializing language dropdown:\", error);\r\n    return false; // Return false instead of throwing to prevent cascading failures\r\n  }\r\n};\r\n\r\n/**\r\n * Updates the page number display based on meta tags.\r\n * Handles special cases for sectioned and non-sectioned pages.\r\n */\r\nexport const updatePageNumber = () => {\r\n  const pageElement = document.getElementById('page-section-id');\r\n  if (!pageElement) return;\r\n\r\n  const pageSectionMetaTag = document.querySelector('meta[name=\"page-section-id\"]');\r\n  const sectionMetaTag = document.querySelector('meta[name=\"title-id\"]');\r\n\r\n  const fallbackValue = pageSectionMetaTag?.getAttribute('content') || '0';\r\n  state.currentPage = fallbackValue;\r\n\r\n  const sectionId = sectionMetaTag?.getAttribute('content');\r\n  let displayLabel = null;\r\n\r\n  if (sectionId) {\r\n    const navPages = getNavigationData()?.pages || [];\r\n    const matchingEntry = navPages.find((page) => page.section_id === sectionId);\r\n    if (matchingEntry?.page_label) {\r\n      displayLabel = matchingEntry.page_label;\r\n    }\r\n  }\r\n\r\n  pageElement.innerHTML = `<span data-id=\"page\"></span> ${displayLabel || fallbackValue}`;\r\n};\r\n\r\n/**\r\n * Updates the page number display based on meta tags.\r\n * Handles special cases for sectioned and non-sectioned pages.\r\n */\r\nexport const toggleSidebar = () => {\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  if (!sidebar) return;\r\n\r\n  // Determine current state\r\n  const isCurrentlyOpen = sidebar.getAttribute(\"aria-expanded\") === \"true\";\r\n\r\n  // Toggle to opposite state\r\n  setSidebarVisibility(!isCurrentlyOpen);\r\n\r\n  // Update state\r\n  state.sideBarActive = !isCurrentlyOpen;\r\n\r\n  // Adjust layout\r\n  adjustLayout();\r\n};\r\n\r\n/**\r\n * Adjusts layout for sidebar, navigation, and submit button based on state.\r\n * Applies/removes Tailwind classes to main content and navigation elements.\r\n */\r\nexport const adjustLayout = () => {\r\n  const submitButtonContainer = document.querySelector(\".fixed.bottom-0 .container .absolute\");\r\n  const navButtons = document.getElementById(\"back-forward-buttons\");\r\n  const mainContent = document.querySelector(\"body > .container\");\r\n  const submitButton = document.getElementById(\"submit-button\");\r\n\r\n  const isSignLanguageActive = state.signLanguageMode;\r\n  // Only the sign language panel should influence layout spacing.\r\n  const shouldShiftLayout = isSignLanguageActive;\r\n\r\n  // Check if this is an activity page with submit button visible\r\n  const isActivity = submitButton && window.getComputedStyle(submitButton).display !== 'none';\r\n\r\n  // Set classes directly based on current state rather than toggling\r\n  if (mainContent) {\r\n    // Remove all relevant classes first\r\n    mainContent.classList.remove(\"lg:ml-0\", \"lg:w-[calc(100vw-450px)]\", \"mx-auto\");\r\n\r\n    // Apply appropriate classes based on current state\r\n    if (shouldShiftLayout) {\r\n      mainContent.classList.add(\"lg:ml-0\", \"lg:w-[calc(100vw-450px)]\");\r\n    } else {\r\n      mainContent.classList.add(\"mx-auto\");\r\n    }\r\n  }\r\n\r\n  // Adjust the submit button position\r\n  if (submitButtonContainer) {\r\n    // Remove all relevant classes first\r\n    submitButtonContainer.classList.remove(\"lg:right-0\", \"lg:right-[calc(425px-1rem)]\");\r\n\r\n    // Apply appropriate classes based on current state\r\n    if (shouldShiftLayout) {\r\n      submitButtonContainer.classList.add(\"lg:right-[calc(425px-1rem)]\");\r\n    } else {\r\n      submitButtonContainer.classList.add(\"lg:right-0\");\r\n    }\r\n  }\r\n\r\n  // Adjust the navigation buttons position\r\n  if (navButtons) {\r\n    // Remove all relevant classes first\r\n    navButtons.classList.remove(\"left-1/2\", \"lg:left-[calc(50vw-212.5px)]\", \"left-20\");\r\n\r\n    // Apply appropriate classes based on current state\r\n    if (isActivity) {\r\n      // On activity pages, use left-20 for all screen sizes\r\n      navButtons.classList.add(\"left-20\");\r\n    } else if (shouldShiftLayout) {\r\n      navButtons.classList.add(\"lg:left-[calc(50vw-212.5px)]\", \"left-1/2\");\r\n    } else {\r\n      navButtons.classList.add(\"left-1/2\");\r\n    }\r\n  }\r\n\r\n  // Re-apply zoom if active to maintain proper layout\r\n  const currentZoom = getCurrentZoom();\r\n  if (currentZoom !== 1) {\r\n    // Small delay to let the DOM update first\r\n    setTimeout(() => {\r\n      setNativeZoom(currentZoom);\r\n    }, 10);\r\n  }\r\n};\r\n\r\n/**\r\n * Caches the current sidebar and navigation HTML.\r\n * Stores them in the interfaceCache object.\r\n */\r\nexport const cacheInterfaceElements = () => {\r\n  try {\r\n    const sidebar = document.getElementById(\"sidebar\");\r\n    const navPopup = document.getElementById(\"navPopup\");\r\n\r\n    if (sidebar) {\r\n      interfaceCache.interface = sidebar.outerHTML;\r\n    }\r\n    if (navPopup) {\r\n      interfaceCache.navigation = navPopup.outerHTML;\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error caching interface elements:\", error);\r\n  }\r\n};\r\n\r\n/**\r\n * Restores cached sidebar and navigation HTML.\r\n * @returns {boolean} True if successful, false otherwise.\r\n */\r\nexport const restoreInterfaceElements = () => {\r\n  try {\r\n    if (interfaceCache.interface) {\r\n      const interfaceContainer = document.getElementById(\"interface-container\");\r\n      if (interfaceContainer) {\r\n        interfaceContainer.innerHTML = interfaceCache.interface;\r\n      }\r\n    }\r\n    if (interfaceCache.navigation) {\r\n      const navContainer = document.getElementById(\"nav-container\");\r\n      if (navContainer) {\r\n        navContainer.innerHTML = interfaceCache.navigation;\r\n      }\r\n    }\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error restoring interface elements:\", error);\r\n    return false;\r\n  }\r\n};\r\n\r\n/**\r\n * Handles sidebar accessibility attributes and focus.\r\n * Sets aria-hidden and tabindex based on sidebar state.\r\n * @private\r\n * @param {HTMLElement} openSidebar - Sidebar toggle button.\r\n * @param {HTMLElement} languageDropdown - Language dropdown element.\r\n */\r\nconst handleSidebarAccessibility = (openSidebar, languageDropdown) => {\r\n  const elements = [\"close-sidebar\", \"language-dropdown\", \"sidebar\"];\r\n\r\n  elements.forEach((id) => {\r\n    const element = document.getElementById(id);\r\n    if (state.sideBarActive) {\r\n      element.setAttribute(\"aria-hidden\", \"false\");\r\n      element.removeAttribute(\"tabindex\");\r\n      openSidebar.setAttribute(\"aria-expanded\", \"true\");\r\n\r\n      setTimeout(() => {\r\n        languageDropdown.focus();\r\n      }, 500);\r\n    } else {\r\n      element.setAttribute(\"aria-hidden\", \"true\");\r\n      element.setAttribute(\"tabindex\", \"-1\");\r\n      openSidebar.setAttribute(\"aria-expanded\", \"false\");\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Switches the UI language, updates state, cookies, and translations.\r\n * Also updates glossary highlights if glossary mode is active.\r\n */\r\nexport const switchLanguage = async () => {\r\n  try {\r\n    const dropdown = document.getElementById(\"language-dropdown\");\r\n    if (!dropdown) return;\r\n\r\n    // Disable dropdown during switch\r\n    dropdown.disabled = true;\r\n\r\n    // Stop any audio playing\r\n    stopAudio();\r\n\r\n    // Update language state\r\n    setState(\"currentLanguage\", dropdown.value);\r\n\r\n    // Save to cookie\r\n    const basePath = window.location.pathname.substring(\r\n      0,\r\n      window.location.pathname.lastIndexOf(\"/\") + 1\r\n    );\r\n    setCookie(\"currentLanguage\", state.currentLanguage, 7, basePath);\r\n\r\n    // Update HTML lang attribute\r\n    document.documentElement.lang = state.currentLanguage;\r\n\r\n    // Fetch and apply new translations\r\n    await fetchTranslations();\r\n\r\n    populateGlossaryTerms();\r\n\r\n    // If glossary mode is on, update the highlights\r\n    if (state.glossaryMode) {\r\n      highlightGlossaryTerms();\r\n    }\r\n\r\n    // Re-enable dropdown\r\n    dropdown.disabled = false;\r\n\r\n  } catch (error) {\r\n    console.error(\"Error switching language:\", error);\r\n    showErrorToast(\"Error changing language\");\r\n  }\r\n};\r\n\r\n/**\r\n * Toggles Easy Read mode, updates state and cookie, and fetches translations.\r\n * @param {Object} [options]\r\n * @param {boolean} [options.stopCalls=false]\r\n * @async\r\n */\r\nexport const toggleEasyReadMode = async ({ stopCalls = false } = {}) => {\r\n  setState(\"easyReadMode\", !state.easyReadMode);\r\n  setCookie(\"easyReadMode\", state.easyReadMode, 7);\r\n  toggleButtonState(\"toggle-easy-read\", state.easyReadMode);\r\n\r\n  // Track the toggle event\r\n  trackToggleEvent('EasyReadMode', state.easyReadMode);\r\n\r\n  /*if (!stopCalls && state.readAloudMode) {\r\n    toggleReadAloud({ stopCalls: true });\r\n  }\r\n  if (!stopCalls && state.signLanguageMode) {\r\n    toggleSignLanguageMode({ stopCalls: true });\r\n  }*/\r\n\r\n  stopAudio();\r\n  /*setState(\r\n    \"currentLanguage\",\r\n    document.getElementById(\"language-dropdown\").value\r\n  );*/\r\n  await fetchTranslations();\r\n};\r\n\r\n/**\r\n * Toggles syllables mode and updates state and cookie.\r\n */\r\nexport const toggleSyllablesMode = () => {\r\n  setState(\"syllablesMode\", !state.syllablesMode);\r\n  setCookie(\"syllablesMode\", state.syllablesMode, 7);\r\n  toggleButtonState(\"toggle-syllables\", state.syllablesMode);\r\n};\r\n\r\n/**\r\n * Initializes the Sign Language quick toggle button.\r\n * Makes the button visible if it was hidden.\r\n */\r\nexport const initializeSignLanguage = () => {\r\n  const slQuickToggleButton = document.getElementById(\"sl-quick-toggle-button\");\r\n  if (slQuickToggleButton && slQuickToggleButton.classList.contains(\"hidden\")) {\r\n    slQuickToggleButton.classList.remove(\"hidden\");\r\n  }\r\n};\r\n\r\n/**\r\n * Toggles Sign Language mode, updates state and cookie, and manages video and layout.\r\n * @param {Object} [options]\r\n * @param {boolean} [options.stopCalls=false]\r\n */\r\nexport const toggleSignLanguageMode = ({ stopCalls = false } = {}) => {\r\n  setState(\"signLanguageMode\", !state.signLanguageMode);\r\n  setCookie(\"signLanguageMode\", state.signLanguageMode ? \"true\" : \"false\", 7);\r\n  toggleButtonState(\"toggle-sign-language\", state.signLanguageMode);\r\n  toggleButtonColor(\"sl-quick-toggle-button\", state.signLanguageMode);\r\n\r\n  // Toggle the bottom container\r\n  toggleBottomContainer(state.signLanguageMode);\r\n\r\n  // Track the toggle event\r\n  trackToggleEvent('SignLanguageMode', state.signLanguageMode);\r\n\r\n  adjustLayout();\r\n\r\n  if (state.signLanguageMode) {\r\n    startSLVideo();\r\n  } else {\r\n    stopSLVideo();\r\n  }\r\n  if (!stopCalls && state.readAloudMode) {\r\n    toggleReadAloud({ stopCalls: true });\r\n  }\r\n  /* if (!stopCalls && state.easyReadMode) {\r\n    toggleEasyReadMode({ stopCalls: true });\r\n  } */\r\n}\r\n\r\n/**\r\n * Loads Sign Language mode from cookies and applies state.\r\n * Updates UI and video as needed.\r\n */\r\nexport const loadSignLanguageMode = () => {\r\n  const signLanguageModeCookie = getCookie(\"signLanguageMode\") === \"true\";\r\n\r\n  if (signLanguageModeCookie !== \"\") {\r\n    setState(\"signLanguageMode\", signLanguageModeCookie);\r\n    toggleButtonState(\"toggle-sign-language\", state.signLanguageMode);\r\n    toggleButtonColor(\"sl-quick-toggle-button\", state.signLanguageMode);\r\n\r\n    // Toggle the bottom container based on saved state\r\n    toggleBottomContainer(state.signLanguageMode);\r\n\r\n    stopSLVideo();\r\n    if (state.signLanguageMode) {\r\n      startSLVideo();\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Loads glossary terms for the current language and updates state.\r\n * Fetches glossary JSON and stores it in state.\r\n * @async\r\n */\r\nexport const loadGlossaryTerms = async () => {\r\n  try {\r\n    // Fallback to \"es\" if state.currentLanguage is not set\r\n    const language = state.currentLanguage || \"es\";\r\n    const response = await fetch(`./content/i18n/${language}/glossary.json`);\r\n    const data = await response.json();\r\n    glossaryTerms = data;\r\n    state.glossaryTerms = data;\r\n  } catch (error) {\r\n    console.error('Error loading glossary:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Toggles glossary mode, updates state and cookie, and highlights or removes glossary terms.\r\n */\r\nexport const toggleGlossaryMode = () => {\r\n  setState(\"glossaryMode\", !state.glossaryMode);\r\n  setCookie(\"glossaryMode\", state.glossaryMode, 7);\r\n  toggleButtonState(\"toggle-glossary\", state.glossaryMode);\r\n\r\n  if (state.glossaryMode) {\r\n    loadGlossaryTerms().then(() => {\r\n      highlightGlossaryTerms();\r\n    })\r\n  } else {\r\n    removeGlossaryHighlights();\r\n  }\r\n};\r\n\r\n/**\r\n * Highlights glossary terms in the content area.\r\n * Adds event listeners for showing definitions.\r\n */\r\nexport const highlightGlossaryTerms = () => {\r\n  if (!state.glossaryMode || !glossaryTerms) return;\r\n\r\n  // Remove any existing highlights first\r\n  removeGlossaryHighlights();\r\n\r\n  // Extract terms from the current page\r\n  const pageTerms = extractPageTerms();\r\n\r\n  // Escape special characters for regex\r\n  const escapeRegExp = (string) => {\r\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  };\r\n\r\n  // Build term objects with normalized base forms\r\n  const termObjects = [];\r\n  Object.entries(glossaryTerms || {}).forEach(([key, value]) => {\r\n    // Add main term\r\n    termObjects.push({\r\n      text: key,\r\n      pattern: escapeRegExp(key),\r\n      baseForm: key.toLowerCase().replace(/[es]$|[s]$/, ''), // Basic singular form\r\n      definition: value.definition,\r\n      emoji: value.emoji || ''\r\n    });\r\n\r\n    // Add variations\r\n    if (value.variations) {\r\n      value.variations.forEach(term => {\r\n        termObjects.push({\r\n          text: term,\r\n          pattern: escapeRegExp(term),\r\n          baseForm: term.toLowerCase().replace(/[es]$|[s]$/, ''), // Basic singular form\r\n          definition: value.definition,\r\n          emoji: value.emoji || ''\r\n        });\r\n      });\r\n    }\r\n  });\r\n\r\n  // Sort longer terms first to handle overlapping terms properly\r\n  termObjects.sort((a, b) => b.text.length - a.text.length);\r\n\r\n  if (termObjects.length === 0) return;\r\n\r\n  // Track which base forms have been highlighted\r\n  const highlightedBaseForms = new Set();\r\n\r\n  // Get content area\r\n  const contentArea = document.getElementById('content');\r\n  if (!contentArea) return;\r\n\r\n  // First check headers for terms we should highlight elsewhere\r\n  const termsInHeaders = new Set();\r\n  contentArea.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(header => {\r\n    const headerText = header.textContent.toLowerCase();\r\n\r\n    // Check each term\r\n    for (const term of termObjects) {\r\n      const regex = new RegExp(`\\\\b${term.pattern}\\\\b`, 'i');\r\n      if (regex.test(headerText)) {\r\n        termsInHeaders.add(term.baseForm);\r\n      }\r\n    }\r\n  });\r\n\r\n  // Process text nodes using a safer approach - direct DOM manipulation\r\n  const walker = document.createTreeWalker(\r\n    contentArea,\r\n    NodeFilter.SHOW_TEXT,\r\n    {\r\n      acceptNode(node) {\r\n        // Skip nodes in headers, scripts, styles, or already processed nodes\r\n        if (\r\n          node.parentNode.nodeName.match(/^H[1-6]$/i) ||\r\n          node.parentNode.nodeName === 'SCRIPT' ||\r\n          node.parentNode.nodeName === 'STYLE' ||\r\n          node.parentNode.classList?.contains('glossary-term') ||\r\n          node.parentNode.closest('.glossary-popup, .glossary-term') ||\r\n          node.parentNode.closest('.activity-text')\r\n        ) {\r\n          return NodeFilter.FILTER_REJECT;\r\n        }\r\n        return NodeFilter.FILTER_ACCEPT;\r\n      }\r\n    }\r\n  );\r\n\r\n  // We'll process nodes one by one - can't modify during traversal\r\n  const nodesToProcess = [];\r\n  let currentNode;\r\n  while (currentNode = walker.nextNode()) {\r\n    // Only process non-empty text nodes\r\n    if (currentNode.textContent.trim()) {\r\n      nodesToProcess.push(currentNode);\r\n    }\r\n  }\r\n\r\n  // Process each node\r\n  nodesToProcess.forEach(textNode => {\r\n    const originalText = textNode.textContent;\r\n    if (!originalText.trim()) return;\r\n\r\n    // Create segments array to hold parts of the text and their status (highlighted or not)\r\n    const segments = [{ text: originalText, highlighted: false }];\r\n\r\n    // Process each term\r\n    for (const term of termObjects) {\r\n      // Skip if this base form is already highlighted (unless it was in a header)\r\n      if (highlightedBaseForms.has(term.baseForm) && !termsInHeaders.has(term.baseForm)) {\r\n        continue;\r\n      }\r\n\r\n      // Loop through segments looking for matches\r\n      for (let i = 0; i < segments.length; i++) {\r\n        const segment = segments[i];\r\n\r\n        // Skip already highlighted segments\r\n        if (segment.highlighted) continue;\r\n\r\n        // Look for the term in this segment\r\n        const regex = new RegExp(`\\\\b(${term.pattern})([,;:.!?)]|\\\\s|$)`, 'i');\r\n        const match = segment.text.match(regex);\r\n\r\n        if (match) {\r\n          // Found a match - split this segment into three parts\r\n          const beforeText = segment.text.substring(0, match.index);\r\n          const termText = match[1]; // The matched term\r\n          const punctuation = match[2]; // Any punctuation that followed\r\n          const afterText = segment.text.substring(match.index + match[1].length + match[2].length);\r\n\r\n          // Replace the segment with three new segments\r\n          segments.splice(\r\n            i, 1,\r\n            { text: beforeText, highlighted: false },\r\n            { text: termText, highlighted: true, term: term },\r\n            { text: punctuation, highlighted: false },\r\n            { text: afterText, highlighted: false }\r\n          );\r\n\r\n          // Mark this term as highlighted\r\n          highlightedBaseForms.add(term.baseForm);\r\n          termsInHeaders.delete(term.baseForm);\r\n\r\n          // Only process the first match of each term\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Check if any segments were highlighted\r\n    if (segments.some(s => s.highlighted)) {\r\n      // Filter out empty segments\r\n      const nonEmptySegments = segments.filter(s => s.text);\r\n\r\n      // Create document fragment to hold the new content\r\n      const fragment = document.createDocumentFragment();\r\n\r\n      // Process each segment\r\n      nonEmptySegments.forEach(segment => {\r\n        if (segment.highlighted) {\r\n          // Create a highlighted span\r\n          const span = document.createElement('span');\r\n          span.className = 'glossary-term bg-emerald-100 bg-opacity-80 text-emerald-800 rounded cursor-pointer';\r\n          span.setAttribute('role', 'button');\r\n          span.setAttribute('tabindex', '0');\r\n          span.textContent = segment.text;\r\n\r\n          // Add click event\r\n          span.addEventListener('click', showGlossaryDefinition);\r\n          span.addEventListener('keydown', e => {\r\n            if (e.key === 'Enter' || e.key === ' ') {\r\n              e.preventDefault();\r\n              showGlossaryDefinition.call(span, e);\r\n            }\r\n          });\r\n\r\n          fragment.appendChild(span);\r\n        } else {\r\n          // Create a text node\r\n          fragment.appendChild(document.createTextNode(segment.text));\r\n        }\r\n      });\r\n\r\n      // Replace the original text node with our fragment\r\n      textNode.parentNode.replaceChild(fragment, textNode);\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Shows a glossary definition popup for a clicked term.\r\n * Handles popup positioning, accessibility, and navigation to glossary sidebar.\r\n * @param {Event} event - The click event from a glossary term.\r\n */\r\nexport const showGlossaryDefinition = async (event) => {\r\n\r\n  // Hide any existing popups\r\n  const existingPopup = document.querySelector('.glossary-popup');\r\n  if (existingPopup) {\r\n    existingPopup.remove();\r\n  }\r\n\r\n  // Get the term text and normalize it by removing punctuation\r\n  const termWithPunctuation = event.target.textContent;\r\n  const term = termWithPunctuation\r\n    .toLowerCase()\r\n    .trim()\r\n    .replace(/[.,;:!?()]/g, ''); // Remove punctuation\r\n\r\n  let definition = '';\r\n  let emoji = '';\r\n  let originalTerm = ''; // Store the original key term\r\n\r\n  // Find the definition, emoji and original term\r\n  for (const [key, value] of Object.entries(glossaryTerms)) {\r\n    // Compare using normalized versions of both the key and search term\r\n    const normalizedKey = key.toLowerCase().trim().replace(/[.,;:!?()]/g, '');\r\n\r\n    if (normalizedKey === term) {\r\n      definition = value.definition;\r\n      emoji = value.emoji;\r\n      originalTerm = key; // Use the original key\r\n      break;\r\n    } else if (value.variations && value.variations.some(v =>\r\n      v.toLowerCase().trim().replace(/[.,;:!?()]/g, '') === term)) {\r\n      definition = value.definition;\r\n      emoji = value.emoji;\r\n      originalTerm = key; // Use the original key even for variations\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (!definition) return;\r\n\r\n  // Create popup\r\n  const popup = document.createElement('div');\r\n  popup.className = 'glossary-popup text-2xl fixed z-50 bg-white rounded-lg border-[1px] border-gray shadow-xl p-4 max-w-sm text-base';\r\n  popup.setAttribute('role', 'dialog');\r\n  popup.setAttribute('aria-label', `Definition for ${originalTerm}`);\r\n\r\n  // Create header container with flex layout\r\n  const headerContainer = document.createElement('div');\r\n  headerContainer.className = 'flex items-center gap-4 mb-4';\r\n\r\n  // Create emoji container\r\n  const emojiContainer = document.createElement('div');\r\n  emojiContainer.className = 'text-4xl flex-shrink-0';\r\n  emojiContainer.textContent = emoji;\r\n  emojiContainer.setAttribute('role', 'img');\r\n  emojiContainer.setAttribute('aria-label', `Symbol for ${originalTerm}`);\r\n\r\n  // Create header text - now using the original term\r\n  const header = document.createElement('div');\r\n  header.className = 'font-bold text-2xl';\r\n  header.textContent = originalTerm; // Use the original key from glossaryTerms\r\n\r\n  // Assemble header\r\n  headerContainer.appendChild(emojiContainer);\r\n  headerContainer.appendChild(header);\r\n\r\n  // Create content\r\n  const content = document.createElement('div');\r\n  content.className = 'mt-3 text-lg leading-relaxed';\r\n  content.textContent = definition;\r\n\r\n  // Create footer with button\r\n  const footer = document.createElement('div');\r\n  footer.className = 'mt-4 flex justify-end border-t border-gray-200 pt-4 pb-1';\r\n\r\n  // Create \"View in glossary\" button\r\n  const viewInGlossaryButton = document.createElement('button');\r\n  viewInGlossaryButton.className = 'px-4 py-2 border border-blue-600 text-blue-600 bg-transparent rounded hover:bg-blue-50 transition-colors flex items-center gap-2 mx-auto';\r\n  viewInGlossaryButton.innerHTML = '<i class=\"fas fa-book\"></i> <span data-id=\"glossary-view-term\">' + translateText(\"glossary-view-term\") + '</span>';\r\n  viewInGlossaryButton.addEventListener('click', (event) => {\r\n    // Stop event propagation to prevent it from reaching document click handlers\r\n    event.stopPropagation();\r\n\r\n    // Close the popup\r\n    popup.remove();\r\n    document.removeEventListener('click', handleClickOutside);\r\n    document.removeEventListener('keydown', handleEscape);\r\n    document.removeEventListener('scroll', updatePopupPosition);\r\n\r\n    // Get sidebar and glossary elements\r\n    const sidebar = document.getElementById('sidebar');\r\n    const glossaryContent = document.getElementById('glossary-content');\r\n    const pageTab = document.getElementById('page-tab');\r\n    const pageContent = document.getElementById('page-content');\r\n    const glossaryTermsPage = document.getElementById('glossary-terms-page');\r\n\r\n    // Make sure the sidebar is open\r\n    if (sidebar && sidebar.getAttribute('aria-expanded') !== 'true') {\r\n      toggleSidebar();\r\n\r\n      // Add small delay to ensure sidebar is open before proceeding\r\n      setTimeout(() => {\r\n        // Rest of the function...\r\n        showGlossaryContent();\r\n      }, 50);\r\n    } else {\r\n      showGlossaryContent();\r\n    }\r\n\r\n    // Function to handle showing glossary content\r\n    function showGlossaryContent() {\r\n      // Show the glossary content\r\n      if (glossaryContent && glossaryContent.classList.contains('hidden')) {\r\n        // Hide other sidebar content first\r\n        document.querySelectorAll('#sidebar > div').forEach(div => {\r\n          if (div !== glossaryContent) {\r\n            div.classList.add('hidden');\r\n          }\r\n        });\r\n\r\n        // Show glossary content\r\n        glossaryContent.classList.remove('hidden');\r\n      }\r\n\r\n      // Select the \"On this page\" tab\r\n      if (pageTab) {\r\n        pageTab.setAttribute('aria-selected', 'true');\r\n        pageTab.classList.add('bg-gray-100');\r\n\r\n        if (document.getElementById('book-tab')) {\r\n          document.getElementById('book-tab').setAttribute('aria-selected', 'false');\r\n          document.getElementById('book-tab').classList.remove('bg-gray-100');\r\n        }\r\n      }\r\n\r\n      // Show the page content tab content\r\n      if (pageContent && pageContent.classList.contains('hidden')) {\r\n        pageContent.classList.remove('hidden');\r\n\r\n        if (document.getElementById('book-content')) {\r\n          document.getElementById('book-content').classList.add('hidden');\r\n        }\r\n      }\r\n\r\n      // Find the term in the glossary list and scroll to it\r\n      if (glossaryTermsPage) {\r\n        // Wait a bit for any animations to complete\r\n        setTimeout(() => {\r\n          // Look for all items with the glossary-page-item class\r\n          const glossaryItems = glossaryTermsPage.querySelectorAll('.glossary-page-item');\r\n          let targetItem = null;\r\n\r\n          for (const item of glossaryItems) {\r\n            // Find the term element using the new glossary-page-term class\r\n            const termElement = item.querySelector('.glossary-page-term');\r\n            if (termElement) {\r\n              // Get the text content and normalize it for comparison\r\n              const termText = termElement.textContent.toLowerCase().trim();\r\n              // Check if this term matches our search term\r\n              if (termText.includes(term.toLowerCase())) {\r\n                targetItem = item;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n\r\n          if (targetItem) {\r\n            // Scroll the item into view\r\n            targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n\r\n            // Highlight the item temporarily using Tailwind classes\r\n            targetItem.classList.add('bg-yellow-100', 'transition-colors', 'duration-500');\r\n\r\n            // Remove highlight after delay\r\n            setTimeout(() => {\r\n              targetItem.classList.remove('bg-yellow-100', 'transition-colors', 'duration-500');\r\n            }, 2000);\r\n          }\r\n        }, 300);\r\n      }\r\n    }\r\n  });\r\n\r\n  footer.appendChild(viewInGlossaryButton);\r\n\r\n  // Assemble popup\r\n  popup.appendChild(headerContainer);\r\n  popup.appendChild(content);\r\n  popup.appendChild(footer);\r\n\r\n  // Position popup\r\n  const updatePopupPosition = () => {\r\n    const popupElement = document.querySelector('.glossary-popup');\r\n    if (popupElement) {\r\n      // Get the current position of the clicked element relative to the viewport\r\n      const newRect = event.target.getBoundingClientRect();\r\n\r\n      // Calculate absolute position by adding current scroll position\r\n      const absoluteTop = newRect.bottom + window.scrollY;\r\n      const absoluteLeft = newRect.left + window.scrollX;\r\n\r\n      // Position the popup relative to the clicked element's current position\r\n      popup.style.position = 'absolute'; // Use absolute instead of fixed\r\n      popup.style.top = `${absoluteTop + 10}px`;\r\n      popup.style.left = `${absoluteLeft}px`;\r\n\r\n      // Adjust position if popup goes off screen\r\n      const popupRect = popup.getBoundingClientRect();\r\n      const viewportWidth = window.innerWidth;\r\n      const viewportHeight = window.innerHeight;\r\n\r\n      if (popupRect.right > viewportWidth) {\r\n        popup.style.left = `${window.scrollX + viewportWidth - popupRect.width - 10}px`;\r\n      }\r\n\r\n      if (popupRect.bottom > viewportHeight) {\r\n        // Show popup above the term if it would go off the bottom\r\n        popup.style.top = `${window.scrollY + newRect.top - popupRect.height - 10}px`;\r\n      }\r\n    }\r\n  };\r\n  // Add to document\r\n  document.body.appendChild(popup);\r\n  updatePopupPosition();\r\n  // Handle scroll event to update position\r\n  window.addEventListener('scroll', updatePopupPosition);\r\n\r\n  // Handle click outside\r\n  function handleClickOutside(e) {\r\n    if (!popup.contains(e.target) && e.target !== event.target) {\r\n      popup.remove();\r\n      document.removeEventListener('click', handleClickOutside);\r\n      document.removeEventListener('scroll', updatePopupPosition);\r\n    }\r\n  }\r\n\r\n  // Handle Escape key\r\n  function handleEscape(e) {\r\n    if (e.key === 'Escape') {\r\n      popup.remove();\r\n      document.removeEventListener('keydown', handleEscape);\r\n      document.removeEventListener('click', handleClickOutside);\r\n      document.removeEventListener('scroll', updatePopupPosition);\r\n      // Return focus to the term that was clicked\r\n      event.target.focus();\r\n    }\r\n  }\r\n\r\n  // Add event listeners\r\n  setTimeout(() => {\r\n    document.addEventListener('click', handleClickOutside);\r\n    document.addEventListener('keydown', handleEscape);\r\n    document.addEventListener('scroll', updatePopupPosition);\r\n  }, 0);\r\n}\r\n\r\n/**\r\n * Removes all glossary term highlights and glossary popups from the content area.\r\n */\r\nexport const removeGlossaryHighlights = () => {\r\n  // First, handle any existing popups\r\n  document.querySelectorAll('.glossary-popup').forEach(popup => {\r\n    popup.remove();\r\n  });\r\n\r\n  // Find all glossary terms\r\n  document.querySelectorAll('.glossary-term').forEach(term => {\r\n    const text = document.createTextNode(term.textContent);\r\n    term.parentNode.replaceChild(text, term);\r\n  });\r\n\r\n  // Look for empty wrapper spans that may have been created\r\n  document.querySelectorAll('span:not([class])').forEach(span => {\r\n    // Check if this is likely a wrapper we created (no attributes, only text nodes)\r\n    if (span.attributes.length === 0 &&\r\n      span.childNodes.length > 0 &&\r\n      Array.from(span.childNodes).every(node => node.nodeType === 3)) {\r\n\r\n      // Get the text content\r\n      const text = document.createTextNode(span.textContent);\r\n\r\n      // Replace the span with its content\r\n      if (span.parentNode) {\r\n        span.parentNode.replaceChild(text, span);\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\n/**\r\n * Loads Easy Read mode from cookies and applies state.\r\n * Updates UI and fetches translations.\r\n * @async\r\n */\r\nexport const loadEasyReadMode = async () => {\r\n  const easyReadModeCookie = getCookie(\"easyReadMode\");\r\n\r\n  if (easyReadModeCookie !== \"\") {\r\n    setState(\"easyReadMode\", easyReadModeCookie === \"true\");\r\n    toggleButtonState(\"toggle-easy-read\", state.easyReadMode);\r\n\r\n    stopAudio();\r\n    /*setState(\r\n      \"currentLanguage\",\r\n      document.getElementById(\"language-dropdown\").value\r\n    );*/\r\n    await fetchTranslations();\r\n  }\r\n};\r\n\r\n/**\r\n * Toggles state mode and updates state and cookie.\r\n */\r\nexport const toggleStateMode = () => {\r\n  setState(\"stateMode\", !state.stateMode);\r\n  setCookie(\"stateMode\", state.stateMode ? \"true\" : \"false\", 7);\r\n  toggleButtonState(\"toggle-state\", state.stateMode);\r\n};\r\n\r\n/**\r\n * Loads state mode from cookies and applies state.\r\n */\r\nexport const loadStateMode = () => {\r\n  const stateModeCookie = getCookie(\"stateMode\");\r\n\r\n  // Only apply state if the cookie has a value and the feature is enabled\r\n  if (stateModeCookie !== \"\" && stateModeCookie !== null) {\r\n    const isEnabled = stateModeCookie === \"true\";\r\n    setState(\"stateMode\", isEnabled);\r\n    setCookie(\"stateMode\", isEnabled ? \"true\" : \"false\", 7);\r\n    toggleButtonState(\"toggle-state\", isEnabled);\r\n  } else {\r\n    // Set default state - auto-hide disabled by default\r\n    setState(\"stateMode\", false);\r\n    setCookie(\"stateMode\", \"false\", 7);\r\n    toggleButtonState(\"toggle-state\", false);\r\n  }\r\n};\r\n\r\n/**\r\n * Initializes the play bar based on state and cookies.\r\n * Shows or hides the play bar as needed.\r\n */\r\nexport const initializePlayBar = () => {\r\n  try {\r\n    // Get play bar visibility state\r\n    const playBarVisible = getCookie(\"playBarVisible\") === \"true\";\r\n    const readAloudMode = getCookie(\"readAloudMode\") === \"true\";\r\n    // Set initial state\r\n    setState(\"readAloudMode\", readAloudMode);\r\n\r\n    // Get play bar element\r\n    const playBar = document.getElementById(\"play-bar\");\r\n    if (!playBar) return;\r\n\r\n    if (state.readAloudMode) {\r\n      playBar.classList.remove(\"hidden\");\r\n    } else {\r\n      playBar.classList.add(\"hidden\");\r\n    }\r\n    // // Show/hide based on read aloud mode\r\n    // if (readAloudMode) {\r\n    //     playBar.classList.remove(\"hidden\");\r\n    //     setCookie(\"playBarVisible\", \"true\", 7);\r\n    // } else {\r\n    //     playBar.classList.add(\"hidden\");\r\n    //     setCookie(\"playBarVisible\", \"false\", 7);\r\n    // }\r\n  } catch (error) {\r\n    console.error('Error initializing play bar:', error);\r\n  }\r\n};\r\n\r\n/**\r\n * Toggles the visibility of the play bar settings panel.\r\n */\r\nexport const togglePlayBarSettings = () => {\r\n  const readAloudSettings = document.getElementById(\"read-aloud-settings\");\r\n  const triggerButton = document.getElementById(\"read-aloud-speed\");\r\n  const isHidden = readAloudSettings.classList.contains(\"opacity-0\");\r\n\r\n  if (isHidden) {\r\n    // Show settings\r\n    readAloudSettings.classList.add(\r\n      \"opacity-100\",\r\n      \"pointer-events-auto\",\r\n      \"h-auto\"\r\n    );\r\n    readAloudSettings.classList.remove(\r\n      \"opacity-0\",\r\n      \"pointer-events-none\",\r\n      \"h-0\"\r\n    );\r\n    readAloudSettings.setAttribute(\"aria-hidden\", \"false\");\r\n    readAloudSettings.removeAttribute(\"inert\");\r\n    triggerButton?.setAttribute(\"aria-expanded\", \"true\");\r\n\r\n    // Focus first menu item after a brief delay for transition\r\n    setTimeout(() => {\r\n      const firstMenuItem = readAloudSettings.querySelector('[role=\"menuitem\"]');\r\n      firstMenuItem?.focus();\r\n    }, 100);\r\n  } else {\r\n    // Hide settings\r\n    readAloudSettings.classList.remove(\r\n      \"opacity-100\",\r\n      \"pointer-events-auto\",\r\n      \"h-auto\"\r\n    );\r\n    readAloudSettings.classList.add(\"h-0\", \"opacity-0\", \"pointer-events-none\");\r\n    readAloudSettings.setAttribute(\"aria-hidden\", \"true\");\r\n    readAloudSettings.setAttribute(\"inert\", \"\");\r\n    triggerButton?.setAttribute(\"aria-expanded\", \"false\");\r\n\r\n    // Return focus to trigger button\r\n    triggerButton?.focus();\r\n  }\r\n};\r\n\r\n/**\r\n * Formats navigation items, adds icons, and highlights the current page.\r\n * Handles activity completion and page/section formatting.\r\n */\r\nexport const formatNavigationItems = () => {\r\n  const navListItems = document.querySelectorAll('.nav__list[data-nav-type=\"pages\"] .nav__list-item');\r\n\r\n  navListItems.forEach((item, index) => {\r\n    const link = item.querySelector(\".nav__list-link\");\r\n    if (!link) return;\r\n\r\n    // Setup basic classes for the item and link\r\n    item.classList.add(\r\n      \"border-b\",\r\n      \"border-gray-300\",\r\n      \"flex\",\r\n      \"items-center\",\r\n      \"gap-2\"\r\n    );\r\n\r\n    link.classList.add(\r\n      \"flex-grow\",\r\n      \"flex\",\r\n      \"items-center\",\r\n      \"min-w-0\",\r\n      \"w-full\",\r\n      \"h-full\",\r\n      \"p-2\",\r\n      \"py-3\",\r\n      \"hover:bg-blue-50\",\r\n      \"transition\",\r\n      \"text-gray-500\"\r\n    );\r\n\r\n    if (index === 0) {\r\n      item.classList.add(\"border-t\");\r\n    }\r\n\r\n    const href = link.getAttribute(\"href\");\r\n    const humanReadablePage =\r\n      link.dataset.pageDisplayLabel || link.dataset.pageLabel || link.dataset.pageNumber || link.textContent.trim() || \"\u2014\";\r\n    const pdfPageLabel = link.dataset.pdfPage;\r\n\r\n    // Handle activity items\r\n    let itemIcon = \"\";\r\n    let activityStatus = \"\";\r\n    if (item.classList.contains(\"activity\")) {\r\n      const activityId = href.split(\".\")[0];\r\n      const success = JSON.parse(localStorage.getItem(`${activityId}_success`)) || false;\r\n\r\n      if (success) {\r\n        itemIcon = `<i class=\"${activityId} fas fa-check-square text-green-500 mt-1\"></i>`;\r\n        activityStatus = \"<span class='activity-status' data-id='activity-completed'></span>\";\r\n      } else {\r\n        itemIcon = `<i class=\"${activityId} fas fa-pen-to-square mt-1 text-blue-700\"></i>`;\r\n        activityStatus = \"<span class='activity-status' data-id='activity-to-do'></span>\";\r\n      }\r\n    }\r\n\r\n    const metadataSegments = [];\r\n    if (activityStatus) {\r\n      metadataSegments.push(activityStatus);\r\n    }\r\n\r\n    const metadataHtml = metadataSegments.length\r\n      ? `<div class='text-xs text-gray-500 flex flex-wrap items-center gap-2'>${metadataSegments.join(\r\n        \"<span class='text-gray-300'>\u2022</span>\"\r\n      )}</div>`\r\n      : \"\";\r\n\r\n    const pdfBadge = pdfPageLabel\r\n      ? `<div class='text-xs text-gray-500 whitespace-nowrap ml-4' aria-label='Print page ${pdfPageLabel}'>Print Page ${pdfPageLabel}</div>`\r\n      : \"\";\r\n\r\n    const leftContent =\r\n      \"<div class='flex items-top space-x-2'>\" +\r\n      itemIcon +\r\n      \"<div>\" +\r\n      `<div class='text-gray-800 font-medium'>${humanReadablePage}</div>` +\r\n      metadataHtml +\r\n      \"</div>\" +\r\n      \"</div>\";\r\n\r\n    link.innerHTML =\r\n      `<div class='flex items-center justify-between gap-2 w-full'>${leftContent}${pdfBadge}</div>`;\r\n\r\n    // Highlight current page\r\n    if (href === window.location.pathname.split(\"/\").pop()) {\r\n      item.classList.add(\"min-h-[3rem]\");\r\n      link.classList.add(\r\n        \"border-l-4\",\r\n        \"border-blue-500\",\r\n        \"bg-blue-100\",\r\n        \"p-2\"\r\n      );\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Updates the play/pause icon in the play bar based on state.\r\n */\r\nexport const setPlayPauseIcon = () => {\r\n  const playIcon = document.getElementById(\"read-aloud-play-icon\");\r\n  const pauseIcon = document.getElementById(\"read-aloud-pause-icon\");\r\n\r\n  if (state.isPlaying) {\r\n    playIcon.style.display = \"none\";\r\n    playIcon.setAttribute(\"aria-hidden\", \"true\");\r\n    pauseIcon.style.display = \"\";\r\n    pauseIcon.setAttribute(\"aria-hidden\", \"false\");\r\n  } else {\r\n    playIcon.style.display = \"\";\r\n    playIcon.setAttribute(\"aria-hidden\", \"false\");\r\n    pauseIcon.style.display = \"none\";\r\n    pauseIcon.setAttribute(\"aria-hidden\", \"true\");\r\n  }\r\n};\r\n\r\nconst initializePlaybackControls = () => {\r\n  const playbackSpeed = document.getElementById(\"read-aloud-speed\");\r\n  if (playbackSpeed) {\r\n    playbackSpeed.classList.add(\r\n      \"absolute\",\r\n      \"bottom-24\",\r\n      \"right-4\",\r\n      \"bg-white\",\r\n      \"rounded-lg\",\r\n      \"shadow-lg\",\r\n      \"z-50\"\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Updates toggle switch visuals based on checked state.\r\n * @param {HTMLInputElement} toggle - The toggle input element.\r\n */\r\nexport const updateToggleVisuals = (toggle) => {\r\n  const container = toggle.closest(\".toggle-container\");\r\n  if (container) {\r\n    const track = container.querySelector(\".toggle-track\");\r\n    const thumb = container.querySelector(\".toggle-thumb\");\r\n\r\n    if (toggle.checked) {\r\n      track?.classList.remove(\"bg-gray-200\");\r\n      track?.classList.add(\"bg-blue-600\");\r\n      thumb?.classList.add(\"translate-x-5\");\r\n    } else {\r\n      track?.classList.add(\"bg-gray-200\");\r\n      track?.classList.remove(\"bg-blue-600\");\r\n      thumb?.classList.remove(\"translate-x-5\");\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Extracts glossary terms found on the current page.\r\n * @returns {string[]} Array of terms found.\r\n */\r\nexport const extractPageTerms = () => {\r\n  const contentArea = document.getElementById('content');\r\n  if (!contentArea) return [];\r\n\r\n  // Get the actual text content of the page\r\n  const pageContent = contentArea.textContent;\r\n\r\n  // Create a map to track terms and their original capitalization\r\n  const termMap = new Map(); // Maps lowercase terms to their preferred display form\r\n\r\n  // Escape special characters for regex\r\n  const escapeRegExp = (string) => {\r\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  };\r\n\r\n  // Build a list of all terms to check\r\n  const allTerms = [];\r\n  Object.entries(glossaryTerms || {}).forEach(([key, value]) => {\r\n    // Add main term\r\n    allTerms.push(key);\r\n\r\n    // Add variations\r\n    if (value.variations && Array.isArray(value.variations)) {\r\n      value.variations.forEach(term => allTerms.push(term));\r\n    }\r\n  });\r\n\r\n  // Check each term with a word boundary regex to ensure exact matches\r\n  allTerms.forEach(term => {\r\n    // Create a pattern that handles word boundaries better with accented characters\r\n    const regex = new RegExp(`(^|[^a-z\u00E1\u00E9\u00ED\u00F3\u00FA\u00F1A-Z\u00C1\u00C9\u00CD\u00D3\u00DA\u00D1])${escapeRegExp(term)}($|[^a-z\u00E1\u00E9\u00ED\u00F3\u00FA\u00F1A-Z\u00C1\u00C9\u00CD\u00D3\u00DA\u00D1])`, 'gi');\r\n\r\n    // Find all exact matches in the content\r\n    let matches = pageContent.match(regex);\r\n    if (matches) {\r\n      matches.forEach(match => {\r\n        // Extract just the term from the match (remove the boundary characters)\r\n        const extractedTerm = match.trim().replace(/^[^a-z\u00E1\u00E9\u00ED\u00F3\u00FA\u00F1A-Z\u00C1\u00C9\u00CD\u00D3\u00DA\u00D1]|[^a-z\u00E1\u00E9\u00ED\u00F3\u00FA\u00F1A-Z\u00C1\u00C9\u00CD\u00D3\u00DA\u00D1]$/g, '');\r\n\r\n        // Store the lowercase version as key, but keep the first occurrence's capitalization\r\n        const lowerCaseTerm = extractedTerm.toLowerCase();\r\n\r\n        // Only add to the map if it's not already there\r\n        if (!termMap.has(lowerCaseTerm)) {\r\n          termMap.set(lowerCaseTerm, extractedTerm);\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n  // Convert the map values to an array and sort it alphabetically\r\n  return Array.from(termMap.values()).sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));\r\n};\r\n\r\n/**\r\n * Checks for Windows scaling and shows a notification if needed.\r\n * Also initializes the zoom controller.\r\n */\r\nexport const checkWindowsScaling = () => {\r\n  // Initialize the zoom controller first\r\n  initializeZoomController();\r\n\r\n  // Only show notification if we're on Windows with high DPI and haven't shown it before\r\n  if (isHighDpiWindows() && localStorage.getItem('hasSeenScalingNotice') !== 'true') {\r\n\r\n    // Create notification container\r\n    const notification = document.createElement('div');\r\n    notification.className = 'fixed top-4 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 max-w-md z-50 flex flex-col';\r\n    notification.style.maxWidth = '350px';\r\n\r\n    // Add notification content\r\n    notification.innerHTML = `\r\n      <div class=\"flex items-start mb-3\">\r\n      <div class=\"text-amber-500 mr-3 text-xl flex-shrink-0\">\r\n        <i class=\"fas fa-exclamation-triangle\"></i>\r\n      </div>\r\n      <div>\r\n        <h3 class=\"font-semibold text-gray-800 mb-1\">Escalado de Pantalla Detectado</h3>\r\n        <p class=\"text-gray-600 text-sm\">\r\n        Se ha detectado un escalado de alta resoluci\u00F3n. Esto puede resultar en una experiencia de visualizaci\u00F3n menos \u00F3ptima. Presiona Ctrl + \u201C-\u201D (menos) para reducir el zoom hasta alcanzar el tama\u00F1o de visualizaci\u00F3n deseado.\r\n        </p>\r\n      </div>\r\n      </div>\r\n      <div class=\"flex justify-end space-x-2\">\r\n      <button id=\"dismiss-scaling-notice\" class=\"text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded transition-colors\">\r\n        No mostrar de nuevo\r\n      </button>\r\n      </div>\r\n    `;\r\n\r\n    // Add to document\r\n    document.body.appendChild(notification);\r\n\r\n    // Add dismiss handler\r\n    document.getElementById('dismiss-scaling-notice').addEventListener('click', () => {\r\n      // Close notification\r\n      notification.remove();\r\n      localStorage.setItem('hasSeenScalingNotice', 'true');\r\n    });\r\n\r\n    // Auto-dismiss after 15 seconds\r\n    setTimeout(() => {\r\n      if (document.body.contains(notification)) {\r\n        notification.remove();\r\n      }\r\n    }, 15000);\r\n  }\r\n};\r\n\r\n/**\r\n * Creates and shows the zoom reset button (or controls).\r\n */\r\nexport const createZoomResetButton = () => {\r\n  // Use the more comprehensive zoom controls instead\r\n  return createZoomControls();\r\n};\r\n\r\n// Update this function to match the new ID\r\nfunction removeResetZoomButton() {\r\n  const existingButton = document.getElementById('zoom-reset-button');\r\n  if (existingButton) {\r\n    existingButton.remove();\r\n  }\r\n}\r\n\r\n// Add a direct zoom function to test functionality\r\nexport const testZoom = (level) => {\r\n  return setNativeZoom(level);\r\n};\r\n\r\n/**\r\n * Public function to manually trigger the zoom reset button creation.\r\n */\r\nexport const showZoomResetButton = () => {\r\n  return createZoomResetButton();\r\n};\r\n\r\n// Initial check on load - using window.onload instead of DOMContentLoaded to ensure everything is loaded\r\nwindow.addEventListener('load', () => {\r\n  setTimeout(checkWindowsScaling, 500); // Slight delay to ensure everything is ready\r\n});\r\n\r\n/**\r\n * Shows or hides the sidebar based on provided state.\r\n * @param {boolean} show - Whether to show the sidebar (true) or hide it (false).\r\n */\r\nexport const setSidebarVisibility = (show, { manageFocus = true } = {}) => {\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n  if (!sidebar) return;\r\n\r\n  if (show) {\r\n    // Show sidebar\r\n    if (manageFocus) {\r\n      lastSidebarTrigger = document.activeElement;\r\n    }\r\n    sidebar.style.opacity = \"1\";\r\n    sidebar.style.visibility = \"visible\";\r\n    sidebar.style.pointerEvents = \"auto\";\r\n    sidebar.setAttribute(\"aria-expanded\", \"true\");\r\n    sidebar.setAttribute(\"aria-hidden\", \"false\");\r\n    sidebar.removeAttribute(\"inert\");\r\n  } else {\r\n    // Hide sidebar\r\n    sidebar.style.opacity = \"0\";\r\n    sidebar.style.visibility = \"hidden\";\r\n    sidebar.style.pointerEvents = \"none\";\r\n    sidebar.setAttribute(\"aria-expanded\", \"false\");\r\n    sidebar.setAttribute(\"aria-hidden\", \"true\");\r\n    sidebar.setAttribute(\"inert\", \"\");\r\n  }\r\n  // Save current state\r\n  interfaceCache.sidebarState = show;\r\n  setCookie(\"sidebarState\", show ? \"open\" : \"closed\", 7);\r\n  setState(\"sideBarActive\", show);\r\n  adjustLayout();\r\n  // If zoomed, re-apply zoom to keep sidebar properly positioned\r\n  const currentZoom = getCurrentZoom();\r\n  if (currentZoom !== 1) {\r\n    setTimeout(() => {\r\n      setNativeZoom(currentZoom);\r\n    }, 50);\r\n  }\r\n\r\n  if (manageFocus) {\r\n    if (show) {\r\n      // Wait for CSS transition to complete before focusing\r\n      setTimeout(() => focusFirstSidebarElement(), SIDEBAR_FOCUS_DELAY_MS);\r\n    } else {\r\n      // Use requestAnimationFrame for immediate focus return (no transition when closing)\r\n      requestAnimationFrame(() => restoreSidebarTriggerFocus());\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Shows or hides the navigation popup based on provided state.\r\n * @param {boolean} show - Whether to show the navigation (true) or hide it (false).\r\n */\r\nexport const setNavVisibility = (show) => {\r\n  const navPopup = document.getElementById(\"navPopup\");\r\n  const navList = document.querySelector('.nav__list[data-nav-type=\"pages\"]');\r\n  if (!navPopup) return;\r\n\r\n  // Always ensure transform and transition classes are present\r\n  navPopup.classList.add(\"transform\", \"transition-transform\", \"duration-300\", \"ease-in-out\");\r\n\r\n  if (show) {\r\n    // Remove translate-x-full to slide in\r\n    navPopup.classList.remove(\"-translate-x-full\");\r\n    navPopup.classList.add(\"left-2\");\r\n    navPopup.setAttribute(\"aria-expanded\", \"true\");\r\n    navPopup.setAttribute(\"aria-hidden\", \"false\");\r\n    navPopup.removeAttribute(\"inert\");\r\n\r\n    // Show navList\r\n    if (navList) {\r\n      // navList.removeAttribute(\"hidden\");\r\n      // Restore scroll position if available\r\n      const savedPosition = getCookie(\"navScrollPosition\");\r\n      if (savedPosition) {\r\n        navList.scrollTop = parseInt(savedPosition);\r\n      }\r\n    }\r\n    setCookie(\"navState\", \"open\", 7);\r\n  } else {\r\n    // Add translate-x-full to slide out\r\n    navPopup.classList.add(\"-translate-x-full\");\r\n    navPopup.classList.remove(\"left-2\");\r\n    navPopup.setAttribute(\"aria-expanded\", \"false\");\r\n    navPopup.setAttribute(\"aria-hidden\", \"true\");\r\n    navPopup.setAttribute(\"inert\", \"\");\r\n\r\n    // Hide navList and save scroll position\r\n    if (navList) {\r\n      const scrollPosition = navList.scrollTop;\r\n      setCookie(\"navScrollPosition\", scrollPosition, 7);\r\n    }\r\n    setCookie(\"navState\", \"closed\", 7);\r\n  }\r\n\r\n  // Save current state\r\n  interfaceCache.navigation = show;\r\n};", "/**\r\n * @module ui_utils\r\n * @description\r\n * UI utility functions for toggles, audio highlighting, ELI5, glossary, tabs, reference pages, and accessibility.\r\n */\r\n\r\nimport { getState, setState, state } from './state.js';\r\nimport { setCookie, getCookie } from './cookies.js';\r\nimport {\r\n    stopAudio,\r\n    gatherAudioElements,\r\n    playCurrentAudio,\r\n    playAudioSequentially\r\n} from './audio.js';\r\nimport { setPlayPauseIcon, loadGlossaryTerms, highlightGlossaryTerms, removeGlossaryHighlights, cacheInterfaceElements } from './interface.js'\r\nimport { toggleButtonColor, toggleButtonState } from './utils.js';\r\nimport { extractPageTerms } from './interface.js';\r\nimport { translateText } from './translations.js';\r\nimport { trackToggleEvent, trackEvent } from './analytics.js';\r\nimport { isFeatureEnabled } from '../base.js';\r\n\r\ndocument.addEventListener('click', (event) => {\r\n    // Check for clicks on any element with glossary-term class or data-glossary-term attribute\r\n    const glossaryTerm = event.target.closest('.glossary-term, [data-glossary-term=\"true\"]');\r\n\r\n    if (glossaryTerm) {\r\n        // Import the showGlossaryDefinition function\r\n        import('./interface.js').then(module => {\r\n            // Call the function directly with the event\r\n            module.showGlossaryDefinition(event);\r\n        });\r\n\r\n        // Set flag to prevent audio playback\r\n        window._isGlossaryTermClick = true;\r\n\r\n        // Stop any currently playing audio\r\n        if (state.isPlaying || state.currentAudio) {\r\n            stopAudio();\r\n            unhighlightAllElements();\r\n        }\r\n\r\n        // Clear the flag after a delay\r\n        setTimeout(() => {\r\n            window._isGlossaryTermClick = false;\r\n        }, 100);\r\n\r\n        return false;\r\n    }\r\n}, { capture: true }); // Use capture to ensure this runs before other handlers\r\n\r\n/**\r\n * Loads the autoplay state from cookies and updates UI.\r\n */\r\nexport const loadAutoplayState = () => {\r\n    const autoplayModeCookie = getCookie(\"autoplayMode\");\r\n    if (autoplayModeCookie !== null) {\r\n        setState('autoplayMode', autoplayModeCookie === \"true\");\r\n        toggleButtonState(\"toggle-autoplay\", state.autoplayMode);\r\n    }\r\n};\r\n\r\n/**\r\n * Loads the describe images state from cookies and updates UI.\r\n */\r\nexport const loadDescribeImagesState = () => {\r\n    const describeImagesModeCookie = getCookie(\"describeImagesMode\");\r\n    if (describeImagesModeCookie !== null) {\r\n        // Cookie exists, use its value\r\n        setState('describeImagesMode', describeImagesModeCookie === \"true\");\r\n    } else {\r\n        // Cookie doesn't exist, set a default value (false)\r\n        setState('describeImagesMode', false);\r\n        setCookie(\"describeImagesMode\", \"false\", 7);\r\n    }\r\n\r\n    // Always sync UI with state (this line was commented out)\r\n    toggleButtonState(\"toggle-describe-images\", state.describeImagesMode);\r\n\r\n    // Regather audio elements to ensure correct initial state\r\n    if (state.describeImagesMode) {\r\n        gatherAudioElements();\r\n    }\r\n};\r\n\r\n/**\r\n * Loads the syllables state from cookies and updates UI.\r\n */\r\nexport const loadSyllablesState = () => {\r\n    const syllablesModeCookie = getCookie(\"syllablesMode\");\r\n    if (syllablesModeCookie !== null) {\r\n        setState('syllablesMode', syllablesModeCookie === \"true\");\r\n        toggleButtonState(\"toggle-syllables\", state.syllablesMode);\r\n    }\r\n};\r\n\r\n/**\r\n * Loads the glossary state from cookies and updates UI.\r\n */\r\nexport const loadGlossaryState = async () => {\r\n    const glossaryModeCookie = getCookie(\"glossaryMode\");\r\n    if (glossaryModeCookie !== null) {\r\n        setState('glossaryMode', glossaryModeCookie === \"true\");\r\n        toggleButtonState(\"toggle-glossary\", state.glossaryMode);\r\n\r\n        if (state.glossaryMode) {\r\n            await loadGlossaryTerms();\r\n            highlightGlossaryTerms();\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Toggles autoplay mode, updates state, UI, and cookies, and starts playback if needed.\r\n */\r\nexport const toggleAutoplay = () => {\r\n    stopAudio();\r\n    unhighlightAllElements();\r\n\r\n    setState('autoplayMode', !state.autoplayMode);\r\n    toggleButtonState(\"toggle-autoplay\", state.autoplayMode);\r\n    setCookie(\"autoplayMode\", state.autoplayMode, 7);\r\n\r\n    if (state.readAloudMode && state.autoplayMode) {\r\n        setState('currentIndex', 0);\r\n        setState('isPlaying', true);\r\n        setPlayPauseIcon();\r\n        playAudioSequentially();\r\n    }\r\n};\r\n\r\n/**\r\n * Toggles describe images mode, updates state, UI, and cookies, and starts playback if needed.\r\n */\r\nexport const toggleDescribeImages = () => {\r\n    stopAudio();\r\n    unhighlightAllElements();\r\n\r\n    setState('describeImagesMode', !state.describeImagesMode);\r\n    toggleButtonState(\"toggle-describe-images\", state.describeImagesMode);\r\n    setCookie(\"describeImagesMode\", state.describeImagesMode, 7);\r\n\r\n    // Regather audio elements to update the sequence with or without images\r\n    // gatherAudioElements();\r\n\r\n    // If read aloud and autoplay are active, start playing from beginning\r\n    if (state.readAloudMode && state.autoplayMode) {\r\n        setState('currentIndex', 0);\r\n        setState('isPlaying', true);\r\n        setPlayPauseIcon();\r\n        playAudioSequentially();\r\n    }\r\n};\r\n\r\n/**\r\n * Initializes autoplay if both read aloud and autoplay are enabled.\r\n */\r\nexport const initializeAutoplay = () => {\r\n    // Don't automatically start playing on page load\r\n    if (state.readAloudMode && state.autoplayMode) {\r\n        setState('isPlaying', true);\r\n        setPlayPauseIcon();\r\n\r\n        // Setup audio elements but don't play yet\r\n        gatherAudioElements();\r\n        setState('currentIndex', 0);\r\n\r\n        playAudioSequentially();\r\n    }\r\n};\r\n\r\n/**\r\n * Loads and updates the toggle button states for all main features.\r\n */\r\nexport const loadToggleButtonState = () => {\r\n    const easyReadItem = document.getElementById(\"toggle-easy-read\");\r\n    const readAloudItem = document.getElementById(\"toggle-read-aloud\");\r\n    //const syllablesItem = document.getElementById(\"toggle-syllables\");\r\n    const eli5Item = document.getElementById(\"toggle-eli5\");\r\n    const ttsOptionsContainer = document.getElementById(\"tts-options-container\");\r\n    //const glossaryItem = document.getElementById(\"glossary-toggle\");\r\n\r\n    if (!readAloudItem || !eli5Item || !ttsOptionsContainer || !easyReadItem) {\r\n        setTimeout(loadToggleButtonState, 100);\r\n        return;\r\n    }\r\n\r\n    // Set visibility for each feature container based on state\r\n    // setAutoplayContainerVisibility(state.autoplayMode);\r\n    // setDescribeImagesContainerVisibility(state.describeImagesMode);\r\n    updateTtsOptionsContainerVisibility(state.readAloudMode);\r\n    // setEli5ContainerVisibility(state.eli5Mode);\r\n\r\n    // Optionally, update button states/colors as before\r\n    toggleButtonState(\"toggle-read-aloud\", state.readAloudMode);\r\n    toggleButtonColor(\"tts-quick-toggle-button\", state.readAloudMode);\r\n    toggleButtonState(\"toggle-eli5\", state.eli5Mode);\r\n    toggleButtonState(\"toggle-easy-read\", state.easyReadMode);\r\n    handleEli5State();\r\n};\r\n\r\n/**\r\n * Initializes click listeners for all audio elements in state.\r\n */\r\nexport const initializeAudioElements = () => {\r\n    state.audioElements.forEach(({ element }) => {\r\n        // Remove existing handler if it exists\r\n        if (element._audioHandler) {\r\n            element.removeEventListener('click', element._audioHandler);\r\n        }\r\n\r\n        // Create and store new handler\r\n        element._audioHandler = () => handleAudioElementClick(element, state.audioElements);\r\n\r\n        // Add the new listener\r\n        element.addEventListener('click', element._audioHandler);\r\n    });\r\n}\r\n\r\n/**\r\n * Removes all audio click handlers from elements in the audio elements array.\r\n * Use this function before modifying the page content or when disabling read aloud mode\r\n */\r\nexport const deactivateAudioElements = () => {\r\n    // Check if there are any audio elements to process\r\n    if (!state.audioElements || state.audioElements.length === 0) {\r\n        return;\r\n    }\r\n\r\n    // Remove handlers from all elements in the state.audioElements array\r\n    state.audioElements.forEach(({ element }) => {\r\n        if (element && element._audioHandler) {\r\n            // Remove the event listener using the stored handler reference\r\n            element.removeEventListener('click', element._audioHandler);\r\n\r\n            // Clear the stored handler reference to free memory\r\n            element._audioHandler = null;\r\n\r\n            // Remove visual indication that the element is clickable (if any)\r\n            element.classList.remove('audio-clickable');\r\n        }\r\n    });\r\n}\r\n\r\nconst handleAudioElementClick = (element, elements) => {\r\n    // First check the global glossary click flag\r\n    if (window._isGlossaryTermClick === true) {\r\n        return;\r\n    }\r\n\r\n    // Then check element classes/attributes\r\n    const isGlossaryTerm =\r\n        element.classList.contains('glossary-highlighted') ||\r\n        element.classList.contains('glossary-term') ||\r\n        element.hasAttribute('data-glossary-term') ||\r\n        element.closest('.glossary-term-highlight') ||\r\n        element.closest('.glossary-term') ||\r\n        element.closest('[data-glossary-term]');\r\n\r\n    if (isGlossaryTerm) {\r\n        return;\r\n    }\r\n\r\n    if (state.readAloudMode) {\r\n        const isImage = element.tagName.toLowerCase() === \"img\";\r\n\r\n        // Always allow clicks to play audio, even for images when describe images is off\r\n        const index = elements.findIndex(item => item.element === element);\r\n\r\n        // If the element is found in our current sequence, play it\r\n        if (index !== -1) {\r\n            setState('currentIndex', index);\r\n            stopAudio();\r\n            setState('isPlaying', true);\r\n            playCurrentAudio();\r\n        }\r\n        // Special handling for images that might not be in the sequence (when describe images is off)\r\n        else if (isImage) {\r\n            // Get the image's ID and audio source directly\r\n            const id = element.getAttribute('data-id');\r\n            let audioSrc = state.audioFiles[id];\r\n\r\n            const ariaId = element.getAttribute('data-aria-id');\r\n            if (ariaId && state.audioFiles[ariaId]) {\r\n                audioSrc = state.audioFiles[ariaId];\r\n            }\r\n\r\n            if (audioSrc) {\r\n                // Play the audio directly without using the sequence\r\n                stopAudio();\r\n                unhighlightAllElements();\r\n\r\n                const audio = new Audio(audioSrc);\r\n                setState('currentAudio', audio);\r\n                audio.playbackRate = parseFloat(state.audioSpeed);\r\n\r\n                highlightElement(element);\r\n                setState('isPlaying', true);\r\n                updatePlayPauseIcon(true);\r\n\r\n                audio.play().catch(err => {\r\n                    console.error(\"Error playing audio:\", err);\r\n                    unhighlightElement(element);\r\n                    setState('isPlaying', false);\r\n                    updatePlayPauseIcon(false);\r\n                });\r\n\r\n                audio.onended = () => {\r\n                    unhighlightElement(element);\r\n                    setState('currentAudio', null);\r\n                    setState('isPlaying', false);\r\n                    updatePlayPauseIcon(false);\r\n                };\r\n            }\r\n        }\r\n    }\r\n};\r\n\r\n/* const handleReadAloudState = (autoplayContainer, describeImagesContainer, ttsOptionsContainer, eli5Container) => {\r\n    const readAloudModeCookie = getCookie(\"readAloudMode\");\r\n    if (readAloudModeCookie) {\r\n        setState('readAloudMode', readAloudModeCookie === \"true\");\r\n        if (state.readAloudMode) {\r\n            initializeAudioElements();\r\n        }\r\n        toggleButtonState(\"toggle-read-aloud\", state.readAloudMode);\r\n        toggleButtonColor(\"tts-quick-toggle-button\", state.readAloudMode);\r\n        updateContainersVisibility(\r\n            state.readAloudMode,\r\n            autoplayContainer,\r\n            describeImagesContainer,\r\n            ttsOptionsContainer,\r\n            eli5Container\r\n        );\r\n    }\r\n};\r\n\r\nconst updateContainersVisibility = (\r\n    isReadAloudMode,\r\n    autoplayContainer,\r\n    describeImagesContainer,\r\n    ttsOptionsContainer,\r\n    eli5Container\r\n) => {\r\n    if (isReadAloudMode) {\r\n        showReadAloudContainers(ttsOptionsContainer, autoplayContainer, describeImagesContainer, eli5Container);\r\n    } else {\r\n        hideReadAloudContainers(ttsOptionsContainer, autoplayContainer, describeImagesContainer, eli5Container);\r\n    }\r\n}; */\r\n\r\nexport const showReadAloudContainers = () => {\r\n    const ttsOptionsContainer = document.getElementById('tts-options-container');\r\n    //const autoplayContainer = document.getElementById('autoplay-container');\r\n    const describeImagesContainer = document.getElementById('describe-images-container');\r\n    const eli5Container = document.querySelector('#eli5-label')?.closest('.flex');\r\n\r\n    // Show options and ensure proper spacing\r\n    ttsOptionsContainer?.classList.remove('hidden');\r\n    //autoplayContainer?.classList.remove('hidden');\r\n    describeImagesContainer?.classList.remove('hidden');\r\n\r\n    ttsOptionsContainer?.classList.add('mt-4', 'mb-2', 'px-4');\r\n    eli5Container?.classList.add('mt-4');\r\n};\r\n\r\n/**\r\n * Updates the play/pause icon in the UI based on playback state.\r\n * @param {boolean} isPlaying - Whether audio is currently playing.\r\n */\r\nexport const updatePlayPauseIcon = (isPlaying) => {\r\n    const playIcon = document.getElementById(\"read-aloud-play-icon\");\r\n    const pauseIcon = document.getElementById(\"read-aloud-pause-icon\");\r\n    if (isPlaying) {\r\n        playIcon.style.display = \"none\";\r\n        playIcon.setAttribute(\"aria-hidden\", \"true\");\r\n        pauseIcon.style.display = \"\";\r\n        pauseIcon.setAttribute(\"aria-hidden\", \"false\");\r\n    } else {\r\n        playIcon.style.display = \"\";\r\n        playIcon.setAttribute(\"aria-hidden\", \"false\");\r\n        pauseIcon.style.display = \"none\";\r\n        pauseIcon.setAttribute(\"aria-hidden\", \"true\");\r\n    }\r\n};\r\n\r\n/**\r\n * Hides the read aloud containers (TTS options, autoplay, describe images, ELI5) and updates ARIA attributes.\r\n * @param {HTMLElement} ttsOptionsContainer - The TTS options container element.\r\n * @param {HTMLElement} autoplayContainer - The autoplay container element.\r\n * @param {HTMLElement} describeImagesContainer - The describe images container element.\r\n * @param {HTMLElement} eli5Container - The ELI5 container element.\r\n * @private\r\n */\r\nconst hideReadAloudContainers = (ttsOptionsContainer, autoplayContainer, describeImagesContainer, eli5Container) => {\r\n    ttsOptionsContainer.classList.add(\"hidden\");\r\n    ttsOptionsContainer.setAttribute(\"aria-expanded\", \"false\");\r\n    autoplayContainer.classList.add(\"hidden\");\r\n    describeImagesContainer.classList.add(\"hidden\");\r\n    eli5Container.classList.add(\"border-t\", \"border-gray-300\");\r\n};\r\n\r\n/**\r\n * Handles the ELI5 state, toggling the explain button visibility and updating the toggle state.\r\n * Checks feature availability and cookie, updates state and UI accordingly.\r\n * @private\r\n */\r\nconst handleEli5State = () => {\r\n    const explainButton = document.getElementById('explain-me-button');\r\n    const eli5ModeCookie = getCookie(\"eli5Mode\");\r\n    if (isFeatureEnabled(\"eli5\") && eli5ModeCookie) {\r\n        setState('eli5Mode', eli5ModeCookie === \"true\");\r\n        toggleButtonState(\"toggle-eli5\", state.eli5Mode);\r\n\r\n        if (state.eli5Mode && state.translations) {\r\n            displayEli5Content();\r\n            explainButton?.classList.remove('hidden');\r\n        } else {\r\n            // Hide the button if ELI5 mode is off\r\n            explainButton?.classList.add('hidden');\r\n        }\r\n    } else {\r\n        // If no cookie is set, ELI5 is off by default\r\n        explainButton?.classList.add('hidden');\r\n    }\r\n};\r\n\r\n/**\r\n * Displays ELI5 content in the UI if available for the current section.\r\n * Applies custom list styling for ELI5 content.\r\n * @private\r\n */\r\nconst displayEli5Content = () => {\r\n    const eli5Id = document.querySelector('section[data-eli5-id]')?.getAttribute(\"data-eli5-id\");\r\n    if (!eli5Id) {\r\n        return;\r\n    }\r\n\r\n    const eli5Text = state.translations[eli5Id];\r\n\r\n    if (eli5Text) {\r\n        const eli5Container = document.getElementById(\"eli5-content-text\");\r\n        if (eli5Container) {\r\n            eli5Container.innerHTML = eli5Text;\r\n            eli5Container.classList.remove(\"hidden\");\r\n\r\n            // Apply dash styling to lists if they exist\r\n            if (!document.getElementById('eli5-list-style')) {\r\n                const style = document.createElement('style');\r\n                style.id = 'eli5-list-style';\r\n                style.textContent = `\r\n                    #eli5-content-text ul {\r\n                        list-style-type: none;\r\n                        padding-left: 2.5em;\r\n                        margin-top:0.8em;\r\n                    }\r\n                    #eli5-content-text ul li {\r\n                        position: relative;\r\n                        margin-bottom: 0.5em;\r\n                    }\r\n                    #eli5-content-text ul li::before {\r\n                        content: \"\u2014\";\r\n                        position: absolute;\r\n                        left: -1.5em;\r\n                        color: #666;\r\n                    }\r\n                `;\r\n                document.head.appendChild(style);\r\n            }\r\n            eli5Container.classList.remove(\"hidden\");\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Toggles ELI5 mode, updates state, cookies, and UI.\r\n */\r\nexport const toggleEli5Mode = () => {\r\n    setState('eli5Mode', !state.eli5Mode);\r\n    setCookie(\"eli5Mode\", state.eli5Mode, 7);\r\n    toggleButtonState(\"toggle-eli5\", state.eli5Mode);\r\n\r\n    // Track the toggle event\r\n    trackToggleEvent('Eli5Mode', state.eli5Mode);\r\n\r\n    if (state.isPlaying) stopAudio();\r\n    unhighlightAllElements();\r\n\r\n    handleEli5ModeToggle();\r\n};\r\n\r\n/**\r\n * Initializes ELI5 UI elements and ensures accessibility.\r\n */\r\nexport const initializeEli5 = () => {\r\n    // Show the explain-me-button if it exists and is hidden\r\n    const explainButton = document.getElementById(\"explain-me-button\");\r\n    if (explainButton && explainButton.classList.contains(\"hidden\")) {\r\n        explainButton.classList.remove(\"hidden\");\r\n        explainButton.setAttribute('aria-hidden', 'false');\r\n        explainButton.setAttribute('tabindex', '0');\r\n    }\r\n\r\n    // Show the toggle-eli5 button if it exists and is hidden\r\n    const toggleEli5Button = document.getElementById(\"toggle-eli5\");\r\n    if (toggleEli5Button && toggleEli5Button.classList.contains(\"hidden\")) {\r\n        toggleEli5Button.classList.remove(\"hidden\");\r\n        toggleEli5Button.setAttribute('aria-hidden', 'false');\r\n        toggleEli5Button.setAttribute('tabindex', '0');\r\n    }\r\n\r\n    // Show the container of toggle-eli5 if it exists and is hidden\r\n    const eli5Container = document.getElementById(\"eli5-container\");\r\n    if (eli5Container && eli5Container.classList.contains(\"hidden\")) {\r\n        eli5Container.classList.remove(\"hidden\");\r\n        eli5Container.setAttribute('aria-hidden', 'false');\r\n    }\r\n}\r\n\r\n/**\r\n * Handles the ELI5 popup, including open/close and audio playback.\r\n */\r\nexport const handleEli5Popup = () => {\r\n    const explainButton = document.getElementById('explain-me-button');\r\n    const eli5Content = document.getElementById('eli5-content');\r\n    const closeButton = document.getElementById('close-eli5-content');\r\n    const mainSection = document.querySelector('section[data-eli5-id]');\r\n\r\n    // Check if elements exist before proceeding\r\n    if (!explainButton || !eli5Content || !closeButton || !mainSection) {\r\n        return;\r\n    }\r\n\r\n    const eli5Id = mainSection.getAttribute(\"data-eli5-id\");\r\n\r\n    // Toggle the visibility when the button is clicked\r\n    explainButton.addEventListener('click', function () {\r\n        const isVisible = !eli5Content.classList.contains('hidden');\r\n\r\n        if (isVisible) {\r\n            eli5Content.classList.add('hidden');\r\n            explainButton.setAttribute('aria-expanded', 'false');\r\n            removeEli5AudioFromQueue();\r\n        } else {\r\n            eli5Content.classList.remove('hidden');\r\n            explainButton.setAttribute('aria-expanded', 'true');\r\n            handleEli5Audio(eli5Id);\r\n        }\r\n    });\r\n\r\n    // Hide the popup when the close button is clicked\r\n    closeButton.addEventListener('click', function () {\r\n        eli5Content.classList.add('hidden');\r\n        explainButton.setAttribute('aria-expanded', 'false');\r\n        removeEli5AudioFromQueue();\r\n    });\r\n\r\n    // Close popup if user clicks outside of it\r\n    document.addEventListener('click', function (event) {\r\n        if (!eli5Content.contains(event.target) &&\r\n            !explainButton.contains(event.target) &&\r\n            !eli5Content.classList.contains('hidden')) {\r\n            eli5Content.classList.add('hidden');\r\n            explainButton.setAttribute('aria-expanded', 'false');\r\n            removeEli5AudioFromQueue();\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Handles toggling of ELI5 mode, updating content and explain button visibility.\r\n * Clears content and hides the button if ELI5 mode is off.\r\n * @private\r\n */\r\nconst handleEli5ModeToggle = () => {\r\n    const explainButton = document.getElementById('explain-me-button');\r\n    if (state.eli5Mode) {\r\n        const mainSection = document.querySelector('section[data-eli5-id]');\r\n        if (!mainSection) {\r\n            if (explainButton) {\r\n                explainButton.classList.add('hidden');\r\n            }\r\n            return;\r\n        }\r\n\r\n        const eli5Id = mainSection.getAttribute(\"data-eli5-id\");\r\n        const eli5Text = state.translations[eli5Id];\r\n\r\n        if (eli5Text) {\r\n            updateEli5Content(eli5Id, eli5Text);\r\n        }\r\n\r\n        if (explainButton) {\r\n            explainButton.classList.remove('hidden');\r\n        }\r\n    } else {\r\n\r\n        clearEli5Content();\r\n        //Hide the eli5 toggle button\r\n\r\n        if (explainButton) {\r\n            explainButton.classList.add('hidden');\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the ELI5 content area with the provided text and ID.\r\n * @param {string} eli5Id - The ELI5 section ID.\r\n * @param {string} eli5Text - The ELI5 content to display.\r\n * @private\r\n */\r\nconst updateEli5Content = (eli5Id, eli5Text) => {\r\n    const eli5Container = document.getElementById(\"eli5-content-text\");\r\n    eli5Container.innerHTML = `<span data-id=\"${eli5Id}\">${eli5Text}</span>`;\r\n    eli5Container.classList.remove(\"hidden\");\r\n};\r\n\r\n/**\r\n * Handles ELI5 audio playback when ELI5 content is shown.\r\n * @param {string} eli5Id - The ELI5 section ID.\r\n * @private\r\n */\r\nconst handleEli5Audio = (eli5Id) => {\r\n    if (state.readAloudMode) {\r\n        stopAudio();\r\n        const eli5Container = document.getElementById(\"eli5-content-text\");\r\n        highlightElement(eli5Container);\r\n        // Get the current language from state or a global config\r\n        const currentLanguage = state.currentLanguage || (window.appConfig && window.appConfig.languages && window.appConfig.languages.default) || 'es';\r\n        const audioBasePath = `content/i18n/${currentLanguage}/audio/`;\r\n        const eli5AudioSrc = audioBasePath + state.audioFiles[eli5Id];\r\n\r\n        if (eli5AudioSrc) {\r\n            addEli5AudioToQueue(eli5AudioSrc, eli5Container);\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Adds ELI5 audio to the audio queue and starts playback.\r\n * @param {string} audioSrc - The audio source URL.\r\n * @param {HTMLElement} container - The container element for ELI5 content.\r\n * @private\r\n */\r\nconst addEli5AudioToQueue = (audioSrc, container) => {\r\n    // Check if the element is already in the audio queue\r\n    const existingIndex = state.audioElements.findIndex(\r\n        (item) => item.element === container && item.audioSrc === audioSrc\r\n    );\r\n\r\n    if (existingIndex !== -1) {\r\n        // Element is already in the queue, set the current index to the existing element\r\n        setState('currentIndex', existingIndex);\r\n    } else {\r\n        // Add the ELI5 audio to the audio queue\r\n        state.audioElements.push({\r\n            element: container,\r\n            id: 'eli5-audio',\r\n            audioSrc: audioSrc\r\n        });\r\n\r\n        // Update the current index to the new ELI5 audio\r\n        setState('currentIndex', state.audioElements.length - 1);\r\n    }\r\n\r\n    // Play the ELI5 audio\r\n    setState('isPlaying', true);\r\n    playCurrentAudio();\r\n};\r\n\r\n/**\r\n * Removes ELI5 audio from the audio queue and stops playback.\r\n * @private\r\n */\r\nconst removeEli5AudioFromQueue = () => {\r\n    // Stop the audio and unhighlight all elements\r\n    stopAudio();\r\n    unhighlightAllElements();\r\n\r\n    // Find the index of the ELI5 audio in the audio elements queue\r\n    const eli5Index = state.audioElements.findIndex(item => item.id === 'eli5-audio');\r\n\r\n    // If the ELI5 audio is found, remove it from the queue\r\n    if (eli5Index !== -1) {\r\n        state.audioElements.splice(eli5Index, 1);\r\n\r\n        // Adjust the current index if necessary\r\n        if (state.currentIndex >= eli5Index) {\r\n            setState('currentIndex', Math.max(0, state.currentIndex - 1));\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Plays ELI5 audio directly and updates playback state.\r\n * @param {string} audioSrc - The audio source URL.\r\n * @param {HTMLElement} container - The container element for ELI5 content.\r\n * @private\r\n */\r\nconst playEli5Audio = (audioSrc, container) => {\r\n    stopAudio();\r\n    setState('eli5Active', true);\r\n    const audio = new Audio(audioSrc);\r\n    setState('eli5Audio', audio);\r\n    audio.playbackRate = parseFloat(state.audioSpeed);\r\n    audio.play();\r\n\r\n    audio.onended = () => {\r\n        unhighlightElement(container);\r\n        setState('eli5Active', false);\r\n        setState('isPlaying', false);\r\n        setPlayPauseIcon();\r\n    };\r\n\r\n    setState('isPlaying', true);\r\n    setPlayPauseIcon();\r\n};\r\n\r\n/**\r\n * Clears the ELI5 content area and hides it.\r\n * @private\r\n */\r\nconst clearEli5Content = () => {\r\n    const eli5Container = document.getElementById(\"eli5-content-text\");\r\n    eli5Container.textContent = \"\";\r\n    eli5Container.classList.add(\"hidden\");\r\n};\r\n\r\nexport const announceToScreenReader = (message, assertive = false) => {\r\n    let announcement = document.getElementById('sr-announcement');\r\n    if (!announcement) {\r\n        const div = document.createElement('div');\r\n        div.id = 'sr-announcement';\r\n        div.setAttribute('role', 'status');\r\n        div.setAttribute('aria-live', 'polite');\r\n        div.classList.add('sr-only'); // Make it invisible but available to screen readers\r\n        document.body.appendChild(div);\r\n        announcement = div;\r\n    }\r\n\r\n    // Clear existing content first\r\n    announcement.textContent = '';\r\n\r\n    // Set the politeness based on the assertive parameter\r\n    announcement.setAttribute('aria-live', assertive ? 'assertive' : 'polite');\r\n\r\n    // Add lang attribute to ensure Spanish pronunciation\r\n    announcement.setAttribute('lang', 'es');\r\n\r\n    // Set the message after a small delay to ensure screen readers detect the change\r\n    setTimeout(() => {\r\n        announcement.textContent = message;\r\n    }, 50);\r\n}\r\n\r\n/**\r\n * Populates glossary terms in the sidebar and page glossary lists.\r\n */\r\nexport const populateGlossaryTerms = () => {\r\n    loadGlossaryTerms().then(() => {\r\n        const glossaryList = document.getElementById('glossary-terms-book');\r\n        const glossaryPageList = document.getElementById('glossary-terms-page');\r\n        const glossaryTerms = state.glossaryTerms;\r\n        state.pageTerms = extractPageTerms(); // Extract terms from the current page\r\n        const pageTerms = state.pageTerms;\r\n\r\n        // Empty glossary lists if they already have content\r\n        if (glossaryList) glossaryList.innerHTML = '';\r\n        if (glossaryPageList) glossaryPageList.innerHTML = '';\r\n\r\n        // Use a Set to track added terms and avoid duplicates\r\n        const addedTerms = new Set();\r\n\r\n        // Populate the main glossary book list with alphabetical grouping\r\n        if (glossaryList && glossaryTerms) {\r\n            // Step 1: Collect and organize terms by first letter (normalized to group accented letters)\r\n            const termsByLetter = {};\r\n\r\n            Object.entries(glossaryTerms).forEach(([key, data]) => {\r\n                if (!addedTerms.has(key.toLowerCase())) {\r\n                    // Get first letter, normalize it to remove diacritics, and ensure it's uppercase\r\n                    const firstLetterWithAccent = key.charAt(0).toUpperCase();\r\n                    const firstLetterNormalized = firstLetterWithAccent\r\n                        .normalize('NFD')\r\n                        .replace(/[\\u0300-\\u036f]/g, '')\r\n                        .toUpperCase();\r\n\r\n                    // Use the normalized letter as the key for grouping\r\n                    if (!termsByLetter[firstLetterNormalized]) {\r\n                        termsByLetter[firstLetterNormalized] = [];\r\n                    }\r\n\r\n                    // Add the term data to the appropriate letter group\r\n                    termsByLetter[firstLetterNormalized].push({\r\n                        term: key,\r\n                        displayTerm: key.charAt(0).toUpperCase() + key.slice(1),\r\n                        emoji: data.emoji,\r\n                        definition: data.definition,\r\n                        originalFirstLetter: firstLetterWithAccent // Store for potential display\r\n                    });\r\n\r\n                    addedTerms.add(key.toLowerCase());\r\n                }\r\n            });\r\n\r\n            // Step 2: Sort the letters alphabetically (normalized)\r\n            const sortedLetters = Object.keys(termsByLetter).sort();\r\n\r\n            // Step 3: Create letter groups and append terms\r\n            sortedLetters.forEach(letter => {\r\n                // Determine the display letter (we could use the first term's original letter)\r\n                const letterGroup = termsByLetter[letter];\r\n\r\n                // Find if there's any accented version of this letter in the group\r\n                // Otherwise, use the normalized letter itself\r\n                const displayLetter = letter;\r\n\r\n                // Create a letter heading\r\n                const letterHeading = document.createElement('div');\r\n                letterHeading.classList.add('glossary-letter-grouping', 'text-2xl', 'font-bold', 'mt-6', 'mb-3', 'text-blue-700', 'pb-4');\r\n                letterHeading.textContent = displayLetter;\r\n                glossaryList.appendChild(letterHeading);\r\n\r\n                // Sort terms within this letter group alphabetically\r\n                // We use localeCompare with sensitivity: 'base' to treat accented letters the same\r\n                letterGroup.sort((a, b) =>\r\n                    a.term.localeCompare(b.term, undefined, { sensitivity: 'base' })\r\n                );\r\n\r\n                // Create and append each term in this letter group\r\n                letterGroup.forEach(item => {\r\n                    createGlossaryItem(glossaryList, item.displayTerm, item.emoji, item.definition, item.term);\r\n                });\r\n            });\r\n        }\r\n\r\n        // Populate the page-specific glossary terms\r\n        if (glossaryPageList && pageTerms && pageTerms.length > 0) {\r\n            pageTerms.forEach(term => {\r\n                let termData = null;\r\n                let matchedMainTerm = null;\r\n\r\n                // Find the term data and the corresponding main term\r\n                Object.entries(glossaryTerms).forEach(([key, data]) => {\r\n                    const { variations } = data;\r\n                    const variation = variations.find(v => v.toLowerCase() === term.toLowerCase());\r\n                    if (variation) {\r\n                        termData = data;\r\n                        matchedMainTerm = key; // Store the main term, not the variation\r\n                    } else if (key.toLowerCase() === term.toLowerCase()) {\r\n                        termData = data;\r\n                        matchedMainTerm = key;\r\n                    }\r\n                });\r\n\r\n                if (termData && matchedMainTerm) {\r\n                    const { emoji, definition } = termData;\r\n\r\n                    // Create a container for each glossary item\r\n                    const glossaryItem = document.createElement('div');\r\n                    glossaryItem.classList.add('mb-4',\r\n                        'border-b',\r\n                        'border-gray-300',\r\n                        'pb-4',\r\n                        'glossary-page-item',\r\n                        'cursor-pointer',\r\n                        'focus:outline-none',\r\n                        'focus:ring-2',\r\n                        'focus:ring-blue-700',\r\n                        'focus:ring-opacity-50'\r\n                    );\r\n\r\n                    // Make the container focusable with proper keyboard support - added these lines\r\n                    glossaryItem.setAttribute('tabindex', '0');\r\n                    glossaryItem.setAttribute('role', 'button');\r\n                    glossaryItem.setAttribute('aria-label', `${term}${emoji ? ' ' + emoji : ''}`);\r\n\r\n                    // Use the exact matched text from the page for display\r\n                    const termTitleText = term.charAt(0).toUpperCase() + term.slice(1);\r\n\r\n                    // Create the term element as a title\r\n                    const termTitle = document.createElement('div');\r\n                    termTitle.classList.add('font-bold', 'text-lg', 'glossary-page-term');\r\n                    termTitle.textContent = emoji ? (termTitleText + \" \" + emoji) : termTitleText;\r\n                    glossaryItem.appendChild(termTitle);\r\n\r\n                    // Create the definition element\r\n                    const definitionElement = document.createElement('div');\r\n                    definitionElement.classList.add('mt-2', 'text-gray-700', 'mb-2');\r\n                    definitionElement.textContent = definition;\r\n                    glossaryItem.appendChild(definitionElement);\r\n\r\n                    // Add keyboard support - added these event listeners\r\n                    glossaryItem.addEventListener('keydown', (event) => {\r\n                        if (event.key === 'Enter' || event.key === ' ') {\r\n                            event.preventDefault(); // Prevent scrolling on space key\r\n                            // Optionally add any action you want when this item is activated\r\n                        }\r\n                    });\r\n\r\n                    // Add focus and hover visual indicators - added these event listeners\r\n                    glossaryItem.addEventListener('focus', () => {\r\n                        glossaryItem.classList.add('bg-gray-100');\r\n                    });\r\n\r\n                    glossaryItem.addEventListener('blur', () => {\r\n                        glossaryItem.classList.remove('bg-gray-100');\r\n                    });\r\n\r\n                    // Append the glossary item to the list\r\n                    glossaryPageList.appendChild(glossaryItem);\r\n                }\r\n            });\r\n        } else if (glossaryPageList) {\r\n            glossaryPageList.innerHTML = '<span data-id=\"glossary-no-terms\">' + translateText('glossary-no-terms') + '</span>';\r\n        }\r\n\r\n        // If glossary mode is on, reload glossary terms\r\n        if (state.glossaryMode) {\r\n            highlightGlossaryTerms();\r\n        } else {\r\n            removeGlossaryHighlights();\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Creates a glossary item element and appends it to the glossary list.\r\n * Adds keyboard and click support for accessibility.\r\n * @param {HTMLElement} glossaryList - The glossary list container.\r\n * @param {string} term - The glossary term.\r\n * @param {string} emoji - The emoji associated with the term.\r\n * @param {string} definition - The definition of the term.\r\n * @param {string} variation - The main term or variation key.\r\n * @private\r\n */\r\nconst createGlossaryItem = (glossaryList, term, emoji, definition, variation) => {\r\n    // Create a container for each glossary item\r\n    const glossaryItem = document.createElement('div');\r\n    glossaryItem.classList.add(\r\n        'mb-4',\r\n        'border-b',\r\n        'border-gray-300',\r\n        'pb-4',\r\n        'glossary-item',\r\n        'cursor-pointer',\r\n        'focus:outline-none',\r\n        'focus:ring-2',\r\n        'focus:ring-blue-500',\r\n        'focus:ring-opacity-50'\r\n    );\r\n\r\n    // Make the container focusable with proper keyboard support\r\n    glossaryItem.setAttribute('tabindex', '0');\r\n    glossaryItem.setAttribute('role', 'button');\r\n    glossaryItem.setAttribute('aria-label', `${term}${emoji ? ' ' + emoji : ''}`);\r\n\r\n    // Create the term element (no longer using <a> to avoid navigation confusion)\r\n    const termElement = document.createElement('div');\r\n    termElement.classList.add('font-bold', 'text-lg', 'glossary-term');\r\n    termElement.textContent = term;\r\n\r\n    // Add emoji if present\r\n    if (emoji) {\r\n        const emojiSpan = document.createElement('span');\r\n        emojiSpan.classList.add('ml-1');\r\n        emojiSpan.textContent = emoji;\r\n        termElement.appendChild(emojiSpan);\r\n    }\r\n\r\n    // Store the variations and other properties as before\r\n    const termData = state.glossaryTerms[variation];\r\n    if (termData && termData.variations && Array.isArray(termData.variations)) {\r\n        const allSearchTerms = [variation.toLowerCase(), ...termData.variations.map(v => v.toLowerCase())];\r\n        glossaryItem.dataset.searchTerms = allSearchTerms.join('|');\r\n    } else {\r\n        glossaryItem.dataset.searchTerms = variation.toLowerCase();\r\n    }\r\n\r\n    glossaryItem.appendChild(termElement);\r\n    glossaryList.appendChild(glossaryItem);\r\n\r\n    // Add keyboard support - handle both click and keyboard events\r\n    const showDetails = (event) => {\r\n        // Only trigger on Enter or Space for keyboard events\r\n        if (event.type === 'keydown' && event.key !== 'Enter' && event.key !== ' ') {\r\n            return;\r\n        }\r\n\r\n        if (event.type === 'keydown' && event.key === ' ') {\r\n            event.preventDefault(); // Prevent page scroll on Space key\r\n        }\r\n\r\n        const glossaryContent = document.getElementById('glossary-content');\r\n        const glossaryTermDetails = document.getElementById('glossary-term-details');\r\n        const glossaryTermContent = document.getElementById('glossary-term-content');\r\n\r\n        // Remember the originating item for later focus return\r\n        glossaryTermDetails.dataset.sourceItemId = glossaryItem.id;\r\n\r\n        // Ensure the glossary item has a unique ID for focus return\r\n        if (!glossaryItem.id) {\r\n            glossaryItem.id = `glossary-item-${variation.replace(/\\s+/g, '-').toLowerCase()}`;\r\n        }\r\n\r\n        // Get the term data and format content as before\r\n        const originalTerm = variation;\r\n        const termData = state.glossaryTerms[originalTerm];\r\n        let variationsHtml = '';\r\n\r\n        if (termData && termData.variations && termData.variations.length > 0) {\r\n            const joinedVariations = termData.variations.join(', ');\r\n            const formattedVariations = joinedVariations.charAt(0).toUpperCase() + joinedVariations.slice(1);\r\n            variationsHtml = `\r\n                <div class=\"text-sm text-gray-500 mt-1 mb-3\">\r\n                    ${formattedVariations}\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        // Populate the term details content\r\n        glossaryTermContent.innerHTML = `\r\n            <div class=\"flex justify-center items-center mt-8 mb-2 border-b border-gray-300 pb-8\">\r\n                <h3 class=\"text-2xl font-bold\">\r\n                    ${term} ${emoji || ''}\r\n                </h3>\r\n            </div>\r\n            ${variationsHtml}\r\n            <div class=\"mt-4 text-lg\">\r\n                ${definition}\r\n            </div>\r\n        `;\r\n\r\n        // Hide glossary content and show term details\r\n        glossaryContent.classList.add('hidden');\r\n        glossaryTermDetails.classList.remove('hidden');\r\n\r\n        // Set focus to the close button for keyboard navigation\r\n        const closeButton = document.getElementById('close-glossary-term-details');\r\n        if (closeButton) {\r\n            setTimeout(() => closeButton.focus(), 10);\r\n        }\r\n\r\n        // Announce to screen readers\r\n        announceToScreenReader(`Showing details for ${term}`);\r\n    };\r\n\r\n    // Add both click and keyboard event listeners\r\n    glossaryItem.addEventListener('click', showDetails);\r\n    glossaryItem.addEventListener('keydown', showDetails);\r\n\r\n    // Add focus indicators\r\n    glossaryItem.addEventListener('focus', () => {\r\n        glossaryItem.classList.add('bg-gray-100');\r\n    });\r\n\r\n    glossaryItem.addEventListener('blur', () => {\r\n        glossaryItem.classList.remove('bg-gray-100');\r\n    });\r\n};\r\n\r\nexport const initializeGlossary = () => {\r\n    const glossaryButton = document.getElementById('glossary-button');\r\n    const glossaryButtonContainer = glossaryButton?.closest('.flex.justify-between.items-left.border-t.border-gray-300');\r\n    const glossaryContent = document.getElementById('glossary-content');\r\n    const backToSidebarButton = document.getElementById('back-to-sidebar');\r\n    const sidebarContent = document.getElementById('sidebar-content');\r\n    const pageTab = document.getElementById('page-tab');\r\n    const bookTab = document.getElementById('book-tab');\r\n    const pageContent = document.getElementById('page-content');\r\n    const bookContent = document.getElementById('book-content');\r\n    const filterInput = document.getElementById('filter-input');\r\n    const glossaryTermsBook = document.getElementById('glossary-terms-book');\r\n    const glossaryTermDetails = document.getElementById('glossary-term-details');\r\n    const closeGlossaryTermDetailsButton = document.getElementById('close-glossary-term-details');\r\n\r\n    // Show the glossary button container if the button exists\r\n    if (glossaryButton && glossaryButtonContainer) {\r\n        glossaryButtonContainer.classList.remove('hidden');\r\n    }\r\n\r\n    populateGlossaryTerms();\r\n\r\n    if (glossaryButton && glossaryContent && backToSidebarButton && sidebarContent) {\r\n        // Check for saved glossary state first\r\n        const savedGlossaryOpen = getCookie(\"glossaryListOpen\");\r\n        if (savedGlossaryOpen === \"true\") {\r\n            // Show glossary content, hide sidebar content\r\n            sidebarContent.classList.add('hidden');\r\n            glossaryContent.classList.remove('hidden');\r\n        }\r\n\r\n        // Update click handlers to save state\r\n        glossaryButton.addEventListener('click', () => {\r\n            sidebarContent.classList.add('hidden');\r\n            glossaryContent.classList.remove('hidden');\r\n            // Make sure term details is hidden when opening glossary\r\n            glossaryTermDetails.classList.add('hidden');\r\n            // Save state when opening glossary\r\n            setCookie(\"glossaryListOpen\", \"true\", 7);\r\n            trackEvent('Glossary', 'Open', 'Glossary button clicked');\r\n        });\r\n\r\n        backToSidebarButton.addEventListener('click', () => {\r\n            glossaryContent.classList.add('hidden');\r\n            sidebarContent.classList.remove('hidden');\r\n            // Make sure term details is hidden when closing glossary\r\n            glossaryTermDetails.classList.add('hidden');\r\n            // Save state when closing glossary\r\n            setCookie(\"glossaryListOpen\", \"false\", 7);\r\n            trackEvent('Glossary', 'Close', 'Glossary back button clicked');\r\n        });\r\n\r\n        // Update the close glossary term details button handler\r\n        if (closeGlossaryTermDetailsButton) {\r\n            closeGlossaryTermDetailsButton.addEventListener('click', () => {\r\n                // Hide term details and show main glossary content\r\n                glossaryTermDetails.classList.add('hidden');\r\n                glossaryContent.classList.remove('hidden');\r\n            });\r\n        }\r\n    }\r\n\r\n    if (pageTab && bookTab && pageContent && bookContent) {\r\n        // Function to set active tab\r\n        const setActiveTab = (tabIndex) => {\r\n            if (tabIndex === 0) {\r\n                // On this page tab\r\n                pageTab.setAttribute('aria-selected', 'true');\r\n                bookTab.setAttribute('aria-selected', 'false');\r\n                pageContent.classList.remove('hidden');\r\n                bookContent.classList.add('hidden');\r\n                pageTab.classList.add(\"text-blue-700\", \"border-b-4\", \"border-blue-700\", \"-mb-1\");\r\n                bookTab.classList.remove(\"border-b-4\", \"border-blue-700\", \"text-blue-700\", \"-mb-1\");\r\n            } else {\r\n                // On this chapter tab\r\n                pageTab.setAttribute('aria-selected', 'false');\r\n                bookTab.setAttribute('aria-selected', 'true');\r\n                pageContent.classList.add('hidden');\r\n                bookContent.classList.remove('hidden');\r\n                pageTab.classList.remove('text-blue-700');\r\n                bookTab.classList.add(\"text-blue-700\", \"border-b-4\", \"-mb-1\", \"border-blue-700\");\r\n                pageTab.classList.remove(\"border-b-4\", \"border-blue-700\", \"text-blue-700\", \"-mb-1\");\r\n            }\r\n\r\n            // Save the tab state to a cookie\r\n            setCookie(\"activeGlossaryTabIndex\", tabIndex, 7); // Save for 7 days\r\n        };\r\n\r\n        // Check if we have a saved tab preference\r\n        const savedTabIndex = getCookie(\"activeGlossaryTabIndex\");\r\n\r\n        // Apply the saved tab or default to the first tab\r\n        if (savedTabIndex !== null && savedTabIndex !== undefined && savedTabIndex !== \"\") {\r\n            // Apply the saved tab\r\n            setActiveTab(parseInt(savedTabIndex));\r\n        } else {\r\n            // Default to first tab (index 0)\r\n            setActiveTab(0);\r\n        }\r\n\r\n        // Event listeners for tab switching\r\n        pageTab.addEventListener('click', () => {\r\n            setActiveTab(0);\r\n        });\r\n\r\n        bookTab.addEventListener('click', () => {\r\n            setActiveTab(1);\r\n        });\r\n    }\r\n\r\n    if (filterInput && glossaryTermsBook) {\r\n        filterInput.addEventListener('input', () => {\r\n            // Normalize the filter value: lowercase and remove diacritics\r\n            const filterValue = filterInput.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n            // Get all terms and letter headings\r\n            const terms = glossaryTermsBook.querySelectorAll('.glossary-item');\r\n            const letterHeadings = glossaryTermsBook.querySelectorAll('.glossary-letter-grouping');\r\n\r\n            let hasResults = false;\r\n\r\n            // Create a map to track which letter headings have visible terms\r\n            const letterHeadingsVisibility = new Map();\r\n\r\n            // Initialize all letter headings as not having visible terms\r\n            letterHeadings.forEach(heading => {\r\n                letterHeadingsVisibility.set(heading, false);\r\n            });\r\n\r\n            // First pass: Filter the terms and mark which letter headings have visible terms\r\n            terms.forEach(term => {\r\n                // Get both visible text and stored search terms (which include variations)\r\n                const termText = term.textContent.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                const searchTerms = (term.dataset.searchTerms || '').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n                // Check if this term matches the filter\r\n                const isVisible = termText.includes(filterValue) || searchTerms.includes(filterValue);\r\n\r\n                if (isVisible) {\r\n                    term.classList.remove('hidden');\r\n                    hasResults = true;\r\n\r\n                    // Find the previous letter heading for this term\r\n                    let currentElement = term;\r\n                    while (currentElement.previousElementSibling) {\r\n                        currentElement = currentElement.previousElementSibling;\r\n                        if (currentElement.classList.contains('glossary-letter-grouping')) {\r\n                            // Mark this heading as having a visible term\r\n                            letterHeadingsVisibility.set(currentElement, true);\r\n                            break;\r\n                        }\r\n                    }\r\n                } else {\r\n                    term.classList.add('hidden');\r\n                }\r\n            });\r\n\r\n            // Second pass: Update visibility of letter headings\r\n            letterHeadings.forEach(heading => {\r\n                if (letterHeadingsVisibility.get(heading)) {\r\n                    heading.classList.remove('hidden');\r\n                } else {\r\n                    heading.classList.add('hidden');\r\n                }\r\n            });\r\n\r\n            // Show or hide the no results message\r\n            let noResultsMessage = document.getElementById('no-results-message');\r\n            if (!noResultsMessage) {\r\n                noResultsMessage = document.createElement('span');\r\n                noResultsMessage.id = 'no-results-message';\r\n                noResultsMessage.dataset.id = 'glossary-no-terms-filter';\r\n                noResultsMessage.classList.add('text-gray-700', 'mt-4');\r\n                noResultsMessage.textContent = translateText('glossary-no-terms-filter');\r\n                glossaryTermsBook.appendChild(noResultsMessage);\r\n            }\r\n\r\n            if (hasResults) {\r\n                noResultsMessage.classList.add('hidden');\r\n            } else {\r\n                noResultsMessage.classList.remove('hidden');\r\n            }\r\n        });\r\n    }\r\n};\r\n\r\n/**\r\n * Initializes the assistant/settings tabs and restores saved tab state.\r\n */\r\nexport const initializeTabs = () => {\r\n    const assistantTab = document.getElementById('assistant-tab');\r\n    const settingsTab = document.getElementById('settings-tab');\r\n    const assistantContent = document.getElementById('assistant-content');\r\n    const settingsContent = document.getElementById('settings-content');\r\n\r\n    if (assistantTab && settingsTab && assistantContent && settingsContent) {\r\n        // Function to set active tab - reuse existing logic\r\n        const setActiveTab = (tabIndex) => {\r\n            if (tabIndex === 0) {\r\n                // Assistant tab\r\n                assistantTab.setAttribute('aria-selected', 'true');\r\n                settingsTab.setAttribute('aria-selected', 'false');\r\n                assistantContent.classList.remove('hidden');\r\n                settingsContent.classList.add('hidden');\r\n                assistantTab.classList.add(\"text-blue-700\", \"border-b-4\", \"-mb-1\", \"border-blue-700\");\r\n                settingsTab.classList.remove(\"border-b-4\", \"-mb-1\", \"border-blue-700\", \"text-blue-700\");\r\n            } else {\r\n                // Settings tab\r\n                assistantTab.setAttribute('aria-selected', 'false');\r\n                settingsTab.setAttribute('aria-selected', 'true');\r\n                assistantContent.classList.add('hidden');\r\n                settingsContent.classList.remove('hidden');\r\n                assistantTab.classList.remove('text-blue-700');\r\n                settingsTab.classList.add(\"text-blue-700\", \"border-b-4\", \"-mb-1\", \"border-blue-700\");\r\n                assistantTab.classList.remove(\"border-b-4\", \"-mb-1\", \"border-blue-700\", \"text-blue-700\");\r\n            }\r\n\r\n            // Save the tab state to a cookie\r\n            setCookie(\"activeTabIndex\", tabIndex, 7); // Save for 7 days\r\n        };\r\n\r\n        // Check if we have a saved tab preference\r\n        const savedTabIndex = getCookie(\"activeTabIndex\");\r\n\r\n        // Apply the saved tab or default to the first tab\r\n        if (savedTabIndex !== null && savedTabIndex !== undefined && savedTabIndex !== \"\") {\r\n            // Apply the saved tab\r\n            setActiveTab(parseInt(savedTabIndex));\r\n        } else {\r\n            // Default to first tab (index 0)\r\n            setActiveTab(0);\r\n        }\r\n\r\n        // Keep existing event listeners, but use the new function\r\n        assistantTab.addEventListener('click', () => {\r\n            setActiveTab(0);\r\n        });\r\n\r\n        settingsTab.addEventListener('click', () => {\r\n            setActiveTab(1);\r\n        });\r\n    }\r\n};\r\n\r\n/**\r\n * Checks if the current page should display a return button\r\n * Also clears originating page if we're back at the original page\r\n */\r\nexport const checkIfReferencePage = () => {\r\n    // Get the originating page from localStorage\r\n    const originatingPage = localStorage.getItem('originatingPage');\r\n\r\n    // If no originating page exists, this isn't a reference context\r\n    if (!originatingPage) {\r\n        return false;\r\n    }\r\n\r\n    // Check if we've navigated back to the originating page by some other means\r\n    const currentUrl = window.location.href;\r\n    if (originatingPage === currentUrl) {\r\n        // Clear the originating page data since we're back at the source\r\n        localStorage.removeItem('originatingPage');\r\n        setState('originatingPage', null);\r\n        setState('isReferencePage', false);\r\n        return false;\r\n    }\r\n\r\n    // Update state\r\n    setState('isReferencePage', true);\r\n    setState('originatingPage', originatingPage);\r\n\r\n    return true;\r\n};\r\n\r\n/**\r\n * Initializes reference page functionality\r\n */\r\nexport const initializeReferencePage = () => {\r\n    // Check if we should display a return button (based on localStorage)\r\n    const shouldShowReturnButton = checkIfReferencePage();\r\n\r\n    if (shouldShowReturnButton) {\r\n        displayReturnButton();\r\n    }\r\n};\r\n\r\n/**\r\n * Creates and displays the return button on reference pages\r\n */\r\nexport const displayReturnButton = () => {\r\n    // Get originating page from state\r\n    const originatingPage = getState('originatingPage');\r\n    if (!originatingPage) {\r\n        return;\r\n    }\r\n\r\n    // Check if return button already exists\r\n    if (document.querySelector('.return-button')) {\r\n        return;\r\n    }\r\n\r\n    // Create return button with translated text\r\n    const returnButton = document.createElement('button');\r\n\r\n    // Get translation if available, otherwise use default text\r\n    const translations = getState('translations') || {};\r\n    const buttonText = translations['return-button'] || 'Regresar'; // Spanish default\r\n\r\n    // Add arrow icon before text\r\n    returnButton.innerHTML = `<i class=\"fas fa-arrow-left mr-1\"></i> ${buttonText}`;\r\n\r\n    // Apply styles to make it appear in the top right\r\n    returnButton.classList.add(\r\n        'return-button',\r\n        'fixed',\r\n        'top-4',  // Position from top\r\n        'right-20', // Position from right (leave space for accessibility button)\r\n        'z-50',\r\n        'inline-flex',\r\n        'items-center',\r\n        'px-3',\r\n        'py-1.5',\r\n        'bg-purple-600',\r\n        'text-white',\r\n        'text-sm',\r\n        'rounded-lg',\r\n        'shadow-md',\r\n        'hover:bg-purple-700',\r\n        'focus:outline-none',\r\n        'focus:ring-2',\r\n        'focus:ring-purple-500',\r\n        'focus:ring-opacity-50'\r\n    );\r\n\r\n    returnButton.setAttribute('aria-label', buttonText);\r\n    returnButton.setAttribute('role', 'button');\r\n    returnButton.setAttribute('tabindex', '0'); // Make it focusable for keyboard navigation\r\n    returnButton.setAttribute('aria-live', 'polite'); // For screen readers\r\n    returnButton.setAttribute('aria-pressed', 'false'); // For screen readers\r\n\r\n    // Add click event to return to originating page\r\n    returnButton.addEventListener('click', () => {\r\n\r\n        // Clear the originating page from localStorage and state\r\n        localStorage.removeItem('originatingPage');\r\n        setState('originatingPage', null);\r\n        setState('isReferencePage', false);\r\n\r\n        // Cache interface elements before navigating\r\n        cacheInterfaceElements();\r\n\r\n        // Add fade-out animation\r\n        const mainContent = document.querySelector('body > .container');\r\n        if (mainContent) {\r\n            mainContent.classList.add(\"opacity-0\");\r\n        }\r\n\r\n        // Navigate back to originating page\r\n        setTimeout(() => {\r\n            window.location.href = originatingPage;\r\n        }, 150);\r\n    });\r\n\r\n    // Add the button directly to the body\r\n    document.body.appendChild(returnButton);\r\n};\r\n\r\n/**\r\n * Sets the visibility of the autoplay container.\r\n * @param {boolean} enabled - Whether to show the container.\r\n */\r\nexport const setAutoplayContainerVisibility = (enabled) => {\r\n    const autoplayContainer = document.getElementById('autoplay-container');\r\n    if (autoplayContainer) {\r\n        autoplayContainer.classList.toggle('hidden', !enabled);\r\n    }\r\n};\r\n\r\n/**\r\n * Sets the visibility of the describe images container.\r\n * @param {boolean} enabled - Whether to show the container.\r\n */\r\nexport const setDescribeImagesContainerVisibility = (enabled) => {\r\n    const describeImagesContainer = document.getElementById('describe-images-container');\r\n    if (describeImagesContainer) {\r\n        describeImagesContainer.classList.toggle('hidden', !enabled);\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the visibility of the TTS options container based on feature state.\r\n * @param {boolean} show - Whether to show the container.\r\n */\r\nexport const updateTtsOptionsContainerVisibility = (show) => {\r\n    const ttsOptionsContainer = document.getElementById('tts-options-container');\r\n    if (!ttsOptionsContainer) return;\r\n\r\n    if (show && (isFeatureEnabled('autoplay') || isFeatureEnabled('describeImages'))) {\r\n        ttsOptionsContainer.classList.remove('hidden');\r\n    } else {\r\n        ttsOptionsContainer.classList.add('hidden');\r\n    }\r\n};\r\n\r\n/**\r\n * Sets the visibility of the ELI5 container.\r\n * @param {boolean} enabled - Whether to show the container.\r\n */\r\nexport const setEli5ContainerVisibility = (enabled) => {\r\n    const eli5Container = document.getElementById('eli5-container');\r\n    if (eli5Container) {\r\n        eli5Container.classList.toggle('hidden', !enabled);\r\n    }\r\n};\r\n\r\n/**\r\n * Highlights a DOM element for audio playback.\r\n * @param {HTMLElement} element - The element to highlight.\r\n */\r\nexport const highlightElement = (element) => {\r\n    element?.classList.add(\r\n        'outline',\r\n        'outline-blue-300',\r\n        'outline-2',\r\n        'bg-blue-100',\r\n        'bg-opacity-30',\r\n        'text-black',\r\n        'rounded-lg'\r\n    );\r\n};\r\n\r\n/**\r\n * Removes highlight from a DOM element.\r\n * @param {HTMLElement} element - The element to unhighlight.\r\n */\r\nexport const unhighlightElement = (element) => {\r\n    element?.classList.remove(\r\n        'outline',\r\n        'outline-blue-300',\r\n        'bg-opacity-30',\r\n        'outline-2',\r\n        'bg-blue-100',\r\n        'text-black'\r\n    );\r\n\r\n};\r\n\r\n/**\r\n * Removes highlight from all elements.\r\n */\r\nexport const unhighlightAllElements = () => {\r\n    document.querySelectorAll('.bg-blue-100').forEach(unhighlightElement);\r\n};\r\n\r\n", "/**\r\n * @module audio\r\n * @description\r\n * Audio playback and Text-to-Speech (TTS) utilities for activities and UI.\r\n * Handles audio element management, playback queue, highlighting, controls, and speed.\r\n */\r\n\r\nimport { state, setState } from './state.js';\r\nimport { getCookie, setCookie } from './cookies.js';\r\nimport {\r\n    updatePlayPauseIcon,\r\n    deactivateAudioElements,\r\n    initializeAudioElements,\r\n    highlightElement,\r\n    unhighlightElement,\r\n    unhighlightAllElements\r\n} from './ui_utils.js';\r\nimport { toggleButtonColor, toggleButtonState } from './utils.js';\r\nimport { togglePlayBarSettings, toggleSignLanguageMode } from './interface.js';\r\nimport { trackToggleEvent } from './analytics.js';\r\nimport { isFeatureEnabled } from '../base.js';\r\n\r\n/**\r\n * Maps speed class names to playback rates.\r\n * @constant\r\n * @type {Object}\r\n */\r\nconst SPEED_MAPPING = {\r\n    'speed-0-5': '0.5',\r\n    'speed-1': '1',\r\n    'speed-1-5': '1.5',\r\n    'speed-2': '2'\r\n};\r\n\r\nlet hasUserInteracted = true;\r\nlet activityAudio = null;\r\nlet isProcessingAudio = false;\r\n\r\n/**\r\n * Initializes activity audio elements for sound effects.\r\n * @returns {Object} activityAudio - Map of sound effect Audio objects.\r\n */\r\nexport const initializeActivityAudioElements = () => {\r\n    if (!activityAudio) {\r\n        activityAudio = {\r\n            drop: new Audio('./assets/sounds/drop.mp3'),\r\n            success: new Audio('./assets/sounds/success.mp3'),\r\n            error: new Audio('./assets/sounds/error.mp3'),\r\n            reset: new Audio('./assets/sounds/reset.mp3'),\r\n            validate_success: new Audio('./assets/sounds/validate_success.mp3'),\r\n            //validate_error: new Audio('./assets/sounds/validate_error.mp3'),\r\n            validate_error: new Audio('./assets/sounds/drop.mp3'),\r\n        };\r\n\r\n        Object.values(activityAudio).forEach(audio => {\r\n            audio.volume = 0.5;\r\n        });\r\n    }\r\n    return activityAudio;\r\n};\r\n\r\n/**\r\n * Plays a sound effect for activities.\r\n * @param {string} soundKey - The key of the sound to play.\r\n */\r\nexport const playActivitySound = (soundKey) => {\r\n    if (!activityAudio || !activityAudio[soundKey]) {\r\n        initializeActivityAudioElements();\r\n    }\r\n\r\n    const soundEffect = activityAudio?.[soundKey];\r\n    if (!soundEffect) {\r\n        console.log(`Sound ${soundKey} not available`);\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        soundEffect.pause();\r\n        soundEffect.currentTime = 0;\r\n        soundEffect.play().catch((err) => {\r\n            console.log(`Error playing ${soundKey} sound:`, err);\r\n        });\r\n    } catch (err) {\r\n        console.warn(`Error playing ${soundKey} sound:`, err);\r\n        return null;\r\n    }\r\n\r\n    return soundEffect;\r\n};\r\n\r\n/**\r\n * Gathers all audio elements from the page for TTS.\r\n * @returns {Array} Array of audio element objects.\r\n */\r\nexport const gatherAudioElements = () => {\r\n    // Get the current language from state or a global config\r\n    const currentLanguage = state.currentLanguage || (window.appConfig && window.appConfig.languages && window.appConfig.languages.default) || 'es';\r\n\r\n    const audioBasePath = `content/i18n/${currentLanguage}/audio/`;\r\n\r\n    const elements = Array.from(\r\n        document.querySelectorAll('.container [data-id], .container textarea[data-placeholder-id], .container input[data-placeholder-id]')\r\n    )\r\n        .filter(el => {\r\n            const isNavElement = el.closest('.nav__list') !== null;\r\n            const isImage = el.tagName.toLowerCase() === 'img';\r\n            // Exclude ELI5 sections\r\n            return !isNavElement && !el.getAttribute('data-id')?.startsWith?.('sectioneli5');\r\n        })\r\n        .map(el => {\r\n            const tagName = el.tagName.toLowerCase();\r\n\r\n            // If it's an input or textarea with data-placeholder-id, use that instead of data-id\r\n            if ((tagName === 'textarea' || tagName === 'input') && el.hasAttribute('data-placeholder-id')) {\r\n                const placeholderId = el.getAttribute('data-placeholder-id');\r\n                if (placeholderId && state.audioFiles[placeholderId]) {\r\n                    return {\r\n                        element: el,\r\n                        id: placeholderId,\r\n                        audioSrc: audioBasePath + state.audioFiles[placeholderId]\r\n                    };\r\n                }\r\n                return null;\r\n            }\r\n\r\n            // Default logic for everything else\r\n            const id = el.getAttribute('data-id');\r\n            let audioSrc = state.audioFiles[id] ? audioBasePath + state.audioFiles[id] : undefined;\r\n\r\n            // If it's an image with a data-aria-id, use that audio instead\r\n            if (tagName === 'img') {\r\n                const ariaId = el.getAttribute('data-aria-id');\r\n                if (ariaId && state.audioFiles[ariaId]) {\r\n                    audioSrc = audioBasePath + state.audioFiles[ariaId];\r\n                }\r\n            }\r\n\r\n            // For easyReadMode, check the \"_easy_read\" variant of id\r\n            // but exclude headers and elements in special containers\r\n            if (state.easyReadMode) {\r\n                // Check if element is a header\r\n                const isHeader = el.tagName.toLowerCase().match(/^h[1-6]$/);\r\n\r\n                // Check if element is inside excluded areas\r\n                const wordCard = el.closest('.word-card');\r\n                const activityItem = el.closest('[data-activity-item]');\r\n                const navList = el.closest('.nav__list');\r\n                const activityText = el.closest('.activity-text');\r\n                const isExcluded = wordCard !== null || activityItem !== null ||\r\n                    navList !== null || activityText !== null;\r\n\r\n                // Only use easyread audio if not a header and not in excluded areas\r\n                if (!isHeader && !isExcluded) {\r\n                    const easyReadAudioId = `${id}_easy_read`;\r\n                    if (state.audioFiles.hasOwnProperty(easyReadAudioId)) {\r\n                        audioSrc = audioBasePath + state.audioFiles[easyReadAudioId];\r\n                    }\r\n                }\r\n            }\r\n\r\n            return { element: el, id, audioSrc };\r\n        })\r\n        .filter(item => item && item.audioSrc);\r\n\r\n    setState('audioElements', elements);\r\n    return elements;\r\n};\r\n\r\n/**\r\n * Stops current audio playback and resets state.\r\n */\r\nexport const stopAudio = () => {\r\n    try {\r\n        unhighlightAllElements();\r\n        if (state.currentAudio) {\r\n            state.currentAudio.pause();\r\n            state.currentAudio.currentTime = 0;\r\n            setState('currentAudio', null);\r\n        }\r\n        setState('isPlaying', false);\r\n        updatePlayPauseIcon(false); // Update play button state\r\n        isProcessingAudio = false;\r\n    } catch (error) {\r\n        console.error('Error stopping audio:', error);\r\n    }\r\n};\r\n\r\n/**\r\n * Toggles play/pause for TTS audio.\r\n */\r\nexport const togglePlayPause = () => {\r\n    if (state.isPlaying) {\r\n        stopAudio();\r\n    } else {\r\n        setState('isPlaying', true);\r\n        updatePlayPauseIcon(true); // Update play button state\r\n        playAudioSequentially();\r\n    }\r\n};\r\n\r\n/**\r\n * Plays audio elements sequentially.\r\n */\r\nexport const playAudioSequentially = async () => {\r\n    if (isProcessingAudio || !hasUserInteracted) {\r\n        return;\r\n    }\r\n\r\n    isProcessingAudio = true;\r\n    try {\r\n        await processAudioQueue();\r\n    } finally {\r\n        isProcessingAudio = false;\r\n    }\r\n    setState('navigationDirection', 'forward');\r\n};\r\n\r\n/**\r\n * Plays the current audio element.\r\n */\r\nexport const playCurrentAudio = async () => {\r\n    const { currentIndex, audioElements, audioSpeed } = state;\r\n\r\n    if (currentIndex < 0 || currentIndex >= audioElements.length) {\r\n        stopAudio();\r\n        return;\r\n    }\r\n\r\n    const { element, audioSrc } = audioElements[currentIndex];\r\n    try {\r\n        highlightElement(element);\r\n        await playAudioWithPromise(audioSrc, audioSpeed);\r\n        unhighlightElement(element);\r\n        stopAudio();\r\n    } catch (error) {\r\n        console.error('Error playing audio:', error);\r\n        stopAudio();\r\n    }\r\n};\r\n\r\n/**\r\n * Processes the audio queue, playing elements in order.\r\n * @private\r\n */\r\nconst processAudioQueue = async () => {\r\n    const { currentIndex, audioElements, audioSpeed, describeImagesMode, navigationDirection } = state;\r\n\r\n    if (currentIndex < 0 || currentIndex >= audioElements.length) {\r\n        stopAudio();\r\n        state.currentIndex = 0; // Reset index if out of bounds\r\n        state.navigationDirection = 'forward'; // Reset navigation direction\r\n        return;\r\n    }\r\n\r\n    // Clear leftover highlights first\r\n    unhighlightAllElements();\r\n\r\n    const { element, audioSrc } = audioElements[currentIndex];\r\n\r\n    // Check if current element is an image and should be skipped\r\n    const isImage = element.tagName.toLowerCase() === 'img';\r\n    if (isImage && !describeImagesMode) {\r\n        // Skip this audio element and move to the next/previous one based on navigation direction\r\n        if (state.isPlaying) {\r\n            // Determine which direction to navigate based on the last user action\r\n            const direction = navigationDirection === 'backward' ? -1 : 1;\r\n            setState('currentIndex', currentIndex + direction);\r\n\r\n            // We don't reset navigation direction here yet - we need to keep skipping in the same direction\r\n            // until we find a non-image element\r\n\r\n            await processAudioQueue();\r\n            return;\r\n        } else {\r\n            stopAudio();\r\n            return;\r\n        }\r\n    }\r\n\r\n    try {\r\n        highlightElement(element);\r\n        await playAudioWithPromise(audioSrc, audioSpeed);\r\n        unhighlightElement(element);\r\n\r\n        if (state.isPlaying) {\r\n            // The key fix: After playing an element, always move forward regardless of how we got here\r\n            if (navigationDirection === 'backward') {\r\n                // We've successfully played the \"previous\" audio, now reset to forward direction\r\n                setState('navigationDirection', 'forward');\r\n                setState('currentIndex', currentIndex + 1); // Move forward\r\n            } else {\r\n                // Continue in forward direction\r\n                setState('currentIndex', currentIndex + 1);\r\n            }\r\n            await processAudioQueue();\r\n        } else {\r\n            stopAudio();\r\n        }\r\n    } catch (error) {\r\n        console.error('Error playing audio:', error);\r\n        stopAudio();\r\n    }\r\n};\r\n\r\n/**\r\n * Play a single audio file with promise.\r\n * @private\r\n * @param {string} src - Audio source URL.\r\n * @param {string|number} speed - Playback speed.\r\n * @returns {Promise<void>}\r\n */\r\nconst playAudioWithPromise = (src, speed) => {\r\n    return new Promise((resolve, reject) => {\r\n        if (!state.isPlaying) {\r\n            resolve();\r\n            return;\r\n        }\r\n\r\n        const audio = new Audio(src);\r\n        setState('currentAudio', audio);\r\n        audio.playbackRate = parseFloat(speed);\r\n\r\n        audio.onended = resolve;\r\n        audio.onerror = reject;\r\n\r\n        updatePlayPauseIcon(true); // Update play button state\r\n\r\n        audio.play().catch((error) => {\r\n            console.warn('Audio playback failed:', error);\r\n            resolve();\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Plays the previous audio element in the sequence.\r\n */\r\nexport const playPreviousAudio = () => {\r\n    setState('navigationDirection', 'backward');\r\n    setState('currentIndex', Math.max(0, state.currentIndex - 1));\r\n    stopAudio();\r\n    setState('isPlaying', true);\r\n    playAudioSequentially();\r\n};\r\n\r\n/**\r\n * Plays the next audio element in the sequence.\r\n */\r\nexport const playNextAudio = () => {\r\n    setState('navigationDirection', 'forward');\r\n    setState('currentIndex', state.currentIndex + 1);\r\n    stopAudio();\r\n    setState('isPlaying', true);\r\n    playAudioSequentially();\r\n};\r\n\r\n/**\r\n * Initializes audio speed from cookies and updates UI.\r\n */\r\nexport const initializeAudioSpeed = () => {\r\n    const savedSpeed = getCookie('audioSpeed');\r\n    if (savedSpeed) {\r\n        setState('audioSpeed', savedSpeed);\r\n        updateSpeedDisplay(savedSpeed);\r\n        updateSpeedButtons(savedSpeed);\r\n    }\r\n};\r\n\r\n/**\r\n * Changes the audio speed based on user selection.\r\n * @param {Event} event - The click event from the speed button.\r\n */\r\nexport const changeAudioSpeed = (event) => {\r\n    const button = event.target.closest('.read-aloud-change-speed');\r\n    const speedClass = Array.from(button.classList).find(cls => cls.startsWith('speed-'));\r\n    const newSpeed = SPEED_MAPPING[speedClass];\r\n\r\n    setState('audioSpeed', newSpeed);\r\n    setCookie('audioSpeed', newSpeed, 7);\r\n\r\n    updateAudioSpeed(newSpeed);\r\n    updateSpeedDisplay(newSpeed);\r\n    updateSpeedButtons(button);\r\n    togglePlayBarSettings();\r\n};\r\n\r\n/**\r\n * Updates the playback speed for current audio elements.\r\n * @private\r\n * @param {string|number} speed - Playback speed.\r\n */\r\nconst updateAudioSpeed = (speed) => {\r\n    if (state.currentAudio) {\r\n        state.currentAudio.playbackRate = parseFloat(speed);\r\n    }\r\n    if (state.eli5Audio) {\r\n        state.eli5Audio.playbackRate = parseFloat(speed);\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the speed display in the UI.\r\n * @private\r\n * @param {string|number} speed - Playback speed.\r\n */\r\nconst updateSpeedDisplay = (speed) => {\r\n    const speedClass = Object.entries(SPEED_MAPPING)\r\n        .find(([key, value]) => value === speed)?.[0] || 'speed-1';\r\n    const speedButton = document.querySelector(`[class*=\"${speedClass}\"]`);\r\n    const display = speedButton?.innerHTML;\r\n\r\n    if (display) {\r\n        const speedButtonElement = document.getElementById('read-aloud-speed');\r\n        speedButtonElement.innerHTML = display;\r\n\r\n        // Update aria-label for screen readers\r\n        const speedText = speedButton.textContent.trim();\r\n        speedButtonElement.setAttribute('aria-label', `Playback speed: ${speedText}`);\r\n    }\r\n};\r\n\r\n/**\r\n * Updates the speed button styles in the UI.\r\n * @private\r\n * @param {HTMLElement|string} selectedButton - The selected button or speed value.\r\n */\r\nconst updateSpeedButtons = (selectedButton) => {\r\n    document.querySelectorAll('.read-aloud-change-speed').forEach(btn => {\r\n        if (btn === selectedButton) {\r\n            btn.classList.add('bg-white', 'text-black');\r\n            btn.classList.remove('bg-black', 'text-white');\r\n        } else {\r\n            btn.classList.remove('bg-white', 'text-black');\r\n            btn.classList.add('bg-black', 'text-white');\r\n        }\r\n    });\r\n};\r\n\r\n/**\r\n * Toggle Read Aloud mode and updates UI.\r\n * @param {Object} [options] - Options for toggling.\r\n * @param {boolean} [options.stopCalls=false] - If true, stops related calls.\r\n */\r\nexport const toggleReadAloud = ({ stopCalls = false } = {}) => {\r\n    stopAudio();\r\n    unhighlightAllElements();\r\n\r\n    // If turning read aloud off, remove all audio handlers\r\n    if (state.readAloudMode) {\r\n        deactivateAudioElements();\r\n    } else {\r\n        initializeAudioElements();\r\n    }\r\n\r\n    const newState = !state.readAloudMode;\r\n    setState('readAloudMode', newState);\r\n    setCookie('readAloudMode', newState.toString(), 7);\r\n    toggleButtonColor(\"tts-quick-toggle-button\", newState);\r\n\r\n    // Track the toggle event\r\n    trackToggleEvent('ReadAloud', newState);\r\n\r\n    // Toggle UI elements\r\n    const playBar = document.getElementById(\"play-bar\");\r\n    const ttsOptionsContainer = document.getElementById(\"tts-options-container\");\r\n    const autoplayContainer = document.getElementById(\"autoplay-container\");\r\n    const describeImagesContainer = document.getElementById(\"describe-images-container\");\r\n    const ttsQuickToggleButton = document.getElementById(\"tts-quick-toggle-button\");\r\n\r\n    if (newState) {\r\n        if (playBar) playBar.classList.remove(\"hidden\");\r\n        if (ttsQuickToggleButton) ttsQuickToggleButton.classList.remove(\"hidden\");\r\n        if ((isFeatureEnabled(\"autoplay\") || isFeatureEnabled(\"describeImages\")) && ttsOptionsContainer) {\r\n            ttsOptionsContainer.classList.remove(\"hidden\");\r\n            if (isFeatureEnabled(\"autoplay\")) autoplayContainer?.classList.remove(\"hidden\");\r\n            if (isFeatureEnabled(\"describeImages\")) describeImagesContainer?.classList.remove(\"hidden\");\r\n        }\r\n    } else {\r\n        if (playBar) playBar.classList.add(\"hidden\");\r\n        //if (ttsQuickToggleButton) ttsQuickToggleButton.classList.add(\"hidden\");\r\n        if (ttsOptionsContainer) {\r\n            ttsOptionsContainer.classList.add(\"hidden\");\r\n            if (isFeatureEnabled(\"autoplay\")) autoplayContainer?.classList.add(\"hidden\");\r\n            if (isFeatureEnabled(\"describeImages\")) describeImagesContainer?.classList.add(\"hidden\");\r\n        }\r\n    }\r\n\r\n    toggleButtonState(\"toggle-read-aloud\", newState);\r\n    if (!stopCalls && state.signLanguageMode) {\r\n        toggleSignLanguageMode({ stopCalls: true });\r\n    }\r\n};\r\n\r\n/**\r\n * Initializes the quick toggle TTS button and its event listener.\r\n */\r\nexport const initializeTtsQuickToggle = () => {\r\n    const ttsQuickToggleButton = document.getElementById(\"tts-quick-toggle-button\");\r\n\r\n    if (ttsQuickToggleButton) {\r\n        // Show the ttsQuickToggleButton if the function is called\r\n        ttsQuickToggleButton.classList.remove(\"hidden\");\r\n\r\n        // Add click event listener\r\n        ttsQuickToggleButton.addEventListener(\"click\", (e) => {\r\n            e.preventDefault();\r\n\r\n            // Toggle read aloud mode\r\n            toggleReadAloud();\r\n        });\r\n    }\r\n};", "/**\r\n * @module tts_highlighter\r\n * @description\r\n * Provides word-by-word highlighting for TTS audio playback, including subtitle popups for images and glossary integration.\r\n */\r\nimport { state } from \"./state.js\";\r\nimport { stopAudio } from \"./audio.js\";\r\nimport { unhighlightAllElements } from './ui_utils.js';\r\nimport { showGlossaryDefinition } from './interface.js';\r\n\r\nlet timecodeData = null;\r\nlet monitorInterval = null;\r\nlet currentListener = null;\r\nlet endedListener = null;\r\nconst TOLERANCE = 0.2; // 200ms tolerance\r\n\r\nlet subtitlePopup = null;\r\nlet lastHighlightedImage = null;\r\n\r\n/**\r\n * Loads the timecode JSON for the current language and starts monitoring the current audio for word highlighting.\r\n * @async\r\n */\r\nexport async function initializeWordByWordHighlighter() {\r\n  const timecodeJsonUrl = `./content/i18n/${state.currentLanguage}/timecode/timecode_output.json`;\r\n  try {\r\n    const response = await fetch(timecodeJsonUrl);\r\n    if (!response.ok) {\r\n      throw new Error(`Failed to load timecode JSON: ${response.statusText}`);\r\n    }\r\n    timecodeData = await response.json();\r\n    startMonitoring();\r\n  } catch (error) {\r\n    console.error(\"Error initializing word-by-word highlighter:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Starts monitoring the current audio for word highlighting.\r\n * Sets up a timer to check the audio's currentTime.\r\n * @private\r\n */\r\nfunction startMonitoring() {\r\n  if (monitorInterval) return;\r\n  // Check the audio's currentTime every 50ms for more responsive updates\r\n  monitorInterval = setInterval(checkCurrentAudio, 50);\r\n}\r\n\r\n/**\r\n * Checks the current audio and attaches or detaches the word highlighter as needed.\r\n * @private\r\n */\r\nfunction checkCurrentAudio() {\r\n  const audio = state.currentAudio;\r\n  if (audio && !audio._wordHighlighterAttached) {\r\n    attachWordHighlighter(audio);\r\n  } else if (!audio && currentListener) {\r\n    detachCurrentListener();\r\n    clearHighlights();\r\n  }\r\n}\r\n\r\n/**\r\n * Attaches the word highlighter to the current audio element.\r\n * Handles easy-read mode, glossary terms, and subtitle popups for images.\r\n * @private\r\n * @param {HTMLAudioElement} audio - The audio element to attach the highlighter to.\r\n */\r\nfunction attachWordHighlighter(audio) {\r\n  // Get the current text element (from state.audioElements and state.currentIndex).\r\n  const audioElements = state.audioElements;\r\n  if (!audioElements || audioElements.length === 0) return;\r\n  const currentIndex = state.currentIndex;\r\n  if (currentIndex < 0 || currentIndex >= audioElements.length) return;\r\n  const { element, id: dataId } = audioElements[currentIndex];\r\n\r\n  // Get the translation key with proper easy-read handling\r\n  let translationKey = dataId;\r\n  let timecodeKey = dataId;\r\n\r\n  if (state.easyReadMode) {\r\n    // Check if element is a header\r\n    const isHeader = element.tagName.toLowerCase().match(/^h[1-6]$/);\r\n\r\n    // Check if element is inside excluded areas\r\n    const wordCard = element.closest('.word-card');\r\n    const activityItem = element.closest('[data-activity-item]');\r\n    const navList = element.closest('.nav__list');\r\n    const activityText = element.closest('.activity-text');\r\n    const isExcluded = wordCard !== null || activityItem !== null ||\r\n      navList !== null || activityText !== null;\r\n\r\n    // Use easyread translation if not a header and not in excluded areas\r\n    if (!isHeader && !isExcluded) {\r\n      const easyReadKey = `easyread-${dataId}`;\r\n      if (state.translations && state.translations.hasOwnProperty(easyReadKey)) {\r\n        translationKey = easyReadKey;\r\n\r\n        // FALLBACK MECHANISM: Try to use easyReadKey for timecode first\r\n        // If that doesn't exist in timecodeData, fall back to original dataId\r\n        timecodeKey = (timecodeData && timecodeData[easyReadKey]) ? easyReadKey : dataId;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!timecodeData || !timecodeData[timecodeKey]) return;\r\n  const entry = timecodeData[timecodeKey];\r\n\r\n  const wordTimestamps = (entry.timecodes && entry.timecodes[1] && entry.timecodes[1].word_timestamps) || [];\r\n  if (wordTimestamps.length === 0) return;\r\n\r\n  const translatedText = state.translations && state.translations[translationKey]\r\n    ? state.translations[translationKey]\r\n    : element.textContent;\r\n\r\n  // Check if this is an image element - if so, create a subtitle popup\r\n  const isImage = element.tagName.toLowerCase() === 'img';\r\n  if (isImage) {\r\n    createSubtitlePopup(element, translatedText);\r\n    lastHighlightedImage = element;\r\n  } else {\r\n    // If we're not highlighting an image, hide any existing subtitle popup\r\n    if (subtitlePopup) {\r\n      hideSubtitlePopup();\r\n    }\r\n  }\r\n\r\n  // Get the target element for highlighting (either the original element or the subtitle popup content)\r\n  const targetElement = isImage ? subtitlePopup.querySelector('.subtitle-content') : element;\r\n\r\n  // Wrap the text in spans (if not already wrapped).\r\n  if (!targetElement.dataset.wordsWrapped) {\r\n    wrapTextInSpans(targetElement, wordTimestamps, translatedText);\r\n    targetElement.dataset.wordsWrapped = \"true\";\r\n  }\r\n\r\n  // Clear highlights on other text elements.\r\n  document.querySelectorAll('[data-words-wrapped=\"true\"]').forEach(el => {\r\n    if (el !== element) {\r\n      el.querySelectorAll(\"span[data-word-index]\").forEach(span => {\r\n        span.classList.remove(\"bg-yellow-300\");\r\n        span.classList.remove(\"rounded-lg\");\r\n        span.classList.remove(\"text-black\");\r\n      });\r\n    }\r\n  });\r\n\r\n  // Highlight the first word when we start\r\n  const firstSpan = element.querySelector('span[data-word-index=\"0\"]');\r\n  if (firstSpan) {\r\n    element.querySelectorAll(\"span[data-word-index]\").forEach(span => {\r\n      span.classList.remove(\"bg-yellow-300\");\r\n      span.classList.remove(\"rounded-lg\");\r\n      span.classList.remove(\"text-black\");\r\n    });\r\n    firstSpan.classList.add(\"bg-yellow-300\");\r\n    firstSpan.classList.add(\"rounded-lg\");\r\n    firstSpan.classList.add(\"text-black\");\r\n  }\r\n\r\n  // Detach any existing listeners first to avoid duplicates\r\n  detachCurrentListener();\r\n\r\n  // Attach a timeupdate listener\r\n  currentListener = () => updateWordHighlighting(audio, targetElement, wordTimestamps);\r\n  audio.addEventListener(\"timeupdate\", currentListener);\r\n\r\n  // Add an ended listener to clear highlights when audio finishes\r\n  endedListener = () => {\r\n    clearHighlights();\r\n    if (isImage && subtitlePopup) {\r\n      hideSubtitlePopup();\r\n    }\r\n  };\r\n  audio.addEventListener(\"ended\", endedListener);\r\n\r\n  // Also listen for play event to ensure first word gets highlighted\r\n  audio.addEventListener(\"play\", () => {\r\n    const firstSpan = element.querySelector('span[data-word-index=\"0\"]');\r\n    if (firstSpan && audio.currentTime < wordTimestamps[0].end + TOLERANCE) {\r\n      element.querySelectorAll(\"span[data-word-index]\").forEach(span => {\r\n        span.classList.remove(\"bg-yellow-300\");\r\n        span.classList.remove(\"rounded-lg\");\r\n        span.classList.remove(\"text-black\");\r\n      });\r\n      firstSpan.classList.add(\"bg-yellow-300\");\r\n      firstSpan.classList.add(\"rounded-lg\");\r\n      firstSpan.classList.add(\"text-black\");\r\n    }\r\n  });\r\n\r\n  // Listen for index changes to clear highlights when moving to next item\r\n  document.addEventListener(\"audioIndexChanged\", clearHighlights);\r\n\r\n  audio._wordHighlighterAttached = true;\r\n}\r\n\r\n/**\r\n * Creates a subtitle popup below an image element and displays the provided text.\r\n * @private\r\n * @param {HTMLElement} imageElement - The image element to anchor the popup to.\r\n * @param {string} text - The subtitle text to display.\r\n * @returns {HTMLElement} The created subtitle popup element.\r\n */\r\nfunction createSubtitlePopup(imageElement, text) {\r\n\r\n  // Remove any click outside listeners before hiding existing popup\r\n  document.removeEventListener('click', handleClickOutside);\r\n\r\n  // Hide any existing popup first\r\n  if (subtitlePopup) {\r\n    // Skip fade-out animation when directly replacing with a new popup\r\n    if (subtitlePopup.parentNode) {\r\n      subtitlePopup.parentNode.removeChild(subtitlePopup);\r\n      subtitlePopup = null;\r\n    }\r\n  }\r\n\r\n  // Create the popup\r\n  subtitlePopup = document.createElement('div');\r\n  subtitlePopup.className = 'fixed z-50 bg-white/90 backdrop-blur-sm rounded-lg border border-gray-300 shadow-lg p-3 max-w-md min-w-[280px] opacity-0 transition-opacity duration-300 ease-in-out';\r\n  subtitlePopup.style.width = Math.min(Math.max(imageElement.offsetWidth * 1.2, 280), 500) + 'px';\r\n\r\n  // Add content div that will hold the text with word-by-word highlighting\r\n  const content = document.createElement('div');\r\n  content.className = 'subtitle-content text-lg leading-relaxed';\r\n  content.textContent = text;\r\n\r\n  subtitlePopup.appendChild(content);\r\n  document.body.appendChild(subtitlePopup);\r\n\r\n  // Position it below the image\r\n  positionSubtitlePopup(imageElement);\r\n\r\n  // Add visible class for fade-in\r\n  setTimeout(() => {\r\n    subtitlePopup.classList.add('opacity-100');\r\n  }, 10);\r\n\r\n  // Add a listener to reposition on window resize\r\n  window.addEventListener('resize', () => {\r\n    if (subtitlePopup && lastHighlightedImage) {\r\n      positionSubtitlePopup(lastHighlightedImage);\r\n    }\r\n  });\r\n\r\n  // Add click outside listener\r\n  setTimeout(() => {\r\n    document.addEventListener('click', handleClickOutside);\r\n  }, 50);\r\n\r\n  return subtitlePopup;\r\n}\r\n\r\n/**\r\n * Handles clicks outside the subtitle popup to hide it.\r\n * @private\r\n * @param {MouseEvent} event\r\n */\r\nfunction handleClickOutside(event) {\r\n  // Check if we have a popup and if the click was outside both the popup and the currently highlighted image\r\n  if (subtitlePopup &&\r\n    !subtitlePopup.contains(event.target) &&\r\n    (!lastHighlightedImage || !lastHighlightedImage.contains(event.target))) {\r\n\r\n    // If we're clicking on a different image, don't hide the popup yet\r\n    // The createSubtitlePopup for that new image will handle it\r\n    if (event.target.tagName.toLowerCase() === 'img' &&\r\n      event.target.getAttribute('data-id')) {\r\n      return;\r\n    }\r\n\r\n    hideSubtitlePopup();\r\n  }\r\n}\r\n\r\n/**\r\n * Positions the subtitle popup below the given image element.\r\n * @private\r\n * @param {HTMLElement} imageElement\r\n */\r\nfunction positionSubtitlePopup(imageElement) {\r\n  if (!subtitlePopup) return;\r\n\r\n  const rect = imageElement.getBoundingClientRect();\r\n\r\n  // Position it centered below the image\r\n  subtitlePopup.style.top = (rect.bottom + window.scrollY + 8) + 'px';\r\n  subtitlePopup.style.left = (rect.left + window.scrollX + (rect.width - subtitlePopup.offsetWidth) / 2) + 'px';\r\n\r\n  // Make sure it's not off-screen\r\n  const viewportWidth = window.innerWidth;\r\n  const popupRect = subtitlePopup.getBoundingClientRect();\r\n\r\n  if (popupRect.right > viewportWidth) {\r\n    subtitlePopup.style.left = (viewportWidth - popupRect.width - 8) + 'px';\r\n  }\r\n\r\n  if (parseFloat(subtitlePopup.style.left) < 8) {\r\n    subtitlePopup.style.left = '8px';\r\n  }\r\n}\r\n\r\n/**\r\n * Hides and removes the subtitle popup from the DOM.\r\n * @private\r\n */\r\nfunction hideSubtitlePopup() {\r\n  if (subtitlePopup) {\r\n    // Remove click outside listener\r\n    document.removeEventListener('click', handleClickOutside);\r\n\r\n    // Fade out\r\n    subtitlePopup.classList.add('opacity-0');\r\n\r\n    // Remove after animation\r\n    setTimeout(() => {\r\n      if (subtitlePopup && subtitlePopup.parentNode) {\r\n        subtitlePopup.parentNode.removeChild(subtitlePopup);\r\n        subtitlePopup = null;\r\n      }\r\n    }, 300);\r\n  }\r\n  lastHighlightedImage = null;\r\n}\r\n\r\n/**\r\n * Removes all word highlights and cleans up subtitle popups.\r\n * @private\r\n */\r\nfunction clearHighlights() {\r\n  // Remove the Tailwind highlight class from all wrapped elements.\r\n  const wrappedElements = document.querySelectorAll('[data-words-wrapped=\"true\"]');\r\n  wrappedElements.forEach(element => {\r\n    element.querySelectorAll(\"span[data-word-index]\").forEach(span => {\r\n      span.classList.remove(\"bg-yellow-300\");\r\n      span.classList.remove(\"rounded-lg\");\r\n      span.classList.remove(\"text-black\");\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Detaches the current audio event listeners for word highlighting.\r\n * @private\r\n */\r\nfunction detachCurrentListener() {\r\n  const audio = state.currentAudio;\r\n  if (audio) {\r\n    if (currentListener) {\r\n      audio.removeEventListener(\"timeupdate\", currentListener);\r\n      currentListener = null;\r\n    }\r\n    if (endedListener) {\r\n      audio.removeEventListener(\"ended\", endedListener);\r\n      endedListener = null;\r\n    }\r\n    audio._wordHighlighterAttached = false;\r\n  }\r\n\r\n  // Remove the index change listener\r\n  document.removeEventListener(\"audioIndexChanged\", clearHighlights);\r\n}\r\n\r\n/**\r\n * Wraps the text content of an element in <span> tags for each word, handling glossary terms.\r\n * Adds click listeners for glossary terms.\r\n * @private\r\n * @param {HTMLElement} element - The element whose text to wrap.\r\n * @param {Array} wordTimestamps - Array of word timestamp objects.\r\n * @param {string} translatedText - The text to use for wrapping.\r\n */\r\nfunction wrapTextInSpans(element, wordTimestamps, translatedText) {\r\n  const glossaryMapping = {};\r\n  const glossaryElements = element.querySelectorAll('.glossary-term');\r\n\r\n  // Use the provided translated text instead of element.textContent\r\n  const originalText = translatedText || element.textContent;\r\n\r\n  // Helper function to normalize text by removing punctuation\r\n  const normalizeText = (text) => {\r\n    return text.toLowerCase().trim().replace(/[.,;:!?()]/g, '');\r\n  };\r\n\r\n  // Build a map of all glossary terms\r\n  glossaryElements.forEach(termElement => {\r\n    const termText = termElement.textContent.trim();\r\n    const normalizedText = normalizeText(termText);\r\n\r\n    glossaryMapping[normalizedText] = {\r\n      classes: Array.from(termElement.classList),\r\n      role: termElement.getAttribute('role'),\r\n      tabindex: termElement.getAttribute('tabindex'),\r\n      text: termText, // Preserve original casing\r\n      originalText: termText // Keep the original text with punctuation\r\n    };\r\n  });\r\n\r\n  // Create a working copy of timestamps that we can modify\r\n  const modifiedTimestamps = [...wordTimestamps];\r\n\r\n  // Step 1: Sort glossary terms by length (longest first) to handle overlapping terms\r\n  // This ensures \"bosque tropical\" is processed before \"bosque\"\r\n  const sortedGlossaryTerms = Object.keys(glossaryMapping)\r\n    .sort((a, b) => b.split(/\\s+/).length - a.split(/\\s+/).length);\r\n\r\n  // Step 2: Look for multi-word glossary terms and mark them\r\n  sortedGlossaryTerms.forEach(term => {\r\n    const words = term.split(/\\s+/);\r\n\r\n    // Find potential matches in our timestamps\r\n    for (let i = 0; i < modifiedTimestamps.length - words.length + 1; i++) {\r\n      // Skip if this position is already part of a glossary term\r\n      if (modifiedTimestamps[i].isPartOfGlossaryTerm) continue;\r\n\r\n      // Get the sequence of words at this position and normalize for comparison\r\n      const sequence = modifiedTimestamps.slice(i, i + words.length)\r\n        .map(ts => normalizeText(ts.text))\r\n        .join(' ');\r\n\r\n      // If we found a match\r\n      if (sequence === term) {\r\n        // Flag each word in this sequence as part of a glossary term\r\n        for (let j = 0; j < words.length; j++) {\r\n          modifiedTimestamps[i + j].isPartOfGlossaryTerm = true;\r\n          modifiedTimestamps[i + j].glossaryTermIndex = i;\r\n          modifiedTimestamps[i + j].glossaryTermLength = words.length;\r\n          modifiedTimestamps[i + j].glossaryTerm = term;\r\n        }\r\n      }\r\n    }\r\n  });\r\n\r\n  // Step 3: Generate HTML with special handling for glossary terms\r\n  let html = [];\r\n  let i = 0;\r\n  while (i < modifiedTimestamps.length) {\r\n    const ts = modifiedTimestamps[i];\r\n\r\n    // If this is the start of a multi-word glossary term\r\n    if (ts.isPartOfGlossaryTerm && ts.glossaryTermIndex === i) {\r\n      // Get the full text of the multi-word term with original punctuation\r\n      const termText = modifiedTimestamps\r\n        .slice(i, i + ts.glossaryTermLength)\r\n        .map(w => w.text)\r\n        .join(' ');\r\n\r\n      const termAttr = glossaryMapping[ts.glossaryTerm];\r\n      const classList = termAttr.classes.join(' ');\r\n\r\n      // Create a single span for the entire term\r\n      html.push(`<span \r\n        data-word-index=\"${i}\" \r\n        class=\"${classList}\" \r\n        role=\"${termAttr.role || 'button'}\" \r\n        tabindex=\"${termAttr.tabindex || '0'}\"\r\n        data-glossary-term=\"true\"\r\n      >${termText}</span>`);\r\n\r\n      // Skip ahead past all words in this term\r\n      i += ts.glossaryTermLength;\r\n    }\r\n    // Single word glossary term - check with normalized text\r\n    else {\r\n      // Check if this word (without punctuation) is a glossary term\r\n      const normalizedWord = normalizeText(ts.text);\r\n\r\n      if (glossaryMapping[normalizedWord]) {\r\n        const termAttr = glossaryMapping[normalizedWord];\r\n        const classList = termAttr.classes.join(' ');\r\n\r\n        html.push(`<span \r\n          data-word-index=\"${i}\" \r\n          class=\"${classList}\" \r\n          role=\"${termAttr.role || 'button'}\" \r\n          tabindex=\"${termAttr.tabindex || '0'}\"\r\n          data-glossary-term=\"true\"\r\n        >${ts.text}</span>`);\r\n      }\r\n      // Regular word\r\n      else if (!ts.isPartOfGlossaryTerm) {\r\n        html.push(`<span data-word-index=\"${i}\">${ts.text}</span>`);\r\n      }\r\n      // Skip words that are part of a multi-word term but not the start\r\n      i++;\r\n    }\r\n  }\r\n\r\n  element.innerHTML = html.join(' ');\r\n\r\n  // Add event parameter to the click handler\r\n  element.querySelectorAll('[data-glossary-term=\"true\"]').forEach(term => {\r\n    term.addEventListener('click', (event) => {  // Note the event parameter here\r\n      // Stop event propagation to prevent parent elements from receiving the click\r\n      event.stopPropagation();\r\n      // event.preventDefault();\r\n\r\n      // Set a flag to prevent audio playback\r\n      window._isGlossaryTermClick = true;\r\n\r\n      // Stop any currently playing audio\r\n      if (state.isPlaying || state.currentAudio) {\r\n        stopAudio();\r\n        unhighlightAllElements();\r\n      }\r\n\r\n      // Show the glossary definition popup\r\n      showGlossaryDefinition(event);\r\n\r\n      // Clear the flag after a short delay\r\n      setTimeout(() => {\r\n        window._isGlossaryTermClick = false;\r\n      }, 100);\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Updates the highlighted word based on the current audio time.\r\n * @private\r\n * @param {HTMLAudioElement} audio - The audio element.\r\n * @param {HTMLElement} element - The element containing the word spans.\r\n * @param {Array} wordTimestamps - Array of word timestamp objects.\r\n */\r\nfunction updateWordHighlighting(audio, element, wordTimestamps) {\r\n  const currentTime = audio.currentTime;\r\n  let activeIndex = -1;\r\n\r\n  // Check if we're past the last word's end time\r\n  const lastWord = wordTimestamps[wordTimestamps.length - 1];\r\n  if (lastWord && currentTime > lastWord.end + TOLERANCE) {\r\n    // We're past the last word, clear all highlights\r\n    clearHighlights();\r\n    return;\r\n  }\r\n\r\n  // Special case for before the first word\r\n  if (currentTime < wordTimestamps[0].start) {\r\n    activeIndex = 0;\r\n  }\r\n  // Special case for after the last word but still within tolerance\r\n  else if (currentTime >= wordTimestamps[wordTimestamps.length - 1].start) {\r\n    activeIndex = wordTimestamps.length - 1;\r\n  }\r\n  // Find the right word based on position between start times\r\n  else {\r\n    // Find the last word whose start time is before or equal to the current time\r\n    for (let i = 0; i < wordTimestamps.length; i++) {\r\n      if (currentTime >= wordTimestamps[i].start) {\r\n        activeIndex = i;\r\n\r\n        // Check if we're very close to the next word's start time\r\n        // This helps catch small words that might be skipped\r\n        if (i < wordTimestamps.length - 1 &&\r\n          currentTime > wordTimestamps[i + 1].start - TOLERANCE) {\r\n          activeIndex = i + 1;\r\n        }\r\n\r\n        // Check if we're past the current word's end time\r\n        if (currentTime > wordTimestamps[i].end + TOLERANCE) {\r\n          // If we're between words, clear highlighting\r\n          const isInGap = i < wordTimestamps.length - 1 &&\r\n            currentTime < wordTimestamps[i + 1].start - TOLERANCE;\r\n          if (isInGap) {\r\n            clearHighlights();\r\n            return;\r\n          }\r\n        }\r\n      } else {\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // If no suitable word was found, default to the first word\r\n  if (activeIndex === -1) {\r\n    activeIndex = 0;\r\n  }\r\n\r\n  // Remove highlight from all spans.\r\n  const spans = element.querySelectorAll(\"span[data-word-index]\");\r\n  spans.forEach(span => {\r\n    span.classList.remove(\"bg-yellow-300\");\r\n    span.classList.remove(\"rounded-lg\");\r\n    span.classList.remove(\"text-black\");\r\n  });\r\n\r\n  // Highlight the active word.\r\n  const activeSpan = element.querySelector(`span[data-word-index=\"${activeIndex}\"]`);\r\n  if (activeSpan) {\r\n    activeSpan.classList.add(\"bg-yellow-300\");\r\n    activeSpan.classList.add(\"rounded-lg\");\r\n    activeSpan.classList.add(\"text-black\");\r\n  }\r\n}\r\n\r\n", "import { setCookie, getCookie } from \"./cookies.js\";\r\nimport { state } from \"./state.js\";\r\nimport { translateText } from \"./translations.js\";\r\n\r\n/**\r\n * @module notepad\r\n * @description\r\n * Utilities for managing the user notepad: toggling visibility, saving/loading notes, and persisting state.\r\n */\r\n\r\n/**\r\n * Initializes the notepad button by making it visible if present.\r\n */\r\nexport const initializeNotepad = () => {\r\n  // Show notepad button if not already shown\r\n  const notepadButton = document.getElementById(\"notepad-button\");\r\n  if (notepadButton) {\r\n    notepadButton.classList.remove(\"hidden\");\r\n  }\r\n}\r\n\r\n/**\r\n * Toggles the notepad open or closed, updates state and cookies, and saves/loads notes as needed.\r\n */\r\nexport const toggleNotepad = () => {\r\n  const notepadContent = document.getElementById(\"notepad-content\");\r\n  const notepadButton = document.getElementById(\"notepad-button\");\r\n\r\n  if (notepadContent) {\r\n    const isVisible = !notepadContent.classList.contains(\"hidden\");\r\n\r\n    if (isVisible) {\r\n      state.notepadOpen = false; // Update state to indicate notepad is closed\r\n      setCookie(\"notepadOpen\", \"false\", 30); // Set cookie to indicate notepad is closed\r\n      // Hide notepad\r\n      notepadContent.classList.add(\"hidden\");\r\n      notepadButton.setAttribute(\"aria-expanded\", \"false\");\r\n\r\n      // Save notes when closing\r\n      saveNotes();\r\n    } else {\r\n      state.notepadOpen = true; // Update state to indicate notepad is closed\r\n      setCookie(\"notepadOpen\", \"true\", 30); // Set cookie to indicate notepad is closed\r\n      // Show notepad\r\n      notepadContent.classList.remove(\"hidden\");\r\n      notepadButton.setAttribute(\"aria-expanded\", \"true\");\r\n\r\n      // Focus the textarea\r\n      const textarea = document.getElementById(\"notepad-textarea\");\r\n      if (textarea) {\r\n        setTimeout(() => textarea.focus(), 100);\r\n      }\r\n\r\n      // Load notes\r\n      loadSavedNotes();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Saves the current notes from the textarea to localStorage and shows a confirmation message.\r\n */\r\nexport const saveNotes = () => {\r\n  const textarea = document.getElementById(\"notepad-textarea\");\r\n  const saveStatus = document.getElementById(\"notepad-save-status\");\r\n\r\n  if (textarea) {\r\n    // Save to localStorage\r\n    localStorage.setItem(\"user_notepad\", textarea.value);\r\n\r\n    // Show save confirmation\r\n    if (saveStatus) {\r\n      saveStatus.textContent = translateText(\"notepad-save-success\");\r\n      saveStatus.classList.remove(\"opacity-0\");\r\n      saveStatus.classList.add(\"opacity-100\");\r\n\r\n      // Hide confirmation after 2 seconds\r\n      setTimeout(() => {\r\n        saveStatus.classList.remove(\"opacity-100\");\r\n        saveStatus.classList.add(\"opacity-0\");\r\n      }, 2000);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Loads saved notes from localStorage into the textarea, if any exist.\r\n */\r\nexport const loadSavedNotes = () => {\r\n  const textarea = document.getElementById(\"notepad-textarea\");\r\n\r\n  if (textarea) {\r\n    const savedNotes = localStorage.getItem(\"user_notepad\");\r\n    if (savedNotes !== null) {\r\n      textarea.value = savedNotes;\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Loads the notepad state from cookies and opens the notepad if it was previously open.\r\n */\r\nexport const loadNotepad = () => {\r\n  const notepadOpen = getCookie(\"notepadOpen\") == \"true\";\r\n  if (notepadOpen) {\r\n    toggleNotepad();\r\n  }\r\n}", "// Character name generator for interactive educational content\r\n// This module generates random character names for the application\r\n\r\nconst characterLastNames = {\r\n  masculine: [\r\n    \"R\u00E1pido\", \"Feroz\", \"Dulce\", \"Elegante\", \"Intr\u00E9pido\", \"Valiente\",\r\n    \"Sabio\", \"Astuto\", \"Brillante\", \"Divertido\", \"Amigable\",\r\n    \"Aventurero\", \"Creativo\", \"Misterioso\", \"Encantador\",\r\n    \"Feliz\", \"Simp\u00E1tico\"\r\n  ],\r\n  feminine: [\r\n    \"R\u00E1pida\", \"Feroz\", \"Dulce\", \"Elegante\", \"Intr\u00E9pida\", \"Valiente\",\r\n    \"Sabia\", \"Astuta\", \"Brillante\", \"Divertida\", \"Amigable\",\r\n    \"Aventurera\", \"Creativa\", \"Misteriosa\", \"Encantadora\",\r\n    \"Feliz\", \"Simp\u00E1tica\"\r\n  ]\r\n};\r\n\r\nconst feminineName = {\r\n  // Feminine nouns\r\n  \"Serpiente\": true, \"Jirafa\": true, \"\u00C1guila\": true, \"Ballena\": true,\r\n  \"Estrella\": true, \"Abeja\": true, \"Mariquita\": true, \"Mariposa\": true,\r\n  \"Tortuga\": true, \"Medusa\": true, \"Cebra\": true, \"Sirena\": true,\r\n  // Masculine nouns\r\n  \"Cocodrilo\": false, \"Panda\": false, \"Koala\": false, \"Tigre\": false,\r\n  \"Le\u00F3n\": false, \"Elefante\": false, \"Zorro\": false, \"Lobo\": false,\r\n  \"Oso\": false, \"Conejo\": false, \"Rat\u00F3n\": false, \"Mono\": false,\r\n  \"Mapache\": false, \"Ping\u00FCino\": false, \"Loro\": false, \"B\u00FAho\": false,\r\n  \"Delf\u00EDn\": false, \"Tibur\u00F3n\": false, \"Pulpo\": false, \"Cangrejo\": false,\r\n  \"Pez\": false, \"Cactus\": false, \"Robot\": false,\r\n  \"Dinosaurio\": false, \"Extraterrestre\": false, \"Fantasma\": false,\r\n  \"Genio\": false, \"Mu\u00F1eco de Nieve\": false, \"Caramelo\": false, \"Unicornio\": false\r\n};\r\n\r\nconst characterFirstNames = [\r\n  // Original reptiles\r\n  \"Cocodrilo\", \"Serpiente\",\r\n\r\n  // Mammals\r\n  \"Panda\", \"Koala\", \"Tigre\", \"Le\u00F3n\", \"Elefante\", \"Jirafa\", \"Zorro\",\r\n  \"Lobo\", \"Oso\", \"Conejo\", \"Rat\u00F3n\", \"Mono\", \"Mapache\", \"Cebra\",\r\n\r\n  // Birds\r\n  \"\u00C1guila\", \"Flamenco\", \"Ping\u00FCino\", \"Loro\", \"B\u00FAho\",\r\n\r\n  // Marine life\r\n  \"Delf\u00EDn\", \"Ballena\", \"Tibur\u00F3n\", \"Pulpo\", \"Estrella\", \"Cangrejo\",\r\n  \"Pez\", \"Tortuga\", \"Medusa\", \"Foca\",\r\n\r\n  // Small creatures\r\n  \"Abeja\", \"Mariquita\", \"Mariposa\",\r\n\r\n  // Plants and nature\r\n  \"Cactus\",\r\n\r\n  // Others\r\n  \"Robot\", \"Dinosaurio\", \"Extraterrestre\", \"Fantasma\", \"Genio\",\r\n  \"Sirena\", \"Mu\u00F1eco de Nieve\", \"Caramelo\", \"Unicornio\"\r\n];\r\n\r\nconst characterSounds = [\r\n\r\n];\r\n\r\n// Map to associate animals with their corresponding emojis\r\nconst animalEmojis = {\r\n  //Original Reptiles\r\n  \"Cocodrilo\": \"\uD83D\uDC0A\",\r\n  \"Serpiente\": \"\uD83D\uDC0D\",\r\n  \"Rana\": \"\uD83D\uDC38\",\r\n\r\n  // Mammals\r\n  \"Panda\": \"\uD83D\uDC3C\",\r\n  \"Koala\": \"\uD83D\uDC28\",\r\n  \"Tigre\": \"\uD83D\uDC2F\",\r\n  \"Le\u00F3n\": \"\uD83E\uDD81\",\r\n  \"Elefante\": \"\uD83D\uDC18\",\r\n  \"Jirafa\": \"\uD83E\uDD92\",\r\n  \"Zorro\": \"\uD83E\uDD8A\",\r\n  \"Lobo\": \"\uD83D\uDC3A\",\r\n  \"Oso\": \"\uD83D\uDC3B\",\r\n  \"Conejo\": \"\uD83D\uDC30\",\r\n  \"Rat\u00F3n\": \"\uD83D\uDC2D\",\r\n  \"Mono\": \"\uD83D\uDC12\",\r\n  \"Mapache\": \"\uD83E\uDD9D\",\r\n  \"Cebra\": \"\uD83E\uDD93\",\r\n\r\n  // Birds\r\n  \"\u00C1guila\": \"\uD83E\uDD85\",\r\n  \"Flamenco\": \"\uD83E\uDDA9\",\r\n  \"Ping\u00FCino\": \"\uD83D\uDC27\",\r\n  \"Loro\": \"\uD83E\uDD9C\",\r\n  \"B\u00FAho\": \"\uD83E\uDD89\",\r\n\r\n  // Marine life\r\n  \"Delf\u00EDn\": \"\uD83D\uDC2C\",\r\n  \"Ballena\": \"\uD83D\uDC0B\",\r\n  \"Tibur\u00F3n\": \"\uD83E\uDD88\",\r\n  \"Pulpo\": \"\uD83D\uDC19\",\r\n  \"Estrella\": \"\u2B50\",\r\n  \"Cangrejo\": \"\uD83E\uDD80\",\r\n  \"Pez\": \"\uD83D\uDC20\",\r\n  \"Tortuga\": \"\uD83D\uDC22\",\r\n  \"Medusa\": \"\uD83D\uDC19\",\r\n  \"Foca\": \"\uD83E\uDDAD\",\r\n\r\n  // Small creatures\r\n  \"Abeja\": \"\uD83D\uDC1D\",\r\n  \"Mariquita\": \"\uD83D\uDC1E\",\r\n  \"Mariposa\": \"\uD83E\uDD8B\",\r\n\r\n  // Plants and nature\r\n  \"Cactus\": \"\uD83C\uDF35\",\r\n\r\n  // Others\r\n  \"Robot\": \"\uD83E\uDD16\",\r\n  \"Dinosaurio\": \"\uD83E\uDD96\",\r\n  \"Extraterrestre\": \"\uD83D\uDC7D\",\r\n  \"Fantasma\": \"\uD83D\uDC7B\",\r\n  \"Genio\": \"\uD83E\uDDDE\u200D\u2642\uFE0F\",\r\n  \"Sirena\": \"\uD83E\uDDDC\u200D\u2640\uFE0F\",\r\n  \"Mu\u00F1eco de Nieve\": \"\u26C4\uFE0F\",\r\n  \"Caramelo\": \"\uD83C\uDF6D\",\r\n  \"Unicornio\": \"\uD83E\uDD84\",\r\n};\r\n\r\n/**\r\n * Generates a unique student ID\r\n * This ID stays consistent for a student even if they change their character\r\n * @returns {string} A unique identifier for the student\r\n */\r\nexport function generateStudentID() {\r\n  // Generate a random alphanumeric ID with a timestamp prefix to ensure uniqueness\r\n  const timestamp = Date.now().toString(36); // Convert timestamp to base36\r\n  const randomPart = Math.random().toString(36).substring(2, 10); // 8 characters of randomness\r\n\r\n  //return `student-${timestamp}-${randomPart}`;\r\n  return `${randomPart}`;\r\n}\r\n\r\n/**\r\n * Generates a random character name\r\n * @returns {Object} Object containing first name, last name, full name, and emoji\r\n */\r\nexport function generateRandomCharacterName() {\r\n  const randomFirstName = characterFirstNames[Math.floor(Math.random() * characterFirstNames.length)];\r\n\r\n  // Select from feminine or masculine last names based on the gender of the first name\r\n  const isFeminine = feminineName[randomFirstName] === true;\r\n  const lastNamesList = isFeminine ? characterLastNames.feminine : characterLastNames.masculine;\r\n  const randomLastName = lastNamesList[Math.floor(Math.random() * lastNamesList.length)];\r\n\r\n  const emoji = animalEmojis[randomFirstName] || \"\uD83E\uDD96\";\r\n\r\n  return {\r\n    firstName: randomFirstName,\r\n    lastName: randomLastName,\r\n    fullName: `${randomFirstName} ${randomLastName}`,\r\n    emoji: emoji\r\n  };\r\n}\r\n\r\n// Function to get a character greeting with the name\r\nexport function getCharacterGreeting(characterName) {\r\n  const greetings = [\r\n    `\u00A1Hola! Soy ${characterName}, tu compa\u00F1ero de aprendizaje.`,\r\n    `\u00A1Bienvenido! Me llamo ${characterName} y te acompa\u00F1ar\u00E9 en esta aventura.`,\r\n    `\u00A1Saludos! ${characterName} a tu servicio para aprender juntos.`\r\n  ];\r\n\r\n  return greetings[Math.floor(Math.random() * greetings.length)];\r\n}", "// Character display script for index page\r\nimport { generateRandomCharacterName, getCharacterGreeting, generateStudentID } from './character-generator.js';\r\nimport { setState } from './state.js';\r\nimport { announceToScreenReader } from './ui_utils.js';\r\nimport { translateText } from './translations.js';\r\n\r\n/**\r\n * Generate a new character and update the display and localStorage\r\n */\r\nfunction regenerateCharacter() {\r\n  // Generate a new character\r\n  const character = generateRandomCharacterName();\r\n\r\n  // Get the existing student ID (don't regenerate it)\r\n  const studentID = localStorage.getItem('studentID');\r\n\r\n  // Save to localStorage\r\n  localStorage.setItem('characterInfo', JSON.stringify(character));\r\n  localStorage.setItem('nameUser', character.fullName);\r\n\r\n  // Update state\r\n  setState('characterName', character.fullName);\r\n  setState('characterEmoji', character.emoji);\r\n  setState('studentID', studentID);\r\n\r\n  //   // Generate a new greeting\r\n  //   const greeting = getCharacterGreeting(character.fullName);\r\n  //   setState('characterGreeting', greeting);\r\n\r\n  // Update UI elements\r\n  updateCharacterDisplay(character, studentID);\r\n\r\n  // Also update the character in the sidebar\r\n  updateSidebarCharacter(character, studentID);\r\n\r\n  // // Announce the new character to screen readers\r\n  // announceToScreenReader(\r\n  //   `Nuevo personaje generado: ${character.fullName}`\r\n  // );\r\n\r\n  // Announce the new character to screen readers\r\n\r\n  announceToScreenReader(\r\n    translateText(\"character-regenerated-announcement\") + character.fullName\r\n  );\r\n\r\n  // Add a small animation to the emoji\r\n  const emojiElement = document.getElementById('character-emoji');\r\n  if (emojiElement) {\r\n    emojiElement.classList.add('animate-bounce');\r\n    setTimeout(() => {\r\n      emojiElement.classList.remove('animate-bounce');\r\n    }, 1000);\r\n  }\r\n}\r\n\r\n/**\r\n * Update the character display with the given character info\r\n */\r\nfunction updateCharacterDisplay(character, studentID) {\r\n  // Find all character-name elements (there might be multiple on the page)\r\n  const nameElements = document.querySelectorAll('#character-name');\r\n  const emojiElements = document.querySelectorAll('#character-emoji');\r\n  const studentIDElements = document.querySelectorAll('#student-id');\r\n  //const messageElement = document.getElementById('character-message');\r\n\r\n  // Update all name elements\r\n  nameElements.forEach(element => {\r\n    if (element) element.textContent = character.fullName;\r\n  });\r\n\r\n  // Update all emoji elements\r\n  emojiElements.forEach(element => {\r\n    if (element) element.textContent = character.emoji;\r\n  });\r\n\r\n  // Update student ID elements\r\n  studentIDElements.forEach(element => {\r\n    if (element) element.textContent = studentID;\r\n  });\r\n\r\n  // Update the message element\r\n  //   if (messageElement) {\r\n  //     messageElement.textContent = greeting;\r\n  //   }\r\n}\r\n\r\n/**\r\n * Update the character display in the sidebar\r\n */\r\nfunction updateSidebarCharacter(character, studentID) {\r\n  // Update the character name in the sidebar\r\n  const sidebarNameElement = document.getElementById('settings-character-name');\r\n  if (sidebarNameElement) {\r\n    sidebarNameElement.textContent = character.fullName;\r\n  }\r\n\r\n  // Update the character emoji in the sidebar\r\n  const sidebarEmojiElement = document.getElementById('settings-character-emoji');\r\n  if (sidebarEmojiElement) {\r\n    sidebarEmojiElement.textContent = character.emoji;\r\n  }\r\n\r\n  // The student ID is already updated in updateCharacterDisplay function\r\n  // as it selects all elements with the ID 'student-id'\r\n}\r\n\r\n/**\r\n * Initializes the character display on the index page\r\n */\r\nfunction initCharacterDisplay() {\r\n  // Check if we already have a student ID in localStorage\r\n  let studentID = localStorage.getItem('studentID');\r\n\r\n  // If no student ID exists, generate and save one\r\n  if (!studentID) {\r\n    studentID = generateStudentID();\r\n    localStorage.setItem('studentID', studentID);\r\n  }\r\n\r\n  // Store the student ID in state\r\n  setState('studentID', studentID);\r\n\r\n  // Check if we already have a character in localStorage\r\n  const existingCharacter = localStorage.getItem('characterInfo');\r\n  let character;\r\n\r\n  if (existingCharacter) {\r\n    // Use the existing character\r\n    character = JSON.parse(existingCharacter);\r\n  } else {\r\n    // Generate a new character and save to localStorage\r\n    character = generateRandomCharacterName();\r\n    localStorage.setItem('characterInfo', JSON.stringify(character));\r\n\r\n    // Also save the character name as nameUser for the send-email.js function\r\n    localStorage.setItem('nameUser', character.fullName);\r\n  }\r\n\r\n  // Store the character in state for use across the application\r\n  setState('characterName', character.fullName);\r\n  setState('characterEmoji', character.emoji);\r\n\r\n  //   // Generate a greeting with the character name\r\n  //   const greeting = getCharacterGreeting(character.fullName);\r\n  //   setState('characterGreeting', greeting);\r\n\r\n  // Update the display\r\n  updateCharacterDisplay(character, studentID);\r\n\r\n  // Also update the sidebar character display\r\n  updateSidebarCharacter(character, studentID);\r\n\r\n  // Set up the refresh button event handler\r\n  const refreshButton = document.getElementById('refresh-character');\r\n  if (refreshButton) {\r\n    refreshButton.addEventListener('click', regenerateCharacter);\r\n  }\r\n}\r\n\r\nexport { initCharacterDisplay, regenerateCharacter };", "/**\r\n * @module tutorial\r\n * @description\r\n * Provides the onboarding tutorial for new users, including welcome dialog, step-by-step UI guidance, accessibility support, and keyboard navigation.\r\n */\r\nimport { translateText } from './translations.js'; // Import translation function\r\nimport { announceToScreenReader } from './ui_utils.js'; // Import screen reader utility\r\n\r\n// Tutorial module for onboarding new users\r\nconst TUTORIAL_SEEN_KEY = 'tutorial_completed';\r\n\r\n// Tutorial steps content (can be translated later)\r\nconst tutorialSteps = [\r\n  {\r\n    title: \"1/3\",\r\n    content: \"tutorial-step-1-content\",\r\n    position: \"left\", // Position of the tooltip relative to the UI element\r\n    arrow: \"left\", // Arrow direction\r\n    targetElementId: \"nav-popup\", // ID of the element this step points to\r\n    targetElementClass: \"nav__toggle\" // Class to identify when cloning the element\r\n  },\r\n  {\r\n    title: \"2/3\",\r\n    content: \"tutorial-step-2-content\",\r\n    position: \"center\",\r\n    arrow: \"bottom\",\r\n    targetElementId: \"back-forward-buttons\",\r\n    targetElementClass: \"navigation-buttons\"\r\n  },\r\n  {\r\n    title: \"3/3\",\r\n    content: \"tutorial-step-3-content\",\r\n    position: \"right\",\r\n    arrow: \"right\",\r\n    targetElementId: \"open-sidebar\",\r\n    targetElementClass: \"sidebar-toggle\"\r\n  }\r\n];\r\n\r\nlet currentStepIndex = 0;\r\nlet tutorialOverlay;\r\nlet tutorialPopup;\r\nlet welcomePopup;\r\nlet popupContainer;\r\n\r\n/**\r\n * Shows the welcome dialog before starting the tutorial.\r\n * Checks if the tutorial has already been completed and, if not, displays the welcome overlay.\r\n */\r\nexport const showWelcome = () => {\r\n  //Check if user has already seen the tutorial\r\n  if (localStorage.getItem(TUTORIAL_SEEN_KEY) === 'true') {\r\n    return;\r\n  }\r\n\r\n  // Create overlay\r\n  tutorialOverlay = document.createElement('div');\r\n  tutorialOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';\r\n  tutorialOverlay.setAttribute('role', 'dialog');\r\n  tutorialOverlay.setAttribute('aria-modal', 'true');\r\n  tutorialOverlay.setAttribute('aria-labelledby', 'welcome-title');\r\n  tutorialOverlay.setAttribute('aria-describedby', 'welcome-description');\r\n\r\n  // Create welcome popup\r\n  welcomePopup = document.createElement('div');\r\n  welcomePopup.className = 'bg-white rounded-lg shadow-lg p-6 max-w-[400px] relative z-[10001] pointer-events-auto text-center animate-tutorialPopIn';\r\n  welcomePopup.setAttribute('tabindex', '0'); // Make focusable\r\n\r\n  // Add wave emoji\r\n  const emoji = document.createElement('div');\r\n  emoji.className = 'text-[48px] mb-2';\r\n  emoji.textContent = '\uD83D\uDC4B';\r\n  emoji.setAttribute('role', 'img');\r\n  emoji.setAttribute('aria-label', translateText(\"tutorial-welcome-emoji-label\")); // Add aria-label for screen readers\r\n\r\n  // Add welcome title\r\n  const welcomeTitle = document.createElement('h2');\r\n  welcomeTitle.className = 'text-2xl font-bold mb-2';\r\n  welcomeTitle.id = 'welcome-title'; // Add ID for aria-labelledby\r\n  welcomeTitle.setAttribute('tabindex', '-1'); // Make focusable\r\n\r\n  //welcomeTitle.textContent = 'Welcome to Cuaderno 5';\r\n  // Spanish version of the text.\r\n  welcomeTitle.textContent = translateText(\"tutorial-welcome-title\");\r\n\r\n  // Add subtitle text\r\n  const welcomeText = document.createElement('p');\r\n  welcomeText.className = 'text-xl mb-5';\r\n  //welcomeText.innerHTML = 'in its new accessible format!';\r\n  // Spanish version of the text.\r\n  welcomeText.innerHTML = translateText(\"tutorial-welcome-content\");\r\n\r\n  // Add description\r\n  const description = document.createElement('p');\r\n  description.className = 'text-gray-600 leading-snug mb-6 text-base';\r\n  description.id = 'welcome-description'; // Add ID for aria-describedby\r\n  //description.innerHTML = \"Before you dive in, here's a quick tour to show you how to navigate, use the menu, and access helpful features. It won't take long!\";\r\n  // Spanish version of the text.\r\n  description.innerHTML = translateText(\"tutorial-description-content\");\r\n\r\n  // Add start button\r\n  const startButton = document.createElement('button');\r\n  startButton.textContent = translateText(\"tutorial-start-button-content\");\r\n  startButton.className = 'bg-blue-600 text-white font-medium py-2 px-4 rounded cursor-pointer border-0 hover:bg-blue-700 text-base py-2 px-5';\r\n  startButton.setAttribute('aria-label', translateText(\"tutorial-start-button-aria-label\"));\r\n\r\n  // Add exit button with a grey x in the top right\r\n  const exitButton = document.createElement('button');\r\n  exitButton.className = 'absolute top-2.5 right-5 bg-transparent border-0 cursor-pointer text-2xl text-gray-600';\r\n  exitButton.setAttribute('aria-label', translateText(\"tutorial-exit-button-aria-label\"));\r\n  exitButton.textContent = '\u00D7'; // Using proper multiplication symbol instead of x\r\n\r\n  exitButton.addEventListener('click', () => {\r\n    // Close the welcome popup\r\n    tutorialOverlay.remove();\r\n    localStorage.setItem(TUTORIAL_SEEN_KEY, 'true'); // Mark tutorial as seen\r\n\r\n    // Announce to screen readers that the tutorial is closed, but remind about shortcuts\r\n    announceToScreenReader(\r\n      translateText(\"tutorial-closed-announcement\")\r\n    );\r\n    const mainContent = document.querySelector('main, [role=\"main\"], .container');\r\n    if (mainContent) {\r\n      mainContent.setAttribute('tabindex', '-1');\r\n      mainContent.focus();\r\n    }\r\n  });\r\n  // Append exit button to welcome popup\r\n  welcomePopup.appendChild(exitButton);\r\n  // Add event listener to exit button\r\n\r\n  startButton.addEventListener('click', () => {\r\n    // Hide welcome popup\r\n    welcomePopup.remove();\r\n\r\n    // Show tutorial steps\r\n    showTutorial();\r\n\r\n    // Announce first step with reminder of shortcuts\r\n    announceToScreenReader(translateText(\"tutorial-starting-announcement\"));\r\n  });\r\n\r\n  // Add elements to welcome popup\r\n  welcomePopup.appendChild(emoji);\r\n  welcomePopup.appendChild(welcomeTitle);\r\n  welcomePopup.appendChild(welcomeText);\r\n  welcomePopup.appendChild(description);\r\n  welcomePopup.appendChild(startButton);\r\n\r\n  // Add welcome popup to overlay\r\n  tutorialOverlay.appendChild(welcomePopup);\r\n\r\n  // Make tutorial visible\r\n  document.body.appendChild(tutorialOverlay);\r\n\r\n  // Add keyboard event listeners\r\n  setupKeyboardNavigation(welcomePopup, [startButton]);\r\n\r\n  // Announce welcome message with keyboard shortcuts to screen readers\r\n  announceToScreenReader(translateText(\"tutorial-welcome-announcement\"));\r\n\r\n  // Improved focus management\r\n  setTimeout(() => {\r\n    welcomeTitle.focus();\r\n  }, 100);\r\n}\r\n\r\n/**\r\n * Creates and shows the tutorial overlay with step-by-step guidance.\r\n * Initializes the tutorial popup and displays the first step.\r\n */\r\nexport const showTutorial = () => {\r\n  // Create popup for tutorial steps\r\n  tutorialPopup = document.createElement('div');\r\n  tutorialPopup.className = 'bg-white rounded-lg shadow-lg p-6 max-w-[350px] relative z-[10001] pointer-events-auto animate-tutorialPopIn';\r\n  tutorialPopup.setAttribute('tabindex', '0'); // Make focusable\r\n  tutorialPopup.setAttribute('role', 'dialog');\r\n  tutorialPopup.setAttribute('aria-modal', 'true');\r\n\r\n  // Add to overlay\r\n  tutorialOverlay.appendChild(tutorialPopup);\r\n\r\n  // Show first step\r\n  showStep(0);\r\n}\r\n\r\n/**\r\n * Shows a specific tutorial step, clones the relevant UI element, and positions the popup.\r\n * Handles accessibility, focus management, and screen reader announcements.\r\n * @param {number} index - The index of the tutorial step to show.\r\n * @private\r\n */\r\nconst showStep = (index) => {\r\n  if (index < 0 || index >= tutorialSteps.length) return;\r\n\r\n  currentStepIndex = index;\r\n  const step = tutorialSteps[index];\r\n\r\n  // Clear previous content\r\n  tutorialPopup.innerHTML = '';\r\n\r\n  // Update aria attributes for the current step\r\n  tutorialPopup.setAttribute('aria-labelledby', `tutorial-title-${index}`);\r\n  tutorialPopup.setAttribute('aria-describedby', `tutorial-content-${index}`);\r\n\r\n  // Get the actual target element\r\n  const targetElement = document.getElementById(step.targetElementId);\r\n  if (!targetElement) {\r\n    console.error(`Target element #${step.targetElementId} not found`);\r\n    return;\r\n  }\r\n\r\n  // Remove any previous cloned elements\r\n  const existingClonedElement = document.querySelector('.cloned-element-container');\r\n  if (existingClonedElement) {\r\n    existingClonedElement.remove();\r\n  }\r\n\r\n  // Create a container for the cloned element\r\n  const clonedElementContainer = document.createElement('div');\r\n  clonedElementContainer.className = 'fixed z-[10002] pointer-events-none cloned-element-container';\r\n  clonedElementContainer.setAttribute('aria-hidden', 'true'); // Hide from screen readers as it's decorative\r\n\r\n  // Create an exact clone of the element using proper Tailwind classes\r\n  let clonedElement;\r\n\r\n  // Special handling for the navigation popup button (1st step)\r\n  if (step.targetElementId === 'nav-popup') {\r\n    clonedElement = document.createElement('button');\r\n    clonedElement.id = 'cloned-nav-popup';\r\n    clonedElement.className = 'px-4 py-3 bg-white text-gray-800 rounded-lg shadow-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50 aria-expanded:bg-blue-700 aria-expanded:text-white';\r\n    clonedElement.setAttribute('aria-label', translateText(\"context-index-menu\"));\r\n    clonedElement.setAttribute('type', 'button');\r\n\r\n    // Add the icon\r\n    const icon = document.createElement('i');\r\n    icon.className = 'fas fa-list';\r\n    icon.setAttribute('aria-hidden', 'true');\r\n\r\n    // Append icon to button\r\n    clonedElement.appendChild(icon);\r\n  }\r\n  // Special handling for other elements\r\n  else if (step.targetElementId === 'back-forward-buttons') {\r\n    // Clone the navigation buttons\r\n    clonedElement = document.createElement('div');\r\n    clonedElement.id = 'cloned-back-forward-buttons';\r\n    clonedElement.className = 'flex flex-row-reverse items-center bg-white border border-gray-300 rounded-2xl shadow-md';\r\n\r\n    // Create the forward button\r\n    const forwardButton = document.createElement('button');\r\n    forwardButton.className = 'text-2xl no-underline text-gray-800 px-4 py-2';\r\n    forwardButton.setAttribute('aria-label', 'Next page');\r\n    const forwardIcon = document.createElement('i');\r\n    forwardIcon.className = 'fas fa-chevron-right';\r\n    forwardButton.appendChild(forwardIcon);\r\n\r\n    // Create the page number span\r\n    const pageSpan = document.createElement('span');\r\n    pageSpan.textContent = '1'; // Placeholder for page number\r\n    pageSpan.className = 'align-text-bottom no-underline text-gray-800 px-4 py-2 text-2xl border-r border-gray-300';\r\n\r\n    // Create the back button\r\n    const backButton = document.createElement('button');\r\n    backButton.className = 'text-2xl no-underline text-gray-800 px-4 py-2 border-r border-gray-300';\r\n    backButton.setAttribute('aria-label', translateText(\"previous\"));\r\n    const backIcon = document.createElement('i');\r\n    backIcon.className = 'fas fa-chevron-left';\r\n    backButton.appendChild(backIcon);\r\n\r\n    // Append all elements to the container\r\n    clonedElement.appendChild(forwardButton);\r\n    clonedElement.appendChild(pageSpan);\r\n    clonedElement.appendChild(backButton);\r\n  }\r\n  else if (step.targetElementId === 'open-sidebar') {\r\n    // Clone the sidebar toggle button\r\n    clonedElement = document.createElement('button');\r\n    clonedElement.id = 'cloned-open-sidebar';\r\n    clonedElement.className = 'w-12 h-12 flex items-center justify-center rounded-full bg-white hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-blue-500 shadow-lg';\r\n    clonedElement.setAttribute('aria-label', translateText(\"tutorial-smart-utility-sidebar-label\"));\r\n\r\n    // Add the icon\r\n    const icon = document.createElement('i');\r\n    icon.className = 'fa fa-universal-access text-4xl text-gray-800';\r\n\r\n    // Append icon to button\r\n    clonedElement.appendChild(icon);\r\n  }\r\n  else {\r\n    // Generic fallback cloning\r\n    clonedElement = targetElement.cloneNode(true);\r\n    clonedElement.id = `cloned-${step.targetElementId}`;\r\n  }\r\n\r\n  // Make the cloned element non-interactive but visible\r\n  clonedElement.style.pointerEvents = 'none';\r\n  clonedElement.className += ' cloned-interface-element flex items-center justify-center border-2 border-blue-500/80 rounded-lg bg-white shadow-tutorial animate-pulseBorder';\r\n  clonedElement.setAttribute('aria-hidden', 'true'); // Hide from screen readers\r\n\r\n  // Position the cloned element based on original element position\r\n  positionClonedElement(clonedElementContainer, targetElement, step.position);\r\n\r\n  // Add the cloned element to its container\r\n  clonedElementContainer.appendChild(clonedElement);\r\n\r\n  // Add the container to the overlay\r\n  tutorialOverlay.appendChild(clonedElementContainer);\r\n\r\n  // Update popup position based on step\r\n  updatePopupPosition(step.position, targetElement);\r\n\r\n  // Add arrow\r\n  if (step.arrow) {\r\n    const arrow = document.createElement('div');\r\n    arrow.className = `absolute w-0 h-0 border-solid ${step.arrow === 'left'\r\n        ? 'border-y-[10px] border-r-[15px] border-y-transparent border-r-white left-[-15px] top-[90%] -translate-y-1/2'\r\n        : step.arrow === 'right'\r\n          ? 'border-y-[10px] border-l-[15px] border-y-transparent border-l-white right-[-15px] top-[6%] -translate-y-1/2'\r\n          : step.arrow === 'top'\r\n            ? 'border-x-[10px] border-b-[15px] border-x-transparent border-b-white top-[-15px] left-1/2 -translate-x-1/2'\r\n            : step.arrow === 'bottom'\r\n              ? 'border-x-[10px] border-t-[15px] border-x-transparent border-t-white bottom-[-15px] left-1/2 -translate-x-1/2'\r\n              : ''\r\n      }`;\r\n    arrow.setAttribute('aria-hidden', 'true'); // Hide from screen readers as it's decorative\r\n    tutorialPopup.appendChild(arrow);\r\n  }\r\n\r\n  // Create content\r\n  const titleEl = document.createElement('h3');\r\n  titleEl.className = 'text-xl font-semibold mb-4 text-gray-800';\r\n  titleEl.id = `tutorial-title-${index}`;\r\n  titleEl.textContent = step.title;\r\n\r\n  const contentEl = document.createElement('div'); // Changed to div for better HTML content support\r\n  contentEl.className = 'mb-6 text-gray-600 leading-snug text-lg';\r\n  contentEl.id = `tutorial-content-${index}`;\r\n\r\n  // Set content directly as HTML - no additional processing needed\r\n  contentEl.innerHTML = translateText(step.content);\r\n\r\n  // Create buttons container\r\n  const buttonsContainer = document.createElement('div');\r\n  buttonsContainer.className = 'flex justify-between items-center';\r\n\r\n  // Skip button (always visible)\r\n  const skipButton = document.createElement('button');\r\n  skipButton.textContent = translateText(\"tutorial-skip\");\r\n  skipButton.className = 'text-gray-500 text-sm p-2 cursor-pointer bg-none border-0 hover:text-gray-600 hover:underline underline';\r\n  skipButton.addEventListener('click', completeTutorial);\r\n\r\n  // Action button (Next or Finish based on step)\r\n  const actionButton = document.createElement('button');\r\n  if (index === tutorialSteps.length - 1) {\r\n    actionButton.textContent = translateText(\"finish\");\r\n    actionButton.className = 'bg-blue-600 text-white font-medium py-2 px-4 rounded cursor-pointer border-0 hover:bg-blue-700';\r\n    actionButton.addEventListener('click', completeTutorial);\r\n  } else {\r\n    actionButton.textContent = translateText('next');\r\n    actionButton.className = 'bg-blue-600 text-white font-medium py-2 px-4 rounded cursor-pointer border-0 hover:bg-blue-700';\r\n    actionButton.addEventListener('click', () => {\r\n      showStep(index + 1);\r\n    });\r\n  }\r\n\r\n  // Add buttons to container\r\n  buttonsContainer.appendChild(skipButton);\r\n  buttonsContainer.appendChild(actionButton);\r\n\r\n  // Add all elements to popup\r\n  tutorialPopup.appendChild(titleEl);\r\n  tutorialPopup.appendChild(contentEl);\r\n  tutorialPopup.appendChild(buttonsContainer);\r\n\r\n  // Set focus to the tutorial popup for accessibility\r\n  tutorialPopup.focus();\r\n\r\n  // Add keyboard event listeners for this step\r\n  setupKeyboardNavigation(tutorialPopup, [skipButton, actionButton]);\r\n\r\n  // Announce to screen readers that a new step is shown\r\n  const newIndex = index + 1; // Adjust for 1-based index\r\n  const stepContent = translateText(\"tutorial-step-\" + newIndex + \"-content-announcement\");\r\n  announceToScreenReader(\r\n    translateText(\"tutorial-step-announcement\", {\r\n      currentStep: newIndex,\r\n      totalSteps: tutorialSteps.length,\r\n      stepContent: stepContent\r\n    })\r\n  );\r\n}\r\n\r\n/**\r\n * Sets up keyboard navigation for the tutorial popup.\r\n * Handles Escape and Tab key events for accessibility.\r\n * @param {HTMLElement} container - The popup container.\r\n * @param {HTMLElement[]} focusableElements - Array of focusable elements within the popup.\r\n * @private\r\n */\r\nconst setupKeyboardNavigation = (container, focusableElements) => {\r\n  container.addEventListener('keydown', (event) => {\r\n    // Handle Escape key to exit tutorial\r\n    if (event.key === 'Escape') {\r\n      completeTutorial();\r\n      event.preventDefault();\r\n    }\r\n\r\n    // Handle Tab key for focus management\r\n    if (event.key === 'Tab') {\r\n      if (focusableElements.length === 0) return;\r\n\r\n      const firstElement = focusableElements[0];\r\n      const lastElement = focusableElements[focusableElements.length - 1];\r\n\r\n      // Shift+Tab on first element should loop to last\r\n      if (event.shiftKey && document.activeElement === firstElement) {\r\n        lastElement.focus();\r\n        event.preventDefault();\r\n      }\r\n      // Tab on last element should loop to first\r\n      else if (!event.shiftKey && document.activeElement === lastElement) {\r\n        firstElement.focus();\r\n        event.preventDefault();\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\n/**\r\n * Positions the cloned element container to match the original element's position and size.\r\n * @param {HTMLElement} container - The cloned element container.\r\n * @param {HTMLElement} originalElement - The original UI element.\r\n * @param {string} position - The tutorial step position (left, center, right).\r\n * @private\r\n */\r\nconst positionClonedElement = (container, originalElement, position) => {\r\n  const rect = originalElement.getBoundingClientRect();\r\n\r\n  container.style.position = 'absolute';\r\n  container.style.left = `${rect.left}px`;\r\n  container.style.top = `${rect.top}px`;\r\n  container.style.width = `${rect.width}px`;\r\n  container.style.height = `${rect.height}px`;\r\n  container.style.zIndex = '10002'; // Higher than the overlay\r\n}\r\n\r\n/**\r\n * Updates the tutorial popup's position based on the target UI element and step position.\r\n * @param {string} position - The tutorial step position (left, center, right).\r\n * @param {HTMLElement} targetElement - The target UI element.\r\n * @private\r\n */\r\nconst updatePopupPosition = (position, targetElement) => {\r\n  // Reset any previous positioning\r\n  tutorialPopup.style.position = 'absolute';\r\n  tutorialPopup.style.top = '';\r\n  tutorialPopup.style.bottom = '';\r\n  tutorialPopup.style.left = '';\r\n  tutorialPopup.style.right = '';\r\n  tutorialPopup.style.transform = '';\r\n\r\n  // Get the bounding rectangle of the target element\r\n  const targetRect = targetElement.getBoundingClientRect();\r\n\r\n  // Position the popup based on the target element and the step position\r\n  switch (position) {\r\n    case 'left':\r\n      // Position near the left element (nav popup) - now using bottom positioning\r\n      tutorialPopup.style.left = `${targetRect.right + 20}px`;\r\n      // Calculate bottom position rather than top\r\n      tutorialPopup.style.bottom = `${window.innerHeight - targetRect.bottom + 20}px`;\r\n      break;\r\n    case 'center':\r\n      // Position above the navigation arrows\r\n      tutorialPopup.style.bottom = `${window.innerHeight - targetRect.top + 20}px`;\r\n      tutorialPopup.style.left = `${targetRect.left + (targetRect.width / 2) - 175}px`;\r\n      break;\r\n    case 'right':\r\n      // Position near the right element (accessibility button)\r\n      tutorialPopup.style.right = `${window.innerWidth - targetRect.left + 20}px`;\r\n      tutorialPopup.style.top = `${targetRect.top + (targetRect.height / 2) - 10}px`;\r\n      break;\r\n    default:\r\n      // Default to center if position is not recognized\r\n      tutorialPopup.style.top = '50%';\r\n      tutorialPopup.style.left = '50%';\r\n      tutorialPopup.style.transform = 'translate(-50%, -50%)';\r\n  }\r\n}\r\n\r\n/**\r\n * Marks the tutorial as complete, removes overlays, and restores focus.\r\n * Announces completion to screen readers.\r\n * @private\r\n */\r\nconst completeTutorial = () => {\r\n  // Mark as seen in localStorage\r\n  localStorage.setItem(TUTORIAL_SEEN_KEY, 'true');\r\n\r\n  // Remove overlay with a fade-out effect\r\n  tutorialOverlay.style.opacity = '0';\r\n  tutorialOverlay.style.transition = 'opacity 0.3s ease';\r\n\r\n  // Remove popup container if it exists\r\n  if (popupContainer) {\r\n    popupContainer.style.opacity = '0';\r\n    popupContainer.style.transition = 'opacity 0.3s ease';\r\n  }\r\n\r\n  // Remove the live region\r\n  const liveRegion = document.getElementById('tutorial-announcer');\r\n  if (liveRegion) {\r\n    liveRegion.remove();\r\n  }\r\n\r\n  setTimeout(() => {\r\n    if (tutorialOverlay && tutorialOverlay.parentNode) {\r\n      tutorialOverlay.parentNode.removeChild(tutorialOverlay);\r\n    }\r\n    if (popupContainer && popupContainer.parentNode) {\r\n      popupContainer.parentNode.removeChild(popupContainer);\r\n    }\r\n\r\n    // Focus on main content instead of tutorial target element\r\n    // First try to find h1, then content div as fallback\r\n    const h1Element = document.querySelector('h1');\r\n    const contentElement = document.getElementById('content');\r\n\r\n    if (h1Element) {\r\n      h1Element.setAttribute('tabindex', '-1');\r\n      h1Element.focus();\r\n    } else if (contentElement) {\r\n      contentElement.setAttribute('tabindex', '-1');\r\n      contentElement.focus();\r\n    }\r\n\r\n    // Announce that tutorial is closed\r\n    announceToScreenReader(translateText(\"tutorial-completed-announcement\"));\r\n  }, 300);\r\n}\r\n\r\n/**\r\n * Resets the tutorial completion status in localStorage (for testing/development).\r\n */\r\nexport const resetTutorial = () => {\r\n  localStorage.removeItem(TUTORIAL_SEEN_KEY);\r\n}\r\n\r\n/**\r\n * Initializes the tutorial, optionally forcing it to show via URL parameter.\r\n * Shows the welcome screen and then the tutorial.\r\n */\r\nexport const initTutorial = () => {\r\n  // Check if we need to force show tutorial via URL parameter\r\n  if (window.location.hash.includes('showTutorial')) {\r\n    resetTutorial();\r\n  }\r\n\r\n  // Show welcome screen first, then tutorial\r\n  setTimeout(showWelcome, 300); // Increased delay to ensure all UI elements are loaded\r\n}\r\n\r\n/**\r\n * Entry point for initializing the tutorial module.\r\n */\r\nexport function init() {\r\n  initTutorial();\r\n}", "import { initializeAdminPopup } from \"./modules/admin_popup.js\";\r\nimport {\r\n  changeAudioSpeed,\r\n  initializeAudioSpeed,\r\n  playNextAudio,\r\n  playPreviousAudio,\r\n  togglePlayPause,\r\n  toggleReadAloud,\r\n  initializeTtsQuickToggle,\r\n} from \"./modules/audio.js\";\r\nimport { initializeWordByWordHighlighter } from \"./modules/tts_highlighter.js\";\r\nimport { getCookie, eraseCookie, setCookie } from \"./modules/cookies.js\";\r\nimport {\r\n  handleInitializationError,\r\n  showMainContent,\r\n} from \"./modules/error_utils.js\";\r\nimport {\r\n  initializeLanguageDropdown,\r\n  cacheInterfaceElements,\r\n  getCachedInterface,\r\n  getCachedNavigation,\r\n  initializePlayBar,\r\n  initializeSidebar,\r\n  loadEasyReadMode,\r\n  restoreInterfaceElements,\r\n  switchLanguage,\r\n  toggleEasyReadMode,\r\n  toggleSyllablesMode,\r\n  toggleGlossaryMode,\r\n  highlightGlossaryTerms,\r\n  togglePlayBarSettings,\r\n  toggleSidebar,\r\n  updatePageNumber,\r\n  formatNavigationItems,\r\n  initializeNavigation,\r\n  toggleStateMode,\r\n  loadStateMode,\r\n  toggleSignLanguageMode,\r\n  loadSignLanguageMode,\r\n  adjustLayout,\r\n  initializeSignLanguage\r\n  //checkWindowsScaling\r\n  //adjustPageScale\r\n} from \"./modules/interface.js\";\r\nimport { initializeZoomController, testZoomNow } from \"./modules/browser_zoom_controller.js\";\r\nimport {\r\n  handleKeyboardShortcuts,\r\n  handleNavigation,\r\n  nextPage,\r\n  toggleNav,\r\n  previousPage,\r\n  setupClickOutsideHandler,\r\n  initializeNavTabs,\r\n  setNavigationData,\r\n} from \"./modules/navigation.js\";\r\nimport { setState, state } from \"./modules/state.js\";\r\nimport { setupTranslations } from \"./modules/translations.js\";\r\nimport {\r\n  initializeAutoplay,\r\n  loadAutoplayState,\r\n  loadDescribeImagesState,\r\n  loadGlossaryState,\r\n  toggleAutoplay,\r\n  toggleDescribeImages,\r\n  toggleEli5Mode,\r\n  handleEli5Popup,\r\n  initializeAudioElements,\r\n  initializeGlossary,\r\n  initializeTabs,\r\n  initializeReferencePage,\r\n  setAutoplayContainerVisibility,\r\n  setDescribeImagesContainerVisibility,\r\n  updateTtsOptionsContainerVisibility,\r\n  loadToggleButtonState,\r\n  initializeEli5\r\n} from \"./modules/ui_utils.js\";\r\nimport {\r\n  toggleNotepad,\r\n  saveNotes,\r\n  loadSavedNotes,\r\n  loadNotepad,\r\n  initializeNotepad\r\n} from \"./modules/notepad.js\";\r\nimport { prepareActivity } from \"./activity.js\";\r\nimport { initializeQuizActivity } from \"./modules/activities/quiz.js\";\r\nimport { initCharacterDisplay } from \"./modules/character-display.js\"\r\nimport { initMatomo } from \"./modules/analytics.js\";\r\n\r\n// Constants\r\nconst PLACEHOLDER_TITLE = \"Accessible Digital Textbook\";\r\nconst basePath = window.location.pathname.substring(\r\n  0,\r\n  window.location.pathname.lastIndexOf(\"/\") + 1\r\n);\r\n\r\n// Create a centralized asset loader\r\nconst assetLoader = {\r\n  cache: new Map(),\r\n\r\n  async load(paths) {\r\n    try {\r\n      const promises = paths.map(path =>\r\n        this.cache.has(path) ?\r\n          Promise.resolve(this.cache.get(path)) :\r\n          fetch(path)\r\n            .then(response => {\r\n              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);\r\n              return response.text();\r\n            })\r\n            .then(content => {\r\n              this.cache.set(path, content);\r\n              return content;\r\n            })\r\n      );\r\n\r\n      return await Promise.all(promises);\r\n    } catch (error) {\r\n      console.error(\"Error loading assets:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n};\r\n\r\n// Element cache to avoid repetitive DOM lookups\r\nconst elementCache = {\r\n  _cache: new Map(),\r\n\r\n  get(id) {\r\n    if (!this._cache.has(id)) {\r\n      const element = document.getElementById(id);\r\n      this._cache.set(id, element);\r\n    }\r\n    return this._cache.get(id);\r\n  },\r\n\r\n  getAll(selector) {\r\n    const key = `selector:${selector}`;\r\n    if (!this._cache.has(key)) {\r\n      const elements = document.querySelectorAll(selector);\r\n      this._cache.set(key, elements);\r\n    }\r\n    return this._cache.get(key);\r\n  },\r\n\r\n  clear() {\r\n    this._cache.clear();\r\n  }\r\n};\r\n\r\n// Initialize the application\r\ndocument.addEventListener(\"DOMContentLoaded\", async function () {\r\n  try {\r\n    await initializeApp();\r\n  } catch (error) {\r\n    console.error(\"Error initializing application:\", error);\r\n    handleInitializationError();\r\n  }\r\n});\r\n\r\n// Store the current page state before leaving\r\nwindow.addEventListener(\"beforeunload\", () => {\r\n  cacheInterfaceElements();\r\n  //saveInterfaceState();\r\n});\r\n\r\n// Create a structured initialization sequence\r\nasync function initializeApp() {\r\n  try {\r\n    addFavicons();\r\n\r\n    // Ensure DOM is ready\r\n    await waitForDOM();\r\n\r\n    // Initialize in a specific sequence with dependencies\r\n    const initSequence = [\r\n      {\r\n        name: \"Core\",\r\n        fn: initializeCoreFunctionality\r\n      },\r\n      {\r\n        name: \"EventListeners\",\r\n        fn: setupEventListeners,\r\n        dependencies: [\"Core\"]\r\n      },\r\n      {\r\n        name: \"UI\",\r\n        fn: initializeUIComponents,\r\n        dependencies: [\"Core\", \"EventListeners\"]\r\n      },\r\n      {\r\n        name: \"Final\",\r\n        fn: finalizeInitialization,\r\n        dependencies: [\"UI\"]\r\n      }\r\n    ];\r\n\r\n    for (const step of initSequence) {\r\n      await step.fn();\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in initialization:\", error);\r\n    handleInitializationError(error);\r\n  } finally {\r\n    showMainContent();\r\n  }\r\n}\r\n\r\n// Add this function in the initializeApp() function\r\n\r\nfunction addFavicons() {\r\n  const faviconLinks = [\r\n    { rel: \"icon\", type: \"image/x-icon\", href: \"./assets/favicon_io/favicon.ico\" },\r\n    { rel: \"apple-touch-icon\", sizes: \"180x180\", href: \"./assets/favicon_io/apple-touch-icon.png\" },\r\n    { rel: \"icon\", type: \"image/png\", sizes: \"32x32\", href: \"./assets/favicon_io/favicon-32x32.png\" },\r\n    { rel: \"icon\", type: \"image/png\", sizes: \"16x16\", href: \"./assets/favicon_io/favicon-16x16.png\" },\r\n    { rel: \"manifest\", href: \"./assets/favicon_io/site.webmanifest\" }\r\n  ];\r\n\r\n  faviconLinks.forEach(linkData => {\r\n    // Check if link already exists to avoid duplicates\r\n    const exists = Array.from(document.head.querySelectorAll('link')).some(\r\n      link => link.rel === linkData.rel && link.href.includes(linkData.href.split('/').pop())\r\n    );\r\n\r\n    if (!exists) {\r\n      const link = document.createElement('link');\r\n      for (const [attr, value] of Object.entries(linkData)) {\r\n        link.setAttribute(attr, value);\r\n      }\r\n      document.head.appendChild(link);\r\n    }\r\n  });\r\n}\r\n\r\nfunction waitForDOM() {\r\n  return new Promise((resolve) => {\r\n    if (document.readyState === \"complete\") {\r\n      resolve();\r\n    } else {\r\n      window.addEventListener(\"load\", resolve);\r\n    }\r\n  });\r\n}\r\n\r\nfunction showLoadingIndicator() {\r\n  const loader = document.createElement(\"div\");\r\n  loader.id = \"app-loader\";\r\n  loader.className =\r\n    \"fixed top-0 left-0 w-full h-full flex items-center justify-center bg-white z-50\";\r\n  loader.innerHTML = `\r\n       <div class=\"text-center\">\r\n           <div class=\"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin\"></div>\r\n           <p class=\"mt-4 text-gray-600\">Loading...</p>\r\n       </div>\r\n   `;\r\n  document.body.appendChild(loader);\r\n}\r\n\r\nfunction hideLoadingIndicator() {\r\n  const loader = document.getElementById(\"app-loader\");\r\n  if (loader) {\r\n    loader.remove();\r\n  }\r\n}\r\n\r\nfunction restoreNavAndSidebar() {\r\n  const navPopup = document.getElementById(\"navPopup\");\r\n  const sidebar = document.getElementById(\"sidebar\");\r\n\r\n  if (navPopup) navPopup.classList.remove(\"hidden\");\r\n  if (sidebar) sidebar.classList.remove(\"hidden\");\r\n}\r\n\r\nasync function initializeCoreFunctionality() {\r\n  try {\r\n    // First ensure the DOM is fully loaded\r\n    if (document.readyState !== \"complete\") {\r\n      await new Promise((resolve) => {\r\n        window.addEventListener(\"load\", resolve);\r\n      });\r\n    }\r\n\r\n    // Set initial language (without validation since config not loaded yet)\r\n    initializeLanguage();\r\n    initCharacterDisplay();\r\n\r\n    // Initialize components after HTML is definitely loaded\r\n    await fetchAndInjectComponents();\r\n\r\n    // IMPORTANT: Validate and correct language AFTER config is loaded\r\n    // This must happen before translations/glossary are fetched\r\n    initializeLanguage();\r\n\r\n    // Try to initialize language dropdown\r\n    const dropdownInitialized = await initializeLanguageDropdown();\r\n    if (!dropdownInitialized) {\r\n      console.warn(\r\n        \"Language dropdown initialization failed, continuing with other components\"\r\n      );\r\n    }\r\n\r\n    formatNavigationItems();\r\n    // Initialize page numbering\r\n    updatePageNumber();\r\n    await setupTranslations();\r\n\r\n    return true;\r\n  } catch (error) {\r\n    console.error(\"Error in core initialization:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction initializeLanguage() {\r\n  const cookieLanguage = getCookie(\"currentLanguage\");\r\n  const htmlLang = document.getElementsByTagName(\"html\")[0].getAttribute(\"lang\");\r\n  const defaultLanguage = window.appConfig?.languages?.default || htmlLang || \"en\";\r\n  const availableLanguages = window.appConfig?.languages?.available || [];\r\n\r\n  let selectedLanguage = null;\r\n\r\n  // If we have config loaded, validate the cookie language\r\n  if (availableLanguages.length > 0) {\r\n    // Check if cookie language is valid\r\n    if (cookieLanguage && availableLanguages.includes(cookieLanguage)) {\r\n      selectedLanguage = cookieLanguage;\r\n    } else {\r\n      // Cookie is invalid or missing, use default\r\n      if (cookieLanguage && !availableLanguages.includes(cookieLanguage)) {\r\n        console.warn(`Cookie language \"${cookieLanguage}\" not available. Available languages:`, availableLanguages, \". Using default:\", defaultLanguage);\r\n        // Clear invalid cookie on root path\r\n        eraseCookie(\"currentLanguage\", \"/\");\r\n        // Also clear cookie on current page path (in case it was set with specific path)\r\n        const currentPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf(\"/\") + 1);\r\n        if (currentPath !== \"/\") {\r\n          eraseCookie(\"currentLanguage\", currentPath);\r\n        }\r\n      }\r\n      selectedLanguage = defaultLanguage;\r\n      // Set the cookie to the correct language\r\n      setCookie(\"currentLanguage\", defaultLanguage, 7);\r\n    }\r\n  } else {\r\n    // Config not loaded yet, use cookie or fallback\r\n    selectedLanguage = cookieLanguage || defaultLanguage;\r\n  }\r\n\r\n  // Always update state\r\n  setState(\"currentLanguage\", selectedLanguage);\r\n}\r\n\r\nconst handleResponse = async (response) => {\r\n  if (!response.ok) {\r\n    throw new Error(`HTTP error! status: ${response.status}`);\r\n  }\r\n  return response;\r\n};\r\n\r\nasync function fetchAndInjectComponents() {\r\n  try {\r\n    const [interfaceHTML, navHTML, config, pages, toc] = await Promise.all([\r\n      fetch(\"./assets/interface.html\").then(response => response.text()),\r\n      fetch(\"./content/navigation/nav.html\").then(response => response.text()),\r\n      fetch(\"./assets/config.json\").then(response => response.json()),\r\n      fetch(\"./content/pages.json\").then(handleResponse).then(response => response.json()),\r\n      fetch(\"./content/toc.json\").then(handleResponse).then(response => response.json()),\r\n    ]);\r\n\r\n    await injectComponents(interfaceHTML, navHTML, config);\r\n\r\n    initializeNavTabs();\r\n    setNavigationData({ pages, toc });\r\n    formatNavigationItems();\r\n  } catch (error) {\r\n    throw new Error(\"Failed to fetch components: \" + error.message);\r\n  }\r\n};\r\n\r\nasync function injectComponents(interfaceHTML, navHTML, config) {\r\n  try {\r\n    const cachedInterface = getCachedInterface();\r\n    const cachedNavigation = getCachedNavigation();\r\n\r\n    if (cachedInterface && cachedNavigation) {\r\n      const restored = restoreInterfaceElements();\r\n      if (!restored) {\r\n        throw new Error(\"Failed to restore cached interface elements\");\r\n      }\r\n    } else {\r\n      const interfaceContainer = elementCache.get(\"interface-container\");\r\n      const navContainer = elementCache.get(\"nav-container\");\r\n\r\n      if (!interfaceContainer || !navContainer) {\r\n        throw new Error(\"Required containers not found\");\r\n      }\r\n\r\n      interfaceContainer.innerHTML = interfaceHTML;\r\n      navContainer.innerHTML = navHTML;\r\n\r\n      // Clear cache since DOM has changed\r\n      elementCache.clear();\r\n\r\n      cacheInterfaceElements();\r\n    }\r\n\r\n    setupConfig(config);\r\n  } catch (error) {\r\n    console.error(\"Error injecting components:\", error);\r\n    throw new Error(\"Failed to inject components: \" + error.message);\r\n  }\r\n}\r\n\r\nfunction setupConfig(config) {\r\n  // Apply title from config\r\n  if (config.title && config.title !== PLACEHOLDER_TITLE) {\r\n    document.title = config.title;\r\n  }\r\n\r\n  // Set available languages meta tag\r\n  if (config.languages && config.languages.available) {\r\n    const availableLanguagesStr = config.languages.available.join(',');\r\n\r\n    // Create or update the meta tag\r\n    let availableLanguagesMeta = document.querySelector('meta[name=\"available-languages\"]');\r\n    if (!availableLanguagesMeta) {\r\n      availableLanguagesMeta = document.createElement(\"meta\");\r\n      availableLanguagesMeta.name = \"available-languages\";\r\n      document.head.appendChild(availableLanguagesMeta);\r\n    }\r\n    availableLanguagesMeta.content = availableLanguagesStr;\r\n  }\r\n\r\n  // Store the config for access throughout the application\r\n  window.appConfig = config;\r\n\r\n  // Apply feature flags\r\n  applyFeatureFlags(config.features || {});\r\n}\r\n\r\n// Add this helper function\r\nfunction applyFeatureFlags(features) {\r\n  // Loop through features and apply them\r\n  Object.entries(features).forEach(([feature, enabled]) => {\r\n    // Convert camelCase to kebab-case for element IDs\r\n    const kebabFeature = feature.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();\r\n\r\n    // Handle special cases that don't follow the toggle pattern\r\n    if (feature === 'notepad') {\r\n      // Hide/show notepad button and content\r\n      const notepadButton = document.getElementById('notepad-button');\r\n      const notepadContent = document.getElementById('notepad-content');\r\n\r\n      if (notepadButton) {\r\n        notepadButton.classList.toggle('hidden', !enabled);\r\n      }\r\n      if (notepadContent) {\r\n        notepadContent.classList.toggle('hidden', !enabled);\r\n      }\r\n    } else if (feature === 'showAutoHideButton') {\r\n      // Hide/show the auto-hide menu toggle button\r\n      const toggleStateElement = document.getElementById('toggle-state');\r\n\r\n      if (toggleStateElement) {\r\n        // Find the container (the div that wraps the toggle)\r\n        const container = toggleStateElement.closest('.flex.justify-between.items-left') ||\r\n          toggleStateElement.parentElement;\r\n\r\n        if (container) {\r\n          container.classList.toggle('hidden', !enabled);\r\n        }\r\n      }\r\n    } else if (feature === 'showNavigationControls') {\r\n      // Hide/show the navigation controls wrapper and ensure it is inert when hidden\r\n      const navButtons = document.getElementById('back-forward-buttons');\r\n      const backButton = document.getElementById('back-button');\r\n      const forwardButton = document.getElementById('forward-button');\r\n\r\n      if (navButtons) {\r\n        navButtons.classList.toggle('hidden', !enabled);\r\n        navButtons.setAttribute('aria-hidden', (!enabled).toString());\r\n      }\r\n\r\n      [backButton, forwardButton].forEach(button => {\r\n        if (!button) return;\r\n        button.tabIndex = enabled ? 0 : -1;\r\n        button.setAttribute('aria-hidden', (!enabled).toString());\r\n      });\r\n    } else if (feature === 'characterDisplay') {\r\n      // Hide/show the character profile row\r\n      const characterProfileRow = document.getElementById('character-profile-row');\r\n\r\n      if (characterProfileRow) {\r\n        characterProfileRow.classList.toggle('hidden', !enabled);\r\n      }\r\n    } else {\r\n      // Find the toggle element for other features\r\n      const toggleElement = elementCache.get(`toggle-${kebabFeature}`);\r\n\r\n      // If the toggle exists but feature is disabled, hide its container\r\n      if (toggleElement) {\r\n        const container = toggleElement.closest('.setting-item') ||\r\n          toggleElement.closest('.feature-container') ||\r\n          toggleElement.parentElement;\r\n\r\n        if (container) {\r\n          container.classList.toggle('hidden', !enabled);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Also store in the state for programmatic checks\r\n    setState(`${feature}Enabled`, enabled);\r\n  });\r\n}\r\n\r\n// Create a helper function for attaching event listeners\r\nfunction addListener(elementId, event, handler) {\r\n  const element = document.getElementById(elementId);\r\n  if (element) element.addEventListener(event, handler);\r\n  return element;\r\n}\r\n\r\n// Use with an object map for clarity\r\nfunction setupEventListeners() {\r\n  // Handle basic click events\r\n  const clickHandlers = {\r\n    \"open-sidebar\": toggleSidebar,\r\n    \"close-sidebar\": toggleSidebar,\r\n    \"toggle-eli5\": toggleEli5Mode,\r\n    \"toggle-easy-read\": toggleEasyReadMode,\r\n    \"toggle-sign-language\": toggleSignLanguageMode,\r\n    \"sl-quick-toggle-button\": toggleSignLanguageMode,\r\n    \"toggle-syllables\": toggleSyllablesMode,\r\n    \"toggle-glossary\": toggleGlossaryMode,\r\n    \"toggle-autoplay\": toggleAutoplay,\r\n    \"toggle-describe-images\": toggleDescribeImages,\r\n    \"toggle-state\": toggleStateMode,\r\n    \"back-button\": previousPage,\r\n    \"forward-button\": nextPage,\r\n    \"nav-popup\": toggleNav,\r\n    \"nav-close\": toggleNav,\r\n  };\r\n\r\n  // Add notepad handlers only if notepad feature is enabled\r\n  if (isFeatureEnabled('notepad')) {\r\n    clickHandlers[\"notepad-button\"] = toggleNotepad;\r\n    clickHandlers[\"close-notepad\"] = toggleNotepad;\r\n    clickHandlers[\"save-notepad\"] = saveNotes;\r\n  }\r\n\r\n  // Attach all click handlers\r\n  Object.entries(clickHandlers).forEach(([id, handler]) => {\r\n    const element = elementCache.get(id);\r\n    if (element) element.addEventListener(\"click\", handler);\r\n  });\r\n\r\n  // Handle special cases\r\n  const languageDropdown = elementCache.get(\"language-dropdown\");\r\n  if (languageDropdown) languageDropdown.addEventListener(\"change\", switchLanguage);\r\n\r\n  // Set up notepad auto-save - only if notepad feature is enabled\r\n  if (isFeatureEnabled('notepad')) {\r\n    const notepadTextarea = elementCache.get(\"notepad-textarea\");\r\n    if (notepadTextarea) {\r\n      let saveTimeout;\r\n      notepadTextarea.addEventListener(\"input\", () => {\r\n        clearTimeout(saveTimeout);\r\n        saveTimeout = setTimeout(saveNotes, 1000);\r\n      });\r\n    }\r\n  }\r\n\r\n  // Global listeners\r\n  document.addEventListener(\"click\", handleNavigation);\r\n  document.addEventListener(\"keydown\", handleKeyboardShortcuts);\r\n\r\n  // Purple links\r\n  const purpleLinks = elementCache.getAll('.purple-link-button');\r\n  purpleLinks.forEach(link => {\r\n    link.addEventListener('click', () => {\r\n      localStorage.setItem('originatingPage', window.location.href);\r\n    });\r\n  });\r\n\r\n  setupClickOutsideHandler();\r\n}\r\n\r\nfunction setupAudioListeners() {\r\n  // Set up basic controls with a map\r\n  const audioControls = [\r\n    [\"play-pause-button\", togglePlayPause],\r\n    [\"toggle-read-aloud\", toggleReadAloud],\r\n    [\"audio-previous\", playPreviousAudio],\r\n    [\"audio-next\", playNextAudio],\r\n    [\"read-aloud-speed\", togglePlayBarSettings]\r\n  ];\r\n\r\n  audioControls.forEach(([id, handler]) => {\r\n    const element = elementCache.get(id);\r\n    if (element) element.addEventListener(\"click\", handler);\r\n  });\r\n\r\n  // Speed buttons\r\n  const speedButtons = elementCache.getAll(\".read-aloud-change-speed\");\r\n  speedButtons.forEach(button => {\r\n    button.addEventListener(\"click\", changeAudioSpeed);\r\n  });\r\n}\r\n\r\nasync function initializeUIComponents() {\r\n  try {\r\n    // Layout and visual components - always initialize these\r\n    await lazyLoad.load('zoom', () => Promise.resolve({ init: initializeZoomController }))\r\n      .then(module => module.init());\r\n    initializeSidebar();\r\n    initializeTabs();\r\n    adjustLayout();\r\n\r\n    // Initialize features based on config\r\n    if (window.appConfig?.features) {\r\n      // Audio features\r\n      if (isFeatureEnabled('readAloud')) {\r\n        initializePlayBar();\r\n        initializeAudioSpeed();\r\n        setupAudioListeners();\r\n        initializeTtsQuickToggle();\r\n\r\n        // Show the sidebar TTS toggle section\r\n        const ttsSidebarSection = document.getElementById(\"tts-sidebar-section\");\r\n        if (ttsSidebarSection) ttsSidebarSection.classList.remove(\"hidden\");\r\n\r\n        // Show play bar if needed\r\n        if (state.readAloudMode) {\r\n          initializeAudioElements();\r\n          const playBar = elementCache.get(\"play-bar\");\r\n          if (playBar) playBar.classList.remove(\"hidden\");\r\n        }\r\n      }\r\n\r\n      // Glossary\r\n      if (isFeatureEnabled('glossary')) {\r\n        initializeGlossary();\r\n      }\r\n\r\n      // ELI5\r\n      if (isFeatureEnabled('eli5')) {\r\n        initializeEli5();\r\n      }\r\n\r\n      // Notepad\r\n      if (isFeatureEnabled('notepad')) {\r\n        initializeNotepad();\r\n      }\r\n\r\n      // Character display\r\n      if (isFeatureEnabled('characterDisplay')) {\r\n        initCharacterDisplay();\r\n        displayCharacterInSettings();\r\n      }\r\n\r\n      // Highlighting text\r\n      if (isFeatureEnabled('highlight')) {\r\n        initializeWordByWordHighlighter();\r\n      }\r\n\r\n      // Load state modes - only if features are enabled\r\n      const stateInitTasks = [];\r\n\r\n      if (isFeatureEnabled('easyRead')) {\r\n        const easyReadSection = document.getElementById(\"easy-read-section\");\r\n        if (easyReadSection) easyReadSection.classList.remove(\"hidden\");\r\n        stateInitTasks.push(loadEasyReadMode);\r\n      }\r\n      // Always load state mode to maintain consistency, regardless of button visibility\r\n      stateInitTasks.push(loadStateMode);\r\n      if (isFeatureEnabled('signLanguage')) {\r\n        const signLanguageSection = document.getElementById(\"sign-language-section\");\r\n        if (signLanguageSection) signLanguageSection.classList.remove(\"hidden\");\r\n        initializeSignLanguage();\r\n        stateInitTasks.push(loadSignLanguageMode);\r\n      }\r\n      if (isFeatureEnabled('notepad')) {\r\n        stateInitTasks.push(loadSavedNotes());\r\n        stateInitTasks.push(loadNotepad);\r\n      }\r\n      if (isFeatureEnabled('autoplay')) {\r\n        setAutoplayContainerVisibility(true);\r\n        stateInitTasks.push(loadAutoplayState);\r\n      } else {\r\n        setAutoplayContainerVisibility(false);\r\n      }\r\n      if (isFeatureEnabled('describeImages')) {\r\n        setDescribeImagesContainerVisibility(true);\r\n        stateInitTasks.push(loadDescribeImagesState);\r\n      }\r\n      if (isFeatureEnabled(\"autoplay\") || isFeatureEnabled(\"describeImages\")) {\r\n        updateTtsOptionsContainerVisibility(true);\r\n      } else {\r\n        updateTtsOptionsContainerVisibility(false);\r\n      }\r\n      if (isFeatureEnabled('glossary')) stateInitTasks.push(loadGlossaryState);\r\n      if (isFeatureEnabled('eli5')) {\r\n        handleEli5Popup();\r\n      }\r\n\r\n      // Hide assistant tab if no assistant features are enabled\r\n      const hasAssistantFeatures =\r\n        isFeatureEnabled('easyRead') ||\r\n        isFeatureEnabled('readAloud') ||\r\n        isFeatureEnabled('signLanguage') ||\r\n        isFeatureEnabled('eli5') ||\r\n        isFeatureEnabled('glossary');\r\n      if (!hasAssistantFeatures) {\r\n        const assistantTab = document.getElementById(\"assistant-tab\");\r\n        if (assistantTab) assistantTab.classList.add(\"hidden\");\r\n        // Default to settings tab\r\n        const settingsTab = document.getElementById(\"settings-tab\");\r\n        const assistantContent = document.getElementById(\"assistant-content\");\r\n        const settingsContent = document.getElementById(\"settings-content\");\r\n        if (settingsTab && assistantContent && settingsContent) {\r\n          settingsTab.setAttribute(\"aria-selected\", \"true\");\r\n          settingsTab.classList.add(\"text-blue-700\", \"border-b-4\", \"-mb-1\", \"border-blue-700\");\r\n          assistantContent.classList.add(\"hidden\");\r\n          settingsContent.classList.remove(\"hidden\");\r\n        }\r\n      }\r\n\r\n      if (stateInitTasks.length > 0) {\r\n        await Promise.all(stateInitTasks.map(task => Promise.resolve().then(task)));\r\n      }\r\n\r\n    } else {\r\n      // Fallback to the original behavior if config isn't available\r\n      const initGroups = [\r\n        // All your original initialization groups\r\n      ];\r\n      await Promise.all(initGroups.map(group => group()));\r\n    }\r\n\r\n    // Activities should be initialized after UI components\r\n    if (isFeatureEnabled('activities', true)) {\r\n      const activitySections = document.querySelectorAll('section[role=\"activity\"]');\r\n      if (activitySections.length > 0) {\r\n        initializeQuizActivity();\r\n        prepareActivity();\r\n      }\r\n    }\r\n    loadToggleButtonState();\r\n  } catch (error) {\r\n    console.error('Error initializing UI components:', error);\r\n  }\r\n}\r\n\r\nconst finalizeInitialization = async () => {\r\n  const navPopup = elementCache.get(\"navPopup\");\r\n  const sidebar = elementCache.get(\"sidebar\");\r\n\r\n  setTimeout(async () => {\r\n    // Show navigation and sidebar\r\n    if (navPopup) navPopup.classList.remove(\"hidden\");\r\n    if (sidebar) sidebar.classList.remove(\"hidden\");\r\n\r\n    // Initialize autoplay if needed\r\n    if (isFeatureEnabled('readAloud') && isFeatureEnabled('autoplay')) {\r\n      initializeAutoplay();\r\n    }\r\n\r\n    // Run these tasks in parallel\r\n    const finalTasks = [\r\n      // Navigation\r\n      () => initializeNavigation(),\r\n\r\n      // Reference page functionality\r\n      () => initializeReferencePage(),\r\n\r\n      // Glossary terms\r\n      () => {\r\n        if (isFeatureEnabled('glossary')) {\r\n          highlightGlossaryTerms();\r\n        }\r\n      },\r\n\r\n      // Math rendering\r\n      () => {\r\n        if (window.MathJax) {\r\n          window.MathJax.typeset();\r\n        }\r\n      },\r\n\r\n      // Adjust layout after all content is ready\r\n      () => {\r\n        adjustLayout();\r\n      },\r\n\r\n      // Initialize tutorial via lazy loading\r\n      async () => {\r\n        if (!isFeatureEnabled('showTutorial', true)) {\r\n          return;\r\n        }\r\n\r\n        const tutorialModule = await lazyLoad.load('tutorial', () => import('./modules/tutorial.js'));\r\n        if (tutorialModule.init) {\r\n          tutorialModule.init();\r\n        }\r\n      },\r\n\r\n      // Analytics\r\n      async () => {\r\n        // Check if analytics is enabled in config\r\n        if (window.appConfig?.analytics?.enabled) {\r\n          const analyticsModule = await lazyLoad.load('analytics', () => import('./modules/analytics.js'));\r\n          analyticsModule.initMatomo(window.appConfig.analytics);\r\n        }\r\n      }\r\n    ];\r\n\r\n    // Execute all tasks in parallel\r\n    await Promise.all(finalTasks.map(task => Promise.resolve().then(task)));\r\n  }, 100);\r\n};\r\n\r\n/**\r\n * Displays character information in the settings menu\r\n */\r\nfunction displayCharacterInSettings() {\r\n  // Get the character information from localStorage\r\n  const characterInfo = localStorage.getItem('characterInfo');\r\n  const studentID = localStorage.getItem('studentID');\r\n\r\n  // Show the entire character-profile-row if it is hidden\r\n  const profileRow = document.getElementById('character-profile-row');\r\n  if (profileRow && profileRow.classList.contains('hidden')) {\r\n    profileRow.classList.remove('hidden');\r\n  }\r\n\r\n  if (characterInfo) {\r\n    try {\r\n      const character = JSON.parse(characterInfo);\r\n      const emojiElement = elementCache.get('settings-character-emoji');\r\n      const nameElement = elementCache.get('settings-character-name');\r\n      const studentIDElements = elementCache.getAll('#student-id');\r\n\r\n      if (emojiElement && nameElement) {\r\n        emojiElement.textContent = character.emoji || '\uD83D\uDC64';\r\n        nameElement.textContent = character.fullName || localStorage.getItem('nameUser') || 'Guest';\r\n      }\r\n\r\n      // Update any student ID elements in the settings\r\n      if (studentID && studentIDElements.length > 0) {\r\n        studentIDElements.forEach(element => {\r\n          if (element) element.textContent = studentID;\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Error parsing character information:', e);\r\n    }\r\n  }\r\n}\r\n\r\n// Lazy load module function\r\nconst lazyLoad = {\r\n  _modules: {},\r\n\r\n  async load(name, loader) {\r\n    if (!this._modules[name]) {\r\n      this._modules[name] = await loader();\r\n    }\r\n    return this._modules[name];\r\n  }\r\n};\r\n\r\n// Add this function near your setupConfig function\r\nexport const isFeatureEnabled = (featureName, defaultValue = false) => {\r\n  // Access from appConfig if available, otherwise fall back to state\r\n  if (typeof window.appConfig?.features?.[featureName] !== 'undefined') {\r\n    return window.appConfig.features[featureName] === true;\r\n  }\r\n\r\n  // Fall back to state object\r\n  const stateKey = `${featureName}Enabled`;\r\n  if (typeof state[stateKey] !== 'undefined') {\r\n    return state[stateKey] === true;\r\n  }\r\n\r\n  return defaultValue;\r\n}\r\n\r\n\r\n// Export necessary functions\r\nexport {\r\n  changeAudioSpeed,\r\n  handleKeyboardShortcuts,\r\n  initializeAutoplay,\r\n  loadAutoplayState,\r\n  loadDescribeImagesState,\r\n  playNextAudio,\r\n  playPreviousAudio,\r\n  toggleEli5Mode,\r\n  togglePlayPause,\r\n  toggleReadAloud,\r\n};\r\n"],
  "mappings": "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",
  "names": ["initialState", "state", "getState", "setState", "init_state", "__esmMin", "key", "value", "setCookie", "getCookie", "eraseCookie", "init_cookies", "__esmMin", "name", "value", "days", "path", "expires", "date", "nameEQ", "ca", "i", "c", "init_admin_popup", "__esmMin", "init_state", "init_cookies", "handleInitializationError", "showErrorToast", "createToastElement", "updateToast", "showMainContent", "init_error_utils", "__esmMin", "error", "errorMessage", "message", "toast", "mainContent", "container", "el", "content", "stopSLVideo", "startSLVideo", "loadSLVideoWithPromise", "loadCurrentSLVideo", "toggleBottomContainer", "init_video", "__esmMin", "init_state", "videoContainer", "video", "state", "setState", "existingVideo", "videoUrl", "error", "src", "resolve", "reject", "videoFiles", "currentPage", "show", "existingContainer", "container", "newVideoContainer", "setupTranslations", "safeJsonParse", "fetchTranslations", "applyTranslations", "applyTranslationToElements", "applyTranslationToPlaceholders", "handleEli5Translation", "updateLanguageDropdownFromAppConfig", "showMainContent", "translateText", "cycleLanguage", "fetchContentFiles", "init_translations", "__esmMin", "init_state", "init_ui_utils", "init_audio", "init_error_utils", "init_interface", "init_video", "state", "setState", "error", "showErrorToast", "response", "errorContext", "text", "currentLang", "interfacePath", "interface_response", "interface_data", "unhighlightAllElements", "translations", "key", "value", "translationKey", "elements", "isHeader", "element", "isExcluded", "wordCard", "activityItem", "activityText", "easyReadKey", "gatherAudioElements", "loadCurrentSLVideo", "highlightGlossaryTerms", "removeGlossaryHighlights", "loadGlossaryTerms", "titleMeta", "titleId", "translatedText", "mainSection", "eli5Id", "eli5Text", "eli5Container", "dropdown", "lang", "languageName", "option", "mainContent", "textToTranslate", "variables", "match", "p1", "languageDropdown", "currentLanguage", "options", "nextIndex", "nextLanguage", "changeEvent", "langName", "announceToScreenReader", "basePath", "version", "versionParam", "textsResponse", "audiosResponse", "videosResponse", "textsData", "audiosData", "videosData", "analytics_exports", "__export", "initMatomo", "trackActivityCompletion", "trackEvent", "trackFormSubmission", "trackNavigation", "trackTimeSpent", "trackToggleEvent", "matomoConfig", "init_analytics", "__esmMin", "config", "finalConfig", "script", "category", "action", "name", "value", "activityId", "activityType", "score", "fromPage", "toPage", "seconds", "formId", "isComplete", "toggleName", "isActive", "handleKeyboardShortcuts", "event", "activeElement", "isInTextBox", "hasModifiers", "readAloudMode", "getCookie", "easyReadMode", "eli5Mode", "nextPage", "previousPage", "toggleNav", "toggleSidebar", "cycleLanguage", "escapeKeyPressed", "PAGE_LIST_SELECTOR", "TOC_LIST_SELECTOR", "NAV_TAB_COOKIE", "NAV_TABS", "DEFAULT_NAV_TAB", "navigationData", "getInitialNavTab", "activeNavTab", "getPageListElement", "getNavLinks", "NAV_BUTTON_DISABLED_CLASSES", "applyNavButtonState", "updateNavigationButtonStates", "enhancePageList", "renderNavigationLists", "buildTableOfContents", "buildPageList", "activateNavTab", "initializeNavTabs", "setNavigationData", "getNavigationData", "handleNavigation", "savePageState", "setNavToggle", "handleActiveLink", "setupClickOutsideHandler", "init_navigation", "__esmMin", "init_cookies", "init_interface", "init_analytics", "init_translations", "savedTab", "button", "isDisabled", "cls", "navContainer", "backButton", "forwardButton", "navItems", "currentHref", "currentIndex", "item", "pages", "page", "index", "pdfPageNumber", "sequentialIndex", "displayLabel", "tocList", "chapter", "link", "baseTitle", "displayIndex", "indexSpan", "titleSpan", "pageList", "chapterLookup", "acc", "renderedChapters", "chapterInfo", "headingItem", "headingLabel", "sequentialLabel", "pdfLabel", "formatNavigationItems", "tab", "previousTab", "previousList", "setCookie", "tabButtons", "tabPanels", "isActive", "panel", "currentList", "savedPosition", "toc", "normalizedPages", "navLink", "trigger", "targetHref", "cacheInterfaceElements", "mainContent", "state", "navState", "navToggle", "newState", "navPopup", "navList", "navLinks", "validState", "isNavOpen", "currentPath", "setNavVisibility", "activeLink", "linkRect", "navRect", "scrollPosition", "basePath", "nextPageId", "trackNavigation", "prevPage", "sidebar", "content", "sidebarToggle", "isSidebarOpen", "clickedOutsideNav", "clickedOutsideSidebar", "announceToScreenReader", "executeMail", "activityType", "email", "iconElements", "urlPage", "iconElement", "index", "parentElement", "spanElement", "answerText", "answers", "activity", "activityId", "pageParts", "firstNumber", "secondNumber", "adjustedFirstNumber", "adjustedSecondNumber", "pageNumber", "namePage", "instructionPage", "intentCount", "filteredStorageData", "i", "key", "instructionPageHtml", "completedActivities", "activitiesWithDetails", "parts", "first", "second", "adjustedFirst", "adjustedSecond", "pageNum", "sortValue", "match", "nameActivity", "intent", "time", "a", "b", "completedActivitiesHtml", "idUser", "characterEmoji", "studentID", "characterInfo", "e", "generarNombre", "adj", "adjetivos", "animales", "htmlContent", "ActivityTypes", "activityLabel", "value", "lastChar", "API_KEY", "payload", "error", "init_send_email", "__esmMin", "init_utils", "isTypingTarget", "init_shortcut_utils", "__esmMin", "target", "tagName", "multipleChoiceShortcutHandler", "restoreSubmitButtonToValidate", "prepareMultipleChoice", "saveSelectionState", "restorePreviousSelection", "isLetterHidden", "setLetterAppearance", "selectOption", "clearAllValidationStyling", "resetOptions", "selectClickedOption", "getActivityItem", "checkMultipleChoice", "styleSelectedOption", "showFeedback", "init_multiple_choice", "__esmMin", "init_state", "init_audio", "init_utils", "init_translations", "init_send_email", "init_activity", "init_shortcut_utils", "submitButton", "translateText", "state", "section", "option", "newOption", "e", "optionLetter", "imgAlt", "shadowInput", "label", "radioGroup", "shortcutHint", "options", "keyHandler", "isTypingTarget", "digit", "activityId", "areaId", "storageKey", "selectedData", "savedSelection", "value", "selectedOption", "setState", "letterElement", "wrapper", "circleClasses", "letterClasses", "circle", "activityItem", "opt", "liveRegion", "mark", "feedback", "feedbackIcon", "feedbackText", "validationResults", "input", "element", "announcement", "dataActivityItem", "isCorrect", "updateResetButtonVisibility", "updateSubmitButtonAndToast", "ActivityTypes", "feedbackContainer", "key", "intentCount", "dataExplanation", "globalExplanation", "explanation", "playActivitySound", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "QUIZ_SECTION_SELECTOR", "CORRECT_ANSWERS_SCRIPT_ID", "EXPLANATIONS_SCRIPT_ID", "QUIZ_SHORTCUT_KEYS", "quizShortcutHandlerRegistered", "getSubmitButton", "disableQuizSubmitButton", "enableQuizSubmitButton", "focusQuizSubmitButton", "focusFirstQuizOption", "ensureValidationLiveRegion", "applyQuizBackground", "parseJsonScriptContent", "mergeIntoWindow", "hydrateQuizData", "getQuizActivityId", "getAreaId", "restoreQuizSubmitButtonToValidate", "saveQuizSelectionState", "restoreQuizSelection", "isLetterHidden", "setLetterAppearance", "clearQuizValidationStyling", "resetQuizOptions", "markQuizSelection", "getQuizActivityItem", "translateExplanationById", "resolveQuizExplanation", "bindQuizFeedbackAudioId", "resolveQuizExplanationAudioSrc", "playQuizExplanationAudio", "updateVisibleQuizFeedbackLanguage", "announceQuizSelection", "handleQuizOptionSelection", "isTypingTarget", "handleQuizShortcutKeydown", "registerQuizShortcutHandler", "resetQuizActivity", "attachQuizRetryHandler", "prepareQuiz", "checkQuiz", "styleQuizOption", "playQuizFeedbackAudioSequence", "showQuizFeedback", "initializeQuizActivity", "init_quiz", "__esmMin", "init_state", "init_audio", "init_utils", "init_translations", "init_send_email", "init_activity", "init_ui_utils", "submitButton", "quizSection", "firstOption", "target", "announcement", "elementId", "scriptElement", "error", "targetKey", "data", "existing", "correctAnswers", "explanations", "element", "translateText", "state", "option", "activityId", "areaId", "storageKey", "selectedData", "section", "savedSelection", "value", "selectedOption", "setState", "letterElement", "wrapper", "circleClasses", "letterClasses", "circle", "audioBindingsCleared", "mark", "feedback", "feedbackIcon", "feedbackText", "shadowInput", "validationResults", "gatherAudioElements", "radioGroup", "input", "activityItem", "label", "explanationId", "translated", "translatedFromId", "globalExplanationKey", "translatedFromGlobal", "fallbackExplanation", "previousId", "normalizedExplanationId", "changed", "filename", "audioSrc", "stopAudio", "explanationAudio", "shouldShowTtsUi", "highlightElement", "updatePlayPauseIcon", "cleanup", "unhighlightElement", "bindingsChanged", "feedbackContainer", "explanation", "isCorrect", "fallbackCopy", "optionLetter", "optionText", "liveRegion", "playActivitySound", "opt", "tagName", "event", "options", "index", "key", "quizRetryHandler", "newOption", "imgAlt", "labelParts", "ariaLabel", "shortcutHint", "dataActivityItem", "updateResetButtonVisibility", "updateSubmitButtonAndToast", "ActivityTypes", "soundEffect", "startExplanationPlayback", "attemptKey", "attemptCount", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "heading", "executeMail", "sorting_exports", "__export", "allowDrop", "checkSorting", "dropSort", "handleDragStart", "highlightBoxes", "placeWord", "prepareSorting", "resetActivity", "selectWordSort", "feedbackElement", "toast", "activityId", "correctCount", "incorrectCount", "key", "intentCount", "category", "categoryType", "placedWord", "wordKey", "correctCategory", "existingMark", "mark", "categoryName", "wordText", "stripEmojisAndCleanText", "correctCategoryElement", "correctCategoryName", "contentContainer", "textWrapper", "textElement", "announceToScreenReader", "totalPlacedWords", "totalWords", "allWordsPlaced", "allCorrect", "message", "translateText", "updateSubmitButtonAndToast", "ActivityTypes", "playActivitySound", "updateResetButtonVisibility", "feedbackMessage", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "executeMail", "setupWordCards", "activity", "getAllFocusableElements", "addWordCardListeners", "handleWordCardKeydown", "handleAllElementsArrowNavigation", "styleWordCard", "setupCategories", "setupFeedbackReset", "clearSortingLocalStorage", "restoreOriginalCard", "removeWord", "handleWordPlacement", "setupClonedCard", "setupTextCard", "disableOriginalCard", "setupImageCard", "resetSelectionState", "saveToLocalStorage", "loadFromLocalStorage", "placeWordSilently", "handleWordCardArrowNavigation", "handleCategoryArrowNavigation", "init_sorting", "__esmMin", "init_state", "init_audio", "init_utils", "init_ui_utils", "init_translations", "init_send_email", "init_activity", "text", "section", "wordCard", "activityElement", "localStorageKey", "availableWordCards", "card", "placedWordCards", "categories", "submitButton", "resetButton", "focusableElements", "event", "cardImage", "state", "allFocusableElements", "nextIndex", "currentElement", "currentIndex", "heading", "placedCards", "placedCount", "announcement", "cardNames", "e", "wordCards", "allCategories", "feedback", "placedWordCard", "setState", "error", "activityKey", "firstCategory", "itemCount", "listItem", "placedItemId", "savedData", "word", "newWordCard", "categoryDiv", "listElement", "currentWordText", "remainingWordCards", "categoryList", "wordsInCategory", "nextWordCard", "clonedWordCard", "clonedCard", "parentCategory", "cleanWordText", "image", "data", "words", "savedDataRaw", "previousWord", "currentWordCard", "currentCategory", "nextCategory", "selectedWordCard", "selectedWordText", "matching_exports", "__export", "allowDrop", "checkMatching", "drag", "drop", "dropWord", "loadDropzoneState", "prepareMatching", "resetActivity", "selectWord", "applyCardStyling", "setupWordButtons", "setupDropzones", "setupDragListeners", "handleWordButtonKeydown", "handleDropzoneKeydown", "getActivityLocalStorageKey", "saveDropzoneState", "removeDropzoneStateForWord", "handleDropExchange", "returnCardToOriginalPosition", "resetDropzones", "removeValidationIcons", "handleDropzoneValidation", "updateFeedback", "updateFeedbackText", "init_matching", "__esmMin", "init_state", "init_audio", "init_utils", "init_translations", "init_send_email", "card", "isInDropzone", "translateText", "section", "button", "event", "dropzone", "item", "state", "setState", "dropzoneId", "target", "existingWord", "playActivitySound", "currentWrapper", "data", "wordElement", "activityElement", "activity", "localStorageKey", "storedData", "wordId", "zoneId", "storedDataRaw", "words", "newWordElement", "newWordDropzone", "newWordRegion", "targetDropzoneId", "sourceDropzoneId", "originalParent", "correctCount", "key", "intentCount", "parentDropzone", "el", "correctAnswer", "onCorrect", "isCorrect", "existingIcon", "mark", "feedback", "totalItems", "isAllCorrect", "activityId", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "ActivityTypes", "updateSubmitButtonAndToast", "originalContainer", "prepareTrueFalse", "initializeAudio", "enhanceKeyboardAccessibility", "announceSelectionWithContext", "createKeyboardActionAnnouncement", "createFocusAnnouncement", "setupRadioButtons", "restorePreviousSelection", "addButtonListener", "clearFeedbackForQuestion", "checkTrueFalse", "createResultsAnnouncementElement", "clearPreviousFeedback", "validateAllQuestions", "validateQuestion", "updateValidationDisplay", "updateScreenReaderFeedback", "getValidationMark", "updateValidationMark", "updateButtonStyling", "playAppropriateSound", "init_true_false", "__esmMin", "init_state", "init_audio", "init_utils", "init_translations", "init_send_email", "section", "playActivitySound", "fieldset", "radios", "legendText", "radio", "newRadio", "event", "changeEvent", "nextIndex", "currentIndex", "optionText", "isChecked", "focusAnnouncement", "questionText", "announcement", "button", "index", "buttonId", "label", "activityId", "areaId", "storageKey", "savedSelection", "value", "selectedData", "setState", "questionName", "parentLabel", "buttonDiv", "validationMark", "srFeedback", "translateText", "validationResults", "key", "intentCount", "resultsAnnouncement", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "ActivityTypes", "incorrectCount", "updateSubmitButtonAndToast", "announcementElement", "el", "mark", "allQuestions", "allCorrect", "allAnswered", "incorrectQuestions", "questionNum", "selectedButton", "dataActivityItem", "selectedValue", "isCorrect", "baseClasses", "TextValidator", "textvalidator_default", "init_textvalidator", "__esmMin", "_TextValidator", "lines", "wordCount", "i", "line", "word", "dictError", "error", "commonWords", "text", "cleanText", "words", "validWordCount", "nonAccentedWord", "possibleStems", "nonAccentedStems", "stem", "stems", "verbEndings", "verbForm", "infinitive", "genderVariations", "variation", "newStem", "endings", "ending", "keyboardRows", "row", "sequence", "letters", "vowelRatio", "w", "maxReasonableLength", "initializeDictionary", "textValidator", "textvalidator_default", "validator", "prepareOpenEnded", "setupInputListeners", "handleInputChange", "handleInputFocus", "handleInputBlur", "saveInputState", "loadInputState", "init_open_ended", "__esmMin", "init_audio", "init_utils", "init_fill_in_the_blank", "init_textvalidator", "section", "inputs", "input", "event", "clearInputValidationFeedback", "activityId", "inputId", "localStorageKey", "savedValue", "preparefillInBlank", "setupInputListeners", "handleInputChange", "clearInputValidationFeedback", "handleInputFocus", "handleInputBlur", "checkFillInTheBlank", "clearOldFeedback", "validateAllInputs", "validateSingleInput", "setAriaAttributes", "handleValidationResult", "validateInput", "updateInputValidationStyle", "saveInputState", "init_fill_in_the_blank", "__esmMin", "init_audio", "init_utils", "init_open_ended", "init_translations", "init_send_email", "init_validation", "section", "inputs", "loadInputState", "input", "event", "dataActivityItem", "alternateItems", "alternateItem", "pairedInput", "dataAriaId", "inputId", "selector", "icon", "parent", "flexParent", "container", "el", "originalLabel", "parts", "validationResult", "feedback", "allCorrect", "firstIncorrectInput", "unfilledCount", "validation", "correctAnswer", "inputValue", "isCorrect", "isFilled", "acceptableAnswers", "answer", "alternateAnswers", "item", "alt", "provideFeedback", "ActivityTypes", "feedbackElement", "activityId", "key", "intentCount", "playActivitySound", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "updateSubmitButtonAndToast", "translateText", "value", "existingFeedback", "isValid", "hasDuplicate", "trimmedValue", "wasValid", "localStorageKey", "initializeDictionary", "textValidator", "textvalidator_default", "prepareFillInTable", "setupTableInputs", "handleTableInputChange", "handleTableInputFocus", "handleTableInputBlur", "checkTableInputs", "clearTableFeedback", "validateTableInputs", "validateSingleTableInput", "updateTableCellStyle", "clearTableInputValidationFeedback", "handleTableValidationResult", "validateTableInput", "updateTableInputValidationStyle", "saveTableInputState", "loadInputState", "highlightRelatedCells", "unhighlightRelatedCells", "init_fill_in_a_table", "__esmMin", "init_audio", "init_utils", "init_fill_in_the_blank", "init_translations", "init_validation", "init_send_email", "init_textvalidator", "section", "inputs", "input", "event", "cell", "validationResult", "hasGibberish", "checkForGibberish", "enhancedValidationResult", "el", "allFilled", "unfilledCount", "correctCount", "key", "intentCount", "filledNotRequired", "validation", "value", "dataActivityItem", "dataAriaId", "correctAnswer", "error", "isFilled", "isCorrect", "provideFeedback", "ActivityTypes", "inputId", "selector", "icon", "originalLabel", "isValid", "playActivitySound", "activityId", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "updateSubmitButtonAndToast", "translateText", "localStorageKey", "savedValue", "rowIndex", "cellIndex", "table", "row", "checkBigrams", "text", "matches", "totalBigrams", "i", "bigram", "SPANISH_FEATURES", "checkVowelRatio", "textNoSpaces", "vowelCount", "vowelRatio", "checkWordEndings", "words", "word", "endingMatches", "ending", "checkSpecialChars", "specialCharCount", "char", "hasExcessiveRepetition", "containsCommonSpanishWords", "hasInvalidConsonantClusters", "cluster", "calculateSpanishScore", "isLikelySpanish", "init_gibberish_detector", "__esmMin", "normalizedText", "bigramScore", "vowelScore", "endingScore", "specialCharScore", "score", "knownSpanishWords", "inappropriateWords", "containsProfanity", "init_profanity_detector", "__esmMin", "text", "lowerText", "word", "validateInputs", "setupOpenEndedInputListeners", "handleOpenEndedInputChange", "validateOpenEndedAnswer", "countUnfilledTextInputs", "checkForGibberish", "provideFeedbackForProfanity", "findAppropriateParentForFeedback", "provideFeedbackForGibberish", "provideFeedback", "applyFeedbackToInput", "createFeedbackElement", "setupAriaAttributes", "playActivityFeedback", "updateActivityFeedback", "handleValidationError", "init_validation", "__esmMin", "init_utils", "init_translations", "init_audio", "init_multiple_choice", "init_quiz", "init_fill_in_the_blank", "init_matching", "init_sorting", "init_true_false", "init_fill_in_a_table", "init_gibberish_detector", "init_send_email", "init_profanity_detector", "init_textvalidator", "activityType", "ActivityTypes", "checkMultipleChoice", "checkQuiz", "checkFillInTheBlank", "checkSorting", "checkMatching", "checkTrueFalse", "checkTableInputs", "error", "input", "event", "clearInputValidationFeedback", "activitySection", "textInputs", "unfilledCount", "hasInvalidContent", "allValid", "key", "intentCount", "activityId", "storedActivities", "completedActivities", "namePage", "timeDone", "newActivityId", "id", "executeMail", "inputs", "firstUnfilledInput", "isFilled", "hasGibberish", "hasProfanity", "firstGibberishInput", "firstProfanityInput", "textValidator", "textvalidator_default", "inputsArray", "text", "containsProfanity", "isLikelySpanish", "feedback", "translateText", "iconElement", "dataAriaId", "dataActivityItem", "icon", "rect", "parentRect", "top", "right", "parent", "isFlexContainer", "isGridContainer", "containerParent", "feedbackContainer", "wrapper", "isValid", "utils", "existingIconClass", "existingIcon", "feedbackId", "isSuccess", "playActivitySound", "hasInappropriateContent", "updateSubmitButtonAndToast", "toast", "initializeActivityHandlers", "activityResetHandlers", "ActivityTypes", "activityId", "resetActivityBase", "SELECTORS", "activitySection", "radioButtons", "resetSelectionInputs", "option", "CLASS_NAMES", "mark", "srText", "resetQuizActivity", "icon", "key", "module", "activityHandlers", "prepareMultipleChoice", "validateInputs", "prepareQuiz", "preparefillInBlank", "prepareOpenEnded", "prepareSorting", "prepareMatching", "prepareTrueFalse", "prepareFillInTable", "getActivityIdFromPath", "hasNonEmptyInputs", "activityHasUserData", "checkForUserData", "updateResetButtonVisibility", "resetInputs", "clearFeedbackElements", "submitActivityClasses", "resetActivityClasses", "relocateActionButtons", "clearActivityLocalStorage", "resetSubmitButton", "clearAllFeedback", "handleResetActivity", "setupActivitySection", "prepareActivity", "init_activity", "__esmMin", "init_state", "init_utils", "init_audio", "init_multiple_choice", "init_quiz", "init_sorting", "init_matching", "init_true_false", "init_validation", "init_fill_in_the_blank", "init_fill_in_a_table", "init_open_ended", "init_translations", "init_navigation", "selector", "inputs", "input", "activityType", "hasLocalStorageData", "resetButton", "hasUserData", "inputId", "localStorageKey", "container", "radio", "section", "target", "submitButton", "originalContainer", "applyActivityStyles", "cls", "removeActivityStyles", "translateText", "nextPage", "state", "elementsToRemove", "el", "attr", "toast", "feedbackElement", "sectionSelector", "inputSelector", "additionalReset", "handlers", "resetHandler", "playActivitySound", "handler", "setState", "initializeActivityAudioElements", "activitySections", "ActivityTypes", "toggleButtonState", "toggleButtonColor", "updateSubmitButtonAndToast", "checkCurrentActivityCompletion", "handleIncorrectSubmission", "updateToastForIncorrectSubmission", "provideFeedback", "handleFeedbackPlacement", "updateFeedbackContent", "handleTextInputFeedback", "handleMultipleChoiceFeedback", "updateForCorrectChoice", "updateForIncorrectChoice", "retryActivity", "clearFeedback", "resetButtons", "resetButtonState", "setToastStyle", "addCloseButtonToToast", "setupToast", "init_utils", "__esmMin", "init_state", "init_cookies", "init_translations", "init_navigation", "init_audio", "init_analytics", "init_activity", "buttonId", "toState", "button", "isChecked", "newState", "icon", "isCorrect", "buttonText", "translateText", "activityType", "unfilledCount", "options", "submitButton", "resetButton", "toast", "shouldShowToast", "mergedOptions", "state", "nextPage", "updateResetButtonVisibility", "activityId", "trackActivityCompletion", "message", "emoji", "toastType", "currentActivityIcon", "isMultipleChoiceLike", "defaultMessage", "element", "correctAnswer", "feedback", "dataActivityItem", "elementId", "iconElement", "rect", "parentRect", "top", "right", "label", "associatedLabel", "mark", "existingMark", "srText", "playActivitySound", "input", "type", "closeButton", "closeIcon", "e", "showCloseButton", "emojiSpan", "textP", "isHighDpiWindows", "isWindows", "hasHighDpi", "isChromiumOrSafari", "isChrome", "isSafari", "setNativeZoom", "zoomLevel", "currentZoom", "adjustInterfaceForNativeZoom", "applyTransformZoom", "html", "body", "contentContainer", "interfaceContainer", "navContainer", "sidebar", "inverseZoom", "bottomInterface", "resetZoom", "getCurrentZoom", "applyStoredZoom", "storedZoom", "initializeZoomController", "zoomApplied", "e", "createZoomControls", "existingControls", "controls", "zoomOutBtn", "resetBtn", "zoomInBtn", "level", "init_browser_zoom_controller", "__esmMin", "interface_exports", "__export", "adjustLayout", "cacheInterfaceElements", "checkWindowsScaling", "createZoomResetButton", "extractPageTerms", "formatNavigationItems", "getCachedInterface", "getCachedNavigation", "highlightGlossaryTerms", "initializeLanguageDropdown", "initializeNavigation", "initializePlayBar", "initializeSidebar", "initializeSignLanguage", "loadEasyReadMode", "loadGlossaryTerms", "loadSignLanguageMode", "loadStateMode", "removeGlossaryHighlights", "restoreInterfaceElements", "setNavVisibility", "setPlayPauseIcon", "setSidebarVisibility", "showGlossaryDefinition", "showZoomResetButton", "switchLanguage", "testZoom", "toggleEasyReadMode", "toggleGlossaryMode", "togglePlayBarSettings", "toggleSidebar", "toggleSignLanguageMode", "toggleStateMode", "toggleSyllablesMode", "updatePageNumber", "updateToggleVisuals", "glossaryTerms", "interfaceCache", "lastSidebarTrigger", "SIDEBAR_TRANSITION_MS", "SIDEBAR_FOCUS_DELAY_MS", "SIDEBAR_FOCUSABLE_SELECTOR", "focusFirstSidebarElement", "restoreSidebarTriggerFocus", "attachSidebarListeners", "init_interface", "__esmMin", "init_audio", "init_cookies", "init_error_utils", "init_state", "init_translations", "init_utils", "init_ui_utils", "init_video", "init_browser_zoom_controller", "init_analytics", "init_navigation", "sidebar", "focusableElements", "firstInteractive", "el", "tabContent", "savedState", "getCookie", "stateMode", "isOpen", "toggleNav", "sidebarState", "setCookie", "retryCount", "tryInitialize", "dropdown", "resolve", "metaTag", "languages", "currentLang", "state", "lang", "option", "setState", "container", "error", "pageElement", "pageSectionMetaTag", "sectionMetaTag", "fallbackValue", "sectionId", "displayLabel", "matchingEntry", "getNavigationData", "page", "isCurrentlyOpen", "submitButtonContainer", "navButtons", "mainContent", "submitButton", "shouldShiftLayout", "isActivity", "currentZoom", "getCurrentZoom", "setNativeZoom", "navPopup", "interfaceContainer", "navContainer", "stopAudio", "basePath", "fetchTranslations", "populateGlossaryTerms", "showErrorToast", "stopCalls", "toggleButtonState", "trackToggleEvent", "slQuickToggleButton", "toggleButtonColor", "toggleBottomContainer", "startSLVideo", "stopSLVideo", "toggleReadAloud", "signLanguageModeCookie", "language", "data", "pageTerms", "escapeRegExp", "string", "termObjects", "key", "value", "term", "a", "b", "highlightedBaseForms", "contentArea", "termsInHeaders", "header", "headerText", "walker", "node", "nodesToProcess", "currentNode", "textNode", "originalText", "segments", "i", "segment", "regex", "match", "beforeText", "termText", "punctuation", "afterText", "s", "nonEmptySegments", "fragment", "span", "e", "event", "existingPopup", "definition", "emoji", "originalTerm", "v", "popup", "headerContainer", "emojiContainer", "content", "footer", "viewInGlossaryButton", "translateText", "handleClickOutside", "handleEscape", "updatePopupPosition", "glossaryContent", "pageTab", "pageContent", "glossaryTermsPage", "showGlossaryContent", "div", "glossaryItems", "targetItem", "item", "termElement", "newRect", "absoluteTop", "absoluteLeft", "popupRect", "viewportWidth", "viewportHeight", "text", "easyReadModeCookie", "stateModeCookie", "isEnabled", "playBarVisible", "readAloudMode", "playBar", "readAloudSettings", "triggerButton", "index", "link", "href", "humanReadablePage", "pdfPageLabel", "itemIcon", "activityStatus", "activityId", "metadataSegments", "metadataHtml", "pdfBadge", "leftContent", "playIcon", "pauseIcon", "toggle", "track", "thumb", "termMap", "allTerms", "matches", "extractedTerm", "lowerCaseTerm", "initializeZoomController", "isHighDpiWindows", "notification", "createZoomControls", "level", "show", "manageFocus", "navList", "savedPosition", "scrollPosition", "ui_utils_exports", "__export", "announceToScreenReader", "checkIfReferencePage", "deactivateAudioElements", "displayReturnButton", "handleEli5Popup", "highlightElement", "initializeAudioElements", "initializeAutoplay", "initializeEli5", "initializeGlossary", "initializeReferencePage", "initializeTabs", "loadAutoplayState", "loadDescribeImagesState", "loadGlossaryState", "loadSyllablesState", "loadToggleButtonState", "populateGlossaryTerms", "setAutoplayContainerVisibility", "setDescribeImagesContainerVisibility", "setEli5ContainerVisibility", "showReadAloudContainers", "toggleAutoplay", "toggleDescribeImages", "toggleEli5Mode", "unhighlightAllElements", "unhighlightElement", "updatePlayPauseIcon", "updateTtsOptionsContainerVisibility", "handleAudioElementClick", "handleEli5State", "displayEli5Content", "handleEli5ModeToggle", "updateEli5Content", "handleEli5Audio", "addEli5AudioToQueue", "removeEli5AudioFromQueue", "clearEli5Content", "createGlossaryItem", "init_ui_utils", "__esmMin", "init_state", "init_cookies", "init_audio", "init_interface", "init_utils", "init_translations", "init_analytics", "init_base", "event", "module", "state", "stopAudio", "autoplayModeCookie", "getCookie", "setState", "toggleButtonState", "describeImagesModeCookie", "setCookie", "gatherAudioElements", "syllablesModeCookie", "glossaryModeCookie", "loadGlossaryTerms", "highlightGlossaryTerms", "setPlayPauseIcon", "playAudioSequentially", "easyReadItem", "readAloudItem", "eli5Item", "ttsOptionsContainer", "toggleButtonColor", "element", "elements", "isImage", "index", "item", "playCurrentAudio", "id", "audioSrc", "ariaId", "audio", "err", "describeImagesContainer", "eli5Container", "isPlaying", "playIcon", "pauseIcon", "explainButton", "eli5ModeCookie", "isFeatureEnabled", "eli5Id", "eli5Text", "style", "trackToggleEvent", "toggleEli5Button", "eli5Content", "closeButton", "mainSection", "eli5AudioSrc", "container", "existingIndex", "eli5Index", "message", "assertive", "announcement", "div", "glossaryList", "glossaryPageList", "glossaryTerms", "extractPageTerms", "pageTerms", "addedTerms", "termsByLetter", "key", "data", "firstLetterWithAccent", "firstLetterNormalized", "letter", "letterGroup", "displayLetter", "letterHeading", "a", "b", "term", "termData", "matchedMainTerm", "variations", "v", "emoji", "definition", "glossaryItem", "termTitleText", "termTitle", "definitionElement", "translateText", "removeGlossaryHighlights", "variation", "termElement", "emojiSpan", "allSearchTerms", "showDetails", "glossaryContent", "glossaryTermDetails", "glossaryTermContent", "originalTerm", "variationsHtml", "joinedVariations", "glossaryButton", "glossaryButtonContainer", "backToSidebarButton", "sidebarContent", "pageTab", "bookTab", "pageContent", "bookContent", "filterInput", "glossaryTermsBook", "closeGlossaryTermDetailsButton", "trackEvent", "setActiveTab", "tabIndex", "savedTabIndex", "filterValue", "terms", "letterHeadings", "hasResults", "letterHeadingsVisibility", "heading", "termText", "searchTerms", "currentElement", "noResultsMessage", "assistantTab", "settingsTab", "assistantContent", "settingsContent", "originatingPage", "currentUrl", "getState", "returnButton", "buttonText", "cacheInterfaceElements", "mainContent", "enabled", "autoplayContainer", "show", "SPEED_MAPPING", "hasUserInteracted", "activityAudio", "isProcessingAudio", "initializeActivityAudioElements", "playActivitySound", "gatherAudioElements", "stopAudio", "togglePlayPause", "playAudioSequentially", "playCurrentAudio", "processAudioQueue", "playAudioWithPromise", "playPreviousAudio", "playNextAudio", "initializeAudioSpeed", "changeAudioSpeed", "updateAudioSpeed", "updateSpeedDisplay", "updateSpeedButtons", "toggleReadAloud", "initializeTtsQuickToggle", "init_audio", "__esmMin", "init_state", "init_cookies", "init_ui_utils", "init_utils", "init_interface", "init_analytics", "init_base", "audio", "soundKey", "soundEffect", "err", "audioBasePath", "state", "elements", "el", "isNavElement", "isImage", "tagName", "placeholderId", "id", "audioSrc", "ariaId", "isHeader", "wordCard", "activityItem", "navList", "activityText", "easyReadAudioId", "item", "setState", "unhighlightAllElements", "updatePlayPauseIcon", "error", "currentIndex", "audioElements", "audioSpeed", "element", "highlightElement", "unhighlightElement", "describeImagesMode", "navigationDirection", "src", "speed", "resolve", "reject", "savedSpeed", "getCookie", "event", "button", "speedClass", "cls", "newSpeed", "setCookie", "togglePlayBarSettings", "key", "value", "speedButton", "display", "speedButtonElement", "speedText", "selectedButton", "btn", "stopCalls", "deactivateAudioElements", "initializeAudioElements", "newState", "toggleButtonColor", "trackToggleEvent", "playBar", "ttsOptionsContainer", "autoplayContainer", "describeImagesContainer", "ttsQuickToggleButton", "isFeatureEnabled", "toggleButtonState", "toggleSignLanguageMode", "e", "initializeWordByWordHighlighter", "timecodeJsonUrl", "state", "response", "timecodeData", "startMonitoring", "error", "monitorInterval", "checkCurrentAudio", "audio", "attachWordHighlighter", "currentListener", "detachCurrentListener", "clearHighlights", "audioElements", "currentIndex", "element", "dataId", "translationKey", "timecodeKey", "isHeader", "wordCard", "activityItem", "navList", "activityText", "easyReadKey", "entry", "wordTimestamps", "translatedText", "isImage", "createSubtitlePopup", "lastHighlightedImage", "subtitlePopup", "hideSubtitlePopup", "targetElement", "wrapTextInSpans", "el", "span", "firstSpan", "updateWordHighlighting", "endedListener", "TOLERANCE", "imageElement", "text", "handleClickOutside", "content", "positionSubtitlePopup", "event", "rect", "viewportWidth", "popupRect", "glossaryMapping", "glossaryElements", "originalText", "normalizeText", "termElement", "termText", "normalizedText", "modifiedTimestamps", "a", "b", "term", "words", "i", "ts", "j", "html", "w", "termAttr", "classList", "normalizedWord", "stopAudio", "unhighlightAllElements", "showGlossaryDefinition", "currentTime", "activeIndex", "lastWord", "activeSpan", "init_tts_highlighter", "__esmMin", "init_state", "init_audio", "init_ui_utils", "init_interface", "initializeNotepad", "toggleNotepad", "saveNotes", "loadSavedNotes", "loadNotepad", "init_notepad", "__esmMin", "init_cookies", "init_state", "init_translations", "notepadButton", "notepadContent", "state", "setCookie", "textarea", "saveStatus", "translateText", "savedNotes", "getCookie", "generateStudentID", "timestamp", "generateRandomCharacterName", "randomFirstName", "characterFirstNames", "lastNamesList", "feminineName", "characterLastNames", "randomLastName", "emoji", "animalEmojis", "init_character_generator", "__esmMin", "regenerateCharacter", "character", "generateRandomCharacterName", "studentID", "setState", "updateCharacterDisplay", "updateSidebarCharacter", "announceToScreenReader", "translateText", "emojiElement", "nameElements", "emojiElements", "studentIDElements", "element", "sidebarNameElement", "sidebarEmojiElement", "initCharacterDisplay", "generateStudentID", "existingCharacter", "refreshButton", "init_character_display", "__esmMin", "init_character_generator", "init_state", "init_ui_utils", "init_translations", "tutorial_exports", "__export", "init", "initTutorial", "resetTutorial", "showTutorial", "showWelcome", "TUTORIAL_SEEN_KEY", "tutorialSteps", "currentStepIndex", "tutorialOverlay", "tutorialPopup", "welcomePopup", "popupContainer", "showStep", "setupKeyboardNavigation", "positionClonedElement", "updatePopupPosition", "completeTutorial", "init_tutorial", "__esmMin", "init_translations", "init_ui_utils", "emoji", "translateText", "welcomeTitle", "welcomeText", "description", "startButton", "exitButton", "announceToScreenReader", "mainContent", "index", "step", "targetElement", "existingClonedElement", "clonedElementContainer", "clonedElement", "icon", "forwardButton", "forwardIcon", "pageSpan", "backButton", "backIcon", "arrow", "titleEl", "contentEl", "buttonsContainer", "skipButton", "actionButton", "newIndex", "stepContent", "container", "focusableElements", "event", "firstElement", "lastElement", "originalElement", "position", "rect", "targetRect", "liveRegion", "h1Element", "contentElement", "initializeApp", "addFavicons", "waitForDOM", "initSequence", "initializeCoreFunctionality", "setupEventListeners", "initializeUIComponents", "finalizeInitialization", "step", "error", "handleInitializationError", "showMainContent", "linkData", "link", "attr", "value", "resolve", "initializeLanguage", "initCharacterDisplay", "fetchAndInjectComponents", "initializeLanguageDropdown", "formatNavigationItems", "updatePageNumber", "setupTranslations", "cookieLanguage", "getCookie", "htmlLang", "defaultLanguage", "availableLanguages", "selectedLanguage", "eraseCookie", "currentPath", "setCookie", "setState", "interfaceHTML", "navHTML", "config", "pages", "toc", "response", "handleResponse", "injectComponents", "initializeNavTabs", "setNavigationData", "cachedInterface", "getCachedInterface", "cachedNavigation", "getCachedNavigation", "restoreInterfaceElements", "interfaceContainer", "elementCache", "navContainer", "cacheInterfaceElements", "setupConfig", "PLACEHOLDER_TITLE", "availableLanguagesStr", "availableLanguagesMeta", "applyFeatureFlags", "features", "feature", "enabled", "kebabFeature", "notepadButton", "notepadContent", "toggleStateElement", "container", "navButtons", "backButton", "forwardButton", "button", "characterProfileRow", "toggleElement", "clickHandlers", "toggleSidebar", "toggleEli5Mode", "toggleEasyReadMode", "toggleSignLanguageMode", "toggleSyllablesMode", "toggleGlossaryMode", "toggleAutoplay", "toggleDescribeImages", "toggleStateMode", "previousPage", "nextPage", "toggleNav", "isFeatureEnabled", "toggleNotepad", "saveNotes", "id", "handler", "element", "languageDropdown", "switchLanguage", "notepadTextarea", "saveTimeout", "handleNavigation", "handleKeyboardShortcuts", "setupClickOutsideHandler", "setupAudioListeners", "togglePlayPause", "toggleReadAloud", "playPreviousAudio", "playNextAudio", "togglePlayBarSettings", "changeAudioSpeed", "lazyLoad", "initializeZoomController", "module", "initializeSidebar", "initializeTabs", "adjustLayout", "initializePlayBar", "initializeAudioSpeed", "initializeTtsQuickToggle", "ttsSidebarSection", "state", "initializeAudioElements", "playBar", "initializeGlossary", "initializeEli5", "initializeNotepad", "displayCharacterInSettings", "initializeWordByWordHighlighter", "stateInitTasks", "easyReadSection", "loadEasyReadMode", "loadStateMode", "signLanguageSection", "initializeSignLanguage", "loadSignLanguageMode", "loadSavedNotes", "loadNotepad", "setAutoplayContainerVisibility", "loadAutoplayState", "setDescribeImagesContainerVisibility", "loadDescribeImagesState", "updateTtsOptionsContainerVisibility", "loadGlossaryState", "handleEli5Popup", "assistantTab", "settingsTab", "assistantContent", "settingsContent", "task", "initGroups", "group", "initializeQuizActivity", "prepareActivity", "loadToggleButtonState", "characterInfo", "studentID", "profileRow", "character", "emojiElement", "nameElement", "studentIDElements", "e", "basePath", "init_base", "__esmMin", "init_admin_popup", "init_audio", "init_tts_highlighter", "init_cookies", "init_error_utils", "init_interface", "init_browser_zoom_controller", "init_navigation", "init_state", "init_translations", "init_ui_utils", "init_notepad", "init_activity", "init_quiz", "init_character_display", "init_analytics", "selector", "key", "elements", "navPopup", "sidebar", "initializeAutoplay", "finalTasks", "initializeNavigation", "initializeReferencePage", "highlightGlossaryTerms", "tutorialModule", "name", "loader", "featureName", "defaultValue", "stateKey"]
}
